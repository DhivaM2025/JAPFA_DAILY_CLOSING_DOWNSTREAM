-- OBJECTIVE #1 - NEW DASHBOARD : SALES AMOUNT --
-- STEP 1 : RUN QUERY BELOW FOR GET SALES AMOUNT - PE1 ONLY --

(SELECT DISTINCT
    SO.COMPANY_CODE || '-' || CP.COMPANY_NAME AS COMPANY,
	SO.CUSTOMER AS CUSTOMER_SO_CODE,
    CUST.CUSTOMER_NAME AS CUSTOMER_SO_NAME,
    SO.PLANT || '-' || CP1.PLANT_NAME AS PLANT,
    CASE 
        WHEN CUST1.SALES_OFFICE IS NULL OR CUST1.SALES_OFFICE = '' OR CUST1.SALES_OFFICE = '9001'
        THEN SO.SALES_OFFICE || '-' || CUSTSO.SALES_OFFICE_DESC
        ELSE CUST1.SALES_OFFICE || '-' || CUST1.SALES_OFFICE_DESC
    END AS SALES_OFFICE,
    CASE 
        WHEN CUST1.SALES_OFFICE IS NULL OR CUST1.SALES_OFFICE = '' OR CUST1.SALES_OFFICE = '9001'
        THEN LEFT(CUSTSO.SALES_OFFICE_DESC, 3)
        WHEN CUST1.SALES_OFFICE_DESC IS NOT NULL AND CUST1.SALES_OFFICE_DESC <> ''
        THEN LEFT(CUST1.SALES_OFFICE_DESC, 3)
        ELSE CUST1.SALES_OFFICE
    END AS SALES_OFFICE_LOKASI,
    SO.DIVISION || '-' || SO.DIVISION_DESC AS DIVISION,
    SO.DISTRIBUTION_CHANNEL || '-' || SA.DISTRIBUTION_CHANNEL_DESC AS DISTRIBUTION_CHANNEL,
    CUST.REGION || '-' || DSR.REGION_DESCRIPTION AS REGION,
    CASE 
        WHEN DSR.REGION IN ('01','02','03','04','05','28') THEN 'PULAU JAWA'
        ELSE 'LUAR JAWA'
    END AS STATUS_REGION,
    CASE 
        WHEN SB.TERM_OF_PAYMENT_DESC IS NULL OR SB.TERM_OF_PAYMENT = '' THEN SB.TERM_OF_PAYMENT
        ELSE SB.TERM_OF_PAYMENT || '-' || SB.TERM_OF_PAYMENT_DESC
    END AS TOP,
    X.*
FROM (
    (SELECT 
    'Sales Order' AS CATEGORY,
    CASE 
        WHEN SO.SALES_ORDER_TYPE = 'ZB20' THEN 'Interco Automation MT'
        WHEN SO.SALES_ORDER_TYPE = 'ZB01' AND SO.CUSTOMER = '2000174657' THEN 'Interco Automation FS'
        ELSE 'Non Interco'
    END AS TYPE,
    SO.SALES_ORDER_TYPE || '-' || SO.SALES_ORDER_TYPE_DESC AS DOCUMENT_TYPE,
    NULL AS PENGIRIMAN_CATEGORY,
    CASE 
        WHEN SO.SALES_ORDER_STATUS IS NULL OR SO.SALES_ORDER_STATUS_DESC IS NULL 
            THEN SO.SALES_ORDER_STATUS_DESC
        ELSE SO.SALES_ORDER_STATUS || '-' || SO.SALES_ORDER_STATUS_DESC
    END AS DOCUMENT_STATUS,
    SO.SALES_ORDER_STATUS_REJECTION || '-' || SO.SALES_ORDER_STATUS_REJECTION_DESC AS REJECTION_STATUS,
    NULL AS POD_STATUS,
    NULL AS REASON_POD,
    NULL AS REASON_POD_FLAG,
    SO.SALES_ORDER_NUMBER AS SALES_ORDER_NUMBER,
    CASE 
        WHEN SO.SALES_ORDER_TYPE = 'ZB20' THEN SO1.SALES_ORDER_NUMBER
        WHEN SO.SALES_ORDER_TYPE = 'ZB01' AND SO.CUSTOMER = '2000174657' THEN SO.SALES_ORDER_EXTERNAL_DOCUMENT
        ELSE SO.SALES_ORDER_EXTERNAL_DOCUMENT
    END AS SALES_ORDER_INTERCO_AUTOMATION,
    NULL AS DELIVERY_NUMBER,
    NULL AS GI_NUMBER,
    NULL AS BILLING_NUMBER,
    NULL AS TFTG_NUMBER,
   	NULL AS BILL_CLEARING_NUMBER,
    TRY_TO_DATE(SO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD') AS SO_CREATED_DATE,
    TRY_TO_DATE(SO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD') AS CREATED_DATE,
    TRY_TO_DATE(SO.SALES_ORDER_DATE, 'YYYYMMDD') AS DOC_DATE,
    NULL AS CURRENCY,
    SUM(SO.SALES_ORDER_NEGATIVE_FLAG * SO.SALES_ORDER_QUANTITY_IN_KG) AS SO_QTY_IN_KG,
    SUM(SO.SALES_ORDER_NEGATIVE_FLAG * SO.SALES_ORDER_NET_AMOUNT) AS SO_AMOUNT,
    0 AS DO_QTY_IN_KG,
	0 AS GI_QTY_BASE_UOM,
    0 AS GI_AMOUNT,
    0 AS BILL_QTY_IN_KG,
    0 AS BILL_AMOUNT,
    CASE 
        WHEN EXISTS (
            SELECT 1
            FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING SB
            JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_CLEARING SBC 
                ON SB.SOURCE_SYSTEM = SBC.SOURCE_SYSTEM 
                AND SB.BILLING_NUMBER = SBC.BILLING_NUMBER
            WHERE SB.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
              AND SB.REFERENCE_SALES_ORDER_NUMBER = SO.SALES_ORDER_NUMBER
              AND SBC.BILLING_CLEARING_DOC IS NOT NULL 
              AND SBC.BILLING_CLEARING_DOC <> ''
        ) THEN 'X'
        ELSE NULL
    END AS BILLING_CLEAR_FLAG
FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER SO
LEFT JOIN 
	(SELECT DISTINCT SALES_ORDER_EXTERNAL_DOCUMENT, SALES_ORDER_NUMBER, SALES_ORDER_TYPE FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER) SO1
    ON SO1.SALES_ORDER_EXTERNAL_DOCUMENT = SO.SALES_ORDER_NUMBER
    AND SO1.SALES_ORDER_TYPE NOT IN ('ZKS3','ZKSC', 'ZKR3', 'ZKRC', 'ZKD3', 'ZKDC')
WHERE SO.PLANT NOT IN ('901A','905A','90VA','90VB','90VC','90WA','90XA','90ZA')
GROUP BY 
    SO.SALES_ORDER_TYPE,
    SO.SALES_ORDER_TYPE_DESC,
    SO.SALES_ORDER_STATUS,
    SO.SALES_ORDER_STATUS_DESC,
    SO.SALES_ORDER_STATUS_REJECTION,
    SO.SALES_ORDER_STATUS_REJECTION_DESC,
    SO.SALES_ORDER_NUMBER,
    SO1.SALES_ORDER_NUMBER,
    SO.SALES_ORDER_EXTERNAL_DOCUMENT,
    SO.SALES_ORDER_CREATED_DATE,
    SO.SALES_ORDER_DATE,
    SO.CUSTOMER,
    SO.SOURCE_SYSTEM)
UNION ALL
(SELECT 
	'Delivery Order' AS CATEGORY,
    CASE 
        WHEN SO.SALES_ORDER_TYPE = 'ZB20' THEN 'Interco Automation MT'
        WHEN SO.SALES_ORDER_TYPE = 'ZB01' AND SO.CUSTOMER = '2000174657' THEN 'Interco Automation FS'
        ELSE 'Non Interco'
    END AS TYPE,
    SD.DELIVERY_TYPE || '-' || SD.DELIVERY_TYPE_DESC AS DOCUMENT_TYPE,
    CASE 
        WHEN (SD.DELIVERY_TYPE = 'ZB04' AND SO.PLANT || SO.DIVISION IN (
            '90EI01','90EF02','90AF01','90BB03','90EB02','90AD01','90ED01',
            '90EH01','90EO02','90AL02','90AB01','90EC01','90BB02','90AD02',
            '90AB02','90AF02','90BB01','90EE02','90EC02','90ED02','90EG01',
            '90EL01','90EK01','90EI02','90AL01'
        ))
        OR (SD.DELIVERY_TYPE = 'ZB05' AND SO.PLANT || SO.DIVISION IN (
            '90AB02','90EO02','90ED01','90AF01','90EB02','90EF02','90EI01',
            '90AB01','90AD02','90AD01','90BB01','90EC02','90EI02','90BB02',
            '90AF02','90AL01','90EE02','90AL02','90ED02'
        ))
        THEN 'Pengiriman Third Party Gudang Third Party'
        ELSE 'Pengiriman Third Party Gudang Internal'
	END AS PENGIRIMAN_CATEGORY,
	CASE 
    	WHEN SD.DELIVERY_STATUS = 'Not yet processed' THEN 'A-Not yet processed'
    	WHEN SD.DELIVERY_STATUS = 'Partially processed' THEN 'B-Partially processed'
		WHEN SD.DELIVERY_STATUS = 'Completely processed' THEN 'C-Completely processed'
    	ELSE SD.DELIVERY_STATUS
	END AS DOCUMENT_STATUS,
	SO.SALES_ORDER_STATUS_REJECTION || '-' || SO.SALES_ORDER_STATUS_REJECTION_DESC AS REJETION_STATUS,
 	CASE 
    	WHEN SD.DELIVERY_POD_STATUS = 'Not yet processed' THEN 'A-Not yet processed'
     	WHEN SD.DELIVERY_POD_STATUS = 'Partially processed' THEN 'B-Partially processed'
     	WHEN SD.DELIVERY_POD_STATUS = 'Completely processed' THEN 'C-Completely processed'
    	ELSE SD.DELIVERY_POD_STATUS
 	END AS POD_STATUS,
 	SD.DELIVERY_NOTE AS REASON_POD,
	CASE
		WHEN SD.DELIVERY_NOTE IS NULL OR SD.DELIVERY_NOTE = '' THEN FALSE
		ELSE TRUE
	END AS REASON_POD_FLAG,
    SD.REFERENCE_SALES_ORDER_NUMBER AS SALES_ORDER_NUMBER, 
    CASE 
        WHEN SO.SALES_ORDER_TYPE = 'ZB20' THEN SO1.SALES_ORDER_NUMBER
        WHEN SO.SALES_ORDER_TYPE = 'ZB01' AND SO.CUSTOMER = '2000174657' THEN SO.SALES_ORDER_EXTERNAL_DOCUMENT
        ELSE SO.SALES_ORDER_EXTERNAL_DOCUMENT
    END AS SALES_ORDER_INTERCO_AUTOMATION,
    SD.DELIVERY_NUMBER, 
    NULL AS GI_NUMBER,
    NULL AS BILLING_NUMBER, 
	NULL AS TFTG_NUMBER,
   	NULL AS BILL_CLEARING_NUMBER,
    TRY_TO_DATE(SO.SALES_ORDER_CREATED_DATE,'YYYYMMDD') AS SO_CREATED_DATE,
    TRY_TO_DATE(SD.DELIVERY_CREATED_DATE,'YYYYMMDD') AS CREATED_DATE,
    TRY_TO_DATE(SD.DELIVERY_ACTUAL_DATE,'YYYYMMDD') AS DOC_DATE,
    NULL AS CURRENCY,
    0 AS SO_QTY_IN_KG,
    0 AS SO_AMOUNT,
    ROUND(SUM(SD.DELIVERY_QUANTITY_IN_KG),2) AS DO_QTY_IN_KG,
    0 AS GI_QTY_BASE_UOM,
    0 AS GI_AMOUNT,
    0 AS BILL_QTY_IN_KG,
    0 AS BILL_AMOUNT,
    CASE 
        WHEN EXISTS (
            SELECT 1
            FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING SB
            JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_CLEARING SBC
              ON SB.SOURCE_SYSTEM = SBC.SOURCE_SYSTEM
             AND SB.BILLING_NUMBER = SBC.BILLING_NUMBER
            WHERE SB.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
              AND SB.REFERENCE_SALES_ORDER_NUMBER = SO.SALES_ORDER_NUMBER
              AND SBC.BILLING_CLEARING_DOC IS NOT NULL
              AND SBC.BILLING_CLEARING_DOC <> ''
        ) THEN 'X' 
        ELSE NULL 
    END AS BILLING_CLEAR_FLAG
FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_DELIVERY SD
LEFT JOIN (
    SELECT DISTINCT 
        SOURCE_SYSTEM, CUSTOMER, PLANT, DIVISION, SALES_ORDER_NUMBER, SALES_ORDER_EXTERNAL_DOCUMENT, 
        SALES_ORDER_CREATED_DATE, SALES_ORDER_STATUS_DELIVERY,SALES_ORDER_STATUS_DELIVERY_DESC, SALES_ORDER_TYPE,
        SALES_ORDER_STATUS_REJECTION,SALES_ORDER_STATUS_REJECTION_DESC
    FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER
) SO
    ON SO.SOURCE_SYSTEM = SD.SOURCE_SYSTEM 
   AND SO.SALES_ORDER_NUMBER = SD.REFERENCE_SALES_ORDER_NUMBER
LEFT JOIN (
    SELECT DISTINCT 
        SALES_ORDER_EXTERNAL_DOCUMENT, SALES_ORDER_NUMBER, SALES_ORDER_TYPE  
    FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER
) SO1
    ON SO1.SALES_ORDER_EXTERNAL_DOCUMENT = SO.SALES_ORDER_NUMBER
    AND SO1.SALES_ORDER_TYPE NOT IN  ('ZKS3','ZKSC', 'ZKR3', 'ZKRC', 'ZKD3', 'ZKDC')
GROUP BY 
    SD.DELIVERY_NUMBER, 
    SD.REFERENCE_SALES_ORDER_NUMBER,
    SO.SALES_ORDER_EXTERNAL_DOCUMENT, 
    SO1.SALES_ORDER_NUMBER,
    SD.DELIVERY_TYPE, 
    SD.DELIVERY_TYPE_DESC,SD.DELIVERY_NOTE,
    SD.DELIVERY_STATUS,SO.SALES_ORDER_STATUS_REJECTION,
    SD.DELIVERY_POD_STATUS,SO.SALES_ORDER_STATUS_REJECTION_DESC,
    SO.SOURCE_SYSTEM, 
    SO.SALES_ORDER_NUMBER, 
    SO.SALES_ORDER_STATUS_DELIVERY, 
    SO.SALES_ORDER_STATUS_DELIVERY_DESC,
    SO.SALES_ORDER_TYPE, 
    SO.CUSTOMER,SO.PLANT,SO.DIVISION,
    SO.SALES_ORDER_CREATED_DATE, 
    SD.DELIVERY_CREATED_DATE, 
    SD.DELIVERY_ACTUAL_DATE)
UNION ALL
(SELECT 
    'Good Issue' AS CATEGORY,
    CASE 
        WHEN SO.SALES_ORDER_TYPE = 'ZB20' THEN 'Interco Automation MT'
        WHEN SO.SALES_ORDER_TYPE = 'ZB01' AND SO.CUSTOMER = '2000174657' THEN 'Interco Automation FS'
        ELSE 'Non Interco'
    END AS TYPE,
    NULL AS DOCUMENT_TYPE,
    NULL AS PENGIRIMAN_CATEGORY,
    NULL AS DELIVERY_STATUS,
    SO.SALES_ORDER_STATUS_REJECTION || '-' || SO.SALES_ORDER_STATUS_REJECTION_DESC AS REJETION_STATUS,
	CASE 
  		WHEN SD.DELIVERY_POD_STATUS = 'Not yet processed' THEN 'A-Not yet processed'
    	WHEN SD.DELIVERY_POD_STATUS = 'Partially processed' THEN 'B-Partially processed'
    	WHEN SD.DELIVERY_POD_STATUS = 'Completely processed' THEN 'C-Completely processed'
    ELSE SD.DELIVERY_POD_STATUS
	END AS POD_STATUS,
	SD.DELIVERY_NOTE AS REASON_POD,
	CASE
		WHEN SD.DELIVERY_NOTE IS NULL OR SD.DELIVERY_NOTE = '' THEN FALSE
		ELSE TRUE
	END AS REASON_POD_FLAG,
    SO.SALES_ORDER_NUMBER AS SALES_ORDER_NUMBER, 
    CASE 
        WHEN SO.SALES_ORDER_TYPE = 'ZB20' THEN SO1.SALES_ORDER_NUMBER
        WHEN SO.SALES_ORDER_TYPE = 'ZB01' AND SO.CUSTOMER = '2000174657' THEN SO.SALES_ORDER_EXTERNAL_DOCUMENT
        ELSE SO.SALES_ORDER_EXTERNAL_DOCUMENT
    END AS SALES_ORDER_INTERCO_AUTOMATION,
    NULL AS DELIVERY_NUMBER, 
    MATERIAL_DOCUMENT_NUMBER AS GI_NUMBER,
    NULL AS BILLING_NUMBER, 
    NULL AS TFTG_NUMBER,
   	NULL AS BILL_CLEARING_NUMBER,
    NULL AS SO_CREATED_DATE,
    TRY_TO_DATE(SCM.ENTRY_DATE, 'YYYYMMDD') AS CREATED_DATE,
    TRY_TO_DATE (SCM.POSTING_DATE, 'YYYYMMDD') AS DOC_DATE,
    NULL AS CURRENCY,
    0 AS SO_QTY_IN_KG,
    0 AS SO_AMOUNT,
    0 AS DO_QTY_IN_KG,
    ROUND(SUM(QUANTITY),2) AS GI_QTY_BASE_UOM,
    ROUND(SUM(AMOUNT_IN_LC),2) AS GI_AMOUNT,
    0 AS BILL_QTY_IN_KG,
    0 AS BILL_AMOUNT,
    CASE 
        WHEN EXISTS (
            SELECT 1
            FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING SB
            JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_CLEARING SBC
              ON SB.SOURCE_SYSTEM = SBC.SOURCE_SYSTEM
             AND SB.BILLING_NUMBER = SBC.BILLING_NUMBER
            WHERE SB.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
              AND SB.REFERENCE_SALES_ORDER_NUMBER = SO.SALES_ORDER_NUMBER
              AND SBC.BILLING_CLEARING_DOC IS NOT NULL
              AND SBC.BILLING_CLEARING_DOC <> ''
        ) THEN 'X' 
        ELSE NULL 
    END AS BILLING_CLEAR_FLAG
FROM PROD_DB.DSTR_BI_COMMUNITY.F_SCM_STOCK_TRANSACTION_SAP SCM
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, DELIVERY_NUMBER, REFERENCE_SALES_ORDER_NUMBER,DELIVERY_POD_STATUS,DELIVERY_NOTE FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_DELIVERY) SD
	ON SD.SOURCE_SYSTEM = SCM.SOURCE_SYSTEM
	AND SD.DELIVERY_NUMBER = SCM."REFERENCE"
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, SALES_ORDER_NUMBER, CUSTOMER, SALES_ORDER_EXTERNAL_DOCUMENT, SALES_ORDER_CREATED_DATE, SALES_ORDER_STATUS_DELIVERY, SALES_ORDER_STATUS_DELIVERY_DESC,SALES_ORDER_TYPE,SALES_ORDER_STATUS_REJECTION,SALES_ORDER_STATUS_REJECTION_DESC
    FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER) SO
    ON SO.SOURCE_SYSTEM = SD.SOURCE_SYSTEM 
	AND SO.SALES_ORDER_NUMBER = SD.REFERENCE_SALES_ORDER_NUMBER 
LEFT JOIN (
    SELECT DISTINCT 
        SALES_ORDER_EXTERNAL_DOCUMENT, SALES_ORDER_NUMBER, SALES_ORDER_TYPE  
    FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER
) SO1
    ON SO1.SALES_ORDER_EXTERNAL_DOCUMENT = SO.SALES_ORDER_NUMBER
    AND SO1.SALES_ORDER_TYPE NOT IN  ('ZKS3','ZKSC', 'ZKR3', 'ZKRC', 'ZKD3', 'ZKDC')
WHERE SCM.SOURCE_SYSTEM = 'PE1'
AND SCM.FISCAL_YEAR = '2025'
GROUP BY  
    SCM.MATERIAL_DOCUMENT_NUMBER,
    SCM.ENTRY_DATE,
    SCM.POSTING_DATE,SD.DELIVERY_POD_STATUS,
    SO.SALES_ORDER_EXTERNAL_DOCUMENT, 
    SO1.SALES_ORDER_NUMBER,
    SO.SOURCE_SYSTEM, 
    SO.SALES_ORDER_NUMBER, 
    SO.SALES_ORDER_STATUS_DELIVERY,SO.SALES_ORDER_STATUS_REJECTION,
    SO.SALES_ORDER_STATUS_DELIVERY_DESC,SO.SALES_ORDER_STATUS_REJECTION_DESC,
    SO.SALES_ORDER_TYPE,SD.DELIVERY_NOTE,
    SO.CUSTOMER,
    SO.SALES_ORDER_CREATED_DATE)
UNION ALL
    (SELECT 
    'Billing' AS CATEGORY,
    CASE 
        WHEN SO.SALES_ORDER_TYPE = 'ZB20' THEN 'Interco Automation MT'
        WHEN SO.SALES_ORDER_TYPE = 'ZB01' AND SO.CUSTOMER = '2000174657' THEN 'Interco Automation FS'
        ELSE 'Non Interco'
    END AS TYPE,
    SB.BILLING_TYPE || '-' || SB.BILLING_TYPE_DESC AS DOCUMENT_TYPE,
    NULL AS PENGIRIMAN_CATEGORY,
 	CASE 
    	WHEN SB.POSTING_STATUS IS NULL OR SB.POSTING_STATUS_DESCRIPTION IS NULL THEN SB.POSTING_STATUS_DESCRIPTION 
     	ELSE SB.POSTING_STATUS || '-' || SB.POSTING_STATUS_DESCRIPTION 
    END AS DOCUMENT_STATUS,
    SO.SALES_ORDER_STATUS_REJECTION || '-' || SO.SALES_ORDER_STATUS_REJECTION_DESC AS REJETION_STATUS,
	CASE 
  		WHEN SD.DELIVERY_POD_STATUS = 'Not yet processed' THEN 'A-Not yet processed'
    	WHEN SD.DELIVERY_POD_STATUS = 'Partially processed' THEN 'B-Partially processed'
    	WHEN SD.DELIVERY_POD_STATUS = 'Completely processed' THEN 'C-Completely processed'
    ELSE SD.DELIVERY_POD_STATUS
	END AS POD_STATUS,
	SD.DELIVERY_NOTE AS REASON_POD,
	CASE
		WHEN SD.DELIVERY_NOTE IS NULL OR SD.DELIVERY_NOTE = '' THEN FALSE
		ELSE TRUE
	END AS REASON_POD_FLAG,
    SB.REFERENCE_SALES_ORDER_NUMBER AS SALES_ORDER_NUMBER, 
    CASE 
        WHEN SO.SALES_ORDER_TYPE = 'ZB20' THEN SO1.SALES_ORDER_NUMBER
        WHEN SO.SALES_ORDER_TYPE = 'ZB01' AND SO.CUSTOMER = '2000174657' THEN SO.SALES_ORDER_EXTERNAL_DOCUMENT
        ELSE SO.SALES_ORDER_EXTERNAL_DOCUMENT
    END AS SALES_ORDER_INTERCO,
    NULL AS DELIVERY_NUMBER, 
    NULL AS GI_NUMBER,
    SB.BILLING_NUMBER, 
   	TTF.TTF_NUMBER AS TFTG_NUMBER,
   	SBC.BILLING_CLEARING_DOC AS BILL_CLEARING_NUMBER,
    TRY_TO_DATE(SO.SALES_ORDER_CREATED_DATE,'YYYYMMDD') AS SO_CREATED_DATE,
    TRY_TO_DATE(SB.BILLING_CREATED_DATE,'YYYYMMDD') AS CREATED_DATE,
    TRY_TO_DATE(SB.BILLING_DATE,'YYYYMMDD') AS DOC_DATE,
    SB.BILLING_DOCUMENT_CURRENCY AS CURRENCY,
    0 AS SO_QTY_IN_KG,
    0 AS SO_AMOUNT,
    0 AS DO_QTY_IN_KG,
	0 AS GI_QTY_BASE_UOM,
    0 AS GI_AMOUNT,
    ROUND(SUM(SB.BILLING_NEGATIVE_FLAG * SB.BILLING_QUANTITY_IN_KG),2) AS BILL_QTY_IN_KG,
    ROUND(SUM(SB.BILLING_NEGATIVE_FLAG * SB.BILLING_NET_AMOUNT),2) AS BILL_AMOUNT,
    CASE 
        WHEN EXISTS (
            SELECT 1
            FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_CLEARING SBC
            WHERE SBC.SOURCE_SYSTEM = SB.SOURCE_SYSTEM
              AND SBC.BILLING_NUMBER = SB.BILLING_NUMBER
              AND SBC.BILLING_CLEARING_DOC IS NOT NULL
              AND SBC.BILLING_CLEARING_DOC <> ''
        ) THEN 'X'
        ELSE NULL
    END AS BILLING_CLEAR_FLAG
FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING SB
LEFT JOIN (
    SELECT DISTINCT 
        SOURCE_SYSTEM, SALES_ORDER_NUMBER, CUSTOMER, SALES_ORDER_EXTERNAL_DOCUMENT, 
        SALES_ORDER_CREATED_DATE, SALES_ORDER_STATUS_BILLING,SALES_ORDER_STATUS_BILLING_DESC, SALES_ORDER_TYPE,
        SALES_ORDER_STATUS_REJECTION, SALES_ORDER_STATUS_REJECTION_DESC
    FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER
) SO
    ON SO.SOURCE_SYSTEM = SB.SOURCE_SYSTEM 
   AND SB.REFERENCE_SALES_ORDER_NUMBER = SO.SALES_ORDER_NUMBER
LEFT JOIN (
    SELECT DISTINCT 
        SALES_ORDER_EXTERNAL_DOCUMENT, SALES_ORDER_NUMBER, SALES_ORDER_TYPE  
    FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER
) SO1
    ON SO1.SALES_ORDER_EXTERNAL_DOCUMENT = SO.SALES_ORDER_NUMBER
    AND SO1.SALES_ORDER_TYPE NOT IN ('ZKS3','ZKSC', 'ZKR3', 'ZKRC', 'ZKD3', 'ZKDC')
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, DELIVERY_NUMBER, REFERENCE_SALES_ORDER_NUMBER,DELIVERY_POD_STATUS,DELIVERY_NOTE FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_DELIVERY) SD
	ON SD.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
	AND SD.REFERENCE_SALES_ORDER_NUMBER = SO.SALES_ORDER_NUMBER
LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_CLEARING SBC
	ON SBC.SOURCE_SYSTEM = SB.SOURCE_SYSTEM
	AND SBC.BILLING_NUMBER = SB.BILLING_NUMBER
LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_TTF TTF
	ON TTF.SOURCE_SYSTEM = SB.SOURCE_SYSTEM
	AND TTF.BILLING_NUMBER = SB.BILLING_NUMBER
WHERE SB.BILLING_TYPE <> 'ZB50'
GROUP BY 
    SB.BILLING_TYPE, 
    SB.BILLING_TYPE_DESC, 
    SB.SOURCE_SYSTEM,
    SB.POSTING_STATUS,SD.DELIVERY_POD_STATUS,
    SB.POSTING_STATUS_DESCRIPTION,
    SO.SALES_ORDER_STATUS_BILLING,SO.SALES_ORDER_STATUS_REJECTION,
    SO.SALES_ORDER_STATUS_BILLING_DESC,SO.SALES_ORDER_STATUS_REJECTION_DESC,
    SO.SALES_ORDER_TYPE,SD.DELIVERY_NOTE,
    SO.CUSTOMER,
    SB.REFERENCE_SALES_ORDER_NUMBER, 
    SO.SALES_ORDER_EXTERNAL_DOCUMENT,
    SO1.SALES_ORDER_NUMBER,
    SB.BILLING_NUMBER,
    SO.SALES_ORDER_CREATED_DATE, 
    SB.BILLING_CREATED_DATE, 
    SB.BILLING_DATE,
    SB.BILLING_DOCUMENT_CURRENCY,
    TTF.TTF_NUMBER,SBC.BILLING_CLEARING_DOC)) X
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, SALES_ORDER_NUMBER, COMPANY_CODE, PLANT, SALES_OFFICE, DIVISION, DIVISION_DESC, CUSTOMER, DISTRIBUTION_CHANNEL, SALES_ORDER_CREATED_DATE, SALES_ORDER_TYPE FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER) SO 
    ON SO.SALES_ORDER_NUMBER = X.SALES_ORDER_NUMBER
LEFT JOIN (
    SELECT DISTINCT SOURCE_SYSTEM, BILLING_NUMBER, TERM_OF_PAYMENT, TERM_OF_PAYMENT_DESC 
    FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING
) SB 
    ON SB.BILLING_NUMBER = X.BILLING_NUMBER
LEFT JOIN (
    SELECT DISTINCT SOURCE_SYSTEM, CUSTOMER, CUSTOMER_NAME, REGION 
    FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER
) CUST 
    ON CUST.SOURCE_SYSTEM = SO.SOURCE_SYSTEM 
   AND CUST.CUSTOMER = SO.CUSTOMER
LEFT JOIN (
    SELECT DISTINCT SOURCE_SYSTEM, COMPANY_CODE, COMPANY_NAME 
    FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT
) CP 
    ON CP.SOURCE_SYSTEM = SO.SOURCE_SYSTEM 
   AND CP.COMPANY_CODE = SO.COMPANY_CODE
LEFT JOIN (
    SELECT DISTINCT SOURCE_SYSTEM, PLANT, PLANT_NAME 
    FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT
) CP1 
    ON CP1.SOURCE_SYSTEM = SO.SOURCE_SYSTEM 
   AND CP1.PLANT = SO.PLANT
LEFT JOIN (SELECT SOURCE_SYSTEM, CUSTOMER, SALES_OFFICE, SALES_OFFICE_DESC, SALES_DIVISION 
           FROM (SELECT SOURCE_SYSTEM, CUSTOMER, SALES_OFFICE, SALES_OFFICE_DESC, SALES_DIVISION,
                        ROW_NUMBER() OVER (PARTITION BY SOURCE_SYSTEM, CUSTOMER 
                                           ORDER BY CASE WHEN SALES_OFFICE <> '9001' THEN 0 ELSE 1 END, SALES_OFFICE) AS RN
                 FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER
                 WHERE BLOCK_FOR_SALES = 'Non block' AND DELETION_FOR_SALES = 'Non delete')
           QUALIFY RN = 1) CUST1
    ON CUST1.SOURCE_SYSTEM = SO.SOURCE_SYSTEM 
    AND CUST1.CUSTOMER = SO.CUSTOMER
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, SALES_OFFICE, SALES_OFFICE_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER
           WHERE BLOCK_FOR_SALES = 'Non block' AND DELETION_FOR_SALES = 'Non delete') CUSTSO
    ON CUSTSO.SOURCE_SYSTEM = SO.SOURCE_SYSTEM 
    AND CUSTSO.SALES_OFFICE = SO.SALES_OFFICE   
LEFT JOIN (
    SELECT DISTINCT SOURCE_SYSTEM, DISTRIBUTION_CHANNEL, DISTRIBUTION_CHANNEL_DESC 
    FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_AREA
) SA 
    ON SA.SOURCE_SYSTEM = SO.SOURCE_SYSTEM 
   AND SA.DISTRIBUTION_CHANNEL = SO.DISTRIBUTION_CHANNEL
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, SALES_DIVISION, SALES_DIVISION_DESC 
           FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_AREA) SA1
    ON SA1.SOURCE_SYSTEM = CUST1.SOURCE_SYSTEM
    AND SA1.SALES_DIVISION = CUST1.SALES_DIVISION
LEFT JOIN (
    SELECT DISTINCT SOURCE_SYSTEM, REGION, REGION_DESCRIPTION
    FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_REGION
) DSR 
    ON DSR.SOURCE_SYSTEM = CUST.SOURCE_SYSTEM 
   AND DSR.REGION = CUST.REGION 
WHERE SO.SOURCE_SYSTEM = 'PE1'
	AND SO.PLANT NOT IN ('901A','905A','90VA','90VB','90VC','90WA','90XA','90ZA')
	AND TRY_TO_DATE(SO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD') BETWEEN '2025-11-01' AND CURRENT_DATE
	/*AND SO.SALES_ORDER_NUMBER IN ('1207539087','1207539088','1207539089','1207539104','1207539106')*/
);
