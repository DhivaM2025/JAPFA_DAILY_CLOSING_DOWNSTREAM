CREATE TEMPORARY TABLE TEMP_SALES_ORDER AS
SELECT * FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER;

CREATE TEMPORARY TABLE TEMP_SALES_ORDER_DELIVERY AS
SELECT * FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_DELIVERY;

CREATE TEMPORARY TABLE TEMP_SALES_ORDER_BILLING AS
SELECT * FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING;


(SELECT DISTINCT
	SO1.COMPANY_CODE || '-' || CP.COMPANY_NAME AS COMPANY,
	SO2.PLANT || '-' || CP1.PLANT_NAME AS PLANT,
	CASE
  		WHEN SO3.SALES_OFFICE IS NULL OR CUST1.SALES_OFFICE_DESC IS NULL THEN SO3.SALES_OFFICE
  		ELSE SO3.SALES_OFFICE || '-' || CUST1.SALES_OFFICE_DESC
  	END AS SALES_OFFICE,
  	CASE 
    WHEN SO3.SALES_OFFICE IS NOT NULL AND SO3.SALES_OFFICE <> '' AND CUST1.SALES_OFFICE_DESC IS NOT NULL AND CUST1.SALES_OFFICE_DESC <> '' 
        THEN LEFT(CUST1.SALES_OFFICE_DESC, 3)
    WHEN SO3.SALES_OFFICE IS NOT NULL AND SO3.SALES_OFFICE <> '' AND (CUST1.SALES_OFFICE_DESC IS NULL OR CUST1.SALES_OFFICE_DESC = '') 
        THEN SO3.SALES_OFFICE
    	ELSE NULL
  	END AS SALES_OFFICE_LOKASI,
	SO.CUSTOMER AS CUSTOMER_SO_CODE,
	CUST.CUSTOMER_NAME AS CUSTOMER_SO_NAME,
	SO4.DISTRIBUTION_CHANNEL || '-' || SA.DISTRIBUTION_CHANNEL_DESC AS DISTRIBUTION_CHANNEL,
	SO5.DIVISION || '-' || SO5.DIVISION_DESC AS SALES_DIVISION,
	CUST.REGION || '-' || DSR.REGION_DESC AS REGION,
  	CASE 
		WHEN DSR.REGION IN ('01', '02', '03', '04', '05', '28') THEN 'PULAU JAWA'
    	ELSE 'LUAR JAWA'
	END AS STATUS_REGION,
	X.*
FROM(
(SELECT 
	'Sales Order' AS CATEGORY, 
	SALES_ORDER_TYPE || '-' || SALES_ORDER_TYPE_DESC AS TYPE,
	CASE 
    	WHEN SALES_ORDER_STATUS IS NULL OR SALES_ORDER_STATUS_DESC IS NULL THEN SALES_ORDER_STATUS_DESC 
    	ELSE SALES_ORDER_STATUS || '-' || SALES_ORDER_STATUS_DESC 
	END AS SALES_ORDER_STATUS,
	SALES_ORDER_STATUS_REJECTION || '-' || SALES_ORDER_STATUS_REJECTION_DESC AS STATUS_REJECTION,
	SALES_ORDER_NUMBER,
	SALES_ORDER_EXTERNAL_DOCUMENT AS SALES_ORDER_REFERENCE,
	NULL AS DELIVERY_NUMBER, 
	NULL AS BILLING_NUMBER, 
	TRY_TO_DATE (SALES_ORDER_CREATED_DATE, 'YYYYMMDD') AS CREATED_DATE, 
	TRY_TO_DATE (SALES_ORDER_DATE, 'YYYYMMDD') AS DOC_DATE, 
	SUM(SALES_ORDER_NEGATIVE_FLAG * SALES_ORDER_QUANTITY_IN_KG) AS SO_QTY, 
	SUM (SALES_ORDER_NEGATIVE_FLAG * SALES_ORDER_NET_AMOUNT) AS SO_AMOUNT,
	0 AS DO_QTY, 
	0 AS BILL_QTY,
	0 AS BILL_AMOUNT,
	NULL AS BILLING_CLEAR_FLAG
FROM /*PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER*/ TEMP_SALES_ORDER
/*WHERE 
	TRY_TO_DATE(SALES_ORDER_CREATED_DATE, 'YYYYMMDD') BETWEEN '2025-09-01' AND CURRENT_DATE
	AND SOURCE_SYSTEM = 'PE1'*/
GROUP BY ALL)
UNION ALL
(SELECT 
	'Delivery Order' AS CATEGORY, 
	DELIVERY_TYPE || '-' || DELIVERY_TYPE_DESC AS TYPE,
	CASE 
    	WHEN SO.SALES_ORDER_STATUS_DELIVERY IS NULL OR SO.SALES_ORDER_STATUS_DELIVERY_DESC IS NULL THEN SO.SALES_ORDER_STATUS_DELIVERY_DESC 
    	ELSE SO.SALES_ORDER_STATUS_DELIVERY || '-' || SO.SALES_ORDER_STATUS_DELIVERY_DESC 
	END AS DELIVERY_STATUS,
	NULL AS SALES_ORDER_STATUS_REJECTION,
	REFERENCE_SALES_ORDER_NUMBER AS SALES_ORDER_NUMBER, 
	NULL AS SALES_ORDER_REFERENCE,
	DELIVERY_NUMBER AS DELIVERY_NUMBER, 
	NULL AS BILLING_NUMBER, 
	TRY_TO_DATE (DELIVERY_CREATED_DATE, 'YYYYMMDD') AS CREATED_DATE, 
	TRY_TO_DATE (DELIVERY_ACTUAL_DATE, 'YYYYMMDD') AS DOC_DATE,
	0 AS SO_QTY, 
	0 AS SO_AMOUNT,
	SUM(DELIVERY_QUANTITY_IN_KG) AS DO_QTY,
	0 AS BILL_QTY,
	0 AS BILL_AMOUNT,
	NULL AS BILLING_CLEAR_FLAG
FROM /*PROD_DB.DSTR_BI_COMMUNITY.F_SALES_DELIVERY*/ TEMP_SALES_ORDER_DELIVERY SD
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, SALES_ORDER_NUMBER, SALES_ORDER_CREATED_DATE, SALES_ORDER_STATUS_DELIVERY, SALES_ORDER_STATUS_DELIVERY_DESC FROM /*PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER*/ TEMP_SALES_ORDER) AS SO
	ON SD.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
	AND SD.REFERENCE_SALES_ORDER_NUMBER  = SO.SALES_ORDER_NUMBER
/*WHERE 
	TRY_TO_DATE(SO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD') BETWEEN '2025-09-01' AND CURRENT_DATE
	AND SO.SOURCE_SYSTEM = 'PE1'*/
GROUP BY ALL)
UNION ALL
(SELECT 'Billing' AS CATEGORY, 
	BILLING_TYPE || '-' || BILLING_TYPE_DESC AS TYPE,
	CASE 
    	WHEN SO.SALES_ORDER_STATUS_BILLING IS NULL OR SO.SALES_ORDER_STATUS_BILLING_DESC IS NULL THEN SO.SALES_ORDER_STATUS_BILLING_DESC 
    	ELSE SO.SALES_ORDER_STATUS_BILLING || '-' || SO.SALES_ORDER_STATUS_BILLING_DESC 
	END AS BILLING_STATUS,
	NULL AS STATUS_REJECTION,
	REFERENCE_SALES_ORDER_NUMBER AS SALES_ORDER_NUMBER, 
	NULL AS SALES_ORDER_REFERENCE,
	NULL AS DELIVERY_NUMBER, 
	SB.BILLING_NUMBER AS BILLING_NUMBER, 
	TRY_TO_DATE (BILLING_CREATED_DATE, 'YYYYMMDD') AS CREATED_DATE,
	TRY_TO_DATE (BILLING_DATE, 'YYYYMMDD') AS DOC_DATE,
	0 AS SO_QTY, 
	0 AS SO_AMOUNT,
	0 AS DO_QTY,
	SUM (BILLING_NEGATIVE_FLAG * BILLING_QUANTITY_IN_KG) AS BILL_QTY,
	SUM (BILLING_NEGATIVE_FLAG * BILLING_NET_AMOUNT) AS BILL_AMOUNT,
	CASE 
        WHEN SBC.BILLING_CLEARING_DOC IS NOT NULL THEN 'X'
        ELSE NULL
    END AS BILLING_CLEAR_FLAG
FROM /*PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING*/ TEMP_SALES_ORDER_BILLING AS SB
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, SALES_ORDER_NUMBER, SALES_ORDER_CREATED_DATE, SALES_ORDER_STATUS_BILLING, SALES_ORDER_STATUS_BILLING_DESC FROM /*PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER*/ TEMP_SALES_ORDER) AS SO
	ON SO.SOURCE_SYSTEM = SB.SOURCE_SYSTEM
	AND SB.REFERENCE_SALES_ORDER_NUMBER = SO.SALES_ORDER_NUMBER
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, BILLING_NUMBER, BILLING_CLEARING_DOC FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_CLEARING) AS SBC
	ON SB.SOURCE_SYSTEM = SBC.SOURCE_SYSTEM
	AND SB.BILLING_NUMBER = SBC.BILLING_NUMBER
WHERE 
	BILLING_TYPE <> 'ZB50'
GROUP BY ALL)) X
LEFT JOIN
	(SELECT DISTINCT SOURCE_SYSTEM, SALES_ORDER_NUMBER, CUSTOMER, SALES_ORDER_CREATED_DATE FROM /*PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER*/ TEMP_SALES_ORDER) AS SO 
		ON X.SALES_ORDER_NUMBER = SO.SALES_ORDER_NUMBER
LEFT JOIN
	(SELECT DISTINCT SOURCE_SYSTEM, SALES_ORDER_NUMBER, COMPANY_CODE FROM /*PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER*/ TEMP_SALES_ORDER) AS SO1 
		ON X.SALES_ORDER_NUMBER = SO1.SALES_ORDER_NUMBER
LEFT JOIN
	(SELECT DISTINCT SOURCE_SYSTEM, SALES_ORDER_NUMBER, PLANT FROM /*PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER*/ TEMP_SALES_ORDER) AS SO2
		ON X.SALES_ORDER_NUMBER = SO2.SALES_ORDER_NUMBER	
LEFT JOIN
	(SELECT DISTINCT SOURCE_SYSTEM, SALES_ORDER_NUMBER, CUSTOMER, SALES_OFFICE FROM /*PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER*/ TEMP_SALES_ORDER) AS SO3
		ON X.SALES_ORDER_NUMBER = SO3.SALES_ORDER_NUMBER
LEFT JOIN
	(SELECT DISTINCT SOURCE_SYSTEM, SALES_ORDER_NUMBER, CUSTOMER, DISTRIBUTION_CHANNEL FROM /*PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER*/ TEMP_SALES_ORDER) AS SO4
		ON X.SALES_ORDER_NUMBER = SO4.SALES_ORDER_NUMBER
LEFT JOIN
	(SELECT DISTINCT SOURCE_SYSTEM, SALES_ORDER_NUMBER, DIVISION, DIVISION_DESC FROM /*PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER*/ TEMP_SALES_ORDER) AS SO5
		ON X.SALES_ORDER_NUMBER = SO5.SALES_ORDER_NUMBER
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, CUSTOMER, CUSTOMER_NAME, REGION FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER) CUST
	    ON SO.SOURCE_SYSTEM = CUST.SOURCE_SYSTEM
	    AND SO.CUSTOMER = CUST.CUSTOMER
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, COMPANY_CODE, COMPANY_NAME FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT) AS CP
    	ON SO1.SOURCE_SYSTEM = CP.SOURCE_SYSTEM
    	AND SO1.COMPANY_CODE = CP.COMPANY_CODE
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, PLANT, PLANT_NAME FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT) AS CP1
    	ON SO2.SOURCE_SYSTEM = CP1.SOURCE_SYSTEM
    	AND SO2.PLANT = CP1.PLANT
LEFT JOIN
	(SELECT SOURCE_SYSTEM, CUSTOMER, SALES_OFFICE, SALES_OFFICE_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER) CUST1
	    ON SO3.SOURCE_SYSTEM = CUST1.SOURCE_SYSTEM
	    AND SO3.CUSTOMER = CUST1.CUSTOMER 
	    AND SO3.SALES_OFFICE = CUST1.SALES_OFFICE
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, CUSTOMER, DISTRIBUTION_CHANNEL FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER) CUST3
    	ON SO4.SOURCE_SYSTEM = CUST3.SOURCE_SYSTEM
    	AND SO4.CUSTOMER = CUST3.CUSTOMER
    	AND SO4.DISTRIBUTION_CHANNEL = CUST3.DISTRIBUTION_CHANNEL
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, DISTRIBUTION_CHANNEL, DISTRIBUTION_CHANNEL_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_AREA) SA
    	ON SO4.SOURCE_SYSTEM = SA.SOURCE_SYSTEM 
    	AND SO4.DISTRIBUTION_CHANNEL = SA.DISTRIBUTION_CHANNEL
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, REGION, REGION_DESC, COUNTRY FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_REGION) AS DSR
		ON CUST.SOURCE_SYSTEM = DSR.SOURCE_SYSTEM
		AND CUST.REGION = DSR.REGION
    	AND DSR.COUNTRY = 'ID'
WHERE
	TRY_TO_DATE(SO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD') BETWEEN '2025-09-01' AND CURRENT_DATE
	AND SO.SOURCE_SYSTEM = 'PE1'
);
