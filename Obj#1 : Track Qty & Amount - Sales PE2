CREATE TEMPORARY TABLE TEMP_SALES_ORDER AS
SELECT * FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER;

CREATE TEMPORARY TABLE TEMP_SALES_ORDER_DELIVERY AS
SELECT * FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_DELIVERY;

CREATE TEMPORARY TABLE TEMP_SALES_ORDER_BILLING AS
SELECT * FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING;

(SELECT DISTINCT
    SO.COMPANY_CODE || '-' || CP.COMPANY_NAME AS COMPANY,
    SO.PLANT || '-' || CP1.PLANT_NAME AS PLANT,
    CASE
        WHEN SO.SALES_OFFICE IS NULL OR CUST1.SALES_OFFICE_DESC IS NULL THEN SO.SALES_OFFICE
        ELSE SO.SALES_OFFICE || '-' || CUST1.SALES_OFFICE_DESC
    END AS SALES_OFFICE,
    CASE 
        WHEN SO.SALES_OFFICE IS NOT NULL AND SO.SALES_OFFICE <> '' 
             AND CUST1.SALES_OFFICE_DESC IS NOT NULL AND CUST1.SALES_OFFICE_DESC <> '' 
            THEN LEFT(CUST1.SALES_OFFICE_DESC, 3)
        WHEN SO.SALES_OFFICE IS NOT NULL AND SO.SALES_OFFICE <> '' 
             AND (CUST1.SALES_OFFICE_DESC IS NULL OR CUST1.SALES_OFFICE_DESC = '') 
            THEN SO.SALES_OFFICE
        ELSE NULL
    END AS SALES_OFFICE_LOKASI,
    SO.CUSTOMER AS CUSTOMER_SO_CODE,
    CUST.CUSTOMER_NAME AS CUSTOMER_SO_NAME,
    SO.DISTRIBUTION_CHANNEL || '-' || SA.DISTRIBUTION_CHANNEL_DESC AS DISTRIBUTION_CHANNEL,
    SO.DIVISION || '-' || SO.DIVISION_DESC AS SALES_DIVISION,
    CUST.REGION || '-' || DSR.REGION_DESC AS REGION,
    CASE 
        WHEN DSR.REGION IN ('01','02','03','04','05','28') THEN 'PULAU JAWA'
        ELSE 'LUAR JAWA'
    END AS STATUS_REGION,
    CASE 
        WHEN SB.TERM_OF_PAYMENT_DESC IS NULL OR SB.TERM_OF_PAYMENT = '' THEN SB.TERM_OF_PAYMENT
        ELSE SB.TERM_OF_PAYMENT || '-' || SB.TERM_OF_PAYMENT_DESC
    END AS TOP,
    X.*
FROM (
    (SELECT 
        'Sales Order' AS CATEGORY,
        CASE 
            WHEN SO.SALES_ORDER_TYPE = 'ZKS9' THEN 'Interco FS'
            WHEN SO.SALES_ORDER_TYPE = 'ZKS2' AND SO.CUSTOMER = 'JID90HA000' THEN 'Interco MT'
            ELSE 'Non Interco'
        END AS TYPE,
        SO.SALES_ORDER_TYPE || '-' || SO.SALES_ORDER_TYPE_DESC AS DOCUMENT_TYPE,
        CASE 
            WHEN SO.SALES_ORDER_STATUS IS NULL OR SO.SALES_ORDER_STATUS_DESC IS NULL THEN SO.SALES_ORDER_STATUS_DESC
            ELSE SO.SALES_ORDER_STATUS || '-' || SO.SALES_ORDER_STATUS_DESC
        END AS SALES_ORDER_STATUS,
        SO.SALES_ORDER_STATUS_REJECTION || '-' || SO.SALES_ORDER_STATUS_REJECTION_DESC AS STATUS_REJECTION,
        SO.SALES_ORDER_NUMBER,
        SO.SALES_ORDER_EXTERNAL_DOCUMENT AS SALES_ORDER_REFERENCE,
        NULL AS DELIVERY_NUMBER, 
        NULL AS BILLING_NUMBER, 
        TRY_TO_DATE(SO.SALES_ORDER_CREATED_DATE,'YYYYMMDD') AS SO_CREATED_DATE,
        TRY_TO_DATE(SO.SALES_ORDER_CREATED_DATE,'YYYYMMDD') AS CREATED_DATE,
        TRY_TO_DATE(SO.SALES_ORDER_DATE,'YYYYMMDD') AS DOC_DATE,
        NULL AS CURRENCY,
        SUM(SO.SALES_ORDER_NEGATIVE_FLAG * SO.SALES_ORDER_QUANTITY_IN_KG) AS SO_QTY_KG,
        SUM(SO.SALES_ORDER_NEGATIVE_FLAG * SO.SALES_ORDER_NET_AMOUNT) AS SO_AMOUNT,
        0 AS DO_QTY_KG,
        0 AS BILL_QTY_KG,
        0 AS BILL_AMOUNT,
        CASE 
            WHEN EXISTS (
                SELECT 1
                FROM TEMP_SALES_ORDER_BILLING SB
                JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_CLEARING SBC
                  ON SB.SOURCE_SYSTEM = SBC.SOURCE_SYSTEM
                 AND SB.BILLING_NUMBER = SBC.BILLING_NUMBER
                WHERE SB.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
                  AND SB.REFERENCE_SALES_ORDER_NUMBER = SO.SALES_ORDER_NUMBER
                  AND SBC.BILLING_CLEARING_DOC IS NOT NULL
                  AND SBC.BILLING_CLEARING_DOC <> ''
            ) THEN 'X' ELSE NULL END AS BILLING_CLEAR_FLAG
     FROM TEMP_SALES_ORDER SO
     GROUP BY 
        SO.SALES_ORDER_TYPE, SO.SALES_ORDER_TYPE_DESC,
        SO.SALES_ORDER_STATUS, SO.SALES_ORDER_STATUS_DESC,
        SO.SALES_ORDER_STATUS_REJECTION, SO.SALES_ORDER_STATUS_REJECTION_DESC,
        SO.SALES_ORDER_NUMBER, SO.SALES_ORDER_EXTERNAL_DOCUMENT,
        SO.SALES_ORDER_CREATED_DATE, SO.SALES_ORDER_DATE,
        SO.CUSTOMER, SO.SOURCE_SYSTEM)
    UNION ALL
    (SELECT 
        'Delivery Order' AS CATEGORY,
        CASE 
            WHEN SO.SALES_ORDER_TYPE = 'ZKS9' THEN 'Interco FS'
            WHEN SO.SALES_ORDER_TYPE = 'ZKS2' AND SO.CUSTOMER = 'JID90HA000' THEN 'Interco MT'
            ELSE 'Non Interco'
        END AS TYPE,
        SD.DELIVERY_TYPE || '-' || SD.DELIVERY_TYPE_DESC AS DOCUMENT_TYPE,
        CASE 
            WHEN SO.SALES_ORDER_STATUS_DELIVERY IS NULL OR SO.SALES_ORDER_STATUS_DELIVERY_DESC IS NULL 
            THEN SO.SALES_ORDER_STATUS_DELIVERY_DESC
            ELSE SO.SALES_ORDER_STATUS_DELIVERY || '-' || SO.SALES_ORDER_STATUS_DELIVERY_DESC
        END AS DELIVERY_STATUS,
        NULL AS SALES_ORDER_STATUS_REJECTION,
        SD.REFERENCE_SALES_ORDER_NUMBER AS SALES_ORDER_NUMBER, 
        SO.SALES_ORDER_EXTERNAL_DOCUMENT AS SALES_ORDER_REFERENCE,
        SD.DELIVERY_NUMBER, 
        NULL AS BILLING_NUMBER, 
        TRY_TO_DATE(SO.SALES_ORDER_CREATED_DATE,'YYYYMMDD') AS SO_CREATED_DATE,
        TRY_TO_DATE(SD.DELIVERY_CREATED_DATE,'YYYYMMDD') AS CREATED_DATE,
        TRY_TO_DATE(SD.DELIVERY_ACTUAL_DATE,'YYYYMMDD') AS DOC_DATE,
        NULL AS CURRENCY,
        0 AS SO_QTY_KG,
        0 AS SO_AMOUNT,
        ROUND(SUM(SD.DELIVERY_QUANTITY_IN_KG),2) AS DO_QTY_KG,
        0 AS BILL_QTY_KG,
        0 AS BILL_AMOUNT,
        CASE 
            WHEN EXISTS (
                SELECT 1
                FROM TEMP_SALES_ORDER_BILLING SB
                JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_CLEARING SBC
                  ON SB.SOURCE_SYSTEM = SBC.SOURCE_SYSTEM
                 AND SB.BILLING_NUMBER = SBC.BILLING_NUMBER
                WHERE SB.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
                  AND SB.REFERENCE_SALES_ORDER_NUMBER = SO.SALES_ORDER_NUMBER
                  AND SBC.BILLING_CLEARING_DOC IS NOT NULL
                  AND SBC.BILLING_CLEARING_DOC <> ''
            ) THEN 'X' ELSE NULL END AS BILLING_CLEAR_FLAG
     FROM TEMP_SALES_ORDER_DELIVERY SD
     LEFT JOIN (
        SELECT DISTINCT SOURCE_SYSTEM, SALES_ORDER_NUMBER, CUSTOMER, SALES_ORDER_EXTERNAL_DOCUMENT, 
                        SALES_ORDER_CREATED_DATE, SALES_ORDER_STATUS_DELIVERY, 
                        SALES_ORDER_STATUS_DELIVERY_DESC, SALES_ORDER_TYPE
        FROM TEMP_SALES_ORDER
     ) SO
        ON SD.SOURCE_SYSTEM = SO.SOURCE_SYSTEM 
       AND SD.REFERENCE_SALES_ORDER_NUMBER = SO.SALES_ORDER_NUMBER
     GROUP BY 
        SD.DELIVERY_NUMBER, SD.REFERENCE_SALES_ORDER_NUMBER,
        SO.SALES_ORDER_EXTERNAL_DOCUMENT, 
        SD.DELIVERY_TYPE, SD.DELIVERY_TYPE_DESC,
        SO.SOURCE_SYSTEM, SO.SALES_ORDER_NUMBER, 
        SO.SALES_ORDER_STATUS_DELIVERY, SO.SALES_ORDER_STATUS_DELIVERY_DESC,
        SO.SALES_ORDER_TYPE, SO.CUSTOMER,
        SO.SALES_ORDER_CREATED_DATE, SD.DELIVERY_CREATED_DATE, SD.DELIVERY_ACTUAL_DATE)
    UNION ALL
    (SELECT 
        'Billing' AS CATEGORY,
        CASE 
            WHEN SO.SALES_ORDER_TYPE = 'ZKS9' THEN 'Interco FS'
            WHEN SO.SALES_ORDER_TYPE = 'ZKS2' AND SO.CUSTOMER = 'JID90HA000' THEN 'Interco MT'
            ELSE 'Non Interco'
        END AS TYPE,
        SB.BILLING_TYPE || '-' || SB.BILLING_TYPE_DESC AS DOCUMENT_TYPE,
        CASE 
            WHEN SO.SALES_ORDER_STATUS_BILLING IS NULL OR SO.SALES_ORDER_STATUS_BILLING_DESC IS NULL 
            THEN SO.SALES_ORDER_STATUS_BILLING_DESC
            ELSE SO.SALES_ORDER_STATUS_BILLING || '-' || SO.SALES_ORDER_STATUS_BILLING_DESC
        END AS BILLING_STATUS,
        NULL AS STATUS_REJECTION,
        SB.REFERENCE_SALES_ORDER_NUMBER AS SALES_ORDER_NUMBER, 
        SO.SALES_ORDER_EXTERNAL_DOCUMENT AS SALES_ORDER_REFERENCE,
        NULL AS DELIVERY_NUMBER, 
        SB.BILLING_NUMBER, 
        TRY_TO_DATE(SO.SALES_ORDER_CREATED_DATE,'YYYYMMDD') AS SO_CREATED_DATE,
        TRY_TO_DATE(SB.BILLING_CREATED_DATE,'YYYYMMDD') AS CREATED_DATE,
        TRY_TO_DATE(SB.BILLING_DATE,'YYYYMMDD') AS DOC_DATE,
        SB.BILLING_HEADER_CURRENCY_CODE AS CURRENCY,
        0 AS SO_QTY_KG,
        0 AS SO_AMOUNT,
        0 AS DO_QTY_KG,
        ROUND(SUM(SB.BILLING_NEGATIVE_FLAG * SB.BILLING_QUANTITY_IN_KG),2) AS BILL_QTY_KG,
        ROUND(SUM(SB.BILLING_NEGATIVE_FLAG * SB.BILLING_NET_AMOUNT),2) AS BILL_AMOUNT,
        CASE 
            WHEN EXISTS (
                SELECT 1
                FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_CLEARING SBC
                WHERE SBC.SOURCE_SYSTEM = SB.SOURCE_SYSTEM
                  AND SBC.BILLING_NUMBER = SB.BILLING_NUMBER
                  AND SBC.BILLING_CLEARING_DOC IS NOT NULL
                  AND SBC.BILLING_CLEARING_DOC <> ''
            ) THEN 'X'
            ELSE NULL
        END AS BILLING_CLEAR_FLAG
     FROM TEMP_SALES_ORDER_BILLING SB
     LEFT JOIN (
        SELECT DISTINCT SOURCE_SYSTEM, SALES_ORDER_NUMBER, CUSTOMER, SALES_ORDER_EXTERNAL_DOCUMENT, 
                        SALES_ORDER_CREATED_DATE, SALES_ORDER_STATUS_BILLING, 
                        SALES_ORDER_STATUS_BILLING_DESC, SALES_ORDER_TYPE
        FROM TEMP_SALES_ORDER
     ) SO
        ON SO.SOURCE_SYSTEM = SB.SOURCE_SYSTEM 
       AND SB.REFERENCE_SALES_ORDER_NUMBER = SO.SALES_ORDER_NUMBER
     WHERE SB.BILLING_TYPE <> 'ZB50'
     GROUP BY 
        SB.BILLING_TYPE, SB.BILLING_TYPE_DESC, SB.SOURCE_SYSTEM,
        SO.SALES_ORDER_STATUS_BILLING, SO.SALES_ORDER_STATUS_BILLING_DESC,
        SO.SALES_ORDER_TYPE, SO.CUSTOMER,
        SB.REFERENCE_SALES_ORDER_NUMBER, SO.SALES_ORDER_EXTERNAL_DOCUMENT,
        SB.BILLING_NUMBER,
        SO.SALES_ORDER_CREATED_DATE, SB.BILLING_CREATED_DATE, SB.BILLING_DATE,
        SB.BILLING_HEADER_CURRENCY_CODE
)) X
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, SALES_ORDER_NUMBER, COMPANY_CODE, PLANT, SALES_OFFICE, DIVISION, DIVISION_DESC, CUSTOMER, DISTRIBUTION_CHANNEL, SALES_ORDER_CREATED_DATE FROM TEMP_SALES_ORDER) SO 
    ON X.SALES_ORDER_NUMBER = SO.SALES_ORDER_NUMBER
LEFT JOIN (
    SELECT DISTINCT SOURCE_SYSTEM, BILLING_NUMBER, TERM_OF_PAYMENT, TERM_OF_PAYMENT_DESC 
    FROM TEMP_SALES_ORDER_BILLING
) SB 
    ON X.BILLING_NUMBER = SB.BILLING_NUMBER
LEFT JOIN (
    SELECT DISTINCT SOURCE_SYSTEM, CUSTOMER, CUSTOMER_NAME, REGION 
    FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER
) CUST 
    ON SO.SOURCE_SYSTEM = CUST.SOURCE_SYSTEM 
   AND SO.CUSTOMER = CUST.CUSTOMER
LEFT JOIN (
    SELECT DISTINCT SOURCE_SYSTEM, COMPANY_CODE, COMPANY_NAME 
    FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT
) CP 
    ON SO.SOURCE_SYSTEM = CP.SOURCE_SYSTEM 
   AND SO.COMPANY_CODE = CP.COMPANY_CODE
LEFT JOIN (
    SELECT DISTINCT SOURCE_SYSTEM, PLANT, PLANT_NAME 
    FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT
) CP1 
    ON SO.SOURCE_SYSTEM = CP1.SOURCE_SYSTEM 
   AND SO.PLANT = CP1.PLANT
LEFT JOIN (
    SELECT SOURCE_SYSTEM, CUSTOMER, SALES_OFFICE, SALES_OFFICE_DESC 
    FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER
) CUST1 
    ON SO.SOURCE_SYSTEM = CUST1.SOURCE_SYSTEM 
   AND SO.CUSTOMER = CUST1.CUSTOMER 
   AND SO.SALES_OFFICE = CUST1.SALES_OFFICE
LEFT JOIN (
    SELECT DISTINCT SOURCE_SYSTEM, DISTRIBUTION_CHANNEL, DISTRIBUTION_CHANNEL_DESC 
    FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_AREA
) SA 
    ON SO.SOURCE_SYSTEM = SA.SOURCE_SYSTEM 
   AND SO.DISTRIBUTION_CHANNEL = SA.DISTRIBUTION_CHANNEL
LEFT JOIN (
    SELECT DISTINCT SOURCE_SYSTEM, REGION, REGION_DESC, COUNTRY 
    FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_REGION
) DSR 
    ON CUST.SOURCE_SYSTEM = DSR.SOURCE_SYSTEM 
   AND CUST.REGION = DSR.REGION 
   AND DSR.COUNTRY = 'ID'
WHERE 
	TRY_TO_DATE(SO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD') BETWEEN '2025-05-01' AND '2025-06-30'
	AND SO.SOURCE_SYSTEM = 'PE2');
