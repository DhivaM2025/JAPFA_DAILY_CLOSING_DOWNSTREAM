-- DASHBOARD #1 : SGF SALES BACKDATE ONLY

-- STEP 1 : RUN ALL TEMPORARY TABLE --
CREATE TEMPORARY TABLE temp_scm_mutasi_pe1 AS
SELECT * FROM PROD_DB.DSTR_BI_COMMUNITY.F_SCM_MUTASI_MATERIAL; 

CREATE TEMPORARY TABLE temp_sales_flow AS
SELECT * FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_FLOW_ORDER_DOCUMENT_FLOW;

SELECT DISTINCT
  -- BASIC DATA
  SSO.COMPANY_CODE || '-' || CP.COMPANY_NAME AS COMPANY,
  SSO.PLANT || '-' || CP.PLANT_NAME AS PLANT,
  CASE
  	WHEN CUST1.SALES_OFFICE IS NULL OR CUST1.SALES_OFFICE_DESC IS NULL THEN CUST1.SALES_OFFICE
  	ELSE CUST1.SALES_OFFICE || '-' || CUST1.SALES_OFFICE_DESC
  END AS SALES_OFFICE,
  CASE 
    WHEN CUST1.SALES_OFFICE IS NOT NULL AND CUST1.SALES_OFFICE <> '' 
         AND CUST1.SALES_OFFICE_DESC IS NOT NULL AND CUST1.SALES_OFFICE_DESC <> '' 
        THEN LEFT(CUST1.SALES_OFFICE_DESC, 3)
    WHEN CUST1.SALES_OFFICE IS NOT NULL AND CUST1.SALES_OFFICE <> '' 
         AND (CUST1.SALES_OFFICE_DESC IS NULL OR CUST1.SALES_OFFICE_DESC = '') 
        THEN CUST1.SALES_OFFICE
    ELSE NULL
  END AS SALES_OFFICE_LOKASI,
  SSO.CUSTOMER AS CUSTOMER_SO_CODE,
  CUST.CUSTOMER_NAME AS CUSTOMER_SO_NAME,
  FLOW.CUSTOMER_SHIP_TO AS CUSTOMER_SHIPTO_CODE,
  CUSTSH.CUSTOMER_NAME AS CUSTOMER_SHIPTO_NAME,
  CUST3.DISTRIBUTION_CHANNEL || '-' || SA.DISTRIBUTION_CHANNEL_DESC AS DISTRIBUTION_CHANNEL,
  CUST5.SALES_DIVISION || '-' || SA2.SALES_DIVISION_DESC AS DIVISION,
  CUST.REGION || '-' || DSR.REGION_DESC AS REGION,
  CASE 
	WHEN DSR.REGION IN ('01', '02', '03', '04', '05', '28') THEN 'PULAU JAWA'
    ELSE 'LUAR JAWA'
  END AS STATUS_REGION,
  CASE 
    WHEN CUST2.TERM_OF_PAYMENT_DESC IS NULL OR CUST2.TERM_OF_PAYMENT = '' THEN CUST2.TERM_OF_PAYMENT
    ELSE CUST2.TERM_OF_PAYMENT || '-' || CUST2.TERM_OF_PAYMENT_DESC
  END AS TOP,
  CPOD.POD_FLAG,
  -- TYPE
  FLOW.SALES_ORDER_TYPE || '-' || FLOW.SALES_ORDER_TYPE_DESC AS SALES_ORDER_TYPE,
  SD.DELIVERY_TYPE || '-' || SD.DELIVERY_TYPE_DESC AS DELIVERY_TYPE,
  SB.BILLING_TYPE || '-' || SB.BILLING_TYPE_DESC AS BILLING_TYPE, 
  TF.TTF_DOC_TYPE AS TFTG_TYPE,
  -- STATUS
  CASE 
    WHEN SSO.SALES_ORDER_STATUS IS NULL OR SSO.SALES_ORDER_STATUS_DESC IS NULL THEN SSO.SALES_ORDER_STATUS_DESC 
    ELSE SSO.SALES_ORDER_STATUS || '-' || SSO.SALES_ORDER_STATUS_DESC 
  END AS SALES_ORDER_STATUS,
  SSO.SALES_ORDER_STATUS_REJECTION || '-' || SSO.SALES_ORDER_STATUS_REJECTION_DESC AS SALES_ORDER_STATUS_REJECTION,
  CASE 
  	WHEN SD.DELIVERY_STATUS = 'Not yet processed' THEN 'A-Not yet processed'
    WHEN SD.DELIVERY_STATUS = 'Partially processed' THEN 'B-Partially processed'
    WHEN SD.DELIVERY_STATUS = 'Completely processed' THEN 'C-Completely processed'
    ELSE SD.DELIVERY_STATUS
  END AS DELIVERY_STATUS,
  CASE 
  	WHEN SD.DELIVERY_POD_STATUS = 'Not yet processed' THEN 'A-Not yet processed'
    WHEN SD.DELIVERY_POD_STATUS = 'Partially processed' THEN 'B-Partially processed'
    WHEN SD.DELIVERY_POD_STATUS = 'Completely processed' THEN 'C-Completely processed'
    ELSE SD.DELIVERY_POD_STATUS
  END AS POD_STATUS,
  CASE 
    WHEN SB.POSTING_STATUS IS NULL OR SB.POSTING_STATUS_DESCRIPTION IS NULL THEN SB.POSTING_STATUS_DESCRIPTION 
    ELSE SB.POSTING_STATUS || '-' || SB.POSTING_STATUS_DESCRIPTION 
  END AS BILLING_STATUS,
  	CASE 
        WHEN SSO.SALES_ORDER_TYPE = 'ZB20' THEN 'Interco MT'
        WHEN SSO.SALES_ORDER_TYPE = 'ZB01' AND SSO.CUSTOMER = '2000174657' THEN 'Interco FS'
        ELSE 'Non Interco'
    END AS CATEGORY,
    CASE 
        WHEN (SD.DELIVERY_TYPE = 'ZB04' AND SSO.PLANT || CUST5.SALES_DIVISION IN (
            '90EI01','90EF02','90AF01','90BB03','90EB02','90AD01','90ED01',
            '90EH01','90EO02','90AL02','90AB01','90EC01','90BB02','90AD02',
            '90AB02','90AF02','90BB01','90EE02','90EC02','90ED02','90EG01',
            '90EL01','90EK01','90EI02','90AL01'
        ))
        OR (SD.DELIVERY_TYPE = 'ZB05' AND SSO.PLANT || CUST5.SALES_DIVISION IN (
            '90AB02','90EO02','90ED01','90AF01','90EB02','90EF02','90EI01',
            '90AB01','90AD02','90AD01','90BB01','90EC02','90EI02','90BB02',
            '90AF02','90AL01','90EE02','90AL02','90ED02'
        ))
        THEN 'Pengiriman Gudang Third Party'
        ELSE 'Pengiriman Internal Gudang Third Party'
    END AS PENGIRIMAN_CATEGORY,
  -- DOC NUMBER
  SSO.CREATED_BY,
  FLOW.SALES_ORDER_NUMBER AS SO_NUMBER,
  FLOW.DELIVERY_NUMBER AS DO_NUMBER,
  FLOW.GI_MATERIAL_DOCUMENT AS GI_NUMBER,
  FLOW.BILLING_NUMBER AS BILL_NUMBER,
  TF.TTF_NUMBER AS TFTG_NUMBER,
  SBC.BILLING_CLEARING_DOC AS BILL_CLEARING_NUMBER,
  -- DATE TRANSACTION
  TRY_TO_DATE(SSO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD') AS SO_CREATED_DATE,
  TRY_TO_DATE(SSO.SALES_ORDER_DATE, 'YYYYMMDD') AS SO_DATE,
  TRY_TO_DATE(SD.DELIVERY_CREATED_DATE, 'YYYYMMDD') AS DO_CREATED_DATE,
  TRY_TO_DATE(SD.DELIVERY_ACTUAL_DATE, 'YYYYMMDD') AS DO_ACTUAL_DATE,
  TRY_TO_DATE(SCM.ENTRY_DATE, 'YYYYMMDD') AS GI_ENTRY_DATE,
  TRY_TO_DATE (SCM.POSTING_DATE, 'YYYYMMDD') AS GI_POSTING_DATE,
  TRY_TO_DATE(SD.DELIVERY_POSTING_DATE, 'YYYYMMDD') AS POD_DATE,
  TRY_TO_DATE(PD.POD_DATE, 'YYYYMMDD') AS TVPOD_DATE,
  TRY_TO_DATE(SB.BILLING_CREATED_DATE, 'YYYYMMDD') AS BILLING_CREATED_DATE,
  TRY_TO_DATE(SB.BILLING_DATE, 'YYYYMMDD') AS BILLING_DATE,
  TRY_TO_DATE(TF.TTF_CREATED_DATE, 'YYYYMMDD') AS TFTG_CREATED_DATE,
  TRY_TO_DATE(TF.TTF_DOC_DATE, 'YYYYMMDD') AS TFTG_DATE,
  TRY_TO_DATE(SBC.BILLING_CLEAR_CREATED_DATE, 'YYYYMMDD') AS BILLING_CLEAR_CREATED_DATE,
  TRY_TO_DATE(SBC.BILLING_CLEAR_DATE, 'YYYYMMDD') AS BILLING_CLEAR_DATE,
	-- BACKDATE (Y/N)
	CASE 
	    WHEN TRY_TO_DATE(SSO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD') IS NULL AND TRY_TO_DATE(SSO.SALES_ORDER_DATE, 'YYYYMMDD') IS NULL THEN 'N/A'
	    WHEN TRY_TO_DATE(SSO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(SSO.SALES_ORDER_DATE, 'YYYYMMDD') IS NULL THEN 'Real-time entry'
	    WHEN TRY_TO_DATE(SSO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD') = TRY_TO_DATE(SSO.SALES_ORDER_DATE, 'YYYYMMDD') THEN 'Real-time entry'
	    WHEN TRY_TO_DATE(SSO.SALES_ORDER_DATE, 'YYYYMMDD') > TRY_TO_DATE(SSO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD') THEN 'Forward-dated entry'
	    WHEN TRY_TO_DATE(SSO.SALES_ORDER_DATE, 'YYYYMMDD') < TRY_TO_DATE(SSO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD') THEN 'Backdated entry'
	    ELSE 'Backdated entry'
	END AS SO_BACKDATE,
	CASE  
	    WHEN TRY_TO_DATE(SD.DELIVERY_CREATED_DATE, 'YYYYMMDD') IS NULL AND TRY_TO_DATE(SD.DELIVERY_ACTUAL_DATE, 'YYYYMMDD') IS NULL THEN 'N/A'
	    WHEN TRY_TO_DATE(SD.DELIVERY_CREATED_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(SD.DELIVERY_ACTUAL_DATE, 'YYYYMMDD') IS NULL THEN 'Real-time entry'
	    WHEN TRY_TO_DATE(SD.DELIVERY_CREATED_DATE, 'YYYYMMDD') = TRY_TO_DATE(SD.DELIVERY_ACTUAL_DATE, 'YYYYMMDD') THEN 'Real-time entry'
	    WHEN TRY_TO_DATE(SD.DELIVERY_ACTUAL_DATE, 'YYYYMMDD') > TRY_TO_DATE(SD.DELIVERY_CREATED_DATE, 'YYYYMMDD') THEN 'Forward-dated entry'
	    WHEN TRY_TO_DATE(SD.DELIVERY_ACTUAL_DATE, 'YYYYMMDD') < TRY_TO_DATE(SD.DELIVERY_CREATED_DATE, 'YYYYMMDD') THEN 'Backdated entry'
	    ELSE 'Backdated entry'
	END AS DO_BACKDATE,
	CASE 
	    WHEN TRY_TO_DATE(SCM.ENTRY_DATE , 'YYYYMMDD') IS NULL AND TRY_TO_DATE(SCM.POSTING_DATE, 'YYYYMMDD') IS NULL THEN 'N/A'
	    WHEN TRY_TO_DATE(SCM.ENTRY_DATE , 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(scm.POSTING_DATE, 'YYYYMMDD') IS NULL THEN 'Real-time entry'
	    WHEN TRY_TO_DATE(SCM.ENTRY_DATE , 'YYYYMMDD') = TRY_TO_DATE(SCM.POSTING_DATE , 'YYYYMMDD') THEN 'Real-time entry'
	    WHEN TRY_TO_DATE(SCM.POSTING_DATE, 'YYYYMMDD') > TRY_TO_DATE(SCM.ENTRY_DATE, 'YYYYMMDD') THEN 'Forward-dated entry'
	    WHEN TRY_TO_DATE(SCM.POSTING_DATE, 'YYYYMMDD') < TRY_TO_DATE(SCM.ENTRY_DATE, 'YYYYMMDD') THEN 'Backdated entry'
	    ELSE 'Backdated entry'
	END AS GI_BACKDATE,
	CASE 
	    WHEN TRY_TO_DATE(SB.BILLING_CREATED_DATE, 'YYYYMMDD') IS NULL AND TRY_TO_DATE(SB.BILLING_DATE, 'YYYYMMDD') IS NULL THEN 'N/A'
	    WHEN TRY_TO_DATE(SB.BILLING_CREATED_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(SB.BILLING_DATE, 'YYYYMMDD') IS NULL THEN 'Real-time entry'
	    WHEN TRY_TO_DATE(SB.BILLING_CREATED_DATE, 'YYYYMMDD') = TRY_TO_DATE(SB.BILLING_DATE, 'YYYYMMDD') THEN 'Real-time entry'
	    WHEN TRY_TO_DATE(SB.BILLING_DATE, 'YYYYMMDD') > TRY_TO_DATE(SB.BILLING_CREATED_DATE, 'YYYYMMDD') THEN 'Forward-dated entry'
	    WHEN TRY_TO_DATE(SB.BILLING_DATE, 'YYYYMMDD') < TRY_TO_DATE(SB.BILLING_CREATED_DATE, 'YYYYMMDD') THEN 'Backdated entry'
	    ELSE 'Backdated entry'
	END AS BILL_BACKDATE,
	CASE 
	    WHEN TRY_TO_DATE(TF.TTF_CREATED_DATE, 'YYYYMMDD') IS NULL AND TRY_TO_DATE(TF.TTF_DOC_DATE, 'YYYYMMDD') IS NULL THEN 'N/A'
	    WHEN TRY_TO_DATE(TF.TTF_CREATED_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(TF.TTF_DOC_DATE, 'YYYYMMDD') IS NULL THEN 'Real-time entry'
	    WHEN TRY_TO_DATE(TF.TTF_CREATED_DATE, 'YYYYMMDD') = TRY_TO_DATE(TF.TTF_DOC_DATE, 'YYYYMMDD') THEN 'Real-time entry'
	    WHEN TRY_TO_DATE(TF.TTF_DOC_DATE, 'YYYYMMDD') > TRY_TO_DATE(TF.TTF_CREATED_DATE, 'YYYYMMDD') THEN 'Forward-dated entry'
	    WHEN TRY_TO_DATE(TF.TTF_DOC_DATE, 'YYYYMMDD') < TRY_TO_DATE(TF.TTF_CREATED_DATE, 'YYYYMMDD') THEN 'Backdated entry'
	    ELSE 'Backdated entry'
	END AS TFTG_BACKDATE,
	CASE 
	    WHEN TRY_TO_DATE(SBC.BILLING_CLEAR_CREATED_DATE, 'YYYYMMDD') IS NULL AND TRY_TO_DATE(SBC.BILLING_CLEAR_DATE, 'YYYYMMDD') IS NULL THEN 'N/A'
	    WHEN TRY_TO_DATE(SBC.BILLING_CLEAR_CREATED_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(SBC.BILLING_CLEAR_DATE, 'YYYYMMDD') IS NULL THEN 'Real-time entry'
	    WHEN TRY_TO_DATE(SBC.BILLING_CLEAR_CREATED_DATE, 'YYYYMMDD') = TRY_TO_DATE(SBC.BILLING_CLEAR_DATE, 'YYYYMMDD') THEN 'Real-time entry'
	    WHEN TRY_TO_DATE(SBC.BILLING_CLEAR_DATE, 'YYYYMMDD') > TRY_TO_DATE(SBC.BILLING_CLEAR_CREATED_DATE, 'YYYYMMDD') THEN 'Forward-dated entry'
	    WHEN TRY_TO_DATE(SBC.BILLING_CLEAR_DATE, 'YYYYMMDD') < TRY_TO_DATE(SBC.BILLING_CLEAR_CREATED_DATE, 'YYYYMMDD') THEN 'Backdated entry'
	    ELSE 'Backdated entry'
	END AS BILL_CLEARING_BACKDATE,
	-- BACKDATE CREATED DATE - DOC DATE
	CASE 
	    WHEN TRY_TO_DATE(SSO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD') IS NULL AND TRY_TO_DATE(SSO.SALES_ORDER_DATE, 'YYYYMMDD') IS NULL THEN 'N/A'
	    WHEN TRY_TO_DATE(SSO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(SSO.SALES_ORDER_DATE, 'YYYYMMDD') IS NULL THEN '0'
	    WHEN TRY_TO_DATE(SSO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(SSO.SALES_ORDER_DATE, 'YYYYMMDD') IS NOT NULL 
	    THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(SSO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD'), TRY_TO_DATE(SSO.SALES_ORDER_DATE, 'YYYYMMDD')))
	    ELSE 'N/A'
	END AS SO_DIFF_DAYS,
	CASE 
	    WHEN TRY_TO_DATE(SD.DELIVERY_CREATED_DATE, 'YYYYMMDD') IS NULL AND TRY_TO_DATE(SD.DELIVERY_ACTUAL_DATE, 'YYYYMMDD') IS NULL THEN 'N/A'
	    WHEN TRY_TO_DATE(SD.DELIVERY_CREATED_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(SD.DELIVERY_ACTUAL_DATE, 'YYYYMMDD') IS NULL THEN '0'
	    WHEN TRY_TO_DATE(SD.DELIVERY_CREATED_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(SD.DELIVERY_ACTUAL_DATE, 'YYYYMMDD') IS NOT NULL THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(SD.DELIVERY_CREATED_DATE, 'YYYYMMDD'), TRY_TO_DATE(SD.DELIVERY_ACTUAL_DATE, 'YYYYMMDD')))
	    ELSE 'N/A'
	END AS DO_DIFF_DAYS,
	CASE 
	    WHEN TRY_TO_DATE(SCM.ENTRY_DATE, 'YYYYMMDD') IS NULL AND TRY_TO_DATE(SCM.POSTING_DATE, 'YYYYMMDD') IS NULL THEN 'N/A'
	    WHEN TRY_TO_DATE(SCM.ENTRY_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(SCM.POSTING_DATE, 'YYYYMMDD') IS NULL THEN '0'
	    WHEN TRY_TO_DATE(SCM.ENTRY_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(SCM.POSTING_DATE, 'YYYYMMDD') IS NOT NULL THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(SCM.ENTRY_DATE, 'YYYYMMDD'), TRY_TO_DATE(SCM.POSTING_DATE, 'YYYYMMDD')))
	    ELSE 'N/A'
	END AS GI_DIFF_DAYS,
	CASE 
	    WHEN TRY_TO_DATE(SB.BILLING_CREATED_DATE, 'YYYYMMDD') IS NULL AND TRY_TO_DATE(SB.BILLING_DATE, 'YYYYMMDD') IS NULL THEN 'N/A'
	    WHEN TRY_TO_DATE(SB.BILLING_CREATED_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(SB.BILLING_DATE, 'YYYYMMDD') IS NULL THEN '0'
	    WHEN TRY_TO_DATE(SB.BILLING_CREATED_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(SB.BILLING_DATE, 'YYYYMMDD') IS NOT NULL THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(SB.BILLING_CREATED_DATE, 'YYYYMMDD'), TRY_TO_DATE(SB.BILLING_DATE, 'YYYYMMDD')))
	    ELSE 'N/A'
	END AS BILL_DIFF_DAYS,
	CASE 
	    WHEN TRY_TO_DATE(TF.TTF_CREATED_DATE, 'YYYYMMDD') IS NULL AND TRY_TO_DATE(TF.TTF_DOC_DATE, 'YYYYMMDD') IS NULL THEN 'N/A'
	    WHEN TRY_TO_DATE(TF.TTF_CREATED_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(TF.TTF_DOC_DATE, 'YYYYMMDD') IS NULL THEN '0'
	    WHEN TRY_TO_DATE(TF.TTF_CREATED_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(TF.TTF_DOC_DATE, 'YYYYMMDD') IS NOT NULL THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(TF.TTF_CREATED_DATE, 'YYYYMMDD'), TRY_TO_DATE(TF.TTF_DOC_DATE, 'YYYYMMDD')))
	    ELSE 'N/A'
	END AS TFTG_DIFF_DAYS,
	CASE 
	    WHEN TRY_TO_DATE(SBC.BILLING_CLEAR_CREATED_DATE, 'YYYYMMDD') IS NULL AND TRY_TO_DATE(SBC.BILLING_CLEAR_DATE, 'YYYYMMDD') IS NULL THEN 'N/A'
	    WHEN TRY_TO_DATE(SBC.BILLING_CLEAR_CREATED_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(SBC.BILLING_CLEAR_DATE, 'YYYYMMDD') IS NULL THEN '0'
	    WHEN TRY_TO_DATE(SBC.BILLING_CLEAR_CREATED_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(SBC.BILLING_CLEAR_DATE, 'YYYYMMDD') IS NOT NULL THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(SBC.BILLING_CLEAR_CREATED_DATE, 'YYYYMMDD'), TRY_TO_DATE(SBC.BILLING_CLEAR_DATE, 'YYYYMMDD')))
	    ELSE 'N/A'
	END AS BILL_CLEAR_DIFF_DAYS,
	-- AGING : SELISIH
	CASE
	    WHEN SO_DIFF_DAYS = 'N/A' THEN 'N/A'
	    WHEN SO_DIFF_DAYS >= 0 THEN '1/ 0 Hari'
	    WHEN SO_DIFF_DAYS < 0 AND SO_DIFF_DAYS >= -3 THEN '2/ 1-3 Hari'
	    WHEN SO_DIFF_DAYS < -3 AND SO_DIFF_DAYS >= -7 THEN '3/ 3-7 Hari'
	    WHEN SO_DIFF_DAYS < -7 AND SO_DIFF_DAYS >= -14 THEN '4/ 7-14 Hari'
	    WHEN SO_DIFF_DAYS < -14 AND SO_DIFF_DAYS >= -30 THEN '5/ 14-30 Hari'
	    WHEN SO_DIFF_DAYS < -30 THEN '6/ >30 Hari'
	    ELSE ''
	END AS AGING_SO_DIFF_DAYS,
	CASE
	    WHEN DO_DIFF_DAYS = 'N/A' THEN 'N/A'
	    WHEN DO_DIFF_DAYS >= 0 THEN '1/ 0 Hari'
	    WHEN DO_DIFF_DAYS < 0 AND DO_DIFF_DAYS >= -3 THEN '2/ 1-3 Hari'
	    WHEN DO_DIFF_DAYS < -3 AND DO_DIFF_DAYS >= -7 THEN '3/ 3-7 Hari'
	    WHEN DO_DIFF_DAYS < -7 AND DO_DIFF_DAYS >= -14 THEN '4/ 7-14 Hari'
	    WHEN DO_DIFF_DAYS < -14 AND DO_DIFF_DAYS >= -30 THEN '5/ 14-30 Hari'
	    WHEN DO_DIFF_DAYS < -30 THEN '6/ >30 Hari'
	    ELSE ''
	END AS AGING_DO_DIFF_DAYS,
	CASE
	    WHEN GI_DIFF_DAYS = 'N/A' THEN 'N/A'
	    WHEN GI_DIFF_DAYS >= 0 THEN '1/ 0 Hari'
	    WHEN GI_DIFF_DAYS < 0 AND GI_DIFF_DAYS >= -3 THEN '2/ 1-3 Hari'
	    WHEN GI_DIFF_DAYS < -3 AND GI_DIFF_DAYS >= -7 THEN '3/ 3-7 Hari'
	    WHEN GI_DIFF_DAYS < -7 AND GI_DIFF_DAYS >= -14 THEN '4/ 7-14 Hari'
	    WHEN GI_DIFF_DAYS < -14 AND GI_DIFF_DAYS >= -30 THEN '5/ 14-30 Hari'
	    WHEN GI_DIFF_DAYS < -30 THEN '6/ >30 Hari'
	    ELSE ''
	END AS AGING_GI_DIFF_DAYS,
	CASE
	    WHEN BILL_DIFF_DAYS = 'N/A' THEN 'N/A'
	    WHEN BILL_DIFF_DAYS >= 0 THEN '1/ 0 Hari'
	    WHEN BILL_DIFF_DAYS < 0 AND BILL_DIFF_DAYS >= -3 THEN '2/ 1-3 Hari'
	    WHEN BILL_DIFF_DAYS < -3 AND BILL_DIFF_DAYS >= -7 THEN '3/ 3-7 Hari'
	    WHEN BILL_DIFF_DAYS < -7 AND BILL_DIFF_DAYS >= -14 THEN '4/ 7-14 Hari'
	    WHEN BILL_DIFF_DAYS < -14 AND BILL_DIFF_DAYS >= -30 THEN '5/ 14-30 Hari'
	    WHEN BILL_DIFF_DAYS < -30 THEN '6/ >30 Hari'
	    ELSE ''
	END AS AGING_BILL_DIFF_DAYS,
	CASE
	    WHEN TFTG_DIFF_DAYS = 'N/A' THEN 'N/A'
	    WHEN TFTG_DIFF_DAYS >= 0 THEN '1/ 0 Hari'
	    WHEN TFTG_DIFF_DAYS < 0 AND TFTG_DIFF_DAYS >= -3 THEN '2/ 1-3 Hari'
	    WHEN TFTG_DIFF_DAYS < -3 AND TFTG_DIFF_DAYS >= -7 THEN '3/ 3-7 Hari'
	    WHEN TFTG_DIFF_DAYS < -7 AND TFTG_DIFF_DAYS >= -14 THEN '4/ 7-14 Hari'
	    WHEN TFTG_DIFF_DAYS < -14 AND TFTG_DIFF_DAYS >= -30 THEN '5/ 14-30 Hari'
	    WHEN TFTG_DIFF_DAYS < -30 THEN '6/ >30 Hari'
	    ELSE ''
	END AS AGING_TFTG_DIFF_DAYS,
	CASE
	    WHEN BILL_CLEAR_DIFF_DAYS = 'N/A' THEN 'N/A'
	    WHEN BILL_CLEAR_DIFF_DAYS >= 0 THEN '1/ 0 Hari'
	    WHEN BILL_CLEAR_DIFF_DAYS < 0 AND BILL_CLEAR_DIFF_DAYS >= -3 THEN '2/ 1-3 Hari'
	    WHEN BILL_CLEAR_DIFF_DAYS < -3 AND BILL_CLEAR_DIFF_DAYS >= -7 THEN '3/ 3-7 Hari'
	    WHEN BILL_CLEAR_DIFF_DAYS < -7 AND BILL_CLEAR_DIFF_DAYS >= -14 THEN '4/ 7-14 Hari'
	    WHEN BILL_CLEAR_DIFF_DAYS < -14 AND BILL_CLEAR_DIFF_DAYS >= -30 THEN '5/ 14-30 Hari'
	    WHEN BILL_CLEAR_DIFF_DAYS < -30 THEN '6/ >30 Hari'
	    ELSE ''
	END AS AGING_BILL_CLEAR_DIFF_DAYS
  -- FROM AND WHERE
FROM PROD_DB.DSTR_BI_COMMUNITY./*F_SALES_FLOW_ORDER_DOCUMENT_FLOW*/ temp_sales_flow FLOW
  LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER SSO
    ON FLOW.SALES_ORDER_NUMBER = SSO.SALES_ORDER_NUMBER
	AND FLOW.SOURCE_SYSTEM = SSO.SOURCE_SYSTEM
	AND FLOW.SALES_ORDER_ITEM = SSO.SALES_ORDER_ITEM 
	AND SSO.SALES_ORDER_STATUS_REJECTION <> 'C'
	AND SSO.SALES_ORDER_TYPE NOT IN ('ZB51','ZB52','ZB53','ZB54','ZB55','ZB56','ZB59')
  LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, CUSTOMER, CUSTOMER_NAME, REGION FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER) CUST
    ON SSO.CUSTOMER = CUST.CUSTOMER
    AND SSO.SOURCE_SYSTEM = CUST.SOURCE_SYSTEM
  LEFT JOIN (SELECT SOURCE_SYSTEM, CUSTOMER, SALES_OFFICE, SALES_OFFICE_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER) CUST1
    ON SSO.SOURCE_SYSTEM = CUST1.SOURCE_SYSTEM
    AND SSO.CUSTOMER = CUST1.CUSTOMER 
    AND SSO.SALES_OFFICE = CUST1.SALES_OFFICE
  LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, CUSTOMER, DISTRIBUTION_CHANNEL, BLOCK_FOR_SALES FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER) CUST3
    ON SSO.SOURCE_SYSTEM = CUST3.SOURCE_SYSTEM
    AND SSO.CUSTOMER = CUST3.CUSTOMER
    AND SSO.DISTRIBUTION_CHANNEL = CUST3.DISTRIBUTION_CHANNEL
  LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, CUSTOMER, SALES_DIVISION, BLOCK_FOR_SALES FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER) CUST5
    ON SSO.SOURCE_SYSTEM = CUST5.SOURCE_SYSTEM
    AND SSO.CUSTOMER = CUST5.CUSTOMER
    AND SSO.DIVISION = CUST5.SALES_DIVISION
  LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, CUSTOMER, CUSTOMER_NAME, REGION FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER) CUSTSH
    ON FLOW.CUSTOMER_SHIP_TO = CUSTSH.CUSTOMER
    AND FLOW.SOURCE_SYSTEM = CUSTSH.SOURCE_SYSTEM
  LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_DELIVERY SD
    ON FLOW.DELIVERY_NUMBER  = SD.DELIVERY_NUMBER  
    AND FLOW.SALES_ORDER_NUMBER = SD.REFERENCE_SALES_ORDER_NUMBER 
    AND FLOW.DELIVERY_ITEM = SD.DELIVERY_ITEM 
  LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_DELIVERY_POD PD
    ON PD.DELIVERY_NUMBER  = SD.DELIVERY_NUMBER  
    AND PD.SOURCE_SYSTEM = SD.SOURCE_SYSTEM 
  LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING SB
    ON FLOW.BILLING_NUMBER = SB.BILLING_NUMBER
    AND FLOW.SALES_ORDER_NUMBER = SB.REFERENCE_SALES_ORDER_NUMBER 
    AND FLOW.BILLING_ITEM = SB.BILLING_ITEM 
    AND SB.BILLING_TYPE <> 'ZB99'
  LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, CUSTOMER, TERM_OF_PAYMENT, TERM_OF_PAYMENT_DESC, BLOCK_FOR_SALES FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER) CUST2
    ON CUST.SOURCE_SYSTEM = CUST2.SOURCE_SYSTEM
    AND CUST.CUSTOMER = CUST2.CUSTOMER
    AND SB.TERM_OF_PAYMENT = CUST2.TERM_OF_PAYMENT 
  LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_CLEARING SBC
    ON FLOW.BILLING_NUMBER = SBC.BILLING_NUMBER
  LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, DISTRIBUTION_CHANNEL, DISTRIBUTION_CHANNEL_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_AREA) SA
    ON SSO.SOURCE_SYSTEM = SA.SOURCE_SYSTEM 
    AND SSO.DISTRIBUTION_CHANNEL = SA.DISTRIBUTION_CHANNEL
  LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, SALES_DIVISION, SALES_DIVISION_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_AREA) SA2
    ON SSO.DIVISION = SA2.SALES_DIVISION 
    AND SSO.SOURCE_SYSTEM = SA2.SOURCE_SYSTEM
  LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.D_SALES_REGION DSR
    ON CUST.REGION = DSR.REGION
    AND CUST.SOURCE_SYSTEM = DSR.SOURCE_SYSTEM
    AND DSR.COUNTRY = 'ID'
  LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT CP
    ON SSO.SOURCE_SYSTEM = CP.SOURCE_SYSTEM
    AND SSO.COMPANY_CODE = CP.COMPANY_CODE
    AND SSO.PLANT = CP.PLANT
  LEFT JOIN /*PROD_DB.DSTR_BI_COMMUNITY.F_SCM_MUTASI_MATERIAL SCM*/ temp_scm_mutasi_pe1 SCM
    ON FLOW.SOURCE_SYSTEM = SCM.SOURCE_SYSTEM
    AND FLOW.DELIVERY_NUMBER = SCM."REFERENCE"
    AND SCM.FISCAL_YEAR = '2025'
	AND SCM.SOURCE_SYSTEM = 'PE1'
	/*AND SCM.POSTING_DATE BETWEEN '20250801' AND CURRENT_DATE*/
  LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_TTF TF
    ON FLOW.SOURCE_SYSTEM = TF.SOURCE_SYSTEM 
    AND FLOW.BILLING_NUMBER = TF.BILLING_NUMBER
  LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, CUSTOMER, POD_FLAG FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER) CPOD
	ON SSO.SOURCE_SYSTEM = CPOD.SOURCE_SYSTEM 
	AND SSO.CUSTOMER = CPOD.CUSTOMER
  WHERE 
  FLOW.SOURCE_SYSTEM = 'PE1'
  AND SSO.COMPANY_CODE = 'ID90'
  AND TRY_TO_DATE(SSO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD') BETWEEN '2025-08-01' AND '2025-10-24'
  /*AND SB.BILLING_TYPE <> 'ZB99'*/
  /*AND FLOW.SALES_ORDER_NUMBER IN ('1207184848')*/
  GROUP BY ALL;
