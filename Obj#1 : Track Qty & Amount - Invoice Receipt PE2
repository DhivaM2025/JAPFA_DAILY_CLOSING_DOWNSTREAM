-- STEP 1 : RUN ALL TEMPORARY TABLE --
CREATE TEMPORARY TABLE TEMP_PURCHASE_ORDER AS
SELECT * FROM PROD_DB.DSTR_BI_COMMUNITY.F_SCM_PURCHASING_ORDER;

CREATE TEMPORARY TABLE TEMP_SALES_FLOW AS
SELECT * FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_FLOW_ORDER_DOCUMENT_FLOW;

CREATE TEMPORARY TABLE TEMP_HEADER_INTERCO AS
SELECT * FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_INTERCO_HEADER;

-- STEP 2 : RUN QUERY BELOW FOR GET INV RECEIPT DATA - INTERCO B2B&B2C PE2 ONLY --
SELECT DISTINCT
    PO.SOURCE_SYSTEM,
    CP.COMPANY_CODE || '-' || CP.COMPANY_NAME AS COMPANY,
    CP1.PLANT || '-' || CP1.PLANT_NAME AS PLANT,
    CP2.PLANT || '-' || CP2.PLANT_NAME AS SUPPLYING_PLANT,
    PO.VENDOR AS VENDOR_CODE,
    VDR.VENDOR_DESC AS VENDOR_NAME,
    PO.VENDOR_GROUP,
    SUBSTR(PO.PO_PERIOD, 1, 4) || '/' || SUBSTR(PO.PO_PERIOD, 5, 2) AS PO_PERIOD,
    'Invoice Receipt' AS CATEGORY,
    PO.PURCHASE_ORDER_ITEM_CATEGORY || '-' || PO.PURCHASE_ORDER_ITEM_CATEGORY_DESCRIPTION AS TYPE,
    Z.SALES_ORDER_NUMBER AS SALES_ORDER_NUMBER_CUSTOMER,
    PO.DOCUMENT_NUMBER AS INV_NUMBER,
    TO_DATE(PO.POSTING_DATE) AS POSTING_DATE,
    PO.CURRENCY,
    PO.INV_QTY,
    PO.INV_AMOUNT
FROM (
    SELECT 
        SOURCE_SYSTEM,
        COMPANY_CODE,
        PLANT,
        SUPPLYING_PLANT,
        VENDOR,
        VENDOR_GROUP,
        PO_PERIOD,
        PURCHASE_ORDER_ITEM_CATEGORY,
        PURCHASE_ORDER_ITEM_CATEGORY_DESCRIPTION,
        DOCUMENT_NUMBER,
        POSTING_DATE,
        CURRENCY,
        SUM(IR_QUANTITY) AS INV_QTY,
        SUM(IR_AMOUNT) AS INV_AMOUNT
    FROM TEMP_PURCHASE_ORDER
    WHERE 
        SOURCE_SYSTEM = 'PE2'
        AND PLANT IN ('7AEA','7AEE','7AEB','7AEF','7AEG','7AEC','7AAE','7AAD','7AAA','7AAB','7AED','7AEH')
        AND PURCHASE_DOCUMENT_TYPE = 'ZA7A'
        AND VENDOR LIKE 'ID9000'
        AND PURCHASE_ORDER_ITEM_CATEGORY IN ('M', 'P', 'N', 'K', 'Q')
        AND TO_DATE(POSTING_DATE) BETWEEN '2025-05-01' AND CURRENT_DATE
        AND DOCUMENT_NUMBER = '5100411947'
    GROUP BY 
        SOURCE_SYSTEM, COMPANY_CODE, PLANT, SUPPLYING_PLANT, VENDOR, VENDOR_GROUP,
        PO_PERIOD, PURCHASE_ORDER_ITEM_CATEGORY, PURCHASE_ORDER_ITEM_CATEGORY_DESCRIPTION,
        DOCUMENT_NUMBER, POSTING_DATE, CURRENCY
) PO
LEFT JOIN (
    SELECT DISTINCT SOURCE_SYSTEM, INV_NUM, MIN(SALES_ORDER_NUMBER) AS SALES_ORDER_NUMBER
    FROM TEMP_HEADER_INTERCO
    GROUP BY SOURCE_SYSTEM, INV_NUM
) Z
    ON PO.SOURCE_SYSTEM = Z.SOURCE_SYSTEM
    AND PO.DOCUMENT_NUMBER = Z.INV_NUM
LEFT JOIN (
    SELECT DISTINCT SOURCE_SYSTEM, COMPANY_CODE, COMPANY_NAME 
    FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT
) CP
    ON PO.SOURCE_SYSTEM = CP.SOURCE_SYSTEM
    AND PO.COMPANY_CODE = CP.COMPANY_CODE
LEFT JOIN (
    SELECT DISTINCT SOURCE_SYSTEM, PLANT, PLANT_NAME 
    FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT
) CP1
    ON PO.SOURCE_SYSTEM = CP1.SOURCE_SYSTEM
    AND PO.PLANT = CP1.PLANT
LEFT JOIN (
    SELECT DISTINCT SOURCE_SYSTEM, PLANT, PLANT_NAME 
    FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT
) CP2
    ON PO.SOURCE_SYSTEM = CP2.SOURCE_SYSTEM
    AND PO.SUPPLYING_PLANT = CP2.PLANT
LEFT JOIN (
    SELECT DISTINCT SOURCE_SYSTEM, VENDOR, VENDOR_DESC 
    FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_VENDOR
) VDR
    ON PO.SOURCE_SYSTEM = VDR.SOURCE_SYSTEM
    AND PO.VENDOR = VDR.VENDOR;
