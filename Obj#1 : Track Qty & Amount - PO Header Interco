-- STEP 1 --
CREATE TEMPORARY TABLE TEMP_PURCHASE_ORDER AS
SELECT * FROM PROD_DB.DSTR_BI_COMMUNITY.F_SCM_PURCHASING_ORDER;

-- STEP 2 --
CREATE TEMPORARY TABLE TEMP_HEADER_INTERCO AS
SELECT * FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_INTERCO_HEADER;

-- STEP 3 --
(SELECT 
	Z.SOURCE_SYSTEM,
	Z.COMPANY_CODE || '-' || CP.COMPANY_NAME AS COMPANY,
	PO.PLANT || '-' || CP1.PLANT_NAME AS PLANT,
	PO.SUPPLYING_PLANT || '-' || CP2.PLANT_NAME AS SUPPLYING_PLANT,
	PO.VENDOR AS VENDOR_CODE,
	VDR.VENDOR_DESC AS VENDOR_NAME,
	PO.VENDOR_GROUP,
	SUBSTR(PO.PO_PERIOD, 1, 4) || '/' || SUBSTR(PO.PO_PERIOD, 5, 2) AS PO_PERIOD,
	'Sales Order' AS CATEGORY,
	NULL AS TYPE,
	Z.SALES_ORDER_NUMBER,
	Y.SALES_ORDER_NUMBER AS SALES_ORDER_NUMBER_INTERCO,
	NULL AS PO_NUMBER,
	NULL AS GR_NUMBER,
	NULL AS INV_NUMBER,
	NULL AS PO_POSTING_DATE, 
	NULL AS POSTING_DATE,
	0 AS PO_QTY,
	0 AS PO_AMOUNT,
	0 AS GR_QTY,
	0 AS GR_AMOUNT,
	0 AS INV_QTY,
	0 AS INV_AMOUNT
FROM TEMP_HEADER_INTERCO Z
LEFT JOIN TEMP_PURCHASE_ORDER PO
	ON Z.SOURCE_SYSTEM = PO.SOURCE_SYSTEM
	AND Z.PO_NUM_REQ = PO.PURCHASE_ORDER
LEFT JOIN TEMP_HEADER_INTERCO Y
	ON Z.SALES_ORDER_NUMBER = Y.SALES_ORDER_EXTERNAL_DOCUMENT
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, COMPANY_CODE, COMPANY_NAME FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT) AS CP
    	ON PO.SOURCE_SYSTEM = CP.SOURCE_SYSTEM
    	AND PO.COMPANY_CODE = CP.COMPANY_CODE
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, PLANT, PLANT_NAME FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT) AS CP1
    	ON PO.SOURCE_SYSTEM = CP1.SOURCE_SYSTEM
    	AND PO.PLANT = CP1.PLANT
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, PLANT, PLANT_NAME FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT) AS CP2
    	ON PO.SOURCE_SYSTEM = CP2.SOURCE_SYSTEM
    	AND PO.SUPPLYING_PLANT = CP2.PLANT
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, VENDOR, VENDOR_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_VENDOR) VDR
	    ON PO.SOURCE_SYSTEM = VDR.SOURCE_SYSTEM
	    AND PO.VENDOR = VDR.VENDOR
/*WHERE Z.SALES_ORDER_NUMBER = '1207186517'*/
GROUP BY ALL)
UNION ALL
(SELECT 
	Z.SOURCE_SYSTEM,
	Z.COMPANY_CODE || '-' || CP.COMPANY_NAME AS COMPANY,
	PO.PLANT || '-' || CP1.PLANT_NAME AS PLANT,
	PO.SUPPLYING_PLANT || '-' || CP2.PLANT_NAME AS SUPPLYING_PLANT,
	PO.VENDOR AS VENDOR_CODE,
	VDR.VENDOR_DESC AS VENDOR_NAME,
	PO.VENDOR_GROUP,
	SUBSTR(PO.PO_PERIOD, 1, 4) || '/' || SUBSTR(PO.PO_PERIOD, 5, 2) AS PO_PERIOD,
	'Purchase Order' AS CATEGORY,
	PURCHASE_DOCUMENT_TYPE || '-' || PURCHASE_TYPE AS TYPE,
	Z.SALES_ORDER_NUMBER,
	Y.SALES_ORDER_NUMBER AS SALES_ORDER_NUMBER_INTERCO,
	Z.PO_NUM_REQ AS PO_NUMBER,
	NULL AS GR_NUMBER,
	NULL AS INV_NUMBER,
	TO_DATE(PO.POSTING_DATE_PO) AS PO_POSTING_DATE, 
	TO_DATE(Z.POSTING_DATE_PO) AS POSTING_DATE, 
	SUM(PO.PO_QUANTITY) AS PO_QTY,
	SUM(PO.PO_AMOUNT_ACTUAL_POSTING) AS PO_AMOUNT,
	0 AS GR_QTY,
	0 AS GR_AMOUNT,
	0 AS INV_QTY,
	0 AS INV_AMOUNT
FROM TEMP_HEADER_INTERCO Z
LEFT JOIN TEMP_PURCHASE_ORDER PO
	ON Z.SOURCE_SYSTEM = PO.SOURCE_SYSTEM
	AND Z.PO_NUM_REQ = PO.PURCHASE_ORDER
LEFT JOIN TEMP_HEADER_INTERCO Y
	ON Z.SALES_ORDER_NUMBER = Y.SALES_ORDER_EXTERNAL_DOCUMENT
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, COMPANY_CODE, COMPANY_NAME FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT) AS CP
    	ON PO.SOURCE_SYSTEM = CP.SOURCE_SYSTEM
    	AND PO.COMPANY_CODE = CP.COMPANY_CODE
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, PLANT, PLANT_NAME FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT) AS CP1
    	ON PO.SOURCE_SYSTEM = CP1.SOURCE_SYSTEM
    	AND PO.PLANT = CP1.PLANT
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, PLANT, PLANT_NAME FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT) AS CP2
    	ON PO.SOURCE_SYSTEM = CP2.SOURCE_SYSTEM
    	AND PO.SUPPLYING_PLANT = CP2.PLANT
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, VENDOR, VENDOR_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_VENDOR) VDR
	    ON PO.SOURCE_SYSTEM = VDR.SOURCE_SYSTEM
	    AND PO.VENDOR = VDR.VENDOR
/*WHERE Z.SALES_ORDER_NUMBER = '1207186517'*/
GROUP BY ALL)
UNION ALL
(SELECT 
	Z.SOURCE_SYSTEM,
	Z.COMPANY_CODE || '-' || CP.COMPANY_NAME AS COMPANY,
	PO.PLANT || '-' || CP1.PLANT_NAME AS PLANT,
	PO.SUPPLYING_PLANT || '-' || CP2.PLANT_NAME AS SUPPLYING_PLANT,
	PO.VENDOR AS VENDOR_CODE,
	VDR.VENDOR_DESC AS VENDOR_NAME,
	PO.VENDOR_GROUP,
	SUBSTR(PO.PO_PERIOD, 1, 4) || '/' || SUBSTR(PO.PO_PERIOD, 5, 2) AS PO_PERIOD,
	'Good Receipt' AS CATEGORY,
	PURCHASE_ORDER_ITEM_CATEGORY  || '-' || PURCHASE_ORDER_ITEM_CATEGORY_DESCRIPTION AS TYPE,
	Z.SALES_ORDER_NUMBER,
	Y.SALES_ORDER_NUMBER AS SALES_ORDER_NUMBER_INTERCO,
	Z.PO_NUM_REQ AS PO_NUMBER,
	Z.GR_NUM AS GR_NUMBER,
	NULL AS INV_NUMBER,
	TO_DATE(PO.POSTING_DATE_PO) AS PO_POSTING_DATE, 
	TO_DATE(Z.POSTING_DATE_GR) AS POSTING_DATE,
	0 AS PO_QTY,
	0 AS PO_AMOUNT,
	SUM(PO.GR_QUANTITY) AS GR_QTY,
	SUM(PO.GR_AMOUNT) AS GR_AMOUNT,
	0 AS INV_QTY,
	0 AS INV_AMOUNT
FROM TEMP_HEADER_INTERCO Z
LEFT JOIN TEMP_PURCHASE_ORDER PO
	ON Z.SOURCE_SYSTEM = PO.SOURCE_SYSTEM
	AND Z.PO_NUM_REQ = PO.PURCHASE_ORDER
LEFT JOIN TEMP_HEADER_INTERCO Y
	ON Z.SALES_ORDER_NUMBER = Y.SALES_ORDER_EXTERNAL_DOCUMENT
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, COMPANY_CODE, COMPANY_NAME FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT) AS CP
    	ON PO.SOURCE_SYSTEM = CP.SOURCE_SYSTEM
    	AND PO.COMPANY_CODE = CP.COMPANY_CODE
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, PLANT, PLANT_NAME FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT) AS CP1
    	ON PO.SOURCE_SYSTEM = CP1.SOURCE_SYSTEM
    	AND PO.PLANT = CP1.PLANT
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, PLANT, PLANT_NAME FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT) AS CP2
    	ON PO.SOURCE_SYSTEM = CP2.SOURCE_SYSTEM
    	AND PO.SUPPLYING_PLANT = CP2.PLANT
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, VENDOR, VENDOR_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_VENDOR) VDR
	    ON PO.SOURCE_SYSTEM = VDR.SOURCE_SYSTEM
	    AND PO.VENDOR = VDR.VENDOR
WHERE
	PO.PURCHASE_ORDER_ITEM_CATEGORY IN ('E', 'U', 'F')
	/*AND Z.SALES_ORDER_NUMBER = '1207186517'*/
GROUP BY ALL)
UNION ALL
(SELECT 
	Z.SOURCE_SYSTEM,
	Z.COMPANY_CODE || '-' || CP.COMPANY_NAME AS COMPANY,
	PO.PLANT || '-' || CP1.PLANT_NAME AS PLANT,
	PO.SUPPLYING_PLANT || '-' || CP2.PLANT_NAME AS SUPPLYING_PLANT,
	PO.VENDOR AS VENDOR_CODE,
	VDR.VENDOR_DESC AS VENDOR_NAME,
	PO.VENDOR_GROUP,
	SUBSTR(PO.PO_PERIOD, 1, 4) || '/' || SUBSTR(PO.PO_PERIOD, 5, 2) AS PO_PERIOD,
	'Invoice Receipt' AS CATEGORY,
	PURCHASE_ORDER_ITEM_CATEGORY  || '-' || PURCHASE_ORDER_ITEM_CATEGORY_DESCRIPTION AS TYPE,
	Z.SALES_ORDER_NUMBER,
	Y.SALES_ORDER_NUMBER AS SALES_ORDER_NUMBER_INTERCO,
	Z.PO_NUM_REQ AS PO_NUMBER,
	NULL AS GR_NUMBER,
	Z.INV_NUM AS INV_NUMBER,
	TO_DATE(PO.POSTING_DATE_PO) AS PO_POSTING_DATE, 
	TO_DATE(Z.POSTING_DATE_INV) AS POSTING_DATE,
	0 AS PO_QTY,
	0 AS PO_AMOUNT,
	0 AS GR_QTY,
	0 AS GR_AMOUNT,
	SUM(PO.IR_QUANTITY) AS INV_QTY,
	SUM(PO.IR_AMOUNT) AS INV_AMOUNT,
FROM TEMP_HEADER_INTERCO Z
LEFT JOIN TEMP_PURCHASE_ORDER PO
	ON Z.SOURCE_SYSTEM = PO.SOURCE_SYSTEM
	AND Z.PO_NUM_REQ = PO.PURCHASE_ORDER
LEFT JOIN TEMP_HEADER_INTERCO Y
	ON Z.SALES_ORDER_NUMBER = Y.SALES_ORDER_EXTERNAL_DOCUMENT
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, COMPANY_CODE, COMPANY_NAME FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT) AS CP
    	ON PO.SOURCE_SYSTEM = CP.SOURCE_SYSTEM
    	AND PO.COMPANY_CODE = CP.COMPANY_CODE
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, PLANT, PLANT_NAME FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT) AS CP1
    	ON PO.SOURCE_SYSTEM = CP1.SOURCE_SYSTEM
    	AND PO.PLANT = CP1.PLANT
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, PLANT, PLANT_NAME FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT) AS CP2
    	ON PO.SOURCE_SYSTEM = CP2.SOURCE_SYSTEM
    	AND PO.SUPPLYING_PLANT = CP2.PLANT
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, VENDOR, VENDOR_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_VENDOR) VDR
	    ON PO.SOURCE_SYSTEM = VDR.SOURCE_SYSTEM
	    AND PO.VENDOR = VDR.VENDOR
WHERE 
	PO.PURCHASE_ORDER_ITEM_CATEGORY IN ('M', 'P', 'N', 'K', 'Q')
	/*AND Z.SALES_ORDER_NUMBER = '1207186517'*/
GROUP BY ALL)
