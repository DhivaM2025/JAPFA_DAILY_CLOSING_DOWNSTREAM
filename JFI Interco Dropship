SELECT 
-- SELLING ENTITY [ID90] --
	-- BASIC INFORMATION --
	H.COMPANY_CODE || '-' || CP.COMPANY_NAME AS COMPANY,
	SO.PLANT || '-' || CP1.PLANT_NAME AS PLANT,
	SO.CUSTOMER AS CUSTOMER_CODE,
	CUST.CUSTOMER_NAME AS CUSTOMER_NAME,
	SO.CUSTOMER_SHIP_TO,
	CUSTSH.CUSTOMER_NAME AS CUSTOMER_SHIP_TO_NAME,
    CASE 
        WHEN CUST1.SALES_OFFICE IS NULL OR CUST1.SALES_OFFICE = '' OR CUST1.SALES_OFFICE = '9001'
        THEN SO.SALES_OFFICE || '-' || CUSTSO.SALES_OFFICE_DESC
        ELSE CUST1.SALES_OFFICE || '-' || CUST1.SALES_OFFICE_DESC
    END AS SALES_OFFICE,
    CASE 
        WHEN CUST1.SALES_OFFICE IS NULL OR CUST1.SALES_OFFICE = '' OR CUST1.SALES_OFFICE = '9001'
        THEN LEFT(CUSTSO.SALES_OFFICE_DESC, 3)
        WHEN CUST1.SALES_OFFICE_DESC IS NOT NULL AND CUST1.SALES_OFFICE_DESC <> ''
        THEN LEFT(CUST1.SALES_OFFICE_DESC, 3)
        ELSE CUST1.SALES_OFFICE
    END AS SALES_OFFICE_LOKASI,
	SO.DIVISION || '-' || SO.DIVISION_DESC AS DIVISION,
	SO.DISTRIBUTION_CHANNEL || '-' || SA.DISTRIBUTION_CHANNEL_DESC AS DISTRIBUTION_CHANNEL,
	CUST.REGION || '-' || DSR.REGION_DESCRIPTION AS CUSTOMER_REGION,
	CASE 
		WHEN DSR.REGION IN ('01', '02', '03', '04', '05', '28') THEN 'PULAU JAWA'
    	ELSE 'LUAR JAWA'
	END AS CUSTOMER_REGION_GROUP,
	CASE 
    	WHEN SB.TERM_OF_PAYMENT_DESC IS NULL OR SB.TERM_OF_PAYMENT = '' THEN SB.TERM_OF_PAYMENT
    	ELSE SB.TERM_OF_PAYMENT || '-' || SB.TERM_OF_PAYMENT_DESC
	END AS CUSTOMER_TOP,
	CPOD.POD_FLAG,
-- DOC TYPE --
	SO.SALES_ORDER_TYPE || '-' || SO.SALES_ORDER_TYPE_DESC AS SALES_ORDER_TYPE,
	SD.DELIVERY_TYPE || '-' || SD.DELIVERY_TYPE_DESC AS DELIVERY_TYPE,
	SB.BILLING_TYPE || '-' || SB.BILLING_TYPE_DESC AS BILLING_TYPE, 
	TF.TTF_DOC_TYPE AS TFTG_CUSTOMER_TYPE,
-- DOC STATUS --
	CASE 
    	WHEN SO.SALES_ORDER_STATUS IS NULL OR SO.SALES_ORDER_STATUS_DESC IS NULL THEN SO.SALES_ORDER_STATUS_DESC 
    	ELSE SO.SALES_ORDER_STATUS || '-' || SO.SALES_ORDER_STATUS_DESC 
	END AS SALES_ORDER_STATUS,
	SO.SALES_ORDER_STATUS_REJECTION || '-' || SO.SALES_ORDER_STATUS_REJECTION_DESC AS SALES_ORDER_STATUS_REJECTION,
	SO.SALES_ORDER_REASON_REJECTION_DESC,
	CASE 
	    WHEN LEFT(SO.SALES_ORDER_REASON_REJECTION_DESC, 2) IN ('Z2','Z6','ZH','ZJ','ZK','ZM','ZQ') THEN 'Order Related'
	    WHEN LEFT(SO.SALES_ORDER_REASON_REJECTION_DESC, 2) IN ('Z3','ZI') THEN 'AR Related'
	    WHEN LEFT(SO.SALES_ORDER_REASON_REJECTION_DESC, 2) IN ('ZA','ZN') THEN 'Delivery Related'
	    WHEN LEFT(SO.SALES_ORDER_REASON_REJECTION_DESC, 2) IN ('Z1','Z4','ZO') THEN 'Stock Related'
	    WHEN SO.SALES_ORDER_REASON_REJECTION_DESC IS NULL OR SO.SALES_ORDER_REASON_REJECTION_DESC = '' THEN 'N/A'
	    ELSE 'N/A'
	END AS SALES_ORDER_REASON_REJECTION_GROUP,
	CASE 
  		WHEN SD.DELIVERY_STATUS = 'Not yet processed' THEN 'A-Not yet processed'
    	WHEN SD.DELIVERY_STATUS = 'Partially processed' THEN 'B-Partially processed'
    	WHEN SD.DELIVERY_STATUS = 'Completely processed' THEN 'C-Completely processed'
    ELSE SD.DELIVERY_STATUS
	END AS DELIVERY_STATUS,
	CASE 
  		WHEN SD.DELIVERY_POD_STATUS = 'Not yet processed' THEN 'A-Not yet processed'
    	WHEN SD.DELIVERY_POD_STATUS = 'Partially processed' THEN 'B-Partially processed'
    	WHEN SD.DELIVERY_POD_STATUS = 'Completely processed' THEN 'C-Completely processed'
    ELSE SD.DELIVERY_POD_STATUS
	END AS POD_STATUS,
	CASE 
    	WHEN SB.POSTING_STATUS IS NULL OR SB.POSTING_STATUS_DESCRIPTION IS NULL THEN SB.POSTING_STATUS_DESCRIPTION 
    	ELSE SB.POSTING_STATUS || '-' || SB.POSTING_STATUS_DESCRIPTION 
  	END AS BILLING_STATUS,
	CASE 
    	WHEN SO.SALES_ORDER_TYPE = 'ZB20' THEN 'Interco Automation MT'
        ELSE 'Non Interco'
	END AS CATEGORY,
-- DOC NUMBER --
	-- DOCUMENT NUMBER --
	SO.CREATED_BY AS SO_CREATED_BY,
	H.SALES_ORDER_NUMBER,
	H.DELIVERY_NUMBER,
	SCM.MATERIAL_DOCUMENT_NUMBER AS GI_NUMBER,
	SD.DELIVERY_POD_STATUS AS POD_STATUS,
	H.BILLING_NUMBER,
	TF.TTF_NUMBER,
	SBC.BILLING_CLEARING_DOC AS BILLING_CLEARING_NUMBER,
	H.PO_NUM_REQ AS PO_NUMBER,
	H.GR_NUM AS GR_NUMBER,
	H.INV_NUM AS INVOICE_NUMBER,
-- PRODUCTION ENTITY [ID7A] --
	-- BASIC INFORMATION --
	H2.COMPANY_CODE,
	SO2.PLANT,
	SO2.DISTRIBUTION_CHANNEL,
	CASE 
    	WHEN SO2.SALES_ORDER_STATUS IS NULL OR SO2.SALES_ORDER_STATUS_DESC IS NULL THEN SO2.SALES_ORDER_STATUS_DESC 
    	ELSE SO2.SALES_ORDER_STATUS || '-' || SO2.SALES_ORDER_STATUS_DESC 
	END AS SALES_ORDER_STATUS,
	SO2.SALES_ORDER_STATUS_REJECTION || '-' || SO2.SALES_ORDER_STATUS_REJECTION_DESC AS SALES_ORDER_STATUS_REJECTION,
    SO2.SALES_ORDER_REASON_REJECTION_DESC,
    CASE
	    WHEN SO2.SALES_ORDER_REASON_REJECTION_DESC = '(AJS/VSN) SO Batal' THEN 'Order Related'
	    WHEN SO2.SALES_ORDER_REASON_REJECTION_DESC = '(CCP-ICP) SO Cancel Salah Input Customer' THEN 'Order Related'
	    WHEN SO2.SALES_ORDER_REASON_REJECTION_DESC = '(CCP-ICP) SO Rejected' THEN 'Order Related'
	    WHEN SO2.SALES_ORDER_REASON_REJECTION_DESC = '(CIOSHFPJFS) Cancel SO' THEN 'Order Related'
	    WHEN SO2.SALES_ORDER_REASON_REJECTION_DESC = '(CIOSHFPJFS) Full Retur Surat Jalan' THEN 'Delivery Related'
	    WHEN SO2.SALES_ORDER_REASON_REJECTION_DESC = '(CIOSHFPJFS) Selisih loading' THEN 'Delivery Related'
	    WHEN SO2.SALES_ORDER_REASON_REJECTION_DESC = '(CIOSHFPJFS) Stock tidak ada' THEN 'Stock Related'
	    WHEN SO2.SALES_ORDER_REASON_REJECTION_DESC = '(CIOSHFPJFS) System Rejection' THEN 'Order Related'
	    WHEN SO2.SALES_ORDER_REASON_REJECTION_DESC = '(IJA) Cancel SO' THEN 'Order Related'
	    WHEN SO2.SALES_ORDER_REASON_REJECTION_DESC = 'Over kredit limit dan TOP' THEN 'AR Related'
	    WHEN SO2.SALES_ORDER_REASON_REJECTION_DESC = 'Pembatalan order dari customer' THEN 'Order Related'
	    WHEN SO2.SALES_ORDER_REASON_REJECTION_DESC = 'Pembayaran belum masuk' THEN 'AR Related'
	    WHEN SO2.SALES_ORDER_REASON_REJECTION_DESC = 'Stok Kosong (Barang lagi di produksi)' THEN 'Stock Related'
	    ELSE 'N/A'
	END AS SALES_ORDER_REASON_REJECTION_GROUP,
		CASE 
  		WHEN SD_F.DELIVERY_STATUS = 'Not yet processed' THEN 'A-Not yet processed'
    	WHEN SD_F.DELIVERY_STATUS = 'Partially processed' THEN 'B-Partially processed'
    	WHEN SD_F.DELIVERY_STATUS = 'Completely processed' THEN 'C-Completely processed'
    ELSE SD_F.DELIVERY_STATUS
	END AS DELIVERY_ORDER_STATUS,
	CASE 
  		WHEN SD_C.DELIVERY_STATUS = 'Not yet processed' THEN 'A-Not yet processed'
    	WHEN SD_C.DELIVERY_STATUS = 'Partially processed' THEN 'B-Partially processed'
    	WHEN SD_C.DELIVERY_STATUS = 'Completely processed' THEN 'C-Completely processed'
    ELSE SD_C.DELIVERY_STATUS
	END AS DELIVERY_ORDER_CSG_STATUS,
	CASE 
  		WHEN SD_F.DELIVERY_POD_STATUS = 'Not yet processed' THEN 'A-Not yet processed'
    	WHEN SD_F.DELIVERY_POD_STATUS = 'Partially processed' THEN 'B-Partially processed'
    	WHEN SD_F.DELIVERY_POD_STATUS = 'Completely processed' THEN 'C-Completely processed'
    ELSE SD_F.DELIVERY_POD_STATUS
	END AS POD_STATUS,
	CASE 
  		WHEN SD_C.DELIVERY_POD_STATUS = 'Not yet processed' THEN 'A-Not yet processed'
    	WHEN SD_C.DELIVERY_POD_STATUS = 'Partially processed' THEN 'B-Partially processed'
    	WHEN SD_C.DELIVERY_POD_STATUS = 'Completely processed' THEN 'C-Completely processed'
    ELSE SD_C.DELIVERY_POD_STATUS
	END AS POD_CSG_STATUS,
	COALESCE (DO_REASON.SALES_ORDER_REASON,DO_REASON_FRANCO.SALES_ORDER_REASON) || '-' || COALESCE (DO_REASON.SALES_ORDER_REASON_DESC,DO_REASON_FRANCO.SALES_ORDER_REASON_DESC) AS DELIVERY_REJECTION_REASON,
	CASE
	    WHEN COALESCE(
	            COALESCE(DO_REASON.SALES_ORDER_REASON, DO_REASON_FRANCO.SALES_ORDER_REASON) || '-' || COALESCE(DO_REASON.SALES_ORDER_REASON_DESC, DO_REASON_FRANCO.SALES_ORDER_REASON_DESC), ''
	    ) = '' THEN FALSE
	    ELSE TRUE
	END AS DELIVERY_REJECTION_FLAG,
	NULL AS DELIVERY_REJECTION_REASON_GROUP,
	CASE 
    	WHEN SB2.POSTING_STATUS IS NULL OR SB2.POSTING_STATUS_DESCRIPTION IS NULL THEN SB2.POSTING_STATUS_DESCRIPTION 
    	ELSE SB2.POSTING_STATUS || '-' || SB2.POSTING_STATUS_DESCRIPTION 
  	END AS BILLING_STATUS,
	CASE 
        WHEN SO2.SALES_ORDER_TYPE = 'ZKS2' AND SO2.CUSTOMER = 'JID90HA000' THEN 'Interco Automation MT'
        ELSE 'Non Interco'
	END AS CATEGORY_INTERCO,
	-- DOCUMENT NUMBER --
	H2.SALES_ORDER_NUMBER AS SALES_ORDER_NUMBER_INTERCO,
	H2.DELIVERY_NUMBER AS DELIVERY_NUMBER_INTERCO,
	SCM_F.MATERIAL_DOCUMENT_NUMBER AS GI_NUMBER_INTERCO,
	SD_F.DELIVERY_POD_STATUS AS POD_STATUS_INTERCO,
	F.SO_CSGMNT_NUMBER AS SO_CONS_INTERCO,
	F.DO_CSGMNT_NUMBER AS DO_CONS_INTERCO,
	SCM_C.MATERIAL_DOCUMENT_NUMBER AS GI_CONS_INTERCO,
	H2.BILLING_NUMBER AS BILLING_NUMBER_INTERCO,
	TF2.TTF_NUMBER AS TF_NUMBER_INTERCO,
    SBC2.BILLING_CLEARING_DOC AS BILLING_CLEARING_DOC_INTERCO,
FROM F_SALES_INTERCO_HEADER H
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM,COMPANY_CODE,PLANT,CUSTOMER,CUSTOMER_SHIP_TO,SALES_OFFICE,DIVISION,DIVISION_DESC,DISTRIBUTION_CHANNEL,SALES_ORDER_TYPE,SALES_ORDER_TYPE_DESC,SALES_ORDER_STATUS,
					 SALES_ORDER_STATUS_DESC,SALES_ORDER_STATUS_REJECTION,SALES_ORDER_STATUS_REJECTION_DESC,SALES_ORDER_REASON_REJECTION_DESC,SALES_ORDER_NUMBER,CREATED_BY FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER) SO
	ON SO.SOURCE_SYSTEM = H.SOURCE_SYSTEM
	AND SO.SALES_ORDER_NUMBER = H.SALES_ORDER_NUMBER
LEFT JOIN
	(SELECT DISTINCT SOURCE_SYSTEM,DELIVERY_NUMBER,REFERENCE_SALES_ORDER_NUMBER,DELIVERY_POSTING_DATE,DELIVERY_TYPE,DELIVERY_TYPE_DESC,DELIVERY_STATUS,DELIVERY_POD_STATUS,DELIVERY_NOTE FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_DELIVERY) SD
	ON SD.SOURCE_SYSTEM = H.SOURCE_SYSTEM
	AND SD.DELIVERY_NUMBER = H.DELIVERY_NUMBER
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM,"REFERENCE",MATERIAL_DOCUMENT_NUMBER,FISCAL_YEAR FROM PROD_DB.DSTR_BI_COMMUNITY.F_SCM_STOCK_TRANSACTION_SAP) SCM
    ON SCM.SOURCE_SYSTEM = H.SOURCE_SYSTEM
	AND SCM."REFERENCE" = H.DELIVERY_NUMBER
    AND SCM.FISCAL_YEAR = '2025'
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM,CUSTOMER,POD_FLAG FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER) CPOD
	ON CPOD.SOURCE_SYSTEM = SO.SOURCE_SYSTEM 
	AND CPOD.CUSTOMER = SO.CUSTOMER
LEFT JOIN (SELECT 
        SOURCE_SYSTEM,REFERENCE_SALES_ORDER_NUMBER,BILLING_TYPE,BILLING_TYPE_DESC,
        POSTING_STATUS,POSTING_STATUS_DESCRIPTION,BILLING_NUMBER,BILLING_CREATED_DATE,
        BILLING_DATE,TERM_OF_PAYMENT,TERM_OF_PAYMENT_DESC,SUM(BILLING_NET_AMOUNT) AS TOTAL_BILLING_AMOUNT
    FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING
    GROUP BY SOURCE_SYSTEM,REFERENCE_SALES_ORDER_NUMBER,BILLING_TYPE,BILLING_TYPE_DESC,POSTING_STATUS,POSTING_STATUS_DESCRIPTION,
             BILLING_NUMBER,BILLING_CREATED_DATE,BILLING_DATE,TERM_OF_PAYMENT,TERM_OF_PAYMENT_DESC) SB
    ON SB.SOURCE_SYSTEM = H.SOURCE_SYSTEM 
    AND SB.BILLING_NUMBER = H.BILLING_NUMBER 
   	AND SB.BILLING_TYPE NOT IN ('ZB50','ZB99')
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM,BILLING_NUMBER,TTF_NUMBER,TTF_DOC_TYPE FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_TTF) TF
    ON TF.SOURCE_SYSTEM = SB.SOURCE_SYSTEM
    AND TF.BILLING_NUMBER = SB.BILLING_NUMBER
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM,BILLING_NUMBER,BILLING_CLEARING_DOC FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_CLEARING) SBC
    ON SBC.SOURCE_SYSTEM = SB.SOURCE_SYSTEM
    AND SBC.BILLING_NUMBER = SB.BILLING_NUMBER
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM,COMPANY_CODE,SALES_ORDER_EXTERNAL_DOCUMENT,SALES_ORDER_NUMBER,DELIVERY_NUMBER,BILLING_NUMBER FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_INTERCO_HEADER) H2
    ON H2.SALES_ORDER_EXTERNAL_DOCUMENT = H.SALES_ORDER_NUMBER
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM,COMPANY_CODE,PLANT,CUSTOMER,CUSTOMER_SHIP_TO,SALES_OFFICE,DIVISION,DIVISION_DESC,DISTRIBUTION_CHANNEL,SALES_ORDER_TYPE,SALES_ORDER_TYPE_DESC,SALES_ORDER_STATUS,
					 SALES_ORDER_STATUS_DESC,SALES_ORDER_STATUS_REJECTION,SALES_ORDER_STATUS_REJECTION_DESC,SALES_ORDER_REASON_REJECTION_DESC,SALES_ORDER_NUMBER,CREATED_BY 
					 FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER) SO2
	ON SO2.SOURCE_SYSTEM = H2.SOURCE_SYSTEM
	AND SO2.SALES_ORDER_NUMBER = H2.SALES_ORDER_NUMBER
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM,DELIVERY_NUMBER,DELIVERY_TYPE,DELIVERY_TYPE_DESC,DELIVERY_STATUS,DELIVERY_POD_STATUS,DELIVERY_POSTING_DATE,DELIVERY_CREATED_DATE,DELIVERY_ACTUAL_DATE FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_DELIVERY) SD_F
	ON SD_F.SOURCE_SYSTEM = H2.SOURCE_SYSTEM
	AND SD_F.DELIVERY_NUMBER = H2.DELIVERY_NUMBER
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM,"REFERENCE",MATERIAL_DOCUMENT_NUMBER,ENTRY_DATE,POSTING_DATE,FISCAL_YEAR FROM PROD_DB.DSTR_BI_COMMUNITY.F_SCM_STOCK_TRANSACTION_SAP) SCM_F
    ON SCM_F.SOURCE_SYSTEM = SD_F.SOURCE_SYSTEM
    AND SCM_F."REFERENCE" = SD_F.DELIVERY_NUMBER
    AND SCM_F.FISCAL_YEAR = '2025'
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM,REFERENCE_SALES_ORDER_NUMBER,BILLING_NUMBER,BILLING_TYPE,POSTING_STATUS,POSTING_STATUS_DESCRIPTION FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING) SB2
    ON SB2.SOURCE_SYSTEM = H2.SOURCE_SYSTEM
    AND SB2.REFERENCE_SALES_ORDER_NUMBER = H2.SALES_ORDER_NUMBER
    AND SB2.BILLING_TYPE NOT IN ('ZB50','ZB99')
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM,BILLING_NUMBER,TTF_NUMBER FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_TTF) TF2
    ON TF2.SOURCE_SYSTEM = SB2.SOURCE_SYSTEM
    AND TF2.BILLING_NUMBER = SB2.BILLING_NUMBER
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM,BILLING_NUMBER,BILLING_CLEARING_DOC FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_CLEARING) SBC2
    ON SBC2.SOURCE_SYSTEM = SB2.SOURCE_SYSTEM
    AND SBC2.BILLING_NUMBER = SB2.BILLING_NUMBER
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM,SALES_ORDER_NUMBER,SO_CSGMNT_NUMBER,DO_CSGMNT_NUMBER FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_FLOW_ORDER_DOCUMENT_FLOW) F
	ON F.SOURCE_SYSTEM = H2.SOURCE_SYSTEM
    AND F.SALES_ORDER_NUMBER = H2.SALES_ORDER_NUMBER 
LEFT JOIN (
	SELECT DISTINCT DO.SOURCE_SYSTEM, DELIVERY_NUMBER,REFERENCE_SALES_ORDER_NUMBER, SO.REFERENCE_DOCUMENT_NUMBER,  DO.SALES_ORDER_REASON, DO.SALES_ORDER_REASON_DESC 
	FROM F_SALES_DELIVERY DO
	LEFT JOIN F_SALES_SALES_ORDER SO ON DO.REFERENCE_SALES_ORDER_NUMBER = SO.SALES_ORDER_NUMBER AND DO.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
	WHERE DO.SOURCE_SYSTEM = 'PE2' AND DO.SALES_ORDER_REASON IS NOT NULL
	) DO_REASON 
		ON F.SALES_ORDER_NUMBER = DO_REASON.REFERENCE_DOCUMENT_NUMBER AND F.SOURCE_SYSTEM = DO_REASON.SOURCE_SYSTEM
LEFT JOIN (
	SELECT DISTINCT DO.SOURCE_SYSTEM, DELIVERY_NUMBER,REFERENCE_SALES_ORDER_NUMBER, SO.REFERENCE_DOCUMENT_NUMBER,  DO.SALES_ORDER_REASON, DO.SALES_ORDER_REASON_DESC 
	FROM F_SALES_DELIVERY DO
	LEFT JOIN F_SALES_SALES_ORDER SO ON DO.REFERENCE_SALES_ORDER_NUMBER = SO.SALES_ORDER_NUMBER AND DO.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
	WHERE DO.SOURCE_SYSTEM = 'PE2' AND DO.SALES_ORDER_REASON IS NOT NULL
	) DO_REASON_FRANCO 
	ON F.SO_CSGMNT_NUMBER = DO_REASON_FRANCO.REFERENCE_DOCUMENT_NUMBER AND F.SOURCE_SYSTEM = DO_REASON_FRANCO.SOURCE_SYSTEM
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM,DELIVERY_NUMBER,DELIVERY_TYPE,DELIVERY_TYPE_DESC,DELIVERY_STATUS,DELIVERY_POD_STATUS,DELIVERY_POSTING_DATE,DELIVERY_CREATED_DATE,DELIVERY_ACTUAL_DATE FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_DELIVERY) SD_C
	ON SD_C.SOURCE_SYSTEM = F.SOURCE_SYSTEM
	AND SD_C.DELIVERY_NUMBER = F.DO_CSGMNT_NUMBER
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM,"REFERENCE",MATERIAL_DOCUMENT_NUMBER,ENTRY_DATE,POSTING_DATE,FISCAL_YEAR FROM PROD_DB.DSTR_BI_COMMUNITY.F_SCM_STOCK_TRANSACTION_SAP) SCM_C
    ON SCM_C.SOURCE_SYSTEM = SD_C.SOURCE_SYSTEM
    AND SCM_C."REFERENCE" = SD_C.DELIVERY_NUMBER
    AND SCM_C.FISCAL_YEAR = '2025'
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, CUSTOMER, CUSTOMER_NAME, REGION FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER) CUST
    ON CUST.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
    AND CUST.CUSTOMER = SO.CUSTOMER
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, CUSTOMER, CUSTOMER_NAME FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER) CUSTSH
    ON CUSTSH.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
    AND CUSTSH.CUSTOMER = SO.CUSTOMER_SHIP_TO
LEFT JOIN (SELECT SOURCE_SYSTEM, CUSTOMER, SALES_OFFICE, SALES_OFFICE_DESC, SALES_DIVISION 
           FROM (SELECT SOURCE_SYSTEM, CUSTOMER, SALES_OFFICE, SALES_OFFICE_DESC, SALES_DIVISION,
                        ROW_NUMBER() OVER (PARTITION BY SOURCE_SYSTEM, CUSTOMER 
                                           ORDER BY CASE WHEN SALES_OFFICE <> '9001' THEN 0 ELSE 1 END, SALES_OFFICE) AS RN
                 FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER
                 WHERE BLOCK_FOR_SALES = 'Non block' AND DELETION_FOR_SALES = 'Non delete')
           QUALIFY RN = 1) CUST1
    ON CUST1.SOURCE_SYSTEM = SO.SOURCE_SYSTEM AND CUST1.CUSTOMER = SO.CUSTOMER
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, SALES_OFFICE, SALES_OFFICE_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER
           WHERE BLOCK_FOR_SALES = 'Non block' AND DELETION_FOR_SALES = 'Non delete') CUSTSO
    ON CUSTSO.SOURCE_SYSTEM = SO.SOURCE_SYSTEM AND CUSTSO.SALES_OFFICE = SO.SALES_OFFICE
LEFT JOIN (SELECT SOURCE_SYSTEM, COMPANY_CODE, COMPANY_NAME FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT) CP
    ON CP.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
    AND CP.COMPANY_CODE = SO.COMPANY_CODE
LEFT JOIN (SELECT SOURCE_SYSTEM, PLANT, PLANT_NAME FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT) CP1
    ON CP1.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
    AND CP1.PLANT = SO.PLANT
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, DISTRIBUTION_CHANNEL, DISTRIBUTION_CHANNEL_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_AREA) SA
    ON SA.SOURCE_SYSTEM = SO.SOURCE_SYSTEM 
    AND SA.DISTRIBUTION_CHANNEL = SO.DISTRIBUTION_CHANNEL
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, SALES_DIVISION, SALES_DIVISION_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_AREA) SA1
    ON SA1.SOURCE_SYSTEM = CUST1.SOURCE_SYSTEM
    AND SA1.SALES_DIVISION = CUST1.SALES_DIVISION 
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, REGION, REGION_DESCRIPTION FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_REGION) DSR
    ON DSR.SOURCE_SYSTEM = CUST.SOURCE_SYSTEM
    AND DSR.REGION = CUST.REGION
WHERE H.SALES_ORDER_NUMBER IN ('1207560670','1207560170','1207560566','1207560580','1207559384','1207543944','1207543014')
GROUP BY
    -- SELLING ENTITY BASIC INFORMATION
    H.COMPANY_CODE,
    CP.COMPANY_NAME,
    SO.PLANT,
    CP1.PLANT_NAME,
    SO.CUSTOMER,
    CUST.CUSTOMER_NAME,
    SO.CUSTOMER_SHIP_TO,
    CUSTSH.CUSTOMER_NAME,
    SO.SALES_OFFICE,
    CUST1.SALES_OFFICE,
    CUST1.SALES_OFFICE_DESC,
    CUSTSO.SALES_OFFICE_DESC,
    SO.DIVISION,
    SO.DIVISION_DESC,
    SO.DISTRIBUTION_CHANNEL,
    SA.DISTRIBUTION_CHANNEL_DESC,
    CUST.REGION,DSR.REGION,
    DSR.REGION_DESCRIPTION,
    SB.TERM_OF_PAYMENT,
    SB.TERM_OF_PAYMENT_DESC,
    CPOD.POD_FLAG,
    -- DOC TYPE
    SO.SALES_ORDER_TYPE,
    SO.SALES_ORDER_TYPE_DESC,
    SD.DELIVERY_TYPE,
    SD.DELIVERY_TYPE_DESC,
    SB.BILLING_TYPE,
    SB.BILLING_TYPE_DESC,
    TF.TTF_DOC_TYPE,
    -- DOC STATUS
    SO.SALES_ORDER_STATUS,
    SO.SALES_ORDER_STATUS_DESC,
    SO.SALES_ORDER_STATUS_REJECTION,
    SO.SALES_ORDER_STATUS_REJECTION_DESC,
    SO.SALES_ORDER_REASON_REJECTION_DESC,
    SD.DELIVERY_STATUS,
    SD.DELIVERY_POD_STATUS,
    SB.POSTING_STATUS,
    SB.POSTING_STATUS_DESCRIPTION,
    SO.SALES_ORDER_TYPE,  -- digunakan pada CATEGORY
    -- DOC NUMBER (SELLING ENTITY)
    SO.CREATED_BY,
    H.SALES_ORDER_NUMBER,
    H.DELIVERY_NUMBER,
    SCM.MATERIAL_DOCUMENT_NUMBER,
    SD.DELIVERY_POD_STATUS,
    H.BILLING_NUMBER,
    TF.TTF_NUMBER,
    SBC.BILLING_CLEARING_DOC,
    H.PO_NUM_REQ,
    H.GR_NUM,
    H.INV_NUM,
    -- PRODUCTION ENTITY BASIC INFO
    H2.COMPANY_CODE,
    SO2.PLANT,SO2.CUSTOMER,
    SO2.DISTRIBUTION_CHANNEL,
    SO2.SALES_ORDER_STATUS,
    SO2.SALES_ORDER_STATUS_DESC,
    SO2.SALES_ORDER_STATUS_REJECTION,
    SO2.SALES_ORDER_STATUS_REJECTION_DESC,
    SO2.SALES_ORDER_REASON_REJECTION_DESC,
    SD_F.DELIVERY_STATUS,
    SD_C.DELIVERY_STATUS,
    SD_F.DELIVERY_POD_STATUS,
    SD_C.DELIVERY_POD_STATUS,
    DO_REASON.SALES_ORDER_REASON,
    DO_REASON.SALES_ORDER_REASON_DESC,
    DO_REASON_FRANCO.SALES_ORDER_REASON,
    DO_REASON_FRANCO.SALES_ORDER_REASON_DESC,
    SB2.POSTING_STATUS,
    SB2.POSTING_STATUS_DESCRIPTION,
    SO2.SALES_ORDER_TYPE,
    -- PRODUCTION ENTITY DOCUMENT NUMBERS
    H2.SALES_ORDER_NUMBER,
    H2.DELIVERY_NUMBER,
    SCM_F.MATERIAL_DOCUMENT_NUMBER,
    SD_F.DELIVERY_POD_STATUS,
    F.SO_CSGMNT_NUMBER,
    F.DO_CSGMNT_NUMBER,
    SCM_C.MATERIAL_DOCUMENT_NUMBER,
    H2.BILLING_NUMBER,
    TF2.TTF_NUMBER,
    SBC2.BILLING_CLEARING_DOC
;
