SELECT
	SO.COMPANY_CODE,
	SO.CUSTOMER,
	SO.SALES_ORDER_TYPE || '-' || SO.SALES_ORDER_TYPE_DESC AS SO_CUSTOMER_TYPE,
	CASE 
    	WHEN SO.SALES_ORDER_TYPE = 'ZB20' THEN 'Interco Automation MT'
        ELSE 'Non Interco'
	END AS CATEGORY,
	SO.SALES_ORDER_NUMBER AS SALES_ORDER_NUMBER_CUSTOMER,
    SD.DELIVERY_NUMBER,
    SCM.MATERIAL_DOCUMENT_NUMBER AS GI_NUMBER,
    TRY_TO_DATE(SD.DELIVERY_POSTING_DATE, 'YYYYMMDD') AS POD_DATE,
    SB.BILLING_NUMBER,
    TF.TTF_NUMBER,
    SBC.BILLING_CLEARING_DOC,
	CASE 
		WHEN SO.SALES_ORDER_TYPE = 'ZB20' THEN SO1.SALES_ORDER_NUMBER
        ELSE SO.SALES_ORDER_EXTERNAL_DOCUMENT
    END AS SALES_ORDER_INTERCO,
    SD2.DELIVERY_NUMBER AS DELIVERY_NUMBER_INTERCO,
    SCM2.MATERIAL_DOCUMENT_NUMBER AS GI_NUMBER_INTERCO,
    TRY_TO_DATE(SD2.DELIVERY_POSTING_DATE, 'YYYYMMDD') AS POD_INTERCO_DATE,
	F.SO_CSGMNT_NUMBER AS SO_CONS_NUMBER,
	F.DO_CSGMNT_NUMBER AS DO_CONS_NUMBER,
	SCM3.MATERIAL_DOCUMENT_NUMBER AS GI_CONS_NUMBER_INTERCO,
	TRY_TO_DATE(SD3.DELIVERY_POSTING_DATE, 'YYYYMMDD') AS POD_CONS_DATE,
    SB2.BILLING_NUMBER AS BILLING_NUMBER_INTERCO
FROM F_SALES_SALES_ORDER SO
LEFT JOIN
	(SELECT DISTINCT SOURCE_SYSTEM,DELIVERY_NUMBER,REFERENCE_SALES_ORDER_NUMBER,DELIVERY_POSTING_DATE FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_DELIVERY) SD
	ON SD.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
	AND SD.REFERENCE_SALES_ORDER_NUMBER = SO.SALES_ORDER_NUMBER
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM,"REFERENCE",MATERIAL_DOCUMENT_NUMBER,FISCAL_YEAR FROM PROD_DB.DSTR_BI_COMMUNITY.F_SCM_STOCK_TRANSACTION_SAP) SCM
    ON SCM.SOURCE_SYSTEM = SD.SOURCE_SYSTEM
	AND SCM."REFERENCE" = SD.DELIVERY_NUMBER
    AND SCM.FISCAL_YEAR = '2025'
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM,REFERENCE_SALES_ORDER_NUMBER,BILLING_NUMBER,BILLING_TYPE FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING) SB
	ON SB.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
	AND SB.REFERENCE_SALES_ORDER_NUMBER = SO.SALES_ORDER_NUMBER
	AND SB.BILLING_TYPE NOT IN ('ZB50','ZB99')
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM,BILLING_NUMBER,TTF_NUMBER FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_TTF) TF
    ON TF.SOURCE_SYSTEM = SB.SOURCE_SYSTEM
    AND TF.BILLING_NUMBER = SB.BILLING_NUMBER
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM,BILLING_NUMBER,BILLING_CLEARING_DOC FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_CLEARING) SBC
    ON SBC.SOURCE_SYSTEM = SB.SOURCE_SYSTEM
    AND SBC.BILLING_NUMBER = SB.BILLING_NUMBER
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM,SALES_ORDER_EXTERNAL_DOCUMENT, SALES_ORDER_NUMBER, SALES_ORDER_TYPE FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER) SO1
    ON SO1.SALES_ORDER_EXTERNAL_DOCUMENT = SO.SALES_ORDER_NUMBER
    AND SO1.SALES_ORDER_TYPE <> 'ZKS3'
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM,SALES_ORDER_NUMBER,SO_CSGMNT_NUMBER,DO_CSGMNT_NUMBER FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_FLOW_ORDER_DOCUMENT_FLOW) F
	ON F.SOURCE_SYSTEM = SO1.SOURCE_SYSTEM
    AND F.SALES_ORDER_NUMBER = SO1.SALES_ORDER_NUMBER 
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM,DELIVERY_NUMBER,REFERENCE_SALES_ORDER_NUMBER,DELIVERY_POSTING_DATE FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_DELIVERY) SD2
    ON SD2.SOURCE_SYSTEM = SO1.SOURCE_SYSTEM
    AND SD2.REFERENCE_SALES_ORDER_NUMBER = SO1.SALES_ORDER_NUMBER
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM,DELIVERY_NUMBER,REFERENCE_SALES_ORDER_NUMBER,DELIVERY_POSTING_DATE FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_DELIVERY) SD3
    ON SD3.SOURCE_SYSTEM = F.SOURCE_SYSTEM
    AND SD3.REFERENCE_SALES_ORDER_NUMBER = F.SO_CSGMNT_NUMBER
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM,"REFERENCE",MATERIAL_DOCUMENT_NUMBER,FISCAL_YEAR FROM PROD_DB.DSTR_BI_COMMUNITY.F_SCM_STOCK_TRANSACTION_SAP) SCM2
    ON SCM2.SOURCE_SYSTEM = SD2.SOURCE_SYSTEM
    AND SCM2."REFERENCE" = SD2.DELIVERY_NUMBER
    AND SCM2.FISCAL_YEAR = '2025'
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM,"REFERENCE",MATERIAL_DOCUMENT_NUMBER,FISCAL_YEAR FROM PROD_DB.DSTR_BI_COMMUNITY.F_SCM_STOCK_TRANSACTION_SAP) SCM3
    ON SCM3.SOURCE_SYSTEM = F.SOURCE_SYSTEM
    AND SCM3."REFERENCE" = F.DO_CSGMNT_NUMBER
    AND SCM3.FISCAL_YEAR = '2025'
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM,REFERENCE_SALES_ORDER_NUMBER,BILLING_NUMBER,BILLING_TYPE FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING) SB2
    ON SB2.SOURCE_SYSTEM = SO1.SOURCE_SYSTEM
    AND SB2.REFERENCE_SALES_ORDER_NUMBER = SO1.SALES_ORDER_NUMBER
    AND SB2.BILLING_TYPE NOT IN ('ZB50','ZB99')
LEFT JOIN F_SALES_INTERCO_HEADER HDR
	ON HDR.SALES_ORDER_NUMBER = SO.SALES_ORDER_NUMBER
WHERE SO.SALES_ORDER_TYPE = 'ZB20'
AND SO.SALES_ORDER_NUMBER IN ('1207543944','1207543014')
GROUP BY
	SO.COMPANY_CODE,SO.CUSTOMER,
	SO.SALES_ORDER_TYPE,SO.SALES_ORDER_TYPE_DESC,
	SO.SALES_ORDER_TYPE,
	SO.SALES_ORDER_NUMBER,SO.SALES_ORDER_EXTERNAL_DOCUMENT,
    SD.DELIVERY_NUMBER,SD.DELIVERY_POSTING_DATE,
    SD2.DELIVERY_NUMBER,SD2.DELIVERY_POSTING_DATE,SD3.DELIVERY_POSTING_DATE,
    SCM.MATERIAL_DOCUMENT_NUMBER,SCM2.MATERIAL_DOCUMENT_NUMBER,SCM3.MATERIAL_DOCUMENT_NUMBER,
    SB.BILLING_NUMBER,TF.TTF_NUMBER,SBC.BILLING_CLEARING_DOC,
	SO1.SALES_ORDER_NUMBER,SB2.BILLING_NUMBER,F.SO_CSGMNT_NUMBER,F.DO_CSGMNT_NUMBER
;
