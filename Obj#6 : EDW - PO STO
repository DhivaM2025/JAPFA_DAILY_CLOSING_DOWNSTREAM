WITH PO_STATUS as
(
	SELECT 
		DISTINCT 
		f.SOURCE_SYSTEM , 
		f.COMPANY_CODE,
		f.PURCHASE_ORDER ,
		f.DOCUMENT_NUMBER ,
		f.LINE_ITEM ,
		f.FISCAL_YEAR ,
		f.PLANT ,
		f.MATERIAL,
		f.MATERIAL_MOVEMENT_TYPE, 
		f.DELIVERY_COMPLETED_STATUS, 
		f.DELIVERY_COMPLETED_STATUS_DESC  
	FROM F_SCM_PURCHASING_ORDER f 
	WHERE f.MATERIAL_MOVEMENT_TYPE IN ('101', '641', '351')
	
),REV_642_352 AS (
    SELECT
        SOURCE_SYSTEM,
        COMPANY_CODE,
        PURCHASE_ORDER,
        MATERIAL_DOCUMENT_OF_REVERSE,
        MATERIAL_DOC_ITEM_OF_REVERSE
    FROM F_SCM_STOCK_TRANSACTION_SAP
    WHERE MOVEMENT_TYPE IN ('642','352')
      AND SOURCE_SYSTEM = 'PE2'
      AND MATERIAL_DOCUMENT_OF_REVERSE IS NOT NULL
      AND MATERIAL_DOC_ITEM_OF_REVERSE IS NOT NULL
      
    UNION ALL 
    
    SELECT
        SOURCE_SYSTEM,
        COMPANY_CODE,
        PURCHASE_ORDER,
        MATERIAL_DOCUMENT_OF_REVERSE,
        MATERIAL_DOC_ITEM_OF_REVERSE
    FROM F_SCM_STOCK_TRANSACTION_SAP
    WHERE MOVEMENT_TYPE IN ('642')
      AND SOURCE_SYSTEM = 'PE1'
      AND MATERIAL_DOCUMENT_OF_REVERSE IS NOT NULL
      AND MATERIAL_DOC_ITEM_OF_REVERSE IS NOT NULL

), GI AS (
	SELECT
        T.SOURCE_SYSTEM,
        T.COMPANY_CODE,
        T.PURCHASE_ORDER,
        T.MATERIAL,
        T.BASE_UOM,
        T.PLANT              AS SENDER_PLANT,
        T.RECEIVING_PLANT    AS RECEIVER_PLANT,
        P.DELIVERY_COMPLETED_STATUS, 
		P.DELIVERY_COMPLETED_STATUS_DESC ,
        MIN(T.POSTING_DATE) AS POSTING_DATE_MIN,
        MAX(T.POSTING_DATE) AS POSTING_DATE_MAX,
        SUM(T.SIGNED_QUANTITY_FOR_BALANCE) AS QTY_641_642
    FROM F_SCM_STOCK_TRANSACTION_SAP T
    LEFT JOIN REV_642_352 R
    	ON T.SOURCE_SYSTEM = R.SOURCE_SYSTEM
    	AND T.COMPANY_CODE = R.COMPANY_CODE 
    	AND T.PURCHASE_ORDER = R.PURCHASE_ORDER 
    	AND T.MATERIAL_DOCUMENT_NUMBER = R.MATERIAL_DOCUMENT_OF_REVERSE
    	AND T.MATERIAL_DOCUMENT_ITEM = R.MATERIAL_DOC_ITEM_OF_REVERSE
    LEFT JOIN PO_STATUS P
    	ON T.SOURCE_SYSTEM = P.SOURCE_SYSTEM
    	AND T.COMPANY_CODE = P.COMPANY_CODE 
    	AND T.PURCHASE_ORDER = P.PURCHASE_ORDER 
    	AND T.MATERIAL_DOCUMENT_NUMBER = P.DOCUMENT_NUMBER
    	AND T.MATERIAL_DOCUMENT_ITEM = P.LINE_ITEM
    	AND T.FISCAL_YEAR = P.FISCAL_YEAR
    	AND T.MOVEMENT_TYPE = P.MATERIAL_MOVEMENT_TYPE
    	AND T.PLANT = P.PLANT
    WHERE T.MOVEMENT_TYPE IN ('641','351') -->PE2 using 641 and 351 for PO STO, 642 dan 352 adalah reverse nya
      AND T.MATERIAL_DOCUMENT_NUMBER IS NOT NULL
      AND T.ITEM_AUTOMATICALLY_CREATED IS NULL
      AND T.PURCHASE_ORDER IS NOT NULL
      AND T.SOURCE_SYSTEM = 'PE2'
      AND r.MATERIAL_DOCUMENT_OF_REVERSE IS NULL
    GROUP BY ALL
    HAVING SUM(T.SIGNED_QUANTITY_FOR_BALANCE) <>0
    
    UNION ALL
    
    SELECT
        T.SOURCE_SYSTEM,
        T.COMPANY_CODE,
        T.PURCHASE_ORDER,
        T.MATERIAL,
        T.BASE_UOM,
        T.PLANT              AS SENDER_PLANT,
        T.RECEIVING_PLANT    AS RECEIVER_PLANT,
        P.DELIVERY_COMPLETED_STATUS, 
		P.DELIVERY_COMPLETED_STATUS_DESC ,
        MIN(T.POSTING_DATE) AS POSTING_DATE_MIN,
        MAX(T.POSTING_DATE) AS POSTING_DATE_MAX,
        SUM(T.SIGNED_QUANTITY_FOR_BALANCE) AS QTY_641_642
    FROM F_SCM_STOCK_TRANSACTION_SAP T
    LEFT JOIN REV_642_352 R
    	ON T.SOURCE_SYSTEM = R.SOURCE_SYSTEM
    	AND T.COMPANY_CODE = R.COMPANY_CODE 
    	AND T.PURCHASE_ORDER = R.PURCHASE_ORDER 
    	AND T.MATERIAL_DOCUMENT_NUMBER = R.MATERIAL_DOCUMENT_OF_REVERSE
    	AND T.MATERIAL_DOCUMENT_ITEM = R.MATERIAL_DOC_ITEM_OF_REVERSE
    LEFT JOIN PO_STATUS P
    	ON T.SOURCE_SYSTEM = P.SOURCE_SYSTEM
    	AND T.COMPANY_CODE = P.COMPANY_CODE 
    	AND T.PURCHASE_ORDER = P.PURCHASE_ORDER 
    	AND T.MATERIAL_DOCUMENT_NUMBER = P.DOCUMENT_NUMBER
    	AND T.MATERIAL_DOCUMENT_ITEM = P.LINE_ITEM
    	AND T.FISCAL_YEAR = P.FISCAL_YEAR
    	AND T.MOVEMENT_TYPE = P.MATERIAL_MOVEMENT_TYPE
    	AND T.PLANT = P.PLANT
    WHERE T.MOVEMENT_TYPE IN ('641') -->PE2 using 641 and 351 for PO STO, 642 dan 352 adalah reverse nya
      AND T.MATERIAL_DOCUMENT_NUMBER IS NOT NULL
      AND T.ITEM_AUTOMATICALLY_CREATED IS NULL
      AND T.PURCHASE_ORDER IS NOT NULL
      AND T.SOURCE_SYSTEM = 'PE1'
      AND r.MATERIAL_DOCUMENT_OF_REVERSE IS NULL
    GROUP BY ALL
    HAVING SUM(T.SIGNED_QUANTITY_FOR_BALANCE) <>0
),REV_102 AS (
    SELECT
        SOURCE_SYSTEM,
        COMPANY_CODE,
        PURCHASE_ORDER,
        MATERIAL_DOCUMENT_OF_REVERSE,
        MATERIAL_DOC_ITEM_OF_REVERSE
    FROM F_SCM_STOCK_TRANSACTION_SAP
    WHERE MOVEMENT_TYPE IN ('102')
      AND MATERIAL_DOCUMENT_OF_REVERSE IS NOT NULL
      AND MATERIAL_DOC_ITEM_OF_REVERSE IS NOT NULL

),
GR AS (
SELECT
    t.SOURCE_SYSTEM,
    t.COMPANY_CODE,
    t.PURCHASE_ORDER,
    t.MATERIAL,
    T.BASE_UOM,
    t.PLANT AS RECEIVER_PLANT,
    P.DELIVERY_COMPLETED_STATUS, 
	P.DELIVERY_COMPLETED_STATUS_DESC ,
    MIN(t.POSTING_DATE) AS POSTING_DATE_MIN,
    MAX(t.POSTING_DATE) AS POSTING_DATE_MAX,
    SUM(t.SIGNED_QUANTITY_FOR_BALANCE) AS QTY_101_102
FROM F_SCM_STOCK_TRANSACTION_SAP t
LEFT JOIN REV_102 R 
	ON T.SOURCE_SYSTEM = R.SOURCE_SYSTEM
	AND T.COMPANY_CODE = R.COMPANY_CODE 
	AND T.PURCHASE_ORDER = R.PURCHASE_ORDER 
	AND T.MATERIAL_DOCUMENT_NUMBER = R.MATERIAL_DOCUMENT_OF_REVERSE
	AND T.MATERIAL_DOCUMENT_ITEM = R.MATERIAL_DOC_ITEM_OF_REVERSE
LEFT JOIN PO_STATUS P
    	ON T.SOURCE_SYSTEM = P.SOURCE_SYSTEM
    	AND T.COMPANY_CODE = P.COMPANY_CODE 
    	AND T.PURCHASE_ORDER = P.PURCHASE_ORDER 
    	AND T.MATERIAL_DOCUMENT_NUMBER = P.DOCUMENT_NUMBER
    	AND T.MATERIAL_DOCUMENT_ITEM = P.LINE_ITEM
    	AND T.FISCAL_YEAR = P.FISCAL_YEAR
    	AND T.MOVEMENT_TYPE = P.MATERIAL_MOVEMENT_TYPE
    	AND T.PLANT = P.PLANT
WHERE T.MOVEMENT_TYPE IN ('101')
  AND T.MATERIAL_DOCUMENT_NUMBER IS NOT NULL
  AND T.ITEM_AUTOMATICALLY_CREATED IS NULL
  AND T.PURCHASE_ORDER IS NOT NULL
  AND R.MATERIAL_DOC_ITEM_OF_REVERSE IS NULL
  --for PE1 dan PE2 kodenya sama 101 dan 102 untuk cancel nya
GROUP BY ALL
HAVING SUM(T.SIGNED_QUANTITY_FOR_BALANCE) <> 0
), 
adj_loss_gain AS (
    SELECT
        SOURCE_SYSTEM,
        --FISCAL_YEAR,
        COMPANY_CODE,
        --MATERIAL_DOCUMENT_YEAR,
        PURCHASE_ORDER,
        MATERIAL,
        BASE_UOM,
        PLANT,
        RECEIVING_PLANT,
        SUM(SIGNED_QUANTITY_FOR_BALANCE) AS QTY_LOSS_GAIN
    FROM F_SCM_STOCK_TRANSACTION_SAP
    WHERE MOVEMENT_TYPE IN ('Z01', 'Z19')
      AND ITEM_AUTOMATICALLY_CREATED IS NULL
      AND PURCHASE_ORDER IS NOT NULL
      AND SOURCE_SYSTEM = 'PE2'
    GROUP BY ALL
    
    UNION ALL
    
	SELECT
        SOURCE_SYSTEM,
        --FISCAL_YEAR,
        COMPANY_CODE,
        --MATERIAL_DOCUMENT_YEAR,
        PURCHASE_ORDER,
        MATERIAL,
        BASE_UOM,
        PLANT,
        RECEIVING_PLANT,
        SUM(SIGNED_QUANTITY_FOR_BALANCE) AS QTY_LOSS_GAIN
    FROM F_SCM_STOCK_TRANSACTION_SAP
    WHERE MOVEMENT_TYPE IN ('701')
      AND ITEM_AUTOMATICALLY_CREATED IS NULL
      AND PURCHASE_ORDER IS NOT NULL
      AND SOURCE_SYSTEM = 'PE1'
    GROUP BY ALL
), CURR_STOCK AS (
	SELECT f.SOURCE_SYSTEM , f.MATERIAL, f.PLANT, SUM(f.STOCK_QUANTITY ) AS STOCK_CURRENT_QUANTITY FROM F_SCM_STOCK_SAP_CURRENT f GROUP BY ALL
),
aggr AS (
SELECT
    S.SOURCE_SYSTEM,
    S.COMPANY_CODE,
    S.PURCHASE_ORDER,
    S.MATERIAL, 
    mm.MATERIAL_DESC ,
   /* R.DELIVERY_COMPLETED AS DELIVERY_STATUS,
    CASE WHEN R.DELIVERY_COMPLETED = 'X' THEN 'DELIVERY COMPLETED'
    	ELSE NULL
    END AS DELIVERY_STATUS_DESC,*/
    s.SENDER_PLANT,
    mp.PLANT_NAME AS SENDER_PLANT_NAME,
    S.RECEIVER_PLANT,
    mr.PLANT_NAME AS RECEIVER_PLANT_NAME,
    S.POSTING_DATE_MIN AS SENDER_POSTING_DATE_MIN, 
    S.POSTING_DATE_MAX AS SENDER_POSTING_DATE_MAX,
    R.POSTING_DATE_MIN AS RECEIVER_POSTING_DATE_MIN,
    R.POSTING_DATE_MAX AS RECEIVER_POSTING_DATE_MAX,
    
    SUM(s.QTY_641_642) AS QTY_GI,
    SUM(COALESCE(r.QTY_101_102,0)) AS QTY_GR,
    sum(s.QTY_641_642 + r.QTY_101_102) AS QTY_DIFF,
    sum(COALESCE(QTY_LOSS_GAIN,0)) AS QTY_LOSS_GAIN,
    S.BASE_UOM,
    
    SUM( COALESCE( PROD_DB.DSTR_BI_COMMUNITY.FUNC_GET_CONVERSION( S.Source_System, S.MATERIAL, S.BASE_UOM, 'KG' ), 1 ) * s.QTY_641_642 ) AS QTY_GI_IN_KG,
    SUM( COALESCE( PROD_DB.DSTR_BI_COMMUNITY.FUNC_GET_CONVERSION( S.Source_System, S.MATERIAL, S.BASE_UOM, 'KG' ), 1 ) * COALESCE(r.QTY_101_102,0) ) AS QTY_GR_IN_KG,
    SUM( COALESCE( PROD_DB.DSTR_BI_COMMUNITY.FUNC_GET_CONVERSION( S.Source_System, S.MATERIAL, S.BASE_UOM, 'KG' ), 1 ) * (s.QTY_641_642 + r.QTY_101_102) ) AS QTY_DIFF_IN_KG,
    SUM( COALESCE( PROD_DB.DSTR_BI_COMMUNITY.FUNC_GET_CONVERSION( S.Source_System, S.MATERIAL, S.BASE_UOM, 'KG' ), 1 ) * COALESCE(QTY_LOSS_GAIN,0) ) AS QTY_LOSS_GAIN_IN_KG,

    CS.STOCK_CURRENT_QUANTITY AS SENDER_CURRENT_STOCK_QUANTITY,
    CSR.STOCK_CURRENT_QUANTITY AS RECEIVER_CURRENT_STOCK_QUANTITY,
    CASE
        WHEN SUM(COALESCE(R.QTY_101_102, 0)) = 0
             AND COUNT(R.QTY_101_102) = 0
            THEN 'Not Yet Delivered'
        WHEN SUM(S.QTY_641_642 + COALESCE(R.QTY_101_102, 0)) <> 0
            THEN 'SELISIH'
        ELSE 'MATCH'
    END AS KETERANGAN,
    CASE WHEN s.DELIVERY_COMPLETED_STATUS = 'X' THEN 'DELIVERY COMPLETED' 
    ELSE s.DELIVERY_COMPLETED_STATUS 
    END AS GI_DELIVERY_STATUS,
	CASE WHEN R.DELIVERY_COMPLETED_STATUS = 'X' THEN 'DELIVERY COMPLETED' 
    ELSE R.DELIVERY_COMPLETED_STATUS 
    END AS GR_DELIVERY_STATUS
FROM GI s 
LEFT JOIN GR r
    ON  s.SOURCE_SYSTEM           = r.SOURCE_SYSTEM
    AND s.COMPANY_CODE            = r.COMPANY_CODE
    AND s.PURCHASE_ORDER          = r.PURCHASE_ORDER
    AND s.MATERIAL                = r.MATERIAL
    AND s.RECEIVER_PLANT 		  = r.RECEIVER_PLANT
LEFT JOIN adj_loss_gain lg 
	ON  s.SOURCE_SYSTEM           = lg.SOURCE_SYSTEM
    AND s.COMPANY_CODE            = lg.COMPANY_CODE
    AND s.PURCHASE_ORDER          = lg.PURCHASE_ORDER
    AND s.MATERIAL                = lg.MATERIAL
    AND s.RECEIVER_PLANT 		  = lg.PLANT
LEFT JOIN D_SCM_MATERIAL mm
	ON s.MATERIAL = mm.MATERIAL AND s.SOURCE_SYSTEM = mm.SOURCE_SYSTEM 
LEFT JOIN D_SCM_PLANT mp
	ON s.SENDER_PLANT = mp.PLANT AND s.SOURCE_SYSTEM = mp.SOURCE_SYSTEM 
LEFT JOIN D_SCM_PLANT mr
	ON s.RECEIVER_PLANT = mr.PLANT AND s.SOURCE_SYSTEM = mp.SOURCE_SYSTEM 
LEFT JOIN CURR_STOCK CS 
	ON S.SOURCE_SYSTEM = CS.SOURCE_SYSTEM 
	AND S.MATERIAL = CS.MATERIAL 
	AND S.SENDER_PLANT = CS.PLANT 
LEFT JOIN CURR_STOCK CSR 
	ON S.SOURCE_SYSTEM = CSR.SOURCE_SYSTEM 
	AND S.MATERIAL = CSR.MATERIAL 
	AND S.RECEIVER_PLANT = CSR.PLANT 
GROUP BY ALL )
SELECT * FROM AGGR
    ;
