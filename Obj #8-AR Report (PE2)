SELECT
    CASE 
        WHEN AR.SALES_OFFICE_DESC IS NOT NULL 
             AND AR.SALES_OFFICE_DESC <> ''
            THEN SPLIT_PART(AR.SALES_OFFICE_DESC, ' ', -1)
        WHEN AR.SALES_OFFICE IS NOT NULL 
             AND AR.SALES_OFFICE <> ''
            THEN AR.SALES_OFFICE
        ELSE NULL
    END AS SALES_OFFICE_LOKASI,
    AR.BILLING_NUMBER,
    AR.REFERENCE_DOCUMENT,
    AR.ACCOUNT_DOC_NUMBER,
    AR.DOCUMENT_TYPE || ' - ' || AR.DOCUMENT_TYPE_DESC AS DOCUMENT_TYPE,
    AR.CUSTOMER_GROUP || ' - ' || AR.CUSTOMER_GROUP_DESC AS CUSTOMER_GROUP,
    AR.SALES_DIVISION || ' - ' || AR.SALES_DIVISION_DESC AS SALES_DIVISION,
    AR.CUSTOMER,
    AR.CUSTOMER_NAME,
    AR.CREDIT_OWNER,
    AR.CREDIT_OWNER_NAME,
    AR.BUSINESS_NAME,
    AR.DUE_DATE,
    COALESCE(BILL.BILLING_DATE, AD.POSTING_DATE) AS BILLING_DATE,
    AR.EFFECTIVE_BASELINE_DATE AS BASELINE_DATE,
    AD.POSTING_DATE,
    AR.TOTAL_AMOUNT,
    AR.REMARKS_DOC_TYPE,
    AR.NOT_DUE,
    AR.DAYS_1_10,
    AR.DAYS_11_30,
    AR.DAYS_31_60,
    AR.DAYS_61_90,
    AR.DAYS_91_120,
    AR.DAYS_121_150,
    AR.DAYS_151_360,
    AR.OVER_361_DAYS,
    TF.TTF_DOC_DATE,
    AR.EFFECTIVE_BASELINE_DATE_FLAG,
    AR.PAYMENT_TERM_DAYS,
    CASE 
        WHEN AR.PAYMENT_TERM IN ('T014','TO14') THEN 'T014'
        WHEN AR.PAYMENT_TERM IN ('T030','TO30') THEN 'T030'
        WHEN AR.PAYMENT_TERM IN ('T045','TO45') THEN 'T045'
        ELSE AR.PAYMENT_TERM 
    END AS PAYMENT_TERM,
    AR.DISTRIBUTION_CHANNEL || ' - ' || AR.DISTRIBUTION_CHANNEL_DESC AS DISTRIBUTION_CHANNEL,
    AR.SALES_OFFICE || ' - ' || AR.SALES_OFFICE_DESC AS SALES_OFFICE,
    AR.BLOCK_FOR_SALES,
    AR.DELETION_FOR_SALES,
    CASE 
        WHEN
            ROW_NUMBER() OVER (
                PARTITION BY AR.CREDIT_OWNER
                ORDER BY 
                    CASE 
                        WHEN AR.CUSTOMER = AR.CREDIT_OWNER THEN 1
                        ELSE 2
                    END,
                    AR.BILLING_NUMBER
            ) = 1
        THEN
            MAX(NULLIF(AR.CREDIT_LIMIT, 0))
                OVER (PARTITION BY AR.CREDIT_OWNER)
        ELSE NULL
    END AS CREDIT_LIMIT_PER_CREDIT_OWNER,
    CASE 
        WHEN
            ROW_NUMBER() OVER (
                PARTITION BY AR.CREDIT_OWNER
                ORDER BY 
                    CASE 
                        WHEN AR.CUSTOMER = AR.CREDIT_OWNER THEN 1
                        ELSE 2
                    END,
                    AR.BILLING_NUMBER
            ) = 1
        THEN
            SUM(AR.TOTAL_AMOUNT)
                OVER (PARTITION BY AR.CREDIT_OWNER)
        ELSE NULL
    END AS TOTAL_AMOUNT_PER_CREDIT_OWNER,
    CASE 
        WHEN
            SUM(AR.TOTAL_AMOUNT)
                OVER (PARTITION BY AR.CREDIT_OWNER)
            >
            MAX(NULLIF(AR.CREDIT_LIMIT, 0))
                OVER (PARTITION BY AR.CREDIT_OWNER)
        THEN TRUE
        ELSE FALSE
    END AS IS_EXCEED_CL,
    CASE
        WHEN AR.DUE_DATE < CURRENT_DATE THEN 'Overdue'
        ELSE 'Not Due'
    END AS DUE_STATUS,
    CASE 
        WHEN MAX(
            CASE 
                WHEN AR.DUE_DATE < CURRENT_DATE THEN 1 
                ELSE 0 
            END
        ) OVER (PARTITION BY AR.CUSTOMER) = 1
        THEN 'Overdue'
        ELSE 'Not Due'
    END AS CUSTOMER_DUE,
    AR.SOURCE_SYSTEM,
    AR.COMPANY_CODE,
    AR.CUSTOMER_CLASS || ' - ' || AR.CUSTOMER_CLASS_DESC AS CUSTOMER_CLASS,
    AR.FP_CORETAX,
    MAX(
        CASE
            WHEN AR.DUE_DATE < CURRENT_DATE
            THEN DATEDIFF('day', AR.DUE_DATE, CURRENT_DATE)
            ELSE 0
        END
    ) OVER (PARTITION BY AR.CREDIT_OWNER) AS MAX_OVERDUE_DAYS,
    CASE
        WHEN AR.DUE_DATE >= CURRENT_DATE
            THEN 'Not Due'
        WHEN MAX(
            CASE
                WHEN AR.DUE_DATE < CURRENT_DATE
                THEN DATEDIFF('day', AR.DUE_DATE, CURRENT_DATE)
                ELSE 0
            END
        ) OVER (PARTITION BY AR.CREDIT_OWNER) > 14
            THEN '>14 hari'
        ELSE
            MAX(
                CASE
                    WHEN AR.DUE_DATE < CURRENT_DATE
                    THEN DATEDIFF('day', AR.DUE_DATE, CURRENT_DATE)
                    ELSE 0
                END
            ) OVER (PARTITION BY AR.CREDIT_OWNER) || ' hari'
    END AS TOTAL_OVERDUE
FROM PROD_DB.DSTR_BI_COMMUNITY.F_FINANCE_AR_AGING_CUSTOMER_CURRENT AR
LEFT JOIN (
    SELECT 
        SOURCE_SYSTEM, 
        CUSTOMER, 
        SALES_OFFICE, 
        SALES_OFFICE_DESC,
        ROW_NUMBER() OVER (
            PARTITION BY CUSTOMER 
            ORDER BY SALES_OFFICE
        ) AS rn
    FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER
) CUST
    ON AR.SOURCE_SYSTEM = CUST.SOURCE_SYSTEM
   AND AR.CUSTOMER = CUST.CUSTOMER
   AND CUST.rn = 1
LEFT JOIN (
    SELECT 
        SOURCE_SYSTEM, 
        BILLING_NUMBER, 
        MIN(TO_DATE(BILLING_DATE, 'YYYYMMDD')) AS BILLING_DATE
    FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING
    GROUP BY SOURCE_SYSTEM, BILLING_NUMBER
) BILL
    ON AR.SOURCE_SYSTEM = BILL.SOURCE_SYSTEM
   AND AR.BILLING_NUMBER = BILL.BILLING_NUMBER
LEFT JOIN (
    SELECT 
        SOURCE_SYSTEM, 
        BILLING_NUMBER, 
        MIN(TO_DATE(TTF_DOC_DATE, 'YYYYMMDD')) AS TTF_DOC_DATE
    FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_TTF
    GROUP BY SOURCE_SYSTEM, BILLING_NUMBER
) TF
    ON AR.SOURCE_SYSTEM = TF.SOURCE_SYSTEM
   AND AR.BILLING_NUMBER = TF.BILLING_NUMBER
LEFT JOIN (
    SELECT 
        SOURCE_SYSTEM, 
        ACCOUNTING_DOCUMENT_NUMBER, 
        FISCAL_YEAR,
        TO_DATE(POSTING_DATE, 'YYYYMMDD') AS POSTING_DATE
    FROM PROD_DB.DSTR_BI_COMMUNITY.F_FINANCE_ACCOUNTING_DOCUMENT_HEADER
    GROUP BY 
        SOURCE_SYSTEM, 
        ACCOUNTING_DOCUMENT_NUMBER, 
        POSTING_DATE, 
        FISCAL_YEAR
) AD
    ON AR.SOURCE_SYSTEM = AD.SOURCE_SYSTEM
   AND AR.ACCOUNT_DOC_NUMBER = AD.ACCOUNTING_DOCUMENT_NUMBER
   AND AR.FISCAL_YEAR = AD.FISCAL_YEAR
WHERE AR.SOURCE_SYSTEM = 'PE2';
