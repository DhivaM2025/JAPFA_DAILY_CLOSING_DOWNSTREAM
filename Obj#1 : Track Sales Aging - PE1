-- OBJECTIVE #1 - DASHBOARD #2 : SALES AGING --
-- STEP 1 : RUN QUERY BELOW FOR GET SALES AGING - PE1 ONLY --
SELECT 
-- BASIC DATA --
	SO.COMPANY_CODE || '-' || CP.COMPANY_NAME AS COMPANY,
	SO.PLANT || '-' || CP1.PLANT_NAME AS PLANT,
	SO.CUSTOMER,
	CUST.CUSTOMER_NAME AS CUSTOMER_SO_NAME,
	SO.CUSTOMER_SHIP_TO,
	CUSTSH.CUSTOMER_NAME AS CUSTOMER_SO_NAME,
	CASE
  		WHEN CUST1.SALES_OFFICE IS NULL OR CUST1.SALES_OFFICE_DESC IS NULL THEN CUST1.SALES_OFFICE
  		ELSE CUST1.SALES_OFFICE || '-' || CUST1.SALES_OFFICE_DESC
	END AS SALES_OFFICE,
	CASE 
    	WHEN CUST1.SALES_OFFICE IS NOT NULL AND CUST1.SALES_OFFICE <> '' AND CUST1.SALES_OFFICE_DESC IS NOT NULL AND CUST1.SALES_OFFICE_DESC <> '' 
        THEN LEFT(CUST1.SALES_OFFICE_DESC, 3)
		WHEN CUST1.SALES_OFFICE IS NOT NULL AND CUST1.SALES_OFFICE <> '' AND (CUST1.SALES_OFFICE_DESC IS NULL OR CUST1.SALES_OFFICE_DESC = '') 
        THEN CUST1.SALES_OFFICE
    ELSE NULL
  	END AS SALES_OFFICE_LOKASI,
	SO.DIVISION || '-' || SO.DIVISION_DESC AS DIVISION,
	SO.DISTRIBUTION_CHANNEL || '-' || SA.DISTRIBUTION_CHANNEL_DESC AS DISTRIBUTION_CHANNEL,
	CUST.REGION || '-' || DSR.REGION_DESC AS REGION,
	CASE 
		WHEN DSR.REGION IN ('01', '02', '03', '04', '05', '28') THEN 'PULAU JAWA'
    	ELSE 'LUAR JAWA'
	END AS STATUS_REGION,
	CASE 
    	WHEN SB.TERM_OF_PAYMENT_DESC IS NULL OR SB.TERM_OF_PAYMENT = '' THEN SB.TERM_OF_PAYMENT
    	ELSE SB.TERM_OF_PAYMENT || '-' || SB.TERM_OF_PAYMENT_DESC
	END AS TOP,
	CPOD.POD_FLAG,
-- DOC TYPE --
	SO.SALES_ORDER_TYPE || '-' || SO.SALES_ORDER_TYPE_DESC AS SO_TYPE,
	SD.DELIVERY_TYPE || '-' || SD.DELIVERY_TYPE_DESC AS DELIVERY_TYPE,
	SB.BILLING_TYPE || '-' || SB.BILLING_TYPE_DESC AS BILLING_TYPE, 
	TF.TTF_DOC_TYPE AS TFTG_TYPE,
-- DOC STATUS --
	CASE 
    	WHEN SO.SALES_ORDER_STATUS IS NULL OR SO.SALES_ORDER_STATUS_DESC IS NULL THEN SO.SALES_ORDER_STATUS_DESC 
    	ELSE SO.SALES_ORDER_STATUS || '-' || SO.SALES_ORDER_STATUS_DESC 
	END AS SALES_ORDER_STATUS,
	SO.SALES_ORDER_STATUS_REJECTION || '-' || SO.SALES_ORDER_STATUS_REJECTION_DESC AS SALES_ORDER_STATUS_REJECTION,
	CASE 
  		WHEN SD.DELIVERY_STATUS = 'Not yet processed' THEN 'A-Not yet processed'
    	WHEN SD.DELIVERY_STATUS = 'Partially processed' THEN 'B-Partially processed'
    	WHEN SD.DELIVERY_STATUS = 'Completely processed' THEN 'C-Completely processed'
    ELSE SD.DELIVERY_STATUS
	END AS DELIVERY_STATUS,
	CASE 
  		WHEN SD.DELIVERY_POD_STATUS = 'Not yet processed' THEN 'A-Not yet processed'
    	WHEN SD.DELIVERY_POD_STATUS = 'Partially processed' THEN 'B-Partially processed'
    	WHEN SD.DELIVERY_POD_STATUS = 'Completely processed' THEN 'C-Completely processed'
    ELSE SD.DELIVERY_POD_STATUS
	END AS POD_STATUS,
	CASE 
    	WHEN SB.POSTING_STATUS IS NULL OR SB.POSTING_STATUS_DESCRIPTION IS NULL THEN SB.POSTING_STATUS_DESCRIPTION 
    	ELSE SB.POSTING_STATUS || '-' || SB.POSTING_STATUS_DESCRIPTION 
  	END AS BILLING_STATUS,
	CASE 
    	WHEN SO.SALES_ORDER_TYPE = 'ZB20' THEN 'Interco Automation MT'
        WHEN SO.SALES_ORDER_TYPE = 'ZB01' AND SO.CUSTOMER = '2000174657' THEN 'Interco Automation FS'
        ELSE 'Non Interco'
	END AS CATEGORY,
    CASE 
        WHEN (SD.DELIVERY_TYPE = 'ZB04' AND SO.PLANT || SO.DIVISION IN (
            '90EI01','90EF02','90AF01','90BB03','90EB02','90AD01','90ED01',
            '90EH01','90EO02','90AL02','90AB01','90EC01','90BB02','90AD02',
            '90AB02','90AF02','90BB01','90EE02','90EC02','90ED02','90EG01',
            '90EL01','90EK01','90EI02','90AL01'
        ))
        OR (SD.DELIVERY_TYPE = 'ZB05' AND SO.PLANT || SO.DIVISION IN (
            '90AB02','90EO02','90ED01','90AF01','90EB02','90EF02','90EI01',
            '90AB01','90AD02','90AD01','90BB01','90EC02','90EI02','90BB02',
            '90AF02','90AL01','90EE02','90AL02','90ED02'
        ))
        THEN 'Pengiriman Third Party Gudang Third Party'
        ELSE 'Pengiriman Third Party Gudang Internal'
    END AS PENGIRIMAN_CATEGORY,
-- DOC NUMBER --
	SO.CREATED_BY,
	SO.SALES_ORDER_NUMBER AS SO_NUMBER,
	CASE 
		WHEN SO.SALES_ORDER_TYPE = 'ZB20' THEN SO1.SALES_ORDER_NUMBER
    	WHEN SO.SALES_ORDER_TYPE = 'ZB01' AND SO.CUSTOMER = '2000174657' THEN SO.SALES_ORDER_EXTERNAL_DOCUMENT
        ELSE SO.SALES_ORDER_EXTERNAL_DOCUMENT
    END AS SALES_ORDER_REFERENCE,
    SD.DELIVERY_NUMBER AS DO_NUMBER,
	SCM.MATERIAL_DOCUMENT_NUMBER AS GI_NUMBER,
	SB.BILLING_NUMBER AS BILL_NUMBER,
  	TF.TTF_NUMBER AS TFTG_NUMBER,
  	SBC.BILLING_CLEARING_DOC AS BILL_CLEARING_NUMBER,
-- DATE --
	TRY_TO_DATE(SO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD') AS SO_CREATED_DATE,
	TRY_TO_DATE(SO.SALES_ORDER_DATE, 'YYYYMMDD') AS SO_DATE,
	TRY_TO_DATE(SD.DELIVERY_CREATED_DATE, 'YYYYMMDD') AS DO_CREATED_DATE,
	TRY_TO_DATE(SD.DELIVERY_ACTUAL_DATE, 'YYYYMMDD') AS DO_ACTUAL_DATE,
	TRY_TO_DATE(SCM.ENTRY_DATE, 'YYYYMMDD') AS GI_ENTRY_DATE,
	TRY_TO_DATE (SCM.POSTING_DATE, 'YYYYMMDD') AS GI_POSTING_DATE,
	TRY_TO_DATE(SD.DELIVERY_POSTING_DATE, 'YYYYMMDD') AS POD_DATE,
	/*TRY_TO_DATE(PD.POD_DATE, 'YYYYMMDD') AS TVPOD_DATE,*/
	TRY_TO_DATE(SB.BILLING_CREATED_DATE, 'YYYYMMDD') AS BILLING_CREATED_DATE,
	TRY_TO_DATE(SB.BILLING_DATE, 'YYYYMMDD') AS BILLING_DATE,
	TRY_TO_DATE(TF.TTF_CREATED_DATE, 'YYYYMMDD') AS TFTG_CREATED_DATE,
	TRY_TO_DATE(TF.TTF_DOC_DATE, 'YYYYMMDD') AS TFTG_DATE,
	TRY_TO_DATE(SBC.BILLING_CLEAR_CREATED_DATE, 'YYYYMMDD') AS BILLING_CLEAR_CREATED_DATE,
	TRY_TO_DATE(SBC.BILLING_CLEAR_DATE, 'YYYYMMDD') AS BILLING_CLEAR_DATE,
  -- DATE SELISIH
	CASE 
		WHEN TRY_TO_DATE(SD.DELIVERY_CREATED_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(SO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD') IS NOT NULL 
	    THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(SO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD'), TRY_TO_DATE(SD.DELIVERY_CREATED_DATE, 'YYYYMMDD'))) 	
	    WHEN TRY_TO_DATE(SD.DELIVERY_CREATED_DATE, 'YYYYMMDD') IS NULL AND TRY_TO_DATE(SO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD') IS NOT NULL 
	    THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(SO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD'), CURRENT_DATE))									
	    ELSE 'N/A'
	END AS SELISIH_SO_DO,
	CASE 
	    WHEN TRY_TO_DATE(SCM.ENTRY_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(SD.DELIVERY_CREATED_DATE, 'YYYYMMDD') IS NOT NULL 
	    THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(SD.DELIVERY_CREATED_DATE, 'YYYYMMDD'), TRY_TO_DATE(SCM.ENTRY_DATE, 'YYYYMMDD')))
		WHEN TRY_TO_DATE(SCM.ENTRY_DATE, 'YYYYMMDD') IS NULL AND TRY_TO_DATE(SD.DELIVERY_CREATED_DATE, 'YYYYMMDD') IS NOT NULL 
	    THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(SD.DELIVERY_CREATED_DATE, 'YYYYMMDD'), CURRENT_DATE))
	    ELSE 'N/A'
	END AS SELISIH_DO_GI,
	CASE 
	    WHEN TRY_TO_DATE(SD.DELIVERY_POSTING_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(SCM.ENTRY_DATE, 'YYYYMMDD') IS NOT NULL 
	    THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(SCM.ENTRY_DATE, 'YYYYMMDD'), TRY_TO_DATE(SD.DELIVERY_POSTING_DATE, 'YYYYMMDD')))
		WHEN TRY_TO_DATE(SD.DELIVERY_POSTING_DATE, 'YYYYMMDD') IS NULL AND TRY_TO_DATE(SCM.ENTRY_DATE, 'YYYYMMDD') IS NOT NULL 
	    THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(SCM.ENTRY_DATE, 'YYYYMMDD'), CURRENT_DATE))
	    ELSE 'N/A'
	END AS SELISIH_GI_POD,
	CASE 
	    WHEN TRY_TO_DATE(SB.BILLING_CREATED_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(SD.DELIVERY_POSTING_DATE, 'YYYYMMDD') IS NOT NULL 
	    THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(SD.DELIVERY_POSTING_DATE, 'YYYYMMDD'), TRY_TO_DATE(SB.BILLING_CREATED_DATE, 'YYYYMMDD')))
		WHEN TRY_TO_DATE(SB.BILLING_CREATED_DATE, 'YYYYMMDD') IS NULL AND TRY_TO_DATE(SD.DELIVERY_POSTING_DATE, 'YYYYMMDD') IS NOT NULL 
	    THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(SD.DELIVERY_POSTING_DATE, 'YYYYMMDD'), CURRENT_DATE))
	    ELSE 'N/A'
	END AS SELISIH_POD_BILL,
	CASE 
	    WHEN TRY_TO_DATE(TF.TTF_CREATED_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(SB.BILLING_CREATED_DATE, 'YYYYMMDD') IS NOT NULL 
	    THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(SB.BILLING_CREATED_DATE, 'YYYYMMDD'), TRY_TO_DATE(TF.TTF_CREATED_DATE, 'YYYYMMDD')))
		WHEN TRY_TO_DATE(TF.TTF_CREATED_DATE, 'YYYYMMDD') IS NULL AND TRY_TO_DATE(SB.BILLING_CREATED_DATE, 'YYYYMMDD') IS NOT NULL 
	    THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(SB.BILLING_CREATED_DATE, 'YYYYMMDD'), CURRENT_DATE))
	    ELSE 'N/A'
	END AS SELISIH_BILL_TFTG,
	CASE 
	    WHEN TRY_TO_DATE(SBC.BILLING_CLEAR_CREATED_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(TF.TTF_CREATED_DATE, 'YYYYMMDD') IS NOT NULL 
	    THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(TF.TTF_CREATED_DATE, 'YYYYMMDD'), TRY_TO_DATE(SBC.BILLING_CLEAR_CREATED_DATE, 'YYYYMMDD')))
		WHEN TRY_TO_DATE(SBC.BILLING_CLEAR_CREATED_DATE, 'YYYYMMDD') IS NULL AND TRY_TO_DATE(TF.TTF_CREATED_DATE, 'YYYYMMDD') IS NOT NULL 
	    THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(TF.TTF_CREATED_DATE, 'YYYYMMDD'), CURRENT_DATE))
	    ELSE 'N/A'
	END AS SELISIH_TFTG_BILLING_CLEAR,
-- AGING : SELISIH
	CASE
	    WHEN SELISIH_SO_DO = 'N/A' THEN 'N/A'
	    WHEN SELISIH_SO_DO = 0 THEN '1/ Hari - H'
	    WHEN ABS(SELISIH_SO_DO) = 1 THEN '2/ 1 Hari'
	    WHEN ABS(SELISIH_SO_DO) = 2 THEN '3/ 2 Hari'
	    WHEN ABS(SELISIH_SO_DO) = 3 THEN '4/ 3 Hari'
	    WHEN ABS(SELISIH_SO_DO) BETWEEN 4 AND 7 THEN '5/ 4-7 Hari'
	    WHEN ABS(SELISIH_SO_DO) BETWEEN 8 AND 14 THEN '6/ 7-14 Hari'
	    WHEN ABS(SELISIH_SO_DO) BETWEEN 15 AND 30 THEN '7/ 14-30 Hari'
	    WHEN ABS(SELISIH_SO_DO) > 30 THEN '8/ >30 Hari'
    ELSE ''
	END AS AGING_SO_DO,
	CASE
	    WHEN SELISIH_DO_GI = 'N/A' THEN 'N/A'
	    WHEN SELISIH_DO_GI = 0 THEN '1/ Hari-H'
	    WHEN ABS(SELISIH_DO_GI) = 1 THEN '2/ 1 Hari'
	    WHEN ABS(SELISIH_DO_GI) = 2 THEN '3/ 2 Hari'
	    WHEN ABS(SELISIH_DO_GI) = 3 THEN '4/ 3 Hari'
	    WHEN ABS(SELISIH_DO_GI) BETWEEN 4 AND 7 THEN '5/ 4-7 Hari'
	    WHEN ABS(SELISIH_DO_GI) BETWEEN 8 AND 14 THEN '6/ 7-14 Hari'
	    WHEN ABS(SELISIH_DO_GI) BETWEEN 15 AND 30 THEN '7/ 14-30 Hari'
	    WHEN ABS(SELISIH_DO_GI) > 30 THEN '8/ >30 Hari'
    ELSE ''
	END AS AGING_DO_GI,
	CASE
	    WHEN SELISIH_GI_POD = 'N/A' THEN 'N/A'
	    WHEN SELISIH_GI_POD = 0 THEN '1/ Hari-H'
	    WHEN ABS(SELISIH_GI_POD) = 1 THEN '2/ 1 Hari'
	    WHEN ABS(SELISIH_GI_POD) = 2 THEN '3/ 2 Hari'
	    WHEN ABS(SELISIH_GI_POD) = 3 THEN '4/ 3 Hari'
	    WHEN ABS(SELISIH_GI_POD) BETWEEN 4 AND 7 THEN '5/ 4-7 Hari'
	    WHEN ABS(SELISIH_GI_POD) BETWEEN 8 AND 14 THEN '6/ 7-14 Hari'
	    WHEN ABS(SELISIH_GI_POD) BETWEEN 15 AND 30 THEN '7/ 14-30 Hari'
	    WHEN ABS(SELISIH_GI_POD) > 30 THEN '8/ >30 Hari'
    ELSE ''
	END AS AGING_GI_POD,
	CASE
	    WHEN SELISIH_POD_BILL = 'N/A' THEN 'N/A'
	    WHEN SELISIH_POD_BILL = 0 THEN '1/ Hari-H'
	    WHEN ABS(SELISIH_POD_BILL) = 1 THEN '2/ 1 Hari'
	    WHEN ABS(SELISIH_POD_BILL) = 2 THEN '3/ 2 Hari'
	    WHEN ABS(SELISIH_POD_BILL) = 3 THEN '4/ 3 Hari'
	    WHEN ABS(SELISIH_POD_BILL) BETWEEN 4 AND 7 THEN '5/ 4-7 Hari'
	    WHEN ABS(SELISIH_POD_BILL) BETWEEN 8 AND 14 THEN '6/ 7-14 Hari'
	    WHEN ABS(SELISIH_POD_BILL) BETWEEN 15 AND 30 THEN '7/ 14-30 Hari'
	    WHEN ABS(SELISIH_POD_BILL) > 30 THEN '8/ >30 Hari'
    ELSE ''
	END AS AGING_POD_BILL,
	CASE
	    WHEN SELISIH_BILL_TFTG = 'N/A' THEN 'N/A'
	    WHEN SELISIH_BILL_TFTG = 0 THEN '1/ Hari-H'
	    WHEN ABS(SELISIH_BILL_TFTG) = 1 THEN '2/ 1 Hari'
	    WHEN ABS(SELISIH_BILL_TFTG) = 2 THEN '3/ 2 Hari'
	    WHEN ABS(SELISIH_BILL_TFTG) = 3 THEN '4/ 3 Hari'
	    WHEN ABS(SELISIH_BILL_TFTG) BETWEEN 4 AND 7 THEN '5/ 4-7 Hari'
	    WHEN ABS(SELISIH_BILL_TFTG) BETWEEN 8 AND 14 THEN '6/ 7-14 Hari'
	    WHEN ABS(SELISIH_BILL_TFTG) BETWEEN 15 AND 30 THEN '7/ 14-30 Hari'
	    WHEN ABS(SELISIH_BILL_TFTG) > 30 THEN '8/ >30 Hari'
    ELSE ''
	END AS AGING_BILL_TFTG,
	CASE
	    WHEN SELISIH_TFTG_BILLING_CLEAR = 'N/A' THEN 'N/A'
	    WHEN SELISIH_TFTG_BILLING_CLEAR = 0 THEN '1/ Hari-H'
	    WHEN ABS(SELISIH_TFTG_BILLING_CLEAR) BETWEEN 1 AND 7 THEN '2/ 0-7 Hari'
	    WHEN ABS(SELISIH_TFTG_BILLING_CLEAR) BETWEEN 8 AND 14 THEN '3/ 7-14 Hari'
	    WHEN ABS(SELISIH_TFTG_BILLING_CLEAR) BETWEEN 15 AND 30 THEN '4/ 14-30 Hari'
	    WHEN ABS(SELISIH_TFTG_BILLING_CLEAR) BETWEEN 31 AND 45 THEN '5/ 30-45 Hari'
	    WHEN ABS(SELISIH_TFTG_BILLING_CLEAR) > 45 THEN '6/ >45 Hari'
    ELSE ''
	END AS AGING_TFTG_BILLING_CLEAR
FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER SO
LEFT JOIN 
	(SELECT DISTINCT SALES_ORDER_EXTERNAL_DOCUMENT, SALES_ORDER_NUMBER, SALES_ORDER_TYPE FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER) SO1
    ON SO1.SALES_ORDER_EXTERNAL_DOCUMENT = SO.SALES_ORDER_NUMBER
    AND SO1.SALES_ORDER_TYPE NOT IN ('ZKS3','ZKSC', 'ZKR3', 'ZKRC', 'ZKD3', 'ZKDC')
LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_DELIVERY SD
	ON SD.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
	AND SD.REFERENCE_SALES_ORDER_NUMBER = SO.SALES_ORDER_NUMBER
LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SCM_STOCK_TRANSACTION_SAP SCM
    ON SCM.SOURCE_SYSTEM = SD.SOURCE_SYSTEM
    AND SCM."REFERENCE" = SD.DELIVERY_NUMBER
    AND SCM.FISCAL_YEAR = '2025'
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, CUSTOMER, POD_FLAG FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER) CPOD
	ON CPOD.SOURCE_SYSTEM = SO.SOURCE_SYSTEM 
	AND CPOD.CUSTOMER = SO.CUSTOMER
LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING SB
    ON SB.SOURCE_SYSTEM = SO.SOURCE_SYSTEM 
    AND SB.REFERENCE_SALES_ORDER_NUMBER = SO.SALES_ORDER_NUMBER
    AND SB.BILLING_TYPE NOT IN ('ZB50','ZB99')
LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_TTF TF
    ON TF.SOURCE_SYSTEM = SB.SOURCE_SYSTEM 
    AND TF.BILLING_NUMBER = SB.BILLING_NUMBER
LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_CLEARING SBC
    ON SBC.SOURCE_SYSTEM = SB.SOURCE_SYSTEM
    AND SBC.BILLING_NUMBER = SB.BILLING_NUMBER
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, CUSTOMER, CUSTOMER_NAME, REGION FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER) CUST
    ON CUST.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
    AND CUST.CUSTOMER = SO.CUSTOMER
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, CUSTOMER, CUSTOMER_NAME FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER) CUSTSH
    ON CUSTSH.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
    AND CUSTSH.CUSTOMER = SO.CUSTOMER_SHIP_TO
LEFT JOIN (
    SELECT 
        SOURCE_SYSTEM,
        CUSTOMER,
        SALES_OFFICE,
        SALES_OFFICE_DESC,
        SALES_DIVISION
    FROM (
        SELECT 
            SOURCE_SYSTEM,
            CUSTOMER,
            SALES_OFFICE,
            SALES_OFFICE_DESC,
            SALES_DIVISION,
            ROW_NUMBER() OVER (
                PARTITION BY SOURCE_SYSTEM, CUSTOMER 
                ORDER BY 
                    CASE 
                        WHEN SALES_OFFICE <> '9001' THEN 0 ELSE 1 END,  -- prioritas: di luar daftar dulu
                    SALES_OFFICE ASC
            ) AS RN
        FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER
        WHERE BLOCK_FOR_SALES = 'Non block'
          AND DELETION_FOR_SALES = 'Non delete'
    )
    QUALIFY RN = 1
) CUST1
    ON CUST1.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
    AND CUST1.CUSTOMER = SO.CUSTOMER
LEFT JOIN (SELECT SOURCE_SYSTEM, COMPANY_CODE, COMPANY_NAME FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT) CP
    ON CP.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
    AND CP.COMPANY_CODE = SO.COMPANY_CODE
LEFT JOIN (SELECT SOURCE_SYSTEM, PLANT, PLANT_NAME FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT) CP1
    ON CP1.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
    AND CP1.PLANT = SO.PLANT
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, DISTRIBUTION_CHANNEL, DISTRIBUTION_CHANNEL_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_AREA) SA
    ON SA.SOURCE_SYSTEM = SO.SOURCE_SYSTEM 
    AND SA.DISTRIBUTION_CHANNEL = SO.DISTRIBUTION_CHANNEL
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, SALES_DIVISION, SALES_DIVISION_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_AREA) SA1
    ON SA1.SOURCE_SYSTEM = CUST1.SOURCE_SYSTEM
    AND SA1.SALES_DIVISION = CUST1.SALES_DIVISION 
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, REGION, REGION_DESC, COUNTRY FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_REGION) DSR
    ON DSR.SOURCE_SYSTEM = CUST.SOURCE_SYSTEM
    AND DSR.REGION = CUST.REGION
    AND DSR.COUNTRY = 'ID'
WHERE SO.SOURCE_SYSTEM = 'PE1'
	AND SO.COMPANY_CODE = 'ID90'
	AND SO.SALES_ORDER_STATUS_REJECTION <> 'C'
	AND SO.SALES_ORDER_TYPE NOT IN ('ZB51','ZB52','ZB53','ZB54','ZB55','ZB56','ZB59')
    AND SO.PLANT NOT IN ('901A','905A','90VA','90VB','90VC','90WA','90XA','90ZA')
	AND TRY_TO_DATE(SO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD') BETWEEN '2025-08-01' AND '2025-11-07'
GROUP BY ALL;
