-- DASHBOARD #1 : SGF SALES AGING ONLY

SELECT DISTINCT
  -- BASIC DATA
  SSO.COMPANY_CODE || '-' || CP.COMPANY_NAME AS COMPANY,
  SSO.PLANT || '-' || CP.PLANT_NAME AS PLANT,
  SSO.CUSTOMER AS CUSTOMER_SO_CODE,
  CUST.CUSTOMER_NAME AS CUSTOMER_SO_NAME,
  SSO.DISTRIBUTION_CHANNEL || '-' || SA.DISTRIBUTION_CHANNEL_DESC AS DISTRIBUTION_CHANNEL,
  SSO.DIVISION || '-' || SSO.DIVISION_DESC AS DIVISION,
  DSR.REGION || '-' || DSR.REGION_DESC AS REGION,
  CASE 
	WHEN DSR.REGION IN ('01', '02', '03', '04', '05', '28') THEN 'PULAU JAWA'
    ELSE 'LUAR JAWA'
  END AS STATUS_REGION,
  -- TYPE
  FLOW.SALES_ORDER_TYPE || '-' || FLOW.SALES_ORDER_TYPE_DESC AS SALES_ORDER_TYPE,
  SD.DELIVERY_TYPE || '-' || SD.DELIVERY_TYPE_DESC AS DELIVERY_TYPE,
  SB.BILLING_TYPE || '-' || SB.BILLING_TYPE_DESC AS BILLING_TYPE, 
  -- STATUS
  SSO.SALES_ORDER_STATUS || '-' || SSO.SALES_ORDER_STATUS_DESC AS SALES_ORDER_STATUS,
  SSO.SALES_ORDER_STATUS_REJECTION || '-' || SSO.SALES_ORDER_STATUS_REJECTION_DESC AS SALES_ORDER_STATUS_REJECTION,
  SSO.SALES_ORDER_STATUS_DELIVERY || '-' || SSO.SALES_ORDER_STATUS_DELIVERY_DESC AS SALES_ORDER_DELIVERY_STATUS,
  SSO.SALES_ORDER_STATUS_BILLING || '-' || SSO.SALES_ORDER_STATUS_BILLING_DESC AS SALES_ORDER_BILLING_STATUS,
  -- DOC NUMBER
  SSO.CREATED_BY,
  FLOW.SALES_ORDER_NUMBER AS SO_NUMBER,
  FLOW.DELIVERY_NUMBER AS DO_NUMBER,
  FLOW.GI_MATERIAL_DOCUMENT AS GI_NUMBER,
  FLOW.BILLING_NUMBER,
  TF.TTF_NUMBER,
  SBC.BILLING_CLEARING_DOC,
  -- DATE TRANSACTION
  TRY_TO_DATE(SSO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD') AS SO_CREATED_DATE,
  TRY_TO_DATE(SSO.SALES_ORDER_DATE, 'YYYYMMDD') AS SO_DATE,
  TRY_TO_DATE(SD.DELIVERY_CREATED_DATE, 'YYYYMMDD') AS DO_CREATED_DATE,
  TRY_TO_DATE(SD.DELIVERY_ACTUAL_DATE, 'YYYYMMDD') AS DO_ACTUAL_DATE,
  TRY_TO_DATE(SCM.ENTRY_DATE, 'YYYYMMDD') AS GI_ENTRY_DATE,
  TRY_TO_DATE (SCM.POSTING_DATE, 'YYYYMMDD') AS GI_POSTING_DATE,
  TRY_TO_DATE(SB.BILLING_CREATED_DATE, 'YYYYMMDD') AS BILLING_CREATED_DATE,
  TRY_TO_DATE(SB.BILLING_DATE, 'YYYYMMDD') AS BILLING_DATE,
  TRY_TO_DATE(TF.TTF_CREATED_DATE, 'YYYYMMDD') AS TF_CREATED_DATE,
  TRY_TO_DATE(TF.TTF_DOC_DATE, 'YYYYMMDD') AS TF_DATE,
  TRY_TO_DATE(SBC.BILLING_CLEAR_CREATED_DATE, 'YYYYMMDD') AS BILLING_CLEAR_CREATED_DATE,
  TRY_TO_DATE(SBC.BILLING_CLEAR_DATE, 'YYYYMMDD') AS BILLING_CLEAR_DATE,
  -- DATE SELISIH
	CASE 
	    WHEN TRY_TO_DATE(SD.DELIVERY_ACTUAL_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(SSO.SALES_ORDER_DATE, 'YYYYMMDD') IS NOT NULL 
	    THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(SSO.SALES_ORDER_DATE, 'YYYYMMDD'), TRY_TO_DATE(SD.DELIVERY_ACTUAL_DATE, 'YYYYMMDD'))) 	
	    WHEN TRY_TO_DATE(SD.DELIVERY_ACTUAL_DATE, 'YYYYMMDD') IS NULL AND TRY_TO_DATE(SSO.SALES_ORDER_DATE, 'YYYYMMDD') IS NOT NULL 
	    THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(SSO.SALES_ORDER_DATE, 'YYYYMMDD'), CURRENT_DATE))									
	    ELSE 'N/A'
	END AS SELISIH_SO_DO,
	CASE 
	    WHEN TRY_TO_DATE(SCM.POSTING_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(SD.DELIVERY_ACTUAL_DATE, 'YYYYMMDD') IS NOT NULL 
	    THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(SD.DELIVERY_ACTUAL_DATE, 'YYYYMMDD'), TRY_TO_DATE(SCM.POSTING_DATE, 'YYYYMMDD')))
		WHEN TRY_TO_DATE(SCM.POSTING_DATE, 'YYYYMMDD') IS NULL AND TRY_TO_DATE(SD.DELIVERY_ACTUAL_DATE, 'YYYYMMDD') IS NOT NULL 
	    THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(SD.DELIVERY_ACTUAL_DATE, 'YYYYMMDD'), CURRENT_DATE))
	    ELSE 'N/A'
	END AS SELISIH_DO_GI,
	CASE 
	    WHEN TRY_TO_DATE(SB.BILLING_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(SCM.POSTING_DATE, 'YYYYMMDD') IS NOT NULL 
	    THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(SCM.POSTING_DATE, 'YYYYMMDD'), TRY_TO_DATE(SB.BILLING_DATE, 'YYYYMMDD')))
		WHEN TRY_TO_DATE(SB.BILLING_DATE, 'YYYYMMDD') IS NULL AND TRY_TO_DATE(SCM.POSTING_DATE, 'YYYYMMDD') IS NOT NULL 
	    THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(SCM.POSTING_DATE, 'YYYYMMDD'), CURRENT_DATE))
	    ELSE 'N/A'
	END AS SELISIH_GI_BILL,
	CASE 
	    WHEN TRY_TO_DATE(TF.TTF_DOC_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(SB.BILLING_DATE, 'YYYYMMDD') IS NOT NULL 
	    THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(SB.BILLING_DATE, 'YYYYMMDD'), TRY_TO_DATE(TF.TTF_DOC_DATE, 'YYYYMMDD')))
		WHEN TRY_TO_DATE(TF.TTF_DOC_DATE, 'YYYYMMDD') IS NULL AND TRY_TO_DATE(SB.BILLING_DATE, 'YYYYMMDD') IS NOT NULL 
	    THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(SB.BILLING_DATE, 'YYYYMMDD'), CURRENT_DATE))
	    ELSE 'N/A'
	END AS SELISIH_BILL_TF,
	CASE 
	    WHEN TRY_TO_DATE(SBC.BILLING_CLEAR_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(TF.TTF_DOC_DATE, 'YYYYMMDD') IS NOT NULL 
	    THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(TF.TTF_DOC_DATE, 'YYYYMMDD'), TRY_TO_DATE(SBC.BILLING_CLEAR_DATE, 'YYYYMMDD')))
		WHEN TRY_TO_DATE(SBC.BILLING_CLEAR_DATE, 'YYYYMMDD') IS NULL AND TRY_TO_DATE(TF.TTF_DOC_DATE, 'YYYYMMDD') IS NOT NULL 
	    THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(TF.TTF_DOC_DATE, 'YYYYMMDD'), CURRENT_DATE))
	    ELSE 'N/A'
	END AS SELISIH_TF_BILLING_CLEAR,
	-- AGING : SELISIH
	CASE
	    WHEN SELISIH_SO_DO = 'N/A' THEN 'N/A'
	    WHEN SELISIH_SO_DO >= 0 AND SELISIH_SO_DO <= 3 THEN '1/ 0-3 Hari'
	    WHEN SELISIH_SO_DO > 3 AND SELISIH_SO_DO <= 7 THEN '2/ 3-7 Hari'
	    WHEN SELISIH_SO_DO > 7 AND SELISIH_SO_DO <= 14 THEN '3/ 7-14 Hari'
	    WHEN SELISIH_SO_DO > 14 AND SELISIH_SO_DO <= 30 THEN '4/ 14-30 Hari'
	    WHEN SELISIH_SO_DO > 30 THEN '5/ >30 Hari'
	    WHEN SELISIH_SO_DO < 0 AND SELISIH_SO_DO >= -3 THEN '1/ 0-3 Hari'
	    WHEN SELISIH_SO_DO < -3 AND SELISIH_SO_DO >= -7 THEN '2/ 3-7 Hari'
	    WHEN SELISIH_SO_DO < -7 AND SELISIH_SO_DO >= -14 THEN '3/ 7-14 Hari'
	    WHEN SELISIH_SO_DO < -14 AND SELISIH_SO_DO >= -30 THEN '4/ 14-30 Hari'
	    WHEN SELISIH_SO_DO < -30 THEN '5/ >30 Hari'
    	ELSE ''
	END AS AGING_SO_DO,
	CASE
	    WHEN SELISIH_DO_GI = 'N/A' THEN 'N/A'
	    WHEN SELISIH_DO_GI >= 0 AND SELISIH_DO_GI <= 3 THEN '1/ 0-3 Hari'
	    WHEN SELISIH_DO_GI > 3 AND SELISIH_DO_GI <= 7 THEN '2/ 3-7 Hari'
	    WHEN SELISIH_DO_GI > 7 AND SELISIH_DO_GI <= 14 THEN '3/ 7-14 Hari'
	    WHEN SELISIH_DO_GI > 14 AND SELISIH_DO_GI <= 30 THEN '4/ 14-30 Hari'
	    WHEN SELISIH_DO_GI > 30 THEN '5/ >30 Hari'
	    WHEN SELISIH_DO_GI < 0 AND SELISIH_DO_GI >= -3 THEN '1/ 0-3 Hari'
	    WHEN SELISIH_DO_GI < -3 AND SELISIH_DO_GI >= -7 THEN '2/ 3-7 Hari'
	    WHEN SELISIH_DO_GI < -7 AND SELISIH_DO_GI >= -14 THEN '3/ 7-14 Hari'
	    WHEN SELISIH_DO_GI < -14 AND SELISIH_DO_GI >= -30 THEN '4/ 14-30 Hari'
	    WHEN SELISIH_DO_GI < -30 THEN '5/ >30 Hari'
	    ELSE ''
	END AGING_DO_GI,
	CASE
	    WHEN SELISIH_GI_BILL = 'N/A' THEN 'N/A'
	    WHEN SELISIH_GI_BILL >= 0 AND SELISIH_GI_BILL <= 3 THEN '1/ 0-3 Hari'
	    WHEN SELISIH_GI_BILL > 3 AND SELISIH_GI_BILL <= 7 THEN '2/ 3-7 Hari'
	    WHEN SELISIH_GI_BILL > 7 AND SELISIH_GI_BILL <= 14 THEN '3/ 7-14 Hari'
	    WHEN SELISIH_GI_BILL > 14 AND SELISIH_GI_BILL <= 30 THEN '4/ 14-30 Hari'
	    WHEN SELISIH_GI_BILL > 30 THEN '5/ >30 Hari'
	    WHEN SELISIH_GI_BILL < 0 AND SELISIH_GI_BILL >= -3 THEN '1/ 0-3 Hari'
	    WHEN SELISIH_GI_BILL < -3 AND SELISIH_GI_BILL >= -7 THEN '2/ 3-7 Hari'
	    WHEN SELISIH_GI_BILL < -7 AND SELISIH_GI_BILL >= -14 THEN '3/ 7-14 Hari'
	    WHEN SELISIH_GI_BILL < -14 AND SELISIH_GI_BILL >= -30 THEN '4/ 14-30 Hari'
	    WHEN SELISIH_GI_BILL < -30 THEN '5/ >30 Hari'
	    ELSE ''
	END AGING_GI_BILL,
	CASE
	    WHEN SELISIH_BILL_TF = 'N/A' THEN 'N/A'
	    WHEN SELISIH_BILL_TF >= 0 AND SELISIH_BILL_TF <= 3 THEN '1/ 0-3 Hari'
	    WHEN SELISIH_BILL_TF > 3 AND SELISIH_BILL_TF <= 7 THEN '2/ 3-7 Hari'
	    WHEN SELISIH_BILL_TF > 7 AND SELISIH_BILL_TF <= 14 THEN '3/ 7-14 Hari'
	    WHEN SELISIH_BILL_TF > 14 AND SELISIH_BILL_TF <= 30 THEN '4/ 14-30 Hari'
	    WHEN SELISIH_BILL_TF > 30 THEN '5/ >30 Hari'
	    WHEN SELISIH_BILL_TF < 0 AND SELISIH_BILL_TF >= -3 THEN '1/ 0-3 Hari'
	    WHEN SELISIH_BILL_TF < -3 AND SELISIH_BILL_TF >= -7 THEN '2/ 3-7 Hari'
	    WHEN SELISIH_BILL_TF < -7 AND SELISIH_BILL_TF >= -14 THEN '3/ 7-14 Hari'
	    WHEN SELISIH_BILL_TF < -14 AND SELISIH_BILL_TF >= -30 THEN '4/ 14-30 Hari'
	    WHEN SELISIH_BILL_TF < -30 THEN '5/ >30 Hari'
	    ELSE ''
	END AGING_BILL_TF,
		CASE
	    WHEN SELISIH_TF_BILLING_CLEAR = 'N/A' THEN 'N/A'
	    WHEN SELISIH_TF_BILLING_CLEAR >= 0 AND SELISIH_TF_BILLING_CLEAR <= 3 THEN '1/ 0-3 Hari'
	    WHEN SELISIH_TF_BILLING_CLEAR > 3 AND SELISIH_TF_BILLING_CLEAR <= 7 THEN '2/ 3-7 Hari'
	    WHEN SELISIH_TF_BILLING_CLEAR > 7 AND SELISIH_TF_BILLING_CLEAR <= 14 THEN '3/ 7-14 Hari'
	    WHEN SELISIH_TF_BILLING_CLEAR > 14 AND SELISIH_TF_BILLING_CLEAR <= 30 THEN '4/ 14-30 Hari'
	    WHEN SELISIH_TF_BILLING_CLEAR > 30 THEN '5/ >30 Hari'
	    WHEN SELISIH_TF_BILLING_CLEAR < 0 AND SELISIH_TF_BILLING_CLEAR >= -3 THEN '1/ 0-3 Hari'
	    WHEN SELISIH_TF_BILLING_CLEAR < -3 AND SELISIH_TF_BILLING_CLEAR >= -7 THEN '2/ 3-7 Hari'
	    WHEN SELISIH_TF_BILLING_CLEAR < -7 AND SELISIH_TF_BILLING_CLEAR >= -14 THEN '3/ 7-14 Hari'
	    WHEN SELISIH_TF_BILLING_CLEAR < -14 AND SELISIH_TF_BILLING_CLEAR >= -30 THEN '4/ 14-30 Hari'
	    WHEN SELISIH_TF_BILLING_CLEAR < -30 THEN '5/ >30 Hari'
	    ELSE ''
	END AGING_TF_BILLING_CLEAR,
-- FROM AND WHERE
FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_FLOW_ORDER_DOCUMENT_FLOW FLOW
  LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER SSO
    ON FLOW.SALES_ORDER_NUMBER = SSO.SALES_ORDER_NUMBER
	AND FLOW.SOURCE_SYSTEM = SSO.SOURCE_SYSTEM
	AND FLOW.SALES_ORDER_ITEM = SSO.SALES_ORDER_ITEM 
	AND SSO.SALES_ORDER_STATUS_REJECTION <> 'C'
	AND SSO.SALES_ORDER_TYPE NOT IN ('ZB51','ZB52','ZB53','ZB54','ZB55','ZB56','ZB59')
  LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, CUSTOMER, CUSTOMER_NAME, REGION FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER) CUST
    ON SSO.CUSTOMER = CUST.CUSTOMER
    AND SSO.SOURCE_SYSTEM = CUST.SOURCE_SYSTEM
  LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, CUSTOMER, CUSTOMER_NAME, REGION FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER) CUSTSH
    ON FLOW.CUSTOMER_SHIP_TO = CUSTSH.CUSTOMER
    AND FLOW.SOURCE_SYSTEM = CUSTSH.SOURCE_SYSTEM
  LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_DELIVERY SD
    ON FLOW.DELIVERY_NUMBER  = SD.DELIVERY_NUMBER  
    AND FLOW.SALES_ORDER_NUMBER = SD.REFERENCE_SALES_ORDER_NUMBER 
    AND FLOW.DELIVERY_ITEM = SD.DELIVERY_ITEM 
  LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING SB
    ON FLOW.BILLING_NUMBER = SB.BILLING_NUMBER
    AND FLOW.SALES_ORDER_NUMBER = SB.REFERENCE_SALES_ORDER_NUMBER 
    AND FLOW.BILLING_ITEM = SB.BILLING_ITEM 
  LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_CLEARING SBC
    ON FLOW.BILLING_NUMBER = SBC.BILLING_NUMBER
  LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, DISTRIBUTION_CHANNEL, DISTRIBUTION_CHANNEL_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_AREA) SA
    ON SSO.DISTRIBUTION_CHANNEL = SA.DISTRIBUTION_CHANNEL
    AND SSO.SOURCE_SYSTEM = SA.SOURCE_SYSTEM 
  LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.D_SALES_REGION DSR
    ON CUST.REGION = DSR.REGION
    AND CUST.SOURCE_SYSTEM = DSR.SOURCE_SYSTEM
    AND DSR.COUNTRY = 'ID'
  LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT CP
    ON SSO.SOURCE_SYSTEM = CP.SOURCE_SYSTEM
    AND SSO.COMPANY_CODE = CP.COMPANY_CODE
    AND SSO.PLANT = CP.PLANT
    LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SCM_MUTASI_MATERIAL SCM /*temp_test_dhiva SCM*/
    ON FLOW.SOURCE_SYSTEM = SCM.SOURCE_SYSTEM
    AND FLOW.DELIVERY_NUMBER = SCM."REFERENCE"
  LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_TTF TF
    ON FLOW.SOURCE_SYSTEM = TF.SOURCE_SYSTEM 
    AND FLOW.BILLING_NUMBER = TF.BILLING_NUMBER
WHERE  
  FLOW.SOURCE_SYSTEM = 'PE1'
  AND SSO.COMPANY_CODE = 'ID90'
  AND TRY_TO_DATE(SSO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD') BETWEEN '2025-07-01' AND CURRENT_DATE
  GROUP BY ALL;
