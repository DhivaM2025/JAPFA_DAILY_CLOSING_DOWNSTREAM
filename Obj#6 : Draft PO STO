WITH gi AS (
    SELECT 
        SOURCE_SYSTEM,
        FISCAL_YEAR,
        COMPANY_CODE,
        MATERIAL_DOCUMENT_YEAR,
        PURCHASE_ORDER,
        MATERIAL,
        MATERIAL_DOCUMENT_NUMBER,
        PLANT,
        RECEIVING_PLANT,
        REFERENCE,
        SUM(SIGNED_QUANTITY_FOR_BALANCE) AS QTY_641_351
    FROM F_SCM_STOCK_TRANSACTION_SAP
    WHERE MOVEMENT_TYPE IN ('641','351')
      AND ITEM_AUTOMATICALLY_CREATED IS NULL
      AND PURCHASE_ORDER IS NOT NULL
      AND SOURCE_SYSTEM = 'PE2'
    GROUP BY SOURCE_SYSTEM, FISCAL_YEAR, COMPANY_CODE, MATERIAL_DOCUMENT_YEAR, 
             PURCHASE_ORDER, MATERIAL, MATERIAL_DOCUMENT_NUMBER, PLANT, 
             RECEIVING_PLANT, REFERENCE
    UNION ALL
    SELECT
        SOURCE_SYSTEM,
        FISCAL_YEAR,
        COMPANY_CODE,
        MATERIAL_DOCUMENT_YEAR,
        PURCHASE_ORDER,
        MATERIAL,
        MATERIAL_DOCUMENT_NUMBER,
        PLANT,
        RECEIVING_PLANT,
        REFERENCE,
        SUM(SIGNED_QUANTITY_FOR_BALANCE) AS QTY_641_351
    FROM F_SCM_STOCK_TRANSACTION_SAP
    WHERE MOVEMENT_TYPE IN ('641')
      AND ITEM_AUTOMATICALLY_CREATED IS NULL
      AND PURCHASE_ORDER IS NOT NULL
      AND SOURCE_SYSTEM = 'PE1'
    GROUP BY SOURCE_SYSTEM, FISCAL_YEAR, COMPANY_CODE, MATERIAL_DOCUMENT_YEAR, 
             PURCHASE_ORDER, MATERIAL, MATERIAL_DOCUMENT_NUMBER, PLANT, 
             RECEIVING_PLANT, REFERENCE
),
gr AS (
    SELECT 
        SOURCE_SYSTEM,
        FISCAL_YEAR,
        COMPANY_CODE,
        MATERIAL_DOCUMENT_YEAR,
        PURCHASE_ORDER,
        MATERIAL,
        MATERIAL_DOCUMENT_NUMBER,
        PLANT AS RECEIVING_PLANT, 
        SUM(SIGNED_QUANTITY_FOR_BALANCE) AS QTY_101_102
    FROM F_SCM_STOCK_TRANSACTION_SAP
    WHERE MOVEMENT_TYPE IN ('101', '102')
      AND ITEM_AUTOMATICALLY_CREATED IS NULL
      AND PURCHASE_ORDER IS NOT NULL
    GROUP BY SOURCE_SYSTEM, FISCAL_YEAR, COMPANY_CODE, MATERIAL_DOCUMENT_YEAR, 
             PURCHASE_ORDER, MATERIAL, MATERIAL_DOCUMENT_NUMBER, PLANT
),
gi_gr AS (
    SELECT 
        gi.SOURCE_SYSTEM,
        gi.FISCAL_YEAR,
        gi.COMPANY_CODE,
        gi.MATERIAL_DOCUMENT_YEAR,
        gi.PLANT,
        gi.RECEIVING_PLANT,
        gi.PURCHASE_ORDER,
        gi.MATERIAL,
        gi.MATERIAL_DOCUMENT_NUMBER,
        gi.REFERENCE,
        gi.QTY_641_351,
        COALESCE(gr.QTY_101_102, 0) AS QTY_101_102,
        gi.QTY_641_351 + COALESCE(gr.QTY_101_102, 0) AS NET_QTY
    FROM gi
    LEFT JOIN gr
      ON gi.SOURCE_SYSTEM = gr.SOURCE_SYSTEM
      AND gi.FISCAL_YEAR = gr.FISCAL_YEAR
      AND gi.COMPANY_CODE = gr.COMPANY_CODE
      AND gi.MATERIAL_DOCUMENT_YEAR = gr.MATERIAL_DOCUMENT_YEAR
      AND gi.PURCHASE_ORDER = gr.PURCHASE_ORDER
      AND gi.MATERIAL = gr.MATERIAL
),
adj_loss_gain AS (
    SELECT
        SOURCE_SYSTEM,
        FISCAL_YEAR,
        COMPANY_CODE,
        MATERIAL_DOCUMENT_YEAR,
        PURCHASE_ORDER,
        MATERIAL,
        MATERIAL_DOCUMENT_NUMBER,
        PLANT,
        RECEIVING_PLANT,
        REFERENCE,
        SUM(SIGNED_QUANTITY_FOR_BALANCE) AS QTY_LOSS_GAIN
    FROM F_SCM_STOCK_TRANSACTION_SAP
    WHERE MOVEMENT_TYPE IN ('Z01', 'Z19')
      AND ITEM_AUTOMATICALLY_CREATED IS NULL
      AND PURCHASE_ORDER IS NOT NULL
      AND SOURCE_SYSTEM = 'PE2'
    GROUP BY SOURCE_SYSTEM, FISCAL_YEAR, COMPANY_CODE, MATERIAL_DOCUMENT_YEAR, 
             PURCHASE_ORDER, MATERIAL, MATERIAL_DOCUMENT_NUMBER, PLANT, 
             RECEIVING_PLANT, REFERENCE
    UNION ALL
    SELECT
        SOURCE_SYSTEM,
        FISCAL_YEAR,
        COMPANY_CODE,
        MATERIAL_DOCUMENT_YEAR,
        PURCHASE_ORDER,
        MATERIAL,
        MATERIAL_DOCUMENT_NUMBER,
        PLANT,
        RECEIVING_PLANT,
        REFERENCE,
        SUM(SIGNED_QUANTITY_FOR_BALANCE) AS QTY_LOSS_GAIN
    FROM F_SCM_STOCK_TRANSACTION_SAP
    WHERE MOVEMENT_TYPE IN ('701')
      AND ITEM_AUTOMATICALLY_CREATED IS NULL
      AND PURCHASE_ORDER IS NOT NULL
      AND SOURCE_SYSTEM = 'PE1'
    GROUP BY SOURCE_SYSTEM, FISCAL_YEAR, COMPANY_CODE, MATERIAL_DOCUMENT_YEAR, 
             PURCHASE_ORDER, MATERIAL, MATERIAL_DOCUMENT_NUMBER, PLANT, 
             RECEIVING_PLANT, REFERENCE
),
agg AS (
    SELECT
        gi_gr.SOURCE_SYSTEM,
        gi_gr.FISCAL_YEAR,
        gi_gr.COMPANY_CODE,
        gi_gr.MATERIAL_DOCUMENT_YEAR,
        gi_gr.PLANT,
        gi_gr.RECEIVING_PLANT,
        gi_gr.PURCHASE_ORDER,
        gi_gr.MATERIAL,
        gi_gr.MATERIAL_DOCUMENT_NUMBER,
        gi_gr.REFERENCE,
        gi_gr.QTY_641_351 AS QTY_GI,
        gi_gr.QTY_101_102 AS QTY_GR,
        gi_gr.NET_QTY,
        COALESCE(adj.QTY_LOSS_GAIN, 0) AS QTY_LOSS_GAIN
    FROM gi_gr
    LEFT JOIN adj_loss_gain adj
        ON gi_gr.SOURCE_SYSTEM = adj.SOURCE_SYSTEM 
        AND gi_gr.FISCAL_YEAR = adj.FISCAL_YEAR
        AND gi_gr.COMPANY_CODE = adj.COMPANY_CODE
        AND gi_gr.MATERIAL_DOCUMENT_YEAR = adj.MATERIAL_DOCUMENT_YEAR
        AND gi_gr.PURCHASE_ORDER = adj.PURCHASE_ORDER
        AND gi_gr.MATERIAL = adj.MATERIAL
)
SELECT
    SOURCE_SYSTEM,
    FISCAL_YEAR,
    COMPANY_CODE,
    MATERIAL_DOCUMENT_YEAR,
    PLANT,
    RECEIVING_PLANT,
    PURCHASE_ORDER,
    MATERIAL,
    MATERIAL_DOCUMENT_NUMBER,
    REFERENCE,
    -1*QTY_GI AS DELIVERY,
    -1*NET_QTY AS NOT_YET_DELIVERED,
    CASE 
        WHEN SOURCE_SYSTEM = 'PE2' AND QTY_LOSS_GAIN < 0 THEN QTY_LOSS_GAIN
        ELSE 0 
    END AS QTY_SUSUT,
    CASE 
        WHEN SOURCE_SYSTEM = 'PE2' AND QTY_LOSS_GAIN > 0 THEN QTY_LOSS_GAIN
        ELSE 0 
    END AS QTY_TIMBUL,
    -1*QTY_GI + QTY_TIMBUL - ABS(QTY_SUSUT) AS DELIVERED
FROM agg
;
