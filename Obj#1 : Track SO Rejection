-- DASHBOARD #8: Monitoring SO yang di-Reject

-- STEP 1 : Menampilkan Summary SO Rejection per Bulan pada Tahun 2025 --
SELECT 
    SALES_ORDER_REASON_REJECTION_DESC,
    COUNT(DISTINCT CASE WHEN DATE_TRUNC('MONTH', TRY_TO_DATE(SALES_ORDER_CREATED_DATE, 'YYYYMMDD')) = '2025-01-01' THEN SALES_ORDER_NUMBER END) AS "Jan-25",
    COUNT(DISTINCT CASE WHEN DATE_TRUNC('MONTH', TRY_TO_DATE(SALES_ORDER_CREATED_DATE, 'YYYYMMDD')) = '2025-02-01' THEN SALES_ORDER_NUMBER END) AS "Feb-25",
    COUNT(DISTINCT CASE WHEN DATE_TRUNC('MONTH', TRY_TO_DATE(SALES_ORDER_CREATED_DATE, 'YYYYMMDD')) = '2025-03-01' THEN SALES_ORDER_NUMBER END) AS "Mar-25",
    COUNT(DISTINCT CASE WHEN DATE_TRUNC('MONTH', TRY_TO_DATE(SALES_ORDER_CREATED_DATE, 'YYYYMMDD')) = '2025-04-01' THEN SALES_ORDER_NUMBER END) AS "Apr-25",
    COUNT(DISTINCT CASE WHEN DATE_TRUNC('MONTH', TRY_TO_DATE(SALES_ORDER_CREATED_DATE, 'YYYYMMDD')) = '2025-05-01' THEN SALES_ORDER_NUMBER END) AS "May-25",
    COUNT(DISTINCT CASE WHEN DATE_TRUNC('MONTH', TRY_TO_DATE(SALES_ORDER_CREATED_DATE, 'YYYYMMDD')) = '2025-06-01' THEN SALES_ORDER_NUMBER END) AS "Jun-25",
    COUNT(DISTINCT CASE WHEN DATE_TRUNC('MONTH', TRY_TO_DATE(SALES_ORDER_CREATED_DATE, 'YYYYMMDD')) = '2025-07-01' THEN SALES_ORDER_NUMBER END) AS "Jul-25",
    COUNT(DISTINCT CASE WHEN DATE_TRUNC('MONTH', TRY_TO_DATE(SALES_ORDER_CREATED_DATE, 'YYYYMMDD')) = '2025-08-01' THEN SALES_ORDER_NUMBER END) AS "Aug-25",
    COUNT(DISTINCT CASE WHEN DATE_TRUNC('MONTH', TRY_TO_DATE(SALES_ORDER_CREATED_DATE, 'YYYYMMDD')) = '2025-09-01' THEN SALES_ORDER_NUMBER END) AS "Sep-25",
    COUNT(DISTINCT CASE WHEN DATE_TRUNC('MONTH', TRY_TO_DATE(SALES_ORDER_CREATED_DATE, 'YYYYMMDD')) = '2025-10-01' THEN SALES_ORDER_NUMBER END) AS "Oct-25",
    COUNT(DISTINCT CASE WHEN DATE_TRUNC('MONTH', TRY_TO_DATE(SALES_ORDER_CREATED_DATE, 'YYYYMMDD')) = '2025-11-01' THEN SALES_ORDER_NUMBER END) AS "Nov-25",
    COUNT(DISTINCT CASE WHEN DATE_TRUNC('MONTH', TRY_TO_DATE(SALES_ORDER_CREATED_DATE, 'YYYYMMDD')) = '2025-12-01' THEN SALES_ORDER_NUMBER END) AS "Dec-25",
    (
      COUNT(DISTINCT CASE WHEN DATE_TRUNC('MONTH', TRY_TO_DATE(SALES_ORDER_CREATED_DATE, 'YYYYMMDD')) = '2025-01-01' THEN SALES_ORDER_NUMBER END) +
      COUNT(DISTINCT CASE WHEN DATE_TRUNC('MONTH', TRY_TO_DATE(SALES_ORDER_CREATED_DATE, 'YYYYMMDD')) = '2025-02-01' THEN SALES_ORDER_NUMBER END) +
      COUNT(DISTINCT CASE WHEN DATE_TRUNC('MONTH', TRY_TO_DATE(SALES_ORDER_CREATED_DATE, 'YYYYMMDD')) = '2025-03-01' THEN SALES_ORDER_NUMBER END) +
      COUNT(DISTINCT CASE WHEN DATE_TRUNC('MONTH', TRY_TO_DATE(SALES_ORDER_CREATED_DATE, 'YYYYMMDD')) = '2025-04-01' THEN SALES_ORDER_NUMBER END) +
      COUNT(DISTINCT CASE WHEN DATE_TRUNC('MONTH', TRY_TO_DATE(SALES_ORDER_CREATED_DATE, 'YYYYMMDD')) = '2025-05-01' THEN SALES_ORDER_NUMBER END) +
      COUNT(DISTINCT CASE WHEN DATE_TRUNC('MONTH', TRY_TO_DATE(SALES_ORDER_CREATED_DATE, 'YYYYMMDD')) = '2025-06-01' THEN SALES_ORDER_NUMBER END) +
      COUNT(DISTINCT CASE WHEN DATE_TRUNC('MONTH', TRY_TO_DATE(SALES_ORDER_CREATED_DATE, 'YYYYMMDD')) = '2025-07-01' THEN SALES_ORDER_NUMBER END) +
      COUNT(DISTINCT CASE WHEN DATE_TRUNC('MONTH', TRY_TO_DATE(SALES_ORDER_CREATED_DATE, 'YYYYMMDD')) = '2025-08-01' THEN SALES_ORDER_NUMBER END) +
      COUNT(DISTINCT CASE WHEN DATE_TRUNC('MONTH', TRY_TO_DATE(SALES_ORDER_CREATED_DATE, 'YYYYMMDD')) = '2025-09-01' THEN SALES_ORDER_NUMBER END) +
      COUNT(DISTINCT CASE WHEN DATE_TRUNC('MONTH', TRY_TO_DATE(SALES_ORDER_CREATED_DATE, 'YYYYMMDD')) = '2025-10-01' THEN SALES_ORDER_NUMBER END) +
      COUNT(DISTINCT CASE WHEN DATE_TRUNC('MONTH', TRY_TO_DATE(SALES_ORDER_CREATED_DATE, 'YYYYMMDD')) = '2025-11-01' THEN SALES_ORDER_NUMBER END) +
      COUNT(DISTINCT CASE WHEN DATE_TRUNC('MONTH', TRY_TO_DATE(SALES_ORDER_CREATED_DATE, 'YYYYMMDD')) = '2025-12-01' THEN SALES_ORDER_NUMBER END)
    ) AS "Total"
FROM F_SALES_SALES_ORDER
WHERE SOURCE_SYSTEM = 'PE1'
  AND EXTRACT(YEAR FROM TRY_TO_DATE(SALES_ORDER_CREATED_DATE, 'YYYYMMDD')) = 2025
GROUP BY ALL
ORDER BY SALES_ORDER_REASON_REJECTION_DESC;

-- Menampilkan data SO Rejection all selama 2025
SELECT DISTINCT SALES_ORDER_REASON_REJECTION_DESC, COUNT(DISTINCT SALES_ORDER_NUMBER) AS SO_NUMBER 
FROM F_SALES_SALES_ORDER WHERE SOURCE_SYSTEM = 'PE1' AND SALES_ORDER_CREATED_DATE LIKE '%2025%' GROUP BY ALL;

-- STEP 2 : Menampilkan Data Qty dan Amount Pada SO Rejection Pada Periode Tertentu --
SELECT
	CUSTOMER,
	CUSTOMER_NAME,
	CASE
		WHEN SALES_OFFICE IS NULL OR SALES_OFFICE_DESC IS NULL THEN SALES_OFFICE
    	ELSE SALES_OFFICE || '-' || SALES_OFFICE_DESC
	END AS SALES_OFFICE,
	CASE 
    	WHEN SALES_OFFICE IS NOT NULL AND SALES_OFFICE <> '' AND SALES_OFFICE_DESC IS NOT NULL AND SALES_OFFICE_DESC <> '' THEN LEFT(SALES_OFFICE_DESC, 3)
		WHEN SALES_OFFICE IS NOT NULL AND SALES_OFFICE <> '' AND (SALES_OFFICE_DESC IS NULL OR SALES_OFFICE_DESC = '') 
        THEN SALES_OFFICE
	ELSE NULL
	END AS SALES_OFFICE_LOKASI,
	C.SALES_DIVISION || '-' || SA.SALES_DIVISION_DESC AS DIVISION,
	BLOCK_FOR_SALES,
	DELETION_FOR_SALES
FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER C
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, SALES_DIVISION, SALES_DIVISION_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_AREA) SA
    ON SA.SOURCE_SYSTEM = C.SOURCE_SYSTEM
    AND SA.SALES_DIVISION = C.SALES_DIVISION
WHERE 
	C.SOURCE_SYSTEM = 'PE1'
	AND BLOCK_FOR_SALES = 'Non block'
	AND DELETION_FOR_SALES = 'Non delete';

SELECT * FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER WHERE SOURCE_SYSTEM = 'PE1';


-- OBJECTIVE #1 - DASHBOARD #2 : SALES AGING --
-- STEP 1 : RUN QUERY BELOW FOR GET SALES AGING - PE1 ONLY --
SELECT 
    SO.COMPANY_CODE || '-' || CP.COMPANY_NAME AS COMPANY,
    SO.PLANT || '-' || CP1.PLANT_NAME AS PLANT,
    SO.CUSTOMER,
    CUST.CUSTOMER_NAME AS CUSTOMER_SO_NAME,
    SO.CUSTOMER_SHIP_TO,
    CUSTSH.CUSTOMER_NAME AS CUSTOMER_SHIP_TO_NAME,
    CASE 
        WHEN CUST1.SALES_OFFICE IS NULL OR CUST1.SALES_OFFICE = '' OR CUST1.SALES_OFFICE = '9001'
            THEN SO.SALES_OFFICE || '-' || CUSTSO.SALES_OFFICE_DESC
        ELSE CUST1.SALES_OFFICE || '-' || CUST1.SALES_OFFICE_DESC
    END AS SALES_OFFICE,
    CASE 
        WHEN CUST1.SALES_OFFICE IS NULL OR CUST1.SALES_OFFICE = '' OR CUST1.SALES_OFFICE = '9001'
            THEN LEFT(CUSTSO.SALES_OFFICE_DESC, 3)
        WHEN CUST1.SALES_OFFICE_DESC IS NOT NULL AND CUST1.SALES_OFFICE_DESC <> ''
            THEN LEFT(CUST1.SALES_OFFICE_DESC, 3)
        ELSE CUST1.SALES_OFFICE
    END AS SALES_OFFICE_LOKASI,
    SO.DIVISION || '-' || SO.DIVISION_DESC AS DIVISION,
    SO.DISTRIBUTION_CHANNEL || '-' || SA.DISTRIBUTION_CHANNEL_DESC AS DISTRIBUTION_CHANNEL,
    CUST.REGION || '-' || DSR.REGION_DESC AS REGION,
    CASE WHEN DSR.REGION IN ('01','02','03','04','05','28') THEN 'PULAU JAWA' ELSE 'LUAR JAWA' END AS STATUS_REGION,
    SO.SALES_ORDER_TYPE || '-' || SO.SALES_ORDER_TYPE_DESC AS SO_TYPE,
    CASE 
        WHEN SO.SALES_ORDER_STATUS IS NULL OR SO.SALES_ORDER_STATUS_DESC IS NULL THEN SO.SALES_ORDER_STATUS_DESC
        ELSE SO.SALES_ORDER_STATUS || '-' || SO.SALES_ORDER_STATUS_DESC
    END AS SALES_ORDER_STATUS,
    SO.SALES_ORDER_STATUS_REJECTION || '-' || SO.SALES_ORDER_STATUS_REJECTION_DESC AS SALES_ORDER_STATUS_REJECTION,
    SALES_ORDER_REASON || '-' || SALES_ORDER_REASON_DESC AS SALES_ORDER_REASON_DESC,
    CASE 
        WHEN SO.SALES_ORDER_TYPE = 'ZB20' THEN 'Interco Automation MT'
        WHEN SO.SALES_ORDER_TYPE = 'ZB01' AND SO.CUSTOMER = '2000174657' THEN 'Interco Automation FS'
        ELSE 'Non Interco'
    END AS CATEGORY,
    SO.CREATED_BY,
    SO.SALES_ORDER_NUMBER AS SO_NUMBER,
    CASE 
        WHEN SO.SALES_ORDER_TYPE = 'ZB20' THEN SO1.SALES_ORDER_NUMBER
        WHEN SO.SALES_ORDER_TYPE = 'ZB01' AND SO.CUSTOMER = '2000174657' THEN SO.SALES_ORDER_EXTERNAL_DOCUMENT
        ELSE SO.SALES_ORDER_EXTERNAL_DOCUMENT
    END AS SALES_ORDER_REFERENCE,
    TRY_TO_DATE(SO.SALES_ORDER_CREATED_DATE,'YYYYMMDD') AS SO_CREATED_DATE,
    TRY_TO_DATE(SO.SALES_ORDER_DATE,'YYYYMMDD') AS SO_DATE,
    ROUND(SUM(SO.SALES_ORDER_NEGATIVE_FLAG * SO.SALES_ORDER_QUANTITY_IN_KG),2) AS SO_QTY_IN_KG,
    ROUND(SUM(SO.SALES_ORDER_NEGATIVE_FLAG * SO.SALES_ORDER_NET_AMOUNT),2) AS SO_AMOUNT
FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER SO
LEFT JOIN (
    SELECT 
        SALES_ORDER_EXTERNAL_DOCUMENT,
        SALES_ORDER_NUMBER,
        SALES_ORDER_TYPE
    FROM (
        SELECT 
            SALES_ORDER_EXTERNAL_DOCUMENT,
            SALES_ORDER_NUMBER,
            SALES_ORDER_TYPE,
            ROW_NUMBER() OVER (
                PARTITION BY SALES_ORDER_EXTERNAL_DOCUMENT 
                ORDER BY SALES_ORDER_NUMBER
            ) AS RN
        FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER
        WHERE SALES_ORDER_TYPE NOT IN ('ZKS3','ZKSC','ZKR3','ZKRC','ZKD3','ZKDC')
    )
    WHERE RN = 1
) SO1
    ON SO1.SALES_ORDER_EXTERNAL_DOCUMENT = SO.SALES_ORDER_NUMBER
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, CUSTOMER, CUSTOMER_NAME, REGION 
           FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER) CUST
    ON CUST.SOURCE_SYSTEM = SO.SOURCE_SYSTEM AND CUST.CUSTOMER = SO.CUSTOMER
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, CUSTOMER, CUSTOMER_NAME 
           FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER) CUSTSH
    ON CUSTSH.SOURCE_SYSTEM = SO.SOURCE_SYSTEM AND CUSTSH.CUSTOMER = SO.CUSTOMER_SHIP_TO
LEFT JOIN (
    SELECT SOURCE_SYSTEM, CUSTOMER, SALES_OFFICE, SALES_OFFICE_DESC, SALES_DIVISION
    FROM (
        SELECT 
            SOURCE_SYSTEM, CUSTOMER, SALES_OFFICE, SALES_OFFICE_DESC, SALES_DIVISION,
            ROW_NUMBER() OVER (
                PARTITION BY SOURCE_SYSTEM, CUSTOMER 
                ORDER BY CASE WHEN SALES_OFFICE <> '9001' THEN 0 ELSE 1 END, SALES_OFFICE
            ) AS RN
        FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER
        WHERE BLOCK_FOR_SALES='Non block' AND DELETION_FOR_SALES='Non delete'
    )
    QUALIFY RN = 1
) CUST1
    ON CUST1.SOURCE_SYSTEM = SO.SOURCE_SYSTEM AND CUST1.CUSTOMER = SO.CUSTOMER
LEFT JOIN (
    SELECT DISTINCT SOURCE_SYSTEM, SALES_OFFICE, SALES_OFFICE_DESC
    FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER
    WHERE BLOCK_FOR_SALES='Non block' AND DELETION_FOR_SALES='Non delete'
) CUSTSO
    ON CUSTSO.SOURCE_SYSTEM = SO.SOURCE_SYSTEM AND CUSTSO.SALES_OFFICE = SO.SALES_OFFICE
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, COMPANY_CODE, COMPANY_NAME 
           FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT) CP
    ON CP.SOURCE_SYSTEM = SO.SOURCE_SYSTEM AND CP.COMPANY_CODE = SO.COMPANY_CODE
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, PLANT, PLANT_NAME 
           FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT) CP1
    ON CP1.SOURCE_SYSTEM = SO.SOURCE_SYSTEM AND CP1.PLANT = SO.PLANT
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, DISTRIBUTION_CHANNEL, DISTRIBUTION_CHANNEL_DESC 
           FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_AREA) SA
    ON SA.SOURCE_SYSTEM = SO.SOURCE_SYSTEM AND SA.DISTRIBUTION_CHANNEL = SO.DISTRIBUTION_CHANNEL
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, REGION, REGION_DESC, COUNTRY 
           FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_REGION) DSR
    ON DSR.SOURCE_SYSTEM = CUST.SOURCE_SYSTEM 
   AND DSR.REGION = CUST.REGION 
   AND DSR.COUNTRY = 'ID'
WHERE 
    SO.SOURCE_SYSTEM = 'PE1'
    AND SO.COMPANY_CODE = 'ID90'
    AND SO.SALES_ORDER_STATUS_REJECTION NOT IN ('A','B')
    AND SO.SALES_ORDER_STATUS_REJECTION IS NOT NULL
    AND SO.SALES_ORDER_TYPE NOT IN ('ZB51','ZB52','ZB53','ZB54','ZB55','ZB56','ZB59')
    AND SO.PLANT NOT IN ('901A','905A','90VA','90VB','90VC','90WA','90XA','90ZA')
    AND TRY_TO_DATE(SO.SALES_ORDER_CREATED_DATE,'YYYYMMDD') BETWEEN '2025-08-01' AND '2025-11-14'
    /*AND SO_NUMBER IN ('1207512740','1207486153','1207505886','1207443635','1207419319')*/
GROUP BY
    SO.COMPANY_CODE, CP.COMPANY_NAME,
    SO.PLANT, CP1.PLANT_NAME,
    SO.CUSTOMER, CUST.CUSTOMER_NAME,
    SO.CUSTOMER_SHIP_TO, CUSTSH.CUSTOMER_NAME,
    CUST1.SALES_OFFICE, CUST1.SALES_OFFICE_DESC,
    SO.SALES_OFFICE, CUSTSO.SALES_OFFICE_DESC,
    SO.DIVISION, SO.DIVISION_DESC,
    SO.DISTRIBUTION_CHANNEL, SA.DISTRIBUTION_CHANNEL_DESC,
    CUST.REGION, DSR.REGION_DESC,
    DSR.REGION,
    SO.SALES_ORDER_TYPE, SO.SALES_ORDER_TYPE_DESC,
    SO.SALES_ORDER_STATUS, SO.SALES_ORDER_STATUS_DESC,
    SO.SALES_ORDER_STATUS_REJECTION, SO.SALES_ORDER_STATUS_REJECTION_DESC,
    SALES_ORDER_REASON, SALES_ORDER_REASON_DESC,
    SO.SALES_ORDER_TYPE, SO.CUSTOMER,
    SO.CREATED_BY,
    SO.SALES_ORDER_NUMBER,
    SO1.SALES_ORDER_NUMBER,
    SO.SALES_ORDER_EXTERNAL_DOCUMENT,
    SO.SALES_ORDER_CREATED_DATE,
    SO.SALES_ORDER_DATE;
