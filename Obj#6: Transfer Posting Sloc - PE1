WITH BASE AS (
    SELECT 
    	SOURCE_SYSTEM ,
    	FISCAL_YEAR ,
    	MATERIAL_DOCUMENT_YEAR,
    	COMPANY_CODE ,
    	MATERIAL_DOCUMENT_NUMBER,
    	MATERIAL_DOCUMENT_ITEM, 
    	MATERIAL_DOCUMENT_OF_REVERSE,
    	MATERIAL_DOC_ITEM_OF_REVERSE,
    	"REFERENCE",
    	MOVEMENT_TYPE,
    	MOVEMENT_TYPE_DESC,
    	MATERIAL ,
    	MATERIAL_DESC ,
    	POSTING_DATE,
    	PLANT,
    	PLANT_NAME ,
    	STORAGE_LOCATION ,
    	STORAGE_LOCATION_NAME ,
    	RECEIVING_PLANT ,
    	RECEIVING_STOR_LOC ,
    	SIGNED_QUANTITY_FOR_BALANCE,
    	ITEM_AUTOMATICALLY_CREATED
    FROM F_SCM_STOCK_TRANSACTION_SAP
    WHERE ITEM_AUTOMATICALLY_CREATED IS NULL AND FISCAL_YEAR = '2025'
      AND ((MOVEMENT_TYPE IN ('313','314','315','316') AND SOURCE_SYSTEM = 'PE2') OR (MOVEMENT_TYPE IN ('313','314','315','316') AND SOURCE_SYSTEM = 'PE1')) --> Two Step
    UNION ALL
    SELECT 
    	SOURCE_SYSTEM ,
    	FISCAL_YEAR ,
    	MATERIAL_DOCUMENT_YEAR,
    	COMPANY_CODE ,
    	MATERIAL_DOCUMENT_NUMBER,
    	MATERIAL_DOCUMENT_ITEM, 
    	MATERIAL_DOCUMENT_OF_REVERSE,
    	MATERIAL_DOC_ITEM_OF_REVERSE,
    	"REFERENCE",
    	MOVEMENT_TYPE,
    	MOVEMENT_TYPE_DESC,
    	MATERIAL ,
    	MATERIAL_DESC ,
    	POSTING_DATE,
    	PLANT,
    	PLANT_NAME ,
    	STORAGE_LOCATION ,
    	STORAGE_LOCATION_NAME ,
    	RECEIVING_PLANT ,
    	RECEIVING_STOR_LOC ,
    	SIGNED_QUANTITY_FOR_BALANCE,
    	ITEM_AUTOMATICALLY_CREATED
    FROM F_SCM_STOCK_TRANSACTION_SAP
    WHERE FISCAL_YEAR = '2025' AND ((MOVEMENT_TYPE IN ('301','302') AND SOURCE_SYSTEM = 'PE2') OR (MOVEMENT_TYPE IN ('311','312') AND SOURCE_SYSTEM = 'PE1')) --> One Step
), 
/* =========================
   SENDER (313 / 314)
   ========================= */
SENDER AS (
    SELECT *, ROW_NUMBER() OVER (PARTITION BY a.SOURCE_SYSTEM,a.COMPANY_CODE, a.FISCAL_YEAR, a.MATERIAL_DOCUMENT_NUMBER, a.MATERIAL  ORDER BY a.MATERIAL_DOCUMENT_ITEM) AS ROW_NUMBER_SENDER
    FROM (
	SELECT 
    	a.SOURCE_SYSTEM ,
    	a.FISCAL_YEAR ,
    	a.MATERIAL_DOCUMENT_YEAR,
    	a.COMPANY_CODE ,
    	a.MATERIAL_DOCUMENT_NUMBER,
    	a.MATERIAL_DOCUMENT_ITEM, 
    	a."REFERENCE",
    	a.MOVEMENT_TYPE,
    	a.MOVEMENT_TYPE_DESC,
    	a.MATERIAL ,
    	a.MATERIAL_DESC ,
    	a.POSTING_DATE,
    	a.PLANT,
    	a.PLANT_NAME ,
    	a.STORAGE_LOCATION ,
    	a.STORAGE_LOCATION_NAME ,
    	a.RECEIVING_PLANT ,
    	a.RECEIVING_STOR_LOC ,
    	sum(a.SIGNED_QUANTITY_FOR_BALANCE + COALESCE(b.SIGNED_QUANTITY_FOR_BALANCE,0)) AS SIGNED_QUANTITY_FOR_BALANCE
    FROM BASE a
    	LEFT JOIN (
    		SELECT 
    			SOURCE_SYSTEM ,
		    	FISCAL_YEAR ,
		    	MATERIAL_DOCUMENT_YEAR,
		    	COMPANY_CODE ,
		    	MATERIAL_DOCUMENT_OF_REVERSE,
		    	MATERIAL_DOC_ITEM_OF_REVERSE,
		    	SIGNED_QUANTITY_FOR_BALANCE
		    FROM BASE
		    WHERE MOVEMENT_TYPE IN  ('314') --OR (MOVEMENT_TYPE IN ('302','312') AND MATERIAL_DOCUMENT_OF_REVERSE IS NOT NULL)
    	) b ON a.SOURCE_SYSTEM = b.SOURCE_SYSTEM AND a.FISCAL_YEAR = b.FISCAL_YEAR AND a.COMPANY_CODE = b.COMPANY_CODE AND a.MATERIAL_DOCUMENT_NUMBER = b.MATERIAL_DOCUMENT_OF_REVERSE
    	AND a.MATERIAL_DOCUMENT_ITEM = b.MATERIAL_DOC_ITEM_OF_REVERSE 
    WHERE a.MOVEMENT_TYPE IN ('313') --OR (MOVEMENT_TYPE IN ('301','311') AND a.MATERIAL_DOCUMENT_OF_REVERSE IS NULL)
    GROUP BY ALL 
    HAVING sum(a.SIGNED_QUANTITY_FOR_BALANCE + COALESCE(b.SIGNED_QUANTITY_FOR_BALANCE,0)) <>0 
    ) a
) 
,
/* =========================
   RECEIVER (315 / 316)
   ========================= */
RECEIVER AS (
	SELECT *, ROW_NUMBER() OVER (PARTITION BY a.SOURCE_SYSTEM,a.COMPANY_CODE, a.FISCAL_YEAR, a.MATERIAL_DOCUMENT_NUMBER, a.MATERIAL  ORDER BY a.MATERIAL_DOCUMENT_ITEM) AS ROW_NUMBER_RECEIVER 
	FROM (
	SELECT 
    	a.SOURCE_SYSTEM ,
    	a.FISCAL_YEAR ,
    	a.MATERIAL_DOCUMENT_YEAR,
    	a.COMPANY_CODE ,
    	a.MATERIAL_DOCUMENT_NUMBER,
    	a.MATERIAL_DOCUMENT_ITEM, 
    	a."REFERENCE",
    	a.MOVEMENT_TYPE,
    	a.MOVEMENT_TYPE_DESC,
    	a.MATERIAL ,
    	a.MATERIAL_DESC ,
    	a.POSTING_DATE,
    	a.PLANT,
    	a.PLANT_NAME ,
    	a.STORAGE_LOCATION ,
    	a.STORAGE_LOCATION_NAME ,
    	a.RECEIVING_PLANT ,
    	a.RECEIVING_STOR_LOC ,
    	sum(a.SIGNED_QUANTITY_FOR_BALANCE + COALESCE(b.SIGNED_QUANTITY_FOR_BALANCE,0)) AS SIGNED_QUANTITY_FOR_BALANCE
    FROM BASE a
    	LEFT JOIN (
    		SELECT 
    			SOURCE_SYSTEM ,
		    	FISCAL_YEAR ,
		    	MATERIAL_DOCUMENT_YEAR,
		    	COMPANY_CODE ,
		    	MATERIAL_DOCUMENT_OF_REVERSE,
		    	MATERIAL_DOC_ITEM_OF_REVERSE,
		    	SIGNED_QUANTITY_FOR_BALANCE
		    FROM BASE
		    WHERE MOVEMENT_TYPE = '316'
    	) b ON a.SOURCE_SYSTEM = b.SOURCE_SYSTEM AND a.FISCAL_YEAR = b.FISCAL_YEAR AND a.COMPANY_CODE = b.COMPANY_CODE AND a.MATERIAL_DOCUMENT_NUMBER = b.MATERIAL_DOCUMENT_OF_REVERSE
    	AND a.MATERIAL_DOCUMENT_ITEM = b.MATERIAL_DOC_ITEM_OF_REVERSE 
    WHERE a.MOVEMENT_TYPE = '315' AND a."REFERENCE" IS NOT NULL
    GROUP BY ALL 
    HAVING sum(a.SIGNED_QUANTITY_FOR_BALANCE + COALESCE(b.SIGNED_QUANTITY_FOR_BALANCE,0)) <>0  
    ) a
)--SELECT * FROM receiver;
, 
ONE_STEP AS (
SELECT *, 0 AS ROW_NUMBER_SENDER
    FROM (
	SELECT 
    	a.SOURCE_SYSTEM ,
    	a.FISCAL_YEAR ,
    	a.MATERIAL_DOCUMENT_YEAR,
    	a.COMPANY_CODE ,
    	a.MATERIAL_DOCUMENT_NUMBER,
    	a.MATERIAL_DOCUMENT_ITEM, 
    	a."REFERENCE",
    	a.MOVEMENT_TYPE,
    	a.MOVEMENT_TYPE_DESC,
    	a.MATERIAL ,
    	a.MATERIAL_DESC ,
    	a.POSTING_DATE,
    	a.PLANT,
    	a.PLANT_NAME ,
    	a.STORAGE_LOCATION ,
    	a.STORAGE_LOCATION_NAME ,
    	a.RECEIVING_PLANT ,
    	a.RECEIVING_STOR_LOC ,
    	sum(a.SIGNED_QUANTITY_FOR_BALANCE + COALESCE(b.SIGNED_QUANTITY_FOR_BALANCE,0)) AS SIGNED_QUANTITY_FOR_BALANCE,
    	a.ITEM_AUTOMATICALLY_CREATED
    FROM BASE a
    	LEFT JOIN (
    		SELECT 
    			SOURCE_SYSTEM ,
		    	FISCAL_YEAR ,
		    	MATERIAL_DOCUMENT_YEAR,
		    	COMPANY_CODE ,
		    	MATERIAL_DOCUMENT_OF_REVERSE,
		    	MATERIAL_DOC_ITEM_OF_REVERSE,
		    	SIGNED_QUANTITY_FOR_BALANCE
		    FROM BASE
		    WHERE (MOVEMENT_TYPE IN ('302','312') AND MATERIAL_DOCUMENT_OF_REVERSE IS NOT NULL)
    	) b ON a.SOURCE_SYSTEM = b.SOURCE_SYSTEM AND a.FISCAL_YEAR = b.FISCAL_YEAR AND a.COMPANY_CODE = b.COMPANY_CODE AND a.MATERIAL_DOCUMENT_NUMBER = b.MATERIAL_DOCUMENT_OF_REVERSE
    	AND a.MATERIAL_DOCUMENT_ITEM = b.MATERIAL_DOC_ITEM_OF_REVERSE 
    WHERE (MOVEMENT_TYPE IN ('301','311') AND a.MATERIAL_DOCUMENT_OF_REVERSE IS NULL)
    GROUP BY ALL 
    HAVING sum(a.SIGNED_QUANTITY_FOR_BALANCE + COALESCE(b.SIGNED_QUANTITY_FOR_BALANCE,0)) <>0 
    ) a
),
ONE_STEP_SENDER AS (
	SELECT 
		a.SOURCE_SYSTEM ,
    	a.FISCAL_YEAR ,
    	a.MATERIAL_DOCUMENT_YEAR,
    	a.COMPANY_CODE ,
    	a.MATERIAL_DOCUMENT_NUMBER,
    	a.MATERIAL_DOCUMENT_ITEM, 
    	a."REFERENCE",
    	a.MOVEMENT_TYPE,
    	a.MOVEMENT_TYPE_DESC,
    	a.MATERIAL ,
    	a.MATERIAL_DESC ,
    	a.POSTING_DATE,
    	a.PLANT,
    	a.PLANT_NAME ,
    	a.STORAGE_LOCATION ,
    	a.STORAGE_LOCATION_NAME ,
    	a.RECEIVING_PLANT ,
    	a.RECEIVING_STOR_LOC ,
    	a.SIGNED_QUANTITY_FOR_BALANCE,
    	a.ITEM_AUTOMATICALLY_CREATED,
    	ROW_NUMBER() OVER (PARTITION BY a.SOURCE_SYSTEM,a.COMPANY_CODE, a.FISCAL_YEAR, a.MATERIAL_DOCUMENT_NUMBER, a.MATERIAL  ORDER BY a.MATERIAL_DOCUMENT_ITEM) AS ROW_NUMBER_SENDER
    FROM ONE_STEP a WHERE a.ITEM_AUTOMATICALLY_CREATED IS NULL
),
ONE_STEP_RECEIVER AS (
	SELECT 
		a.SOURCE_SYSTEM ,
    	a.FISCAL_YEAR ,
    	a.MATERIAL_DOCUMENT_YEAR,
    	a.COMPANY_CODE ,
    	a.MATERIAL_DOCUMENT_NUMBER,
    	a.MATERIAL_DOCUMENT_ITEM, 
    	a."REFERENCE",
    	a.MOVEMENT_TYPE,
    	a.MOVEMENT_TYPE_DESC,
    	a.MATERIAL ,
    	a.MATERIAL_DESC ,
    	a.POSTING_DATE,
    	a.PLANT,
    	a.PLANT_NAME ,
    	a.STORAGE_LOCATION ,
    	a.STORAGE_LOCATION_NAME ,
    	a.RECEIVING_PLANT ,
    	a.RECEIVING_STOR_LOC ,
    	a.SIGNED_QUANTITY_FOR_BALANCE,
    	a.ITEM_AUTOMATICALLY_CREATED,
    	ROW_NUMBER() OVER (PARTITION BY a.SOURCE_SYSTEM,a.COMPANY_CODE, a.FISCAL_YEAR, a.MATERIAL_DOCUMENT_NUMBER, a.MATERIAL  ORDER BY a.MATERIAL_DOCUMENT_ITEM) AS ROW_NUMBER_RECEIVER
    FROM ONE_STEP a WHERE a.ITEM_AUTOMATICALLY_CREATED IS NOT NULL
),
calc AS (
SELECT
    /* === KEY === */
    S.SOURCE_SYSTEM,
    S.FISCAL_YEAR,
    S.COMPANY_CODE || '-' || sc.COMPANY_NAME AS COMPANY,
    /* === DOCUMENT === */
    S.MATERIAL_DOCUMENT_NUMBER AS MAT_DOC_SENDER,
    S.MATERIAL_DOCUMENT_ITEM AS MAT_DOC_ITEM_SENDER,
    S.MOVEMENT_TYPE || '-' || S.MOVEMENT_TYPE_DESC AS MOVEMENT_TYPE_SENDER,
    R.MATERIAL_DOCUMENT_NUMBER AS MAT_DOC_RECEIVER,
    R.MATERIAL_DOCUMENT_ITEM AS MAT_DOC_ITEM_RECEIVER,
    R.MOVEMENT_TYPE || '-' || R.MOVEMENT_TYPE_DESC AS MOVEMENT_TYPE_RECEIVER,
    S.MATERIAL_DOCUMENT_YEAR,
    S.MATERIAL,
    /* === DESCRIPTION === */
    S.MATERIAL_DESC,
	mm.MATERIAL_GROUP || '-' || mm.MATERIAL_GROUP_DESC AS MATERIAL_GROUP,
    mm.MATERIAL_TYPE || '-' || mm.MATERIAL_TYPE_DESC AS MATERIAL_TYPE,
	CASE
        WHEN mm.MATERIAL LIKE '%00000000104%' AND mm.MATERIAL_DESC ILIKE '%KF%'
        THEN 'Frozen'
        WHEN mm.MATERIAL LIKE '%00000000105%' AND mm.MATERIAL_DESC ILIKE '%TC%'
        THEN 'Fresh'
        ELSE 'N/A'
    END AS MATERIAL_CATEGORY,
    mm.BASE_UOM,
    /* === SENDER INFO === */
	TRY_TO_DATE(S.POSTING_DATE, 'YYYYMMDD') AS POSTING_DATE_SENDER,
    S.PLANT || '-' || S.PLANT_NAME AS PLANT_SENDER,
    S.STORAGE_LOCATION || '-' || S.STORAGE_LOCATION_NAME AS STORAGE_LOCATION_SENDER,
    /* === RECEIVER INFO === */
    TRY_TO_DATE(R.POSTING_DATE, 'YYYYMMDD') AS POSTING_DATE_RECEIVER,
    R.PLANT || '-' || R.PLANT_NAME AS PLANT_RECEIVER,
    R.STORAGE_LOCATION || '-' || R.STORAGE_LOCATION_NAME AS STORAGE_LOCATION_RECEIVER,
    /* === QUANTITY === */
    S.SIGNED_QUANTITY_FOR_BALANCE AS SIGNED_QUANTITY_FOR_BALANCE_SENDER,
    R.SIGNED_QUANTITY_FOR_BALANCE AS SIGNED_QUANTITY_FOR_BALANCE_RECEIVER,
    (S.SIGNED_QUANTITY_FOR_BALANCE + COALESCE(R.SIGNED_QUANTITY_FOR_BALANCE,0)) AS QTY_DIFF,
	CASE
	    WHEN R.SIGNED_QUANTITY_FOR_BALANCE IS NULL THEN 'NOT YET DELIVERED'
	    WHEN (S.SIGNED_QUANTITY_FOR_BALANCE + COALESCE(R.SIGNED_QUANTITY_FOR_BALANCE,0)) = 0 THEN 'MATCH'
    	ELSE 'SELISIH'
	END AS KETERANGAN
FROM SENDER S
LEFT JOIN RECEIVER R
    ON  S.SOURCE_SYSTEM = R.SOURCE_SYSTEM
    AND S.COMPANY_CODE = R.COMPANY_CODE
    AND S.MATERIAL = R.MATERIAL
    AND S.MATERIAL_DOCUMENT_NUMBER = R.REFERENCE
    AND S.RECEIVING_PLANT = R.PLANT
    AND S.RECEIVING_STOR_LOC = R.STORAGE_LOCATION
    AND s.ROW_NUMBER_SENDER = r.row_number_RECEIVER
LEFT JOIN D_SCM_MATERIAL mm
	ON S.MATERIAL = mm.MATERIAL AND S.SOURCE_SYSTEM = mm.SOURCE_SYSTEM 
LEFT JOIN D_SCM_COMPANY sc
	ON S.COMPANY_CODE = sc.COMPANY_CODE AND S.SOURCE_SYSTEM = sc.SOURCE_SYSTEM  
UNION ALL 
SELECT
    /* === KEY === */
    S.SOURCE_SYSTEM,
    S.FISCAL_YEAR,
    S.COMPANY_CODE || '-' || sc.COMPANY_NAME AS COMPANY,
    /* === DOCUMENT === */
    S.MATERIAL_DOCUMENT_NUMBER AS MAT_DOC_SENDER,
    S.MATERIAL_DOCUMENT_ITEM AS MAT_DOC_ITEM_SENDER,
    S.MOVEMENT_TYPE || '-' || S.MOVEMENT_TYPE_DESC AS MOVEMENT_TYPE_SENDER,
    R.MATERIAL_DOCUMENT_NUMBER AS MAT_DOC_RECEIVER,
    R.MATERIAL_DOCUMENT_ITEM AS MAT_DOC_ITEM_RECEIVER,
    R.MOVEMENT_TYPE || '-' || R.MOVEMENT_TYPE_DESC AS MOVEMENT_TYPE_RECEIVER,
    S.MATERIAL_DOCUMENT_YEAR,
    S.MATERIAL,
    /* === DESCRIPTION === */
    S.MATERIAL_DESC,
	mm.MATERIAL_GROUP || '-' || mm.MATERIAL_GROUP_DESC AS MATERIAL_GROUP,
    mm.MATERIAL_TYPE || '-' || mm.MATERIAL_TYPE_DESC AS MATERIAL_TYPE,
	CASE
        WHEN mm.MATERIAL LIKE '%00000000104%' AND mm.MATERIAL_DESC ILIKE '%KF%'
        THEN 'Frozen'
        WHEN mm.MATERIAL LIKE '%00000000105%' AND mm.MATERIAL_DESC ILIKE '%TC%'
        THEN 'Fresh'
        ELSE 'N/A'
    END AS MATERIAL_CATEGORY,
    mm.BASE_UOM,
    /* === SENDER INFO === */
	TRY_TO_DATE(S.POSTING_DATE, 'YYYYMMDD') AS POSTING_DATE_SENDER,
    S.PLANT || '-' || S.PLANT_NAME AS PLANT_SENDER,
    S.STORAGE_LOCATION || '-' || S.STORAGE_LOCATION_NAME AS STORAGE_LOCATION_SENDER,
    /* === RECEIVER INFO === */
    TRY_TO_DATE(R.POSTING_DATE, 'YYYYMMDD') AS POSTING_DATE_RECEIVER,
    R.PLANT || '-' || R.PLANT_NAME AS PLANT_RECEIVER,
    R.STORAGE_LOCATION || '-' || R.STORAGE_LOCATION_NAME AS STORAGE_LOCATION_RECEIVER,
    /* === QUANTITY === */
    S.SIGNED_QUANTITY_FOR_BALANCE AS SIGNED_QUANTITY_FOR_BALANCE_SENDER,
    R.SIGNED_QUANTITY_FOR_BALANCE AS SIGNED_QUANTITY_FOR_BALANCE_RECEIVER,
    (S.SIGNED_QUANTITY_FOR_BALANCE + COALESCE(R.SIGNED_QUANTITY_FOR_BALANCE,0)) AS QTY_DIFF,
    CASE
	    WHEN R.SIGNED_QUANTITY_FOR_BALANCE IS NULL THEN 'NOT YET DELIVERED'
	    WHEN (S.SIGNED_QUANTITY_FOR_BALANCE + COALESCE(R.SIGNED_QUANTITY_FOR_BALANCE,0)) = 0 THEN 'MATCH'
    	ELSE 'SELISIH'
	END AS KETERANGAN
FROM ONE_STEP_SENDER S
LEFT JOIN ONE_STEP_RECEIVER R
    ON  S.SOURCE_SYSTEM = R.SOURCE_SYSTEM
    AND S.COMPANY_CODE = R.COMPANY_CODE
    AND S.MATERIAL = R.MATERIAL
    AND S.MATERIAL_DOCUMENT_NUMBER = R.MATERIAL_DOCUMENT_NUMBER
    AND S.RECEIVING_PLANT = R.PLANT
    AND S.RECEIVING_STOR_LOC = R.STORAGE_LOCATION
    AND s.ROW_NUMBER_SENDER = r.row_number_RECEIVER
LEFT JOIN D_SCM_MATERIAL mm
	ON S.MATERIAL = mm.MATERIAL AND S.SOURCE_SYSTEM = mm.SOURCE_SYSTEM 
LEFT JOIN D_SCM_COMPANY sc
	ON S.COMPANY_CODE = sc.COMPANY_CODE AND S.SOURCE_SYSTEM = sc.SOURCE_SYSTEM     
) SELECT * FROM calc WHERE SOURCE_SYSTEM = 'PE1' AND COMPANY LIKE '%ID90%'
;
