SELECT
AR.SOURCE_SYSTEM,
AR.COMPANY_CODE,
AR.DISTRIBUTION_CHANNEL ||'-'|| SA.DISTRIBUTION_CHANNEL_DESC AS DISTRIBUTION_CHANNEL_FULL,
CUST.SALES_OFFICE ||'-'|| CUST.SALES_OFFICE_DESC AS SALES_OFFICE,
AR.BILLING_NUMBER,
AR.DOCUMENT_TYPE ||'-'|| AR.DOCUMENT_TYPE_DESC AS DOCUMENT_TYPE,
AR.REMARKS_DOC_TYPE,
--AR.STATUS,
AR.CUSTOMER,
AR.CUSTOMER_NAME,
AR.PAYMENT_TERM_DAYS,
CASE 
	WHEN AR.PAYMENT_TERM IN ('T014','TO14') THEN 'T014'
    WHEN AR.PAYMENT_TERM IN ('T030','TO30') THEN 'T030'
    WHEN AR.PAYMENT_TERM IN ('T045','TO45') THEN 'T045'
    ELSE AR.PAYMENT_TERM 
END AS PAYMENT_TERM,
AR.BLOCK_FOR_SALES,
AR.DELETION_FOR_SALES,
AR.CREDIT_LIMIT,
AR.TOTAL_AMOUNT,
AR.NOT_DUE,
AR.DAYS_1_10,
AR.DAYS_11_30,
AR.DAYS_31_60,
AR.DAYS_61_90,
AR.DAYS_91_120,
AR.DAYS_121_150,
AR.DAYS_151_360,
AR.OVER_361_DAYS,
CASE 
	WHEN ROW_NUMBER() OVER (PARTITION BY AR.CUSTOMER_NAME ORDER BY AR.BILLING_NUMBER) = 1 
    THEN AVG(AR.TOTAL_AMOUNT) OVER (PARTITION BY AR.CUSTOMER_NAME)
    ELSE NULL
END AS AR_AMOUNT_TOTAL
FROM PROD_DB.DSTR_BI_COMMUNITY.F_FINANCE_AR_AGING_CUSTOMER_CURRENT AR
LEFT JOIN (
    SELECT DISTINCT DISTRIBUTION_CHANNEL, DISTRIBUTION_CHANNEL_DESC 
    FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_AREA
) SA
    ON AR.DISTRIBUTION_CHANNEL = SA.DISTRIBUTION_CHANNEL
LEFT JOIN (
    SELECT DISTINCT CUSTOMER, SOURCE_SYSTEM, SALES_OFFICE, SALES_OFFICE_DESC, BLOCK_FOR_SALES, DELETION_FOR_SALES
    FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER
) CUST
    ON AR.SOURCE_SYSTEM = CUST.SOURCE_SYSTEM
    AND AR.CUSTOMER = CUST.CUSTOMER
WHERE AR.SOURCE_SYSTEM = 'PE1' 
	AND AR.BLOCK_FOR_SALES = 'Non block'
	AND AR.DELETION_FOR_SALES = 'Non delete'
	AND CUST.BLOCK_FOR_SALES = 'Non block'
	AND CUST.DELETION_FOR_SALES = 'Non delete'
	AND FISCAL_YEAR = '2025';
