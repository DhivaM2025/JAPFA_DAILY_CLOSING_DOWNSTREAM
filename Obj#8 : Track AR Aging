WITH base AS (
  SELECT
      AR.SOURCE_SYSTEM,
      AR.COMPANY_CODE,
      AR.DISTRIBUTION_CHANNEL ||' - '|| AR.DISTRIBUTION_CHANNEL_DESC AS DISTRIBUTION_CHANNEL_FULL,
      CASE
        WHEN CUST.SALES_OFFICE IS NULL OR CUST.SALES_OFFICE_DESC IS NULL THEN CUST.SALES_OFFICE
        ELSE CUST.SALES_OFFICE || '-' || CUST.SALES_OFFICE_DESC
      END AS SALES_OFFICE,
      CASE 
          WHEN CUST.SALES_OFFICE IS NOT NULL AND CUST.SALES_OFFICE <> '' AND CUST.SALES_OFFICE_DESC IS NOT NULL AND CUST.SALES_OFFICE_DESC <> '' 
              THEN LEFT(CUST.SALES_OFFICE_DESC, 3)
          WHEN CUST.SALES_OFFICE IS NOT NULL AND CUST.SALES_OFFICE <> '' AND (CUST.SALES_OFFICE_DESC IS NULL OR CUST.SALES_OFFICE_DESC = '') 
              THEN CUST.SALES_OFFICE
          ELSE NULL
      END AS SALES_OFFICE_LOKASI,
      AR.BILLING_NUMBER,
      AR.REFERENCE_DOCUMENT,
      AR.ACCOUNT_DOC_NUMBER,
      AR.DOCUMENT_TYPE ||' - '|| AR.DOCUMENT_TYPE_DESC AS DOCUMENT_TYPE,
      AR.REMARKS_DOC_TYPE,
      AR.CUSTOMER,
      AR.CUSTOMER_NAME,
      AR.CUSTOMER_CLASS ||' - '|| AR.CUSTOMER_CLASS_DESC AS CUSTOMER_CLASS,
      AR.CUSTOMER_GROUP ||' - '|| AR.CUSTOMER_GROUP_DESC AS CUSTOMER_GROUP,
      AR.SALES_DIVISION ||' - '|| AR.SALES_DIVISION_DESC AS SALES_DIVISION,
      AR.PAYMENT_TERM_DAYS,
      CASE 
          WHEN AR.PAYMENT_TERM IN ('T014','TO14') THEN 'T014'
          WHEN AR.PAYMENT_TERM IN ('T030','TO30') THEN 'T030'
          WHEN AR.PAYMENT_TERM IN ('T045','TO45') THEN 'T045'
          ELSE AR.PAYMENT_TERM 
      END AS PAYMENT_TERM,
      AR.BLOCK_FOR_SALES,
      AR.DELETION_FOR_SALES,
      AR.CREDIT_LIMIT,
      BILL.BILLING_DATE,
      TF.TTF_DOC_DATE,
      AD.POSTING_DATE AS ACCOUNTING_DOC_POSTING_DATE,
      AR.EFFECTIVE_BASELINE_DATE_FLAG,
      AR.DUE_DATE,
      AR.NOT_DUE,
      AR.DAYS_1_10,
      AR.DAYS_11_30,
      AR.DAYS_31_60,
      AR.DAYS_61_90,
      AR.DAYS_91_120,
      AR.DAYS_121_150,
      AR.DAYS_151_360,
      AR.OVER_361_DAYS,
      AR.TOTAL_AMOUNT
  FROM PROD_DB.DSTR_BI_COMMUNITY.F_FINANCE_AR_AGING_CUSTOMER_CURRENT AR
  LEFT JOIN (
     SELECT SOURCE_SYSTEM, CUSTOMER, DISTRIBUTION_CHANNEL, SALES_ORGANIZATION, SALES_DIVISION, SALES_OFFICE, SALES_OFFICE_DESC, 
            ROW_NUMBER() OVER (PARTITION BY CUSTOMER, SALES_DIVISION ORDER BY SALES_OFFICE) AS rn
     FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER
  ) CUST
    ON AR.SOURCE_SYSTEM = CUST.SOURCE_SYSTEM
    AND AR.CUSTOMER = CUST.CUSTOMER 
    AND AR.SALES_DIVISION = CUST.SALES_DIVISION
    AND AR.DISTRIBUTION_CHANNEL = CUST.DISTRIBUTION_CHANNEL 
    AND AR.SALES_ORGANIZATION = CUST.SALES_ORGANIZATION 
    AND CUST.rn = 1
  LEFT JOIN (
    SELECT SOURCE_SYSTEM, BILLING_NUMBER, MIN(TO_DATE(BILLING_DATE, 'YYYYMMDD')) AS BILLING_DATE
    FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING
    GROUP BY SOURCE_SYSTEM, BILLING_NUMBER
  ) BILL
    ON AR.SOURCE_SYSTEM = BILL.SOURCE_SYSTEM
    AND AR.BILLING_NUMBER = BILL.BILLING_NUMBER
  LEFT JOIN (
    SELECT SOURCE_SYSTEM, BILLING_NUMBER, MIN(TO_DATE(TTF_DOC_DATE, 'YYYYMMDD')) AS TTF_DOC_DATE
    FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_TTF
    GROUP BY SOURCE_SYSTEM, BILLING_NUMBER
  ) TF
    ON AR.SOURCE_SYSTEM = TF.SOURCE_SYSTEM
    AND AR.BILLING_NUMBER = TF.BILLING_NUMBER
  LEFT JOIN (
    SELECT SOURCE_SYSTEM, ACCOUNTING_DOCUMENT_NUMBER, MIN(TO_DATE(POSTING_DATE, 'YYYYMMDD')) AS POSTING_DATE
    FROM PROD_DB.DSTR_BI_COMMUNITY.F_FINANCE_ACCOUNTING_DOCUMENT_HEADER
    GROUP BY SOURCE_SYSTEM, ACCOUNTING_DOCUMENT_NUMBER
  ) AD
    ON AR.ACCOUNT_DOC_NUMBER = AD.ACCOUNTING_DOCUMENT_NUMBER 
    AND AR.SOURCE_SYSTEM = AD.SOURCE_SYSTEM
  WHERE AR.SOURCE_SYSTEM = 'PE1'
)
SELECT
    base.SOURCE_SYSTEM,
    base.COMPANY_CODE,
    base.DISTRIBUTION_CHANNEL_FULL,
    base.SALES_OFFICE,
    base.SALES_OFFICE_LOKASI,
    base.BILLING_NUMBER,
    base.REFERENCE_DOCUMENT,
    base.ACCOUNT_DOC_NUMBER,
    base.DOCUMENT_TYPE,
    base.REMARKS_DOC_TYPE,
    base.CUSTOMER,
    base.CUSTOMER_NAME,
    base.CUSTOMER_CLASS,
    base.CUSTOMER_GROUP,
    base.SALES_DIVISION,
    base.PAYMENT_TERM_DAYS,
    base.PAYMENT_TERM,
    base.BLOCK_FOR_SALES,
    base.DELETION_FOR_SALES,
    base.CREDIT_LIMIT,
    COALESCE(base.BILLING_DATE, base.ACCOUNTING_DOC_POSTING_DATE) AS BILLING_DATE,
    base.TTF_DOC_DATE,
    base.ACCOUNTING_DOC_POSTING_DATE,
    base.EFFECTIVE_BASELINE_DATE_FLAG,
    base.DUE_DATE,
    base.NOT_DUE,
    base.DAYS_1_10,
    base.DAYS_11_30,
    base.DAYS_31_60,
    base.DAYS_61_90,
    base.DAYS_91_120,
    base.DAYS_121_150,
    base.DAYS_151_360,
    base.OVER_361_DAYS,
    base.TOTAL_AMOUNT,
    SUM(base.TOTAL_AMOUNT) OVER (PARTITION BY base.CUSTOMER) AS TOTAL_AMOUNT_PER_CUSTOMER,
    CASE 
        WHEN SUM(base.TOTAL_AMOUNT) OVER (PARTITION BY base.CUSTOMER) > base.CREDIT_LIMIT THEN TRUE
        ELSE FALSE
    END AS IS_EXCEED_CL
FROM base;
