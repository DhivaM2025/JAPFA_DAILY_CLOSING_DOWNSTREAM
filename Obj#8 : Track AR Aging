SELECT
AR.SOURCE_SYSTEM,
AR.COMPANY_CODE,
AR.DISTRIBUTION_CHANNEL ||'-'|| AR.DISTRIBUTION_CHANNEL_DESC AS DISTRIBUTION_CHANNEL_FULL,
CUST.SALES_OFFICE ||'-'|| CUST.SALES_OFFICE_DESC AS SALES_OFFICE,
AR.BILLING_NUMBER,
AR.ACCOUNT_DOC_NUMBER,
AR.DOCUMENT_TYPE ||'-'|| AR.DOCUMENT_TYPE_DESC AS DOCUMENT_TYPE,
AR.REMARKS_DOC_TYPE,
AR.CUSTOMER,
AR.CUSTOMER_NAME,
AR.CUSTOMER_CLASS,
AR.CUSTOMER_GROUP ||'-'|| AR.CUSTOMER_GROUP_DESC AS CUSTOMER_GROUP,
AR.SALES_DIVISION ||'-'|| AR.SALES_DIVISION_DESC AS SALES_DIVISION,
AR.PAYMENT_TERM_DAYS,
CASE 
WHEN AR.PAYMENT_TERM IN ('T014','TO14') THEN 'T014'
WHEN AR.PAYMENT_TERM IN ('T030','TO30') THEN 'T030'
WHEN AR.PAYMENT_TERM IN ('T045','TO45') THEN 'T045'
ELSE AR.PAYMENT_TERM 
END AS PAYMENT_TERM,
AR.BLOCK_FOR_SALES,
AR.DELETION_FOR_SALES,
AR.CREDIT_LIMIT,
TO_DATE(BILL.BILLING_DATE, 'YYYYMMDD') AS BILLING_DATE,
TO_DATE(TF.TTF_CREATED_DATE, 'YYYYMMDD') AS TTF_CREATED_DATE,
TO_DATE(AD.POSTING_DATE, 'YYYYMMDD') AS ACCOUNTING_DOC_POSTING_DATE,
AR.DUE_DATE,
AR.NOT_DUE,
AR.DAYS_1_10,
AR.DAYS_11_30,
AR.DAYS_31_60,
AR.DAYS_61_90,
AR.DAYS_91_120,
AR.DAYS_121_150,
AR.DAYS_151_360,
AR.OVER_361_DAYS,
SUM(AR.TOTAL_AMOUNT)
FROM PROD_DB.DSTR_BI_COMMUNITY.F_FINANCE_AR_AGING_CUSTOMER_CURRENT AR
LEFT JOIN (
   SELECT SOURCE_SYSTEM, CUSTOMER, DISTRIBUTION_CHANNEL, SALES_ORGANIZATION, SALES_DIVISION, SALES_OFFICE, SALES_OFFICE_DESC, ROW_NUMBER() OVER (PARTITION BY CUSTOMER, SALES_DIVISION  ORDER BY SALES_OFFICE) AS rn
   FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER
) CUST
ON AR.SOURCE_SYSTEM = CUST.SOURCE_SYSTEM
AND ar.CUSTOMER = cust.CUSTOMER 
AND AR.SALES_DIVISION = CUST.SALES_DIVISION
AND ar.DISTRIBUTION_CHANNEL = cust.DISTRIBUTION_CHANNEL 
AND ar.SALES_ORGANIZATION = cust.SALES_ORGANIZATION 
AND CUST.rn = 1
LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING BILL
    ON AR.SOURCE_SYSTEM = BILL.SOURCE_SYSTEM
    AND AR.BILLING_NUMBER = BILL.BILLING_NUMBER
LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_TTF TF
    ON AR.SOURCE_SYSTEM =TF.SOURCE_SYSTEM
    AND AR.BILLING_NUMBER = TF.BILLING_NUMBER
LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_FINANCE_ACCOUNTING_DOCUMENT_HEADER AD
    ON AR.ACCOUNT_DOC_NUMBER = AD.ACCOUNTING_DOCUMENT_NUMBER 
    AND AR.SOURCE_SYSTEM = AD.SOURCE_SYSTEM
WHERE AR.SOURCE_SYSTEM = 'PE1' 
AND AR.BLOCK_FOR_SALES = 'Non block'
AND AR.DELETION_FOR_SALES = 'Non delete'
GROUP BY ALL;
