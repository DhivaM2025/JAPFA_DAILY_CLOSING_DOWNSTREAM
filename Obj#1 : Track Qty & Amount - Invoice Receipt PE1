-- STEP 1 : RUN QUERY BELOW FOR GET INV RECEIPT DATA - INTERCO B2B&B2C PE1 ONLY --
SELECT DISTINCT
    PO.SOURCE_SYSTEM,
    CP.COMPANY_CODE || '-' || CP.COMPANY_NAME AS COMPANY,
    CP1.PLANT || '-' || CP1.PLANT_NAME AS PLANT,
    CP2.PLANT || '-' || CP2.PLANT_NAME AS SUPPLYING_PLANT,
    PO.VENDOR AS VENDOR_CODE,
    VDR.VENDOR_DESC AS VENDOR_NAME,
    PO.VENDOR_GROUP,
    SUBSTR(PO.PO_PERIOD, 1, 4) || '/' || SUBSTR(PO.PO_PERIOD, 5, 2) AS PO_PERIOD,
    'Invoice Receipt' AS CATEGORY,
    PO.PURCHASE_ORDER_ITEM_CATEGORY || '-' || PO.PURCHASE_ORDER_ITEM_CATEGORY_DESCRIPTION AS TYPE,
    Z.SALES_ORDER_NUMBER AS SALES_ORDER_NUMBER_CUSTOMER,
    PO.DOCUMENT_NUMBER AS INV_NUMBER,
    Z2.PO_NUM_REQ AS PO_NUM_REQ,
    TO_DATE(PO.POSTING_DATE) AS POSTING_DATE,
    PO.CURRENCY,
    PO.INV_QTY,
    PO.INV_AMOUNT
FROM (
    SELECT 
        SOURCE_SYSTEM,
        COMPANY_CODE,
        PLANT,
        SUPPLYING_PLANT,
        VENDOR,
        VENDOR_GROUP,
        PO_PERIOD,
        PURCHASE_ORDER_ITEM_CATEGORY,
        PURCHASE_ORDER_ITEM_CATEGORY_DESCRIPTION,
        DOCUMENT_NUMBER,
        POSTING_DATE,
        CURRENCY,
        /* agregasi per invoice agar tidak ganda saat join */
        SUM(IR_QUANTITY) AS INV_QTY,
        SUM(IR_AMOUNT) AS INV_AMOUNT
    FROM PROD_DB.DSTR_BI_COMMUNITY.F_SCM_PURCHASING_ORDER
    WHERE 
        SOURCE_SYSTEM = 'PE1'
        AND PLANT = '90HA'
        AND PURCHASE_TYPE LIKE 'STANDARD'
        AND VENDOR IN (
            'ID7A29','ID7A107','ID7A43','ID7A108','ID7A109',
            'ID7A90','ID7A104','ID7A69','ID7AA25','ID7A103',
            'ID7A92','ID7A97'
        )
        AND PURCHASE_ORDER_ITEM_CATEGORY IN ('M', 'P', 'N', 'K', 'Q')
        AND TO_DATE(POSTING_DATE) BETWEEN '2025-04-01' AND CURRENT_DATE
    GROUP BY 
        SOURCE_SYSTEM, COMPANY_CODE, PLANT, SUPPLYING_PLANT,
        VENDOR, VENDOR_GROUP, PO_PERIOD,
        PURCHASE_ORDER_ITEM_CATEGORY, PURCHASE_ORDER_ITEM_CATEGORY_DESCRIPTION,
        DOCUMENT_NUMBER, POSTING_DATE, CURRENCY
) PO
LEFT JOIN (
    SELECT DISTINCT SOURCE_SYSTEM, INV_NUM, MIN(SALES_ORDER_NUMBER) AS SALES_ORDER_NUMBER
    FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_INTERCO_HEADER
    GROUP BY SOURCE_SYSTEM, INV_NUM
) Z
    ON PO.SOURCE_SYSTEM = Z.SOURCE_SYSTEM
    AND PO.DOCUMENT_NUMBER = Z.INV_NUM
LEFT JOIN (
    SELECT 
        SOURCE_SYSTEM,
        INV_NUM,
        MIN(PO_NUM_REQ) AS PO_NUM_REQ   -- pastikan hanya 1 baris
    FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_INTERCO_HEADER
    GROUP BY SOURCE_SYSTEM, INV_NUM
) Z2
    ON PO.SOURCE_SYSTEM = Z2.SOURCE_SYSTEM
    AND PO.DOCUMENT_NUMBER = Z2.INV_NUM
LEFT JOIN (
    SELECT DISTINCT SOURCE_SYSTEM, COMPANY_CODE, COMPANY_NAME
    FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT
) CP
    ON PO.SOURCE_SYSTEM = CP.SOURCE_SYSTEM
    AND PO.COMPANY_CODE = CP.COMPANY_CODE
LEFT JOIN (
    SELECT DISTINCT SOURCE_SYSTEM, PLANT, PLANT_NAME
    FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT
) CP1
    ON PO.SOURCE_SYSTEM = CP1.SOURCE_SYSTEM
    AND PO.PLANT = CP1.PLANT
LEFT JOIN (
    SELECT DISTINCT SOURCE_SYSTEM, PLANT, PLANT_NAME
    FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT
) CP2
    ON PO.SOURCE_SYSTEM = CP2.SOURCE_SYSTEM
    AND PO.SUPPLYING_PLANT = CP2.PLANT
LEFT JOIN (
    SELECT DISTINCT SOURCE_SYSTEM, VENDOR, VENDOR_DESC
    FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_VENDOR
) VDR
    ON PO.SOURCE_SYSTEM = VDR.SOURCE_SYSTEM
    AND PO.VENDOR = VDR.VENDOR;
