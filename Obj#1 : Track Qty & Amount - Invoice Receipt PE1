-- STEP 1 : RUN ALL TEMPORARY TABLE --
CREATE TEMPORARY TABLE TEMP_PURCHASE_ORDER AS
SELECT * FROM PROD_DB.DSTR_BI_COMMUNITY.F_SCM_PURCHASING_ORDER;

CREATE TEMPORARY TABLE TEMP_SALES_FLOW AS
SELECT * FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_FLOW_ORDER_DOCUMENT_FLOW;

CREATE TEMPORARY TABLE TEMP_HEADER_INTERCO AS
SELECT * FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_INTERCO_HEADER;

-- STEP 2 : RUN QUERY BELOW FOR GET INV RECEIPT DATA - INTERCO B2B&B2C PE1 ONLY --
SELECT 
	PO.SOURCE_SYSTEM,
	PO.COMPANY_CODE || '-' || CP.COMPANY_NAME AS COMPANY,
	PO.PLANT || '-' || CP1.PLANT_NAME AS PLANT,
	PO.SUPPLYING_PLANT || '-' || CP2.PLANT_NAME AS SUPPLYING_PLANT,
	PO.VENDOR AS VENDOR_CODE,
	VDR.VENDOR_DESC AS VENDOR_NAME,
	PO.VENDOR_GROUP,
	SUBSTR(PO.PO_PERIOD, 1, 4) || '/' || SUBSTR(PO.PO_PERIOD, 5, 2) AS PO_PERIOD,
	'Invoice Receipt' AS CATEGORY,
	PURCHASE_ORDER_ITEM_CATEGORY  || '-' || PURCHASE_ORDER_ITEM_CATEGORY_DESCRIPTION AS TYPE,
	Z.SALES_ORDER_NUMBER AS SALES_ORDER_NUMBER_CUSTOMER,
	PO.DOCUMENT_NUMBER AS INV_NUMBER,
	TO_DATE(PO.POSTING_DATE) AS POSTING_DATE,
	PO.CURRENCY,
	SUM(PO.IR_QUANTITY) AS INV_QTY,
	SUM(PO.IR_AMOUNT) AS INV_AMOUNT,
FROM TEMP_PURCHASE_ORDER PO
LEFT JOIN TEMP_HEADER_INTERCO Z
	ON PO.SOURCE_SYSTEM = Z.SOURCE_SYSTEM
	AND PO.DOCUMENT_NUMBER = Z.INV_NUM
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, COMPANY_CODE, COMPANY_NAME FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT) AS CP
    	ON PO.SOURCE_SYSTEM = CP.SOURCE_SYSTEM
    	AND PO.COMPANY_CODE = CP.COMPANY_CODE
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, PLANT, PLANT_NAME FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT) AS CP1
    	ON PO.SOURCE_SYSTEM = CP1.SOURCE_SYSTEM
    	AND PO.PLANT = CP1.PLANT
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, PLANT, PLANT_NAME FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT) AS CP2
    	ON PO.SOURCE_SYSTEM = CP2.SOURCE_SYSTEM
    	AND PO.SUPPLYING_PLANT = CP2.PLANT
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, VENDOR, VENDOR_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_VENDOR) VDR
	    ON PO.SOURCE_SYSTEM = VDR.SOURCE_SYSTEM
	    AND PO.VENDOR = VDR.VENDOR
WHERE 
	PO.SOURCE_SYSTEM = 'PE2'
	AND PO.PLANT = '90HA'
	AND PO.PURCHASE_TYPE LIKE 'STANDARD'
	AND PO.VENDOR IN ('ID7A29','ID7A107','ID7A43','ID7A108','ID7A109','ID7A90','ID7A104','ID7A69','ID7AA25','ID7A103','ID7A92','ID7A97')
	AND PO.PURCHASE_ORDER_ITEM_CATEGORY IN ('M', 'P', 'N', 'K', 'Q')
	AND TO_DATE(PO.POSTING_DATE) BETWEEN '20250501' AND CURRENT_DATE
	/*AND PO.DOCUMENT_NUMBER = '5100074485'*/
GROUP BY ALL;
