WITH HEADER AS (
    SELECT DISTINCT
        SOURCE_SYSTEM,
        SALES_ORDER_NUMBER,
        DELIVERY_NUMBER,
        BILLING_NUMBER,
        PO_NUM_REQ AS PO_NUMBER,
        GR_NUM     AS GR_NUMBER,
        INV_NUM    AS INVOICE_NUMBER
    FROM PROD_DB.DSTR_BI_COMMUNITY.DEV_F_SALES_INTERCO_HEADER 
/*    WHERE SALES_ORDER_NUMBER IN ('1207560670','1207560170','1207560566','1207560580','1207559384','1207543944','1207543014','1207644505','1705251294','1705250138','1705283936','1705283656','1705283659','1705283662','1705283464','1705416679')
	AND SALES_ORDER_EXTERNAL_DOCUMENT IS NULL*/
    ),
    HEADER_PRODUCTION AS (
    SELECT DISTINCT
        TH.SOURCE_SYSTEM,
        TH.SALES_ORDER_NUMBER AS SALES_ORDER_NUMBER_INTERCO,
        TH.DELIVERY_NUMBER AS DELIVERY_NUMBER_INTERCO,
        TH.BILLING_NUMBER AS BILLING_NUMBER_INTERCO,
        TH.SALES_ORDER_EXTERNAL_DOCUMENT
    FROM HEADER H
    LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.DEV_F_SALES_INTERCO_HEADER TH 
    	ON TH.SALES_ORDER_EXTERNAL_DOCUMENT = H.SALES_ORDER_NUMBER
    ), 
    DOCUMENT_FLOW AS (
    SELECT DISTINCT 
    	HP.SOURCE_SYSTEM,
    	HP.SALES_ORDER_NUMBER_INTERCO,
    	FLOW.SALES_ORDER_NUMBER,
    	FLOW.SO_CSGMNT_NUMBER AS SALES_ORDER_CONS_NUMBER, 
    	FLOW.DO_CSGMNT_NUMBER AS DELIVERY_CONS_NUMBER,
    	SCMC.MATERIAL_DOCUMENT_NUMBER AS GI_CONS_NUMBER,
    	TRY_TO_DATE(SOC.SALES_ORDER_CREATED_DATE, 'YYYYMMDD') AS SALES_ORDER_CONS_CREATED_DATE,
		TRY_TO_DATE(SDC.DELIVERY_CREATED_DATE, 'YYYYMMDD') AS DELIVERY_CONS_CREATED_DATE,
		TRY_TO_DATE(SCMC.ENTRY_DATE, 'YYYYMMDD') AS GI_CONS_CREATED_DATE,
		CASE 
    		WHEN SOC.SALES_ORDER_STATUS IS NULL OR SOC.SALES_ORDER_STATUS_DESC IS NULL THEN SOC.SALES_ORDER_STATUS_DESC 
    		ELSE SOC.SALES_ORDER_STATUS || '-' || SOC.SALES_ORDER_STATUS_DESC 
		END AS SALES_ORDER_CONS_STATUS,
		CASE 
  			WHEN SDC.DELIVERY_STATUS = 'Not yet processed' THEN 'A-Not yet processed'
    		WHEN SDC.DELIVERY_STATUS = 'Partially processed' THEN 'B-Partially processed'
    		WHEN SDC.DELIVERY_STATUS = 'Completely processed' THEN 'C-Completely processed'
    		ELSE SDC.DELIVERY_STATUS
		END AS DELIVERY_CONS_STATUS,
		DO_REASON_FRANCO.SALES_ORDER_REASON,
		DO_REASON_FRANCO.SALES_ORDER_REASON_DESC,
		CASE 
			WHEN TRY_TO_DATE(SCMC.ENTRY_DATE , 'YYYYMMDD') IS NULL AND TRY_TO_DATE(SCMC.POSTING_DATE, 'YYYYMMDD') IS NULL THEN 'N/A'
			WHEN TRY_TO_DATE(SCMC.ENTRY_DATE , 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(SCMC.POSTING_DATE, 'YYYYMMDD') IS NULL THEN 'Real-time entry'
			WHEN TRY_TO_DATE(SCMC.ENTRY_DATE , 'YYYYMMDD') = TRY_TO_DATE(SCMC.POSTING_DATE , 'YYYYMMDD') THEN 'Real-time entry'
			WHEN TRY_TO_DATE(SCMC.POSTING_DATE, 'YYYYMMDD') > TRY_TO_DATE(SCMC.ENTRY_DATE, 'YYYYMMDD') THEN 'Forward-dated entry'
			WHEN TRY_TO_DATE(SCMC.POSTING_DATE, 'YYYYMMDD') < TRY_TO_DATE(SCMC.ENTRY_DATE, 'YYYYMMDD') THEN 'Backdated entry'
			ELSE 'Backdated entry'
		END AS GI_CONS_BACKDATE_FLAG,
		CASE 
			WHEN TRY_TO_DATE(SCMC.ENTRY_DATE, 'YYYYMMDD') IS NULL AND TRY_TO_DATE(SCMC.POSTING_DATE, 'YYYYMMDD') IS NULL THEN 'N/A'
			WHEN TRY_TO_DATE(SCMC.ENTRY_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(SCMC.POSTING_DATE, 'YYYYMMDD') IS NULL THEN '0'
			WHEN TRY_TO_DATE(SCMC.ENTRY_DATE, 'YYYYMMDD') IS NOT NULL AND TRY_TO_DATE(SCMC.POSTING_DATE, 'YYYYMMDD') IS NOT NULL THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(SCMC.ENTRY_DATE, 'YYYYMMDD'), TRY_TO_DATE(SCMC.POSTING_DATE, 'YYYYMMDD')))
			ELSE 'N/A'
		END AS GI_CONS_DIFF_DAYS,
		CASE
		    WHEN GI_CONS_DIFF_DAYS = 'N/A' THEN 'N/A'
		    WHEN GI_CONS_DIFF_DAYS >= 0 THEN '1/ 0 Hari'
		    WHEN GI_CONS_DIFF_DAYS < 0 AND GI_CONS_DIFF_DAYS >= -3 THEN '2/ 1-3 Hari'
		    WHEN GI_CONS_DIFF_DAYS < -3 AND GI_CONS_DIFF_DAYS >= -7 THEN '3/ 3-7 Hari'
		    WHEN GI_CONS_DIFF_DAYS < -7 AND GI_CONS_DIFF_DAYS >= -14 THEN '4/ 7-14 Hari'
		    WHEN GI_CONS_DIFF_DAYS < -14 AND GI_CONS_DIFF_DAYS >= -30 THEN '5/ 14-30 Hari'
		    WHEN GI_CONS_DIFF_DAYS < -30 THEN '6/ >30 Hari'
		    ELSE ''
		END AS AGING_GI_CONS_DIFF_DAYS
    FROM HEADER_PRODUCTION HP
    LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.DEV_F_SALES_FLOW_ORDER_DOCUMENT_FLOW FLOW 
    	ON FLOW.SALES_ORDER_NUMBER  = HP.SALES_ORDER_NUMBER_INTERCO
    	AND FLOW.SALES_ORDER_TYPE = 'ZKS2'
	LEFT JOIN 
		(SELECT DISTINCT SOURCE_SYSTEM,SALES_ORDER_NUMBER,SALES_ORDER_CREATED_DATE,SALES_ORDER_STATUS,SALES_ORDER_STATUS_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER) SOC
		ON SOC.SALES_ORDER_NUMBER = FLOW.SO_CSGMNT_NUMBER
	LEFT JOIN 
		(SELECT DISTINCT SOURCE_SYSTEM,DELIVERY_NUMBER,DELIVERY_CREATED_DATE,DELIVERY_ACTUAL_DATE,DELIVERY_STATUS FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_DELIVERY) SDC
		ON SDC.DELIVERY_NUMBER = FLOW.DO_CSGMNT_NUMBER
	LEFT JOIN
		(SELECT DISTINCT SOURCE_SYSTEM,"REFERENCE",MATERIAL_DOCUMENT_NUMBER,ENTRY_DATE,POSTING_DATE FROM PROD_DB.DSTR_BI_COMMUNITY.F_SCM_STOCK_TRANSACTION_SAP) SCMC
		ON SCMC."REFERENCE" = FLOW.DO_CSGMNT_NUMBER
	LEFT JOIN (
		SELECT DISTINCT DO.SOURCE_SYSTEM, DELIVERY_NUMBER,REFERENCE_SALES_ORDER_NUMBER, SO.REFERENCE_DOCUMENT_NUMBER,  DO.SALES_ORDER_REASON, DO.SALES_ORDER_REASON_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_DELIVERY DO
		LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER SO 
			ON DO.REFERENCE_SALES_ORDER_NUMBER = SO.SALES_ORDER_NUMBER 
			AND DO.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
		WHERE DO.SOURCE_SYSTEM = 'PE2' AND DO.SALES_ORDER_REASON IS NOT NULL
		) DO_REASON_FRANCO 
		ON FLOW.SO_CSGMNT_NUMBER = DO_REASON_FRANCO.REFERENCE_DOCUMENT_NUMBER AND FLOW.SOURCE_SYSTEM = DO_REASON_FRANCO.SOURCE_SYSTEM
    ),
    SO_DETAIL_SELLING AS (
    SELECT DISTINCT 
        H.SOURCE_SYSTEM,
        H.SALES_ORDER_NUMBER,
        SO.COMPANY_CODE || '-' || CP.COMPANY_NAME AS COMPANY,
        SO.PLANT || '-' || CP1.PLANT_NAME AS PLANT,
        SO.CUSTOMER,
        CUST.CUSTOMER_NAME,
        CUST.REGION || '-' || DSR.REGION_DESCRIPTION AS REGION,
		CASE 
			WHEN DSR.REGION IN ('01', '02', '03', '04', '05', '28') THEN 'Pulau Jawa'
    		ELSE 'Luar Pulau Jawa'
		END AS REGION_GROUP,
        SO.CUSTOMER_SHIP_TO,
        CUSTSH.CUSTOMER_NAME AS CUSTOMER_SHIP_TO_NAME,
		CASE 
        	WHEN CUST1.SALES_OFFICE IS NULL OR CUST1.SALES_OFFICE = '' OR CUST1.SALES_OFFICE = '9001'
        	THEN SO.SALES_OFFICE || '-' || CUSTSO.SALES_OFFICE_DESC
        	ELSE CUST1.SALES_OFFICE || '-' || CUST1.SALES_OFFICE_DESC
    	END AS SALES_OFFICE,
    	CASE 
	        WHEN CUST1.SALES_OFFICE IS NULL OR CUST1.SALES_OFFICE = '' OR CUST1.SALES_OFFICE = '9001'
	        THEN LEFT(CUSTSO.SALES_OFFICE_DESC, 3)
	        WHEN CUST1.SALES_OFFICE_DESC IS NOT NULL AND CUST1.SALES_OFFICE_DESC <> ''
	        THEN LEFT(CUST1.SALES_OFFICE_DESC, 3)
	        ELSE CUST1.SALES_OFFICE
	    END AS SALES_OFFICE_GROUP,
        SO.DIVISION || '-' || SO.DIVISION_DESC AS DIVISION,
        SO.DISTRIBUTION_CHANNEL || '-' || SA.DISTRIBUTION_CHANNEL_DESC AS DISTRIBUTION_CHANNEL,
        CUST.POD_FLAG,
        SO.SALES_ORDER_TYPE || '-' || SO.SALES_ORDER_TYPE_DESC AS SALES_ORDER_TYPE,
		CASE 
    		WHEN SO.SALES_ORDER_STATUS IS NULL OR SO.SALES_ORDER_STATUS_DESC IS NULL THEN SO.SALES_ORDER_STATUS_DESC 
    		ELSE SO.SALES_ORDER_STATUS || '-' || SO.SALES_ORDER_STATUS_DESC 
		END AS SALES_ORDER_STATUS, 
        SO.SALES_ORDER_STATUS_REJECTION || '-' || SO.SALES_ORDER_STATUS_REJECTION_DESC AS SALES_ORDER_STATUS_REJECTION,
        SO.SALES_ORDER_REASON_REJECTION_DESC,
		CASE 
	    	WHEN LEFT(SALES_ORDER_REASON_REJECTION_DESC, 2) IN ('Z2','Z6','ZH','ZJ','ZK','ZM','ZQ') THEN 'Order Related'
	    	WHEN LEFT(SALES_ORDER_REASON_REJECTION_DESC, 2) IN ('Z3','ZI') THEN 'AR Related'
	    	WHEN LEFT(SALES_ORDER_REASON_REJECTION_DESC, 2) IN ('ZA','ZN') THEN 'Delivery Related'
	    	WHEN LEFT(SALES_ORDER_REASON_REJECTION_DESC, 2) IN ('Z1','Z4','ZO') THEN 'Stock Related'
	    	WHEN SALES_ORDER_REASON_REJECTION_DESC IS NULL OR SALES_ORDER_REASON_REJECTION_DESC = '' THEN 'N/A'
	    	ELSE 'N/A'
		END AS SALES_ORDER_REASON_REJECTION_GROUP,
		TRY_TO_DATE(SO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD') AS SALES_ORDER_CREATED_DATE,
		TRY_TO_DATE(SO.SALES_ORDER_DATE, 'YYYYMMDD') AS SALES_ORDER_DATE,
        SO.CREATED_BY,
		CASE 
    		WHEN SO.SALES_ORDER_TYPE = 'ZB20' THEN 'Interco Automation MT'
        	WHEN SO.SALES_ORDER_TYPE = 'ZB01' AND SO.CUSTOMER = '2000174657' THEN 'Interco Automation FS'
        	ELSE 'Non Interco'
		END AS SALES_ORDER_CATEGORY,
    FROM HEADER H
    INNER JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER SO 
        ON SO.SOURCE_SYSTEM = H.SOURCE_SYSTEM
       AND SO.SALES_ORDER_NUMBER = H.SALES_ORDER_NUMBER
	LEFT JOIN (SELECT
        SOURCE_SYSTEM, CUSTOMER, CUSTOMER_NAME, REGION, POD_FLAG FROM (
        SELECT
		    SOURCE_SYSTEM,
		    CUSTOMER,
		    CUSTOMER_NAME,
		    REGION,
		    POD_FLAG,
		    ROW_NUMBER() OVER (
		        PARTITION BY SOURCE_SYSTEM, CUSTOMER
		        ORDER BY SALES_OFFICE ASC
		    ) AS RN
		FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER
    	)
    	WHERE RN = 1
		) CUST
    	ON CUST.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
    	AND CUST.CUSTOMER = SO.CUSTOMER 
	LEFT JOIN (SELECT
        SOURCE_SYSTEM, CUSTOMER, CUSTOMER_NAME FROM (
        SELECT
            SOURCE_SYSTEM, CUSTOMER, CUSTOMER_NAME,
            ROW_NUMBER() OVER (
                PARTITION BY SOURCE_SYSTEM, CUSTOMER
                ORDER BY SALES_OFFICE ASC
            ) AS RN
        FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER
    	)
    	WHERE RN = 1
		) CUSTSH
    	ON CUSTSH.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
    	AND CUSTSH.CUSTOMER = SO.CUSTOMER_SHIP_TO
	LEFT JOIN (SELECT
        SOURCE_SYSTEM, COMPANY_CODE, COMPANY_NAME FROM (
        SELECT
            SOURCE_SYSTEM, COMPANY_CODE, COMPANY_NAME,
            ROW_NUMBER() OVER (
                PARTITION BY SOURCE_SYSTEM, COMPANY_CODE
                ORDER BY PLANT ASC
            ) AS RN
        FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT
    	)
    	WHERE RN = 1
		) CP
    	ON CP.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
    	AND CP.COMPANY_CODE = SO.COMPANY_CODE
	LEFT JOIN ( SELECT
        SOURCE_SYSTEM, PLANT, PLANT_NAME FROM (
        SELECT
            SOURCE_SYSTEM, PLANT, PLANT_NAME,
            ROW_NUMBER() OVER (
                PARTITION BY SOURCE_SYSTEM, PLANT
                ORDER BY STORAGE_LOCATION ASC
            ) AS RN
        FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT
    	)
    	WHERE RN = 1
		) CP1
		ON CP1.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
		AND CP1.PLANT = SO.PLANT
		LEFT JOIN (SELECT SOURCE_SYSTEM, CUSTOMER, SALES_OFFICE, SALES_OFFICE_DESC, SALES_DIVISION 
           FROM (SELECT SOURCE_SYSTEM, CUSTOMER, SALES_OFFICE, SALES_OFFICE_DESC, SALES_DIVISION,
                        ROW_NUMBER() OVER (PARTITION BY SOURCE_SYSTEM, CUSTOMER 
                                           ORDER BY CASE WHEN SALES_OFFICE <> '9001' THEN 0 ELSE 1 END, SALES_OFFICE) AS RN
                 FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER
                 WHERE BLOCK_FOR_SALES = 'Non block' AND DELETION_FOR_SALES = 'Non delete')
           QUALIFY RN = 1) CUST1
    	ON CUST1.SOURCE_SYSTEM = SO.SOURCE_SYSTEM 
    	AND CUST1.CUSTOMER = SO.CUSTOMER
		LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, SALES_OFFICE, SALES_OFFICE_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER
           			WHERE BLOCK_FOR_SALES = 'Non block' AND DELETION_FOR_SALES = 'Non delete') CUSTSO
    	ON CUSTSO.SOURCE_SYSTEM = SO.SOURCE_SYSTEM 
    	AND CUSTSO.SALES_OFFICE = SO.SALES_OFFICE
    	LEFT JOIN (SELECT
        SOURCE_SYSTEM, DISTRIBUTION_CHANNEL, DISTRIBUTION_CHANNEL_DESC FROM (
        SELECT
            SOURCE_SYSTEM, DISTRIBUTION_CHANNEL, DISTRIBUTION_CHANNEL_DESC,
            ROW_NUMBER() OVER (
                PARTITION BY SOURCE_SYSTEM, DISTRIBUTION_CHANNEL
                ORDER BY SALES_OFFICE ASC
            ) AS RN
        FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_AREA
    	)
    	WHERE RN = 1
		) SA
	    ON SA.SOURCE_SYSTEM = SO.SOURCE_SYSTEM 
	    AND SA.DISTRIBUTION_CHANNEL = SO.DISTRIBUTION_CHANNEL
	    LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, REGION, REGION_DESCRIPTION FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_REGION) DSR
	    ON DSR.SOURCE_SYSTEM = CUST.SOURCE_SYSTEM
	    AND DSR.REGION = CUST.REGION
),
SO_DETAIL_PRODUCTION AS (
	SELECT DISTINCT 
		HP.SOURCE_SYSTEM,
        HP.SALES_ORDER_NUMBER_INTERCO,
        SO.SALES_ORDER_NUMBER,
        SO.CREATED_BY,
		SO.COMPANY_CODE || '-' || CP.COMPANY_NAME AS COMPANY_INTERCO,
		SO.PLANT || '-' || CP1.PLANT_NAME AS PLANT_INTERCO,
		SO.SALES_OFFICE || '-' || SA1.SALES_OFFICE_DESC AS SALES_OFFICE_INTERCO,
		SO.DISTRIBUTION_CHANNEL || '-' || SA.DISTRIBUTION_CHANNEL_DESC AS DISTRIBUTION_CHANNEL_INTERCO,
		SO.SALES_ORDER_TYPE || '-' || SO.SALES_ORDER_TYPE_DESC AS SALES_ORDER_INTERCO_TYPE,
		TRY_TO_DATE(SO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD') AS SALES_ORDER_INTERCO_CREATED_DATE,
		TRY_TO_DATE(SO.SALES_ORDER_DATE, 'YYYYMMDD') AS SALES_ORDER_INTERCO_DATE,
		CASE 
    		WHEN SO.SALES_ORDER_STATUS IS NULL OR SO.SALES_ORDER_STATUS_DESC IS NULL THEN SO.SALES_ORDER_STATUS_DESC 
    		ELSE SO.SALES_ORDER_STATUS || '-' || SO.SALES_ORDER_STATUS_DESC 
		END AS SALES_ORDER_INTERCO_STATUS,
		SO.SALES_ORDER_STATUS_REJECTION || '-' || SO.SALES_ORDER_STATUS_REJECTION_DESC AS SALES_ORDER_INTERCO_STATUS_REJECTION,
		SO.SALES_ORDER_REASON_REJECTION_DESC AS SALES_ORDER_INTERCO_REASON_REJECTION_DESC,
			CASE
	    WHEN SO.SALES_ORDER_REASON_REJECTION_DESC = '(AJS/VSN) SO Batal' THEN 'Order Related'
	    WHEN SO.SALES_ORDER_REASON_REJECTION_DESC = '(CCP-ICP) SO Cancel Salah Input Customer' THEN 'Order Related'
	    WHEN SO.SALES_ORDER_REASON_REJECTION_DESC = '(CCP-ICP) SO Rejected' THEN 'Order Related'
	    WHEN SO.SALES_ORDER_REASON_REJECTION_DESC = '(CIOSHFPJFS) Cancel SO' THEN 'Order Related'
	    WHEN SO.SALES_ORDER_REASON_REJECTION_DESC = '(CIOSHFPJFS) Full Retur Surat Jalan' THEN 'Delivery Related'
	    WHEN SO.SALES_ORDER_REASON_REJECTION_DESC = '(CIOSHFPJFS) Selisih loading' THEN 'Delivery Related'
	    WHEN SO.SALES_ORDER_REASON_REJECTION_DESC = '(CIOSHFPJFS) Stock tidak ada' THEN 'Stock Related'
	    WHEN SO.SALES_ORDER_REASON_REJECTION_DESC = '(CIOSHFPJFS) System Rejection' THEN 'Order Related'
	    WHEN SO.SALES_ORDER_REASON_REJECTION_DESC = '(IJA) Cancel SO' THEN 'Order Related'
	    WHEN SO.SALES_ORDER_REASON_REJECTION_DESC = 'Over kredit limit dan TOP' THEN 'AR Related'
	    WHEN SO.SALES_ORDER_REASON_REJECTION_DESC = 'Pembatalan order dari customer' THEN 'Order Related'
	    WHEN SO.SALES_ORDER_REASON_REJECTION_DESC = 'Pembayaran belum masuk' THEN 'AR Related'
	    WHEN SO.SALES_ORDER_REASON_REJECTION_DESC = 'Stok Kosong (Barang lagi di produksi)' THEN 'Stock Related'
	    ELSE 'N/A'
	END AS SALES_ORDER_INTERCO_REASON_REJECTION_GROUP
	FROM HEADER_PRODUCTION HP
	INNER JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER SO 
        ON SO.SOURCE_SYSTEM = HP.SOURCE_SYSTEM
       AND SO.SALES_ORDER_NUMBER = HP.SALES_ORDER_NUMBER_INTERCO
	LEFT JOIN (SELECT SOURCE_SYSTEM, COMPANY_CODE, COMPANY_NAME 
			FROM (SELECT SOURCE_SYSTEM, COMPANY_CODE, COMPANY_NAME,
	            ROW_NUMBER() OVER (
	                PARTITION BY SOURCE_SYSTEM, COMPANY_CODE
	                ORDER BY PLANT ASC
	            ) AS RN
	FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT)
	WHERE RN = 1) CP
    	ON CP.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
    	AND CP.COMPANY_CODE = SO.COMPANY_CODE
	LEFT JOIN ( SELECT SOURCE_SYSTEM, PLANT, PLANT_NAME 
			FROM (SELECT SOURCE_SYSTEM, PLANT, PLANT_NAME,
	            ROW_NUMBER() OVER (
	                PARTITION BY SOURCE_SYSTEM, PLANT
	                ORDER BY STORAGE_LOCATION ASC
	            ) AS RN
        FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT)
    	WHERE RN = 1 ) CP1
		ON CP1.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
		AND CP1.PLANT = SO.PLANT
	LEFT JOIN (SELECT SOURCE_SYSTEM, DISTRIBUTION_CHANNEL, DISTRIBUTION_CHANNEL_DESC 
			FROM (SELECT SOURCE_SYSTEM, DISTRIBUTION_CHANNEL, DISTRIBUTION_CHANNEL_DESC,
	            ROW_NUMBER() OVER (
	                PARTITION BY SOURCE_SYSTEM, DISTRIBUTION_CHANNEL
	                ORDER BY SALES_OFFICE ASC
	            ) AS RN
        FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_AREA)
    	WHERE RN = 1 ) SA
	    ON SA.SOURCE_SYSTEM = SO.SOURCE_SYSTEM 
	    AND SA.DISTRIBUTION_CHANNEL = SO.DISTRIBUTION_CHANNEL
	LEFT JOIN (SELECT SOURCE_SYSTEM, SALES_OFFICE, SALES_OFFICE_DESC 
			FROM (SELECT SOURCE_SYSTEM, SALES_OFFICE, SALES_OFFICE_DESC,
	            ROW_NUMBER() OVER (
	                PARTITION BY SOURCE_SYSTEM, SALES_OFFICE
	                ORDER BY SALES_OFFICE ASC
	            ) AS RN
        FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_AREA)
    	WHERE RN = 1 ) SA1
	    ON SA1.SOURCE_SYSTEM = SO.SOURCE_SYSTEM 
	    AND SA1.SALES_OFFICE = SO.SALES_OFFICE
),
DO_DETAIL_SELLING AS (
    SELECT DISTINCT 
        H.SOURCE_SYSTEM,
        H.DELIVERY_NUMBER,
        SD.REFERENCE_SALES_ORDER_NUMBER,
		TRY_TO_DATE(SD.DELIVERY_CREATED_DATE, 'YYYYMMDD') AS DELIVERY_CREATED_DATE,
		TRY_TO_DATE(SD.DELIVERY_ACTUAL_DATE, 'YYYYMMDD') AS DELIVERY_ACTUAL_DATE,
        TRY_TO_DATE(SD.DELIVERY_POSTING_DATE, 'YYYYMMDD') AS POD_DATE,
        SD.DELIVERY_TYPE || '-' || SD.DELIVERY_TYPE_DESC AS DELIVERY_TYPE,
		CASE 
  			WHEN SD.DELIVERY_STATUS = 'Not yet processed' THEN 'A-Not yet processed'
    		WHEN SD.DELIVERY_STATUS = 'Partially processed' THEN 'B-Partially processed'
    		WHEN SD.DELIVERY_STATUS = 'Completely processed' THEN 'C-Completely processed'
    		ELSE SD.DELIVERY_STATUS
		END AS DELIVERY_STATUS,
		CASE 
	  		WHEN SD.DELIVERY_POD_STATUS = 'Not yet processed' THEN 'A-Not yet processed'
	    	WHEN SD.DELIVERY_POD_STATUS = 'Partially processed' THEN 'B-Partially processed'
	    	WHEN SD.DELIVERY_POD_STATUS = 'Completely processed' THEN 'C-Completely processed'
	    	ELSE SD.DELIVERY_POD_STATUS
		END AS DELIVERY_POD_STATUS,
        SD.DELIVERY_NOTE AS REASON_POD,
		CASE
			WHEN SD.DELIVERY_NOTE IS NULL OR SD.DELIVERY_NOTE = '' THEN FALSE
			ELSE TRUE
		END AS REASON_POD_FLAG,
		CASE 
		    WHEN SD.DELIVERY_NOTE = 'FREEZER RUSAK' THEN 'Customer Related'
		    WHEN SD.DELIVERY_NOTE = 'OUTLET TDK BISA INPUT SKU' THEN 'Customer Related'
		    WHEN SD.DELIVERY_NOTE = 'OVER STOCK' THEN 'Customer Related'
		    WHEN SD.DELIVERY_NOTE = 'STOCK FISIK â‰  SISTEM' THEN 'Customer Related'
		    WHEN SD.DELIVERY_NOTE = 'TOKO TIDAK ORDER' THEN 'Order Related'
		    WHEN SD.DELIVERY_NOTE = 'TOKO TIDAK PUNYA UANG' THEN 'Customer Related'
		    WHEN SD.DELIVERY_NOTE = 'TOKO TUTUP' THEN 'Customer Related'
		    WHEN SD.DELIVERY_NOTE = 'ALAMAT TIDAK SESUAI' THEN 'Delivery Related'
		    WHEN SD.DELIVERY_NOTE = 'BARANG/KEMASAN RUSAK' THEN 'Delivery Related'
		    WHEN SD.DELIVERY_NOTE = 'RETUR PRODUK TDK DIAMBIL' THEN 'Delivery Related'
		    WHEN SD.DELIVERY_NOTE = 'RETUR SF CONSIGMENT' THEN 'Delivery Related'
		    WHEN SD.DELIVERY_NOTE = 'SALAH LOADING' THEN 'Delivery Related'
		    WHEN SD.DELIVERY_NOTE = 'SALAH KIRIM TOKO' THEN 'Delivery Related'
		    WHEN SD.DELIVERY_NOTE = 'SPACE TIDAK CUKUP' THEN 'Customer Related'
		    WHEN SD.DELIVERY_NOTE = 'SUHU MOBIL TIDAK SESUAI' THEN 'Delivery Related'
		    WHEN SD.DELIVERY_NOTE = 'TIDAK TERKIRIM (TPL)' THEN 'Delivery Related'
		    WHEN SD.DELIVERY_NOTE = 'WAKTU DELIVERY TDK CUKUP' THEN 'Delivery Related'
		    WHEN SD.DELIVERY_NOTE = 'DOUBLE PO' THEN 'Order Related'
		    WHEN SD.DELIVERY_NOTE = 'SALAH INPUT DI ANDROID' THEN 'Order Related'
		    WHEN SD.DELIVERY_NOTE = 'SALAH INPUT SO/DO' THEN 'Order Related'
		    WHEN SD.DELIVERY_NOTE = 'TIDAK SESUAI ORDER/PO' THEN 'Order Related'
		    WHEN SD.DELIVERY_NOTE = 'BARANG SUSUT' THEN 'Stock Related'
		    WHEN SD.DELIVERY_NOTE = 'ISI/PRODUK TIDAK SESUAI' THEN 'Stock Related'
		    WHEN SD.DELIVERY_NOTE = 'PRODUK MENDEKATI EXPIRED' THEN 'Stock Related'
		    WHEN SD.DELIVERY_NOTE IS NULL OR DELIVERY_NOTE = '' THEN 'N/A'
		    ELSE 'N/A'
		END AS REASON_POD_GROUP,
    FROM HEADER H
    LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_DELIVERY SD 
        ON SD.SOURCE_SYSTEM = H.SOURCE_SYSTEM
       AND SD.DELIVERY_NUMBER = H.DELIVERY_NUMBER
),
DO_DETAIL_PRODUCTION AS (
	SELECT DISTINCT
		HP.SOURCE_SYSTEM,
        HP.DELIVERY_NUMBER_INTERCO,
		TRY_TO_DATE(SD.DELIVERY_CREATED_DATE, 'YYYYMMDD') AS DELIVERY_INTERCO_CREATED_DATE,
		TRY_TO_DATE(SD.DELIVERY_ACTUAL_DATE, 'YYYYMMDD') AS DELIVERY_INTERCO_ACTUAL_DATE,
        TRY_TO_DATE(SD.DELIVERY_POSTING_DATE, 'YYYYMMDD') AS POD_INTERCO_DATE,
        SD.DELIVERY_TYPE || '-' || SD.DELIVERY_TYPE_DESC AS DELIVERY_INTERCO_TYPE,
		CASE 
  			WHEN SD.DELIVERY_STATUS = 'Not yet processed' THEN 'A-Not yet processed'
    		WHEN SD.DELIVERY_STATUS = 'Partially processed' THEN 'B-Partially processed'
    		WHEN SD.DELIVERY_STATUS = 'Completely processed' THEN 'C-Completely processed'
    		ELSE SD.DELIVERY_STATUS
		END AS DELIVERY_INTERCO_STATUS,
		CASE 
	  		WHEN SD.DELIVERY_POD_STATUS = 'Not yet processed' THEN 'A-Not yet processed'
	    	WHEN SD.DELIVERY_POD_STATUS = 'Partially processed' THEN 'B-Partially processed'
	    	WHEN SD.DELIVERY_POD_STATUS = 'Completely processed' THEN 'C-Completely processed'
	    	ELSE SD.DELIVERY_POD_STATUS
		END AS DELIVERY_INTERCO_POD_STATUS,
		DO_REASON.SALES_ORDER_REASON,
		DO_REASON.SALES_ORDER_REASON_DESC,
	FROM HEADER_PRODUCTION HP
	INNER JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_DELIVERY SD
		ON SD.SOURCE_SYSTEM = HP.SOURCE_SYSTEM
       AND SD.DELIVERY_NUMBER = HP.DELIVERY_NUMBER_INTERCO
	LEFT JOIN DOCUMENT_FLOW DF
		ON DF.DELIVERY_CONS_NUMBER = SD.DELIVERY_NUMBER 
	LEFT JOIN (
		SELECT DISTINCT DO.SOURCE_SYSTEM, DELIVERY_NUMBER,REFERENCE_SALES_ORDER_NUMBER, SO.REFERENCE_DOCUMENT_NUMBER,  DO.SALES_ORDER_REASON, DO.SALES_ORDER_REASON_DESC 
		FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_DELIVERY DO
		LEFT JOIN F_SALES_SALES_ORDER SO ON DO.REFERENCE_SALES_ORDER_NUMBER = SO.SALES_ORDER_NUMBER AND DO.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
		WHERE DO.SOURCE_SYSTEM = 'PE2' AND DO.SALES_ORDER_REASON IS NOT NULL
		) DO_REASON 
			ON DO_REASON.REFERENCE_DOCUMENT_NUMBER = HP.SALES_ORDER_NUMBER_INTERCO AND DO_REASON.SOURCE_SYSTEM = HP.SOURCE_SYSTEM
),
GI_DETAIL_SELLING AS (
    SELECT DISTINCT 
        H.SOURCE_SYSTEM,
        SCM."REFERENCE"                AS DELIVERY_NUMBER,
        SCM.MATERIAL_DOCUMENT_NUMBER   AS GI_NUMBER,
        SCM.FISCAL_YEAR,
		TRY_TO_DATE(SCM.ENTRY_DATE, 'YYYYMMDD') AS GI_ENTRY_DATE,
		TRY_TO_DATE (SCM.POSTING_DATE, 'YYYYMMDD') AS GI_POSTING_DATE,
		CASE 
		    WHEN SCM.ENTRY_DATE IS NULL AND SCM.POSTING_DATE IS NULL THEN 'N/A'
		    WHEN SCM.ENTRY_DATE IS NOT NULL AND SCM.POSTING_DATE IS NULL THEN 'Real-time entry'
		    WHEN SCM.ENTRY_DATE = SCM.POSTING_DATE THEN 'Real-time entry'
		    WHEN SCM.POSTING_DATE > SCM.ENTRY_DATE THEN 'Forward-dated entry'
		    WHEN SCM.POSTING_DATE < SCM.ENTRY_DATE THEN 'Backdated entry'
		    ELSE 'Backdated entry'
		END AS GI_INTERCO_BACKDATE_FLAG,
		CASE 
		    WHEN SCM.ENTRY_DATE IS NULL AND SCM.POSTING_DATE IS NULL THEN 'N/A'
		    WHEN SCM.ENTRY_DATE IS NOT NULL AND SCM.POSTING_DATE IS NULL THEN '0'
		    WHEN SCM.ENTRY_DATE IS NOT NULL AND SCM.POSTING_DATE IS NOT NULL THEN TO_VARCHAR(DATEDIFF(DAY,TRY_TO_DATE(SCM.ENTRY_DATE,'YYYYMMDD'),TRY_TO_DATE(SCM.POSTING_DATE,'YYYYMMDD')))
		    ELSE 'N/A'
		END AS GI_INTERCO_DIFF_DAYS,
		CASE
		    WHEN SCM.ENTRY_DATE IS NULL AND SCM.POSTING_DATE IS NULL THEN 'N/A'
		    WHEN DATEDIFF(DAY,TRY_TO_DATE(SCM.ENTRY_DATE,'YYYYMMDD'),TRY_TO_DATE(SCM.POSTING_DATE,'YYYYMMDD')) >= 0 THEN '1/ 0 Hari'
		    WHEN DATEDIFF(DAY,TRY_TO_DATE(SCM.ENTRY_DATE,'YYYYMMDD'),TRY_TO_DATE(SCM.POSTING_DATE,'YYYYMMDD')) BETWEEN -3 AND -1 THEN '2/ 1-3 Hari'
		    WHEN DATEDIFF(DAY,TRY_TO_DATE(SCM.ENTRY_DATE,'YYYYMMDD'),TRY_TO_DATE(SCM.POSTING_DATE,'YYYYMMDD')) BETWEEN -7 AND -4 THEN '3/ 3-7 Hari'
		    WHEN DATEDIFF(DAY,TRY_TO_DATE(SCM.ENTRY_DATE,'YYYYMMDD'),TRY_TO_DATE(SCM.POSTING_DATE,'YYYYMMDD')) BETWEEN -14 AND -8 THEN '4/ 7-14 Hari'
		    WHEN DATEDIFF(DAY,TRY_TO_DATE(SCM.ENTRY_DATE,'YYYYMMDD'),TRY_TO_DATE(SCM.POSTING_DATE,'YYYYMMDD')) BETWEEN -30 AND -15 THEN '5/ 14-30 Hari'
		    WHEN DATEDIFF(DAY,TRY_TO_DATE(SCM.ENTRY_DATE,'YYYYMMDD'),TRY_TO_DATE(SCM.POSTING_DATE,'YYYYMMDD')) < -30 THEN '6/ >30 Hari'
		    ELSE ''
		END AS AGING_GI_INTERCO_DIFF_DAYS
    FROM HEADER H 
    LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SCM_STOCK_TRANSACTION_SAP SCM
        ON SCM.SOURCE_SYSTEM = H.SOURCE_SYSTEM
       AND SCM."REFERENCE" = H.DELIVERY_NUMBER
       AND SCM.FISCAL_YEAR = '2025'
),
GI_DETAIL_PRODUCTION AS (
	SELECT DISTINCT
		HP.SOURCE_SYSTEM,
		HP.DELIVERY_NUMBER_INTERCO,
		SCM."REFERENCE" AS DELIVERY_NUMBER,
		SCM.MATERIAL_DOCUMENT_NUMBER AS GI_NUMBER_INTERCO,
		TRY_TO_DATE(SCM.ENTRY_DATE, 'YYYYMMDD') AS GI_INTERCO_CREATED_DATE,
		TRY_TO_DATE (SCM.POSTING_DATE, 'YYYYMMDD') AS GI_INTERCO_POSTING_DATE,
		CASE 
		    WHEN SCM.ENTRY_DATE IS NULL AND SCM.POSTING_DATE IS NULL THEN 'N/A'
		    WHEN SCM.ENTRY_DATE IS NOT NULL AND SCM.POSTING_DATE IS NULL THEN 'Real-time entry'
		    WHEN SCM.ENTRY_DATE = SCM.POSTING_DATE THEN 'Real-time entry'
		    WHEN SCM.POSTING_DATE > SCM.ENTRY_DATE THEN 'Forward-dated entry'
		    WHEN SCM.POSTING_DATE < SCM.ENTRY_DATE THEN 'Backdated entry'
		    ELSE 'Backdated entry'
		END AS GI_CUSTOMER_BACKDATE_FLAG,
		CASE 
		    WHEN SCM.ENTRY_DATE IS NULL AND SCM.POSTING_DATE IS NULL THEN 'N/A'
		    WHEN SCM.ENTRY_DATE IS NOT NULL AND SCM.POSTING_DATE IS NULL THEN '0'
		    WHEN SCM.ENTRY_DATE IS NOT NULL AND SCM.POSTING_DATE IS NOT NULL THEN TO_VARCHAR(DATEDIFF(DAY,TRY_TO_DATE(SCM.ENTRY_DATE,'YYYYMMDD'),TRY_TO_DATE(SCM.POSTING_DATE,'YYYYMMDD')))
		    ELSE 'N/A'
		END AS GI_CUSTOMER_DIFF_DAYS,
		CASE
		    WHEN SCM.ENTRY_DATE IS NULL AND SCM.POSTING_DATE IS NULL THEN 'N/A'
		    WHEN DATEDIFF(DAY,TRY_TO_DATE(SCM.ENTRY_DATE,'YYYYMMDD'),TRY_TO_DATE(SCM.POSTING_DATE,'YYYYMMDD')) >= 0 THEN '1/ 0 Hari'
		    WHEN DATEDIFF(DAY,TRY_TO_DATE(SCM.ENTRY_DATE,'YYYYMMDD'),TRY_TO_DATE(SCM.POSTING_DATE,'YYYYMMDD')) BETWEEN -3 AND -1 THEN '2/ 1-3 Hari'
		    WHEN DATEDIFF(DAY,TRY_TO_DATE(SCM.ENTRY_DATE,'YYYYMMDD'),TRY_TO_DATE(SCM.POSTING_DATE,'YYYYMMDD')) BETWEEN -7 AND -4 THEN '3/ 3-7 Hari'
		    WHEN DATEDIFF(DAY,TRY_TO_DATE(SCM.ENTRY_DATE,'YYYYMMDD'),TRY_TO_DATE(SCM.POSTING_DATE,'YYYYMMDD')) BETWEEN -14 AND -8 THEN '4/ 7-14 Hari'
		    WHEN DATEDIFF(DAY,TRY_TO_DATE(SCM.ENTRY_DATE,'YYYYMMDD'),TRY_TO_DATE(SCM.POSTING_DATE,'YYYYMMDD')) BETWEEN -30 AND -15 THEN '5/ 14-30 Hari'
		    WHEN DATEDIFF(DAY,TRY_TO_DATE(SCM.ENTRY_DATE,'YYYYMMDD'),TRY_TO_DATE(SCM.POSTING_DATE,'YYYYMMDD')) < -30 THEN '6/ >30 Hari'
		    ELSE ''
		END AS AGING_GI_CUSTOMER_DIFF_DAYS
    FROM HEADER_PRODUCTION HP
    INNER JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SCM_STOCK_TRANSACTION_SAP SCM
        ON SCM.SOURCE_SYSTEM = HP.SOURCE_SYSTEM
       AND SCM."REFERENCE" = HP.DELIVERY_NUMBER_INTERCO
       AND SCM.FISCAL_YEAR = '2025'
),
BILLING_DETAIL_SELLING AS (
SELECT 
        H.SOURCE_SYSTEM,
        SB.REFERENCE_SALES_ORDER_NUMBER,
        SB.BILLING_TYPE || '-' || SB.BILLING_TYPE_DESC AS BILLING_TYPE,
		CASE 
	    	WHEN SB.POSTING_STATUS IS NULL OR SB.POSTING_STATUS_DESCRIPTION IS NULL THEN SB.POSTING_STATUS_DESCRIPTION 
	    	ELSE SB.POSTING_STATUS || '-' || SB.POSTING_STATUS_DESCRIPTION 
	  	END AS BILLING_STATUS,
        H.BILLING_NUMBER,
		TRY_TO_DATE(SB.BILLING_CREATED_DATE, 'YYYYMMDD') AS BILLING_CREATED_DATE,
		TRY_TO_DATE(SB.BILLING_DATE, 'YYYYMMDD') AS BILLING_DATE,
		CASE 
    		WHEN SB.TERM_OF_PAYMENT_DESC IS NULL OR SB.TERM_OF_PAYMENT = '' THEN SB.TERM_OF_PAYMENT
    		ELSE SB.TERM_OF_PAYMENT || '-' || SB.TERM_OF_PAYMENT_DESC
		END AS TERM_OF_PAYMENT,
        SUM(BILLING_NET_AMOUNT) AS TOTAL_BILLING_AMOUNT,
		CASE 
    		WHEN TOTAL_BILLING_AMOUNT = 0 THEN TRUE 
    		ELSE FALSE 
		END AS AMOUNT_ZERO_FLAG,
		CASE 
		    WHEN SB.BILLING_CREATED_DATE IS NULL AND SB.BILLING_DATE IS NULL THEN 'N/A'
		    WHEN SB.BILLING_CREATED_DATE IS NOT NULL AND SB.BILLING_DATE IS NULL THEN 'Real-time entry'
		    WHEN SB.BILLING_CREATED_DATE = SB.BILLING_DATE THEN 'Real-time entry'
		    WHEN SB.BILLING_DATE > SB.BILLING_CREATED_DATE THEN 'Forward-dated entry'
		    WHEN SB.BILLING_DATE < SB.BILLING_CREATED_DATE THEN 'Backdated entry'
		    ELSE 'Backdated entry'
		END AS BILLING_CUSTOMER_BACKDATE_FLAG,
		CASE 
		    WHEN SB.BILLING_CREATED_DATE IS NULL AND SB.BILLING_DATE IS NULL THEN 'N/A'
		    WHEN SB.BILLING_CREATED_DATE IS NOT NULL AND SB.BILLING_DATE IS NULL THEN '0'
		    WHEN SB.BILLING_CREATED_DATE IS NOT NULL AND SB.BILLING_DATE IS NOT NULL THEN TO_VARCHAR(DATEDIFF(DAY,TRY_TO_DATE(SB.BILLING_CREATED_DATE,'YYYYMMDD'),TRY_TO_DATE(SB.BILLING_DATE,'YYYYMMDD')))
		    ELSE 'N/A'
		END AS BILLING_CUSTOMER_DIFF_DAYS,
		CASE
		    WHEN SB.BILLING_CREATED_DATE IS NULL AND SB.BILLING_DATE IS NULL THEN 'N/A'
		    WHEN DATEDIFF(DAY,TRY_TO_DATE(SB.BILLING_CREATED_DATE,'YYYYMMDD'),TRY_TO_DATE(SB.BILLING_DATE,'YYYYMMDD')) >= 0 THEN '1/ 0 Hari'
		    WHEN DATEDIFF(DAY,TRY_TO_DATE(SB.BILLING_CREATED_DATE,'YYYYMMDD'),TRY_TO_DATE(SB.BILLING_DATE,'YYYYMMDD')) BETWEEN -3 AND -1 THEN '2/ 1-3 Hari'
		    WHEN DATEDIFF(DAY,TRY_TO_DATE(SB.BILLING_CREATED_DATE,'YYYYMMDD'),TRY_TO_DATE(SB.BILLING_DATE,'YYYYMMDD')) BETWEEN -7 AND -4 THEN '3/ 3-7 Hari'
		    WHEN DATEDIFF(DAY,TRY_TO_DATE(SB.BILLING_CREATED_DATE,'YYYYMMDD'),TRY_TO_DATE(SB.BILLING_DATE,'YYYYMMDD')) BETWEEN -14 AND -8 THEN '4/ 7-14 Hari'
		    WHEN DATEDIFF(DAY,TRY_TO_DATE(SB.BILLING_CREATED_DATE,'YYYYMMDD'),TRY_TO_DATE(SB.BILLING_DATE,'YYYYMMDD')) BETWEEN -30 AND -15 THEN '5/ 14-30 Hari'
		    WHEN DATEDIFF(DAY,TRY_TO_DATE(SB.BILLING_CREATED_DATE,'YYYYMMDD'),TRY_TO_DATE(SB.BILLING_DATE,'YYYYMMDD')) < -30 THEN '6/ >30 Hari'
		    ELSE ''
		END AS AGING_BILLING_CUSTOMER_DIFF_DAYS
    FROM HEADER H 
    LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING SB
    ON SB.SOURCE_SYSTEM = H.SOURCE_SYSTEM 
    AND SB.BILLING_NUMBER = H.BILLING_NUMBER 
    WHERE SB.BILLING_TYPE NOT IN ('ZB50','ZB99')
    GROUP BY H.SOURCE_SYSTEM,REFERENCE_SALES_ORDER_NUMBER,BILLING_TYPE,BILLING_TYPE_DESC,POSTING_STATUS,POSTING_STATUS_DESCRIPTION,
             H.BILLING_NUMBER,BILLING_CREATED_DATE,BILLING_DATE,TERM_OF_PAYMENT,TERM_OF_PAYMENT_DESC
),
BILLING_DETAIL_PRODUCTION AS (
	SELECT DISTINCT
		HP.SOURCE_SYSTEM,
		HP.BILLING_NUMBER_INTERCO,
		SB.BILLING_TYPE || '-' || SB.BILLING_TYPE_DESC AS BILLING_INTERCO_TYPE,
		CASE 
	    	WHEN SB.POSTING_STATUS IS NULL OR SB.POSTING_STATUS_DESCRIPTION IS NULL THEN SB.POSTING_STATUS_DESCRIPTION 
	    	ELSE SB.POSTING_STATUS || '-' || SB.POSTING_STATUS_DESCRIPTION 
	  	END AS BILLING_INTERCO_STATUS,
		TRY_TO_DATE(SB.BILLING_CREATED_DATE, 'YYYYMMDD') AS BILLING_INTERCO_CREATED_DATE,
		TRY_TO_DATE(SB.BILLING_DATE, 'YYYYMMDD') AS BILLING_INTERCO_DATE,
		CASE 
		    WHEN SB.BILLING_CREATED_DATE IS NULL AND SB.BILLING_DATE IS NULL THEN 'N/A'
		    WHEN SB.BILLING_CREATED_DATE IS NOT NULL AND SB.BILLING_DATE IS NULL THEN 'Real-time entry'
		    WHEN SB.BILLING_CREATED_DATE = SB.BILLING_DATE THEN 'Real-time entry'
		    WHEN SB.BILLING_DATE > SB.BILLING_CREATED_DATE THEN 'Forward-dated entry'
		    WHEN SB.BILLING_DATE < SB.BILLING_CREATED_DATE THEN 'Backdated entry'
		    ELSE 'Backdated entry'
		END AS BILLING_INTERCO_BACKDATE_FLAG,
		CASE 
		    WHEN SB.BILLING_CREATED_DATE IS NULL AND SB.BILLING_DATE IS NULL THEN 'N/A'
		    WHEN SB.BILLING_CREATED_DATE IS NOT NULL AND SB.BILLING_DATE IS NULL THEN '0'
		    WHEN SB.BILLING_CREATED_DATE IS NOT NULL AND SB.BILLING_DATE IS NOT NULL THEN TO_VARCHAR(DATEDIFF(DAY,TRY_TO_DATE(SB.BILLING_CREATED_DATE,'YYYYMMDD'),TRY_TO_DATE(SB.BILLING_DATE,'YYYYMMDD')))
		    ELSE 'N/A'
		END AS BILLING_INTERCO_DIFF_DAYS,
		CASE
		    WHEN SB.BILLING_CREATED_DATE IS NULL AND SB.BILLING_DATE IS NULL THEN 'N/A'
		    WHEN DATEDIFF(DAY,TRY_TO_DATE(SB.BILLING_CREATED_DATE,'YYYYMMDD'),TRY_TO_DATE(SB.BILLING_DATE,'YYYYMMDD')) >= 0 THEN '1/ 0 Hari'
		    WHEN DATEDIFF(DAY,TRY_TO_DATE(SB.BILLING_CREATED_DATE,'YYYYMMDD'),TRY_TO_DATE(SB.BILLING_DATE,'YYYYMMDD')) BETWEEN -3 AND -1 THEN '2/ 1-3 Hari'
		    WHEN DATEDIFF(DAY,TRY_TO_DATE(SB.BILLING_CREATED_DATE,'YYYYMMDD'),TRY_TO_DATE(SB.BILLING_DATE,'YYYYMMDD')) BETWEEN -7 AND -4 THEN '3/ 3-7 Hari'
		    WHEN DATEDIFF(DAY,TRY_TO_DATE(SB.BILLING_CREATED_DATE,'YYYYMMDD'),TRY_TO_DATE(SB.BILLING_DATE,'YYYYMMDD')) BETWEEN -14 AND -8 THEN '4/ 7-14 Hari'
		    WHEN DATEDIFF(DAY,TRY_TO_DATE(SB.BILLING_CREATED_DATE,'YYYYMMDD'),TRY_TO_DATE(SB.BILLING_DATE,'YYYYMMDD')) BETWEEN -30 AND -15 THEN '5/ 14-30 Hari'
		    WHEN DATEDIFF(DAY,TRY_TO_DATE(SB.BILLING_CREATED_DATE,'YYYYMMDD'),TRY_TO_DATE(SB.BILLING_DATE,'YYYYMMDD')) < -30 THEN '6/ >30 Hari'
		    ELSE ''
		END AS AGING_BILLING_INTERCO_DIFF_DAYS
	FROM HEADER_PRODUCTION HP
    INNER JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING SB
        ON SB.SOURCE_SYSTEM = HP.SOURCE_SYSTEM
       AND SB.BILLING_NUMBER = HP.BILLING_NUMBER_INTERCO
),
INVOICE_RECEIPT AS (
	SELECT DISTINCT
		IR.SOURCE_SYSTEM,
		IR.DOCUMENT_NUMBER,
		H.INVOICE_NUMBER,
		TO_DATE(IR.POSTING_DATE) AS INVOICE_RECEIPT_POSTING_DATE
	FROM HEADER H
	LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SCM_PURCHASING_ORDER IR
	    ON IR.SOURCE_SYSTEM = H.SOURCE_SYSTEM 
	    AND IR.DOCUMENT_NUMBER = H.INVOICE_NUMBER 
),
TFTG_DETAIL_SELLING AS (
SELECT 
		H.SOURCE_SYSTEM,
		H.BILLING_NUMBER,
		TF.TTF_NUMBER,
		TF.TTF_DOC_TYPE,
		TRY_TO_DATE(TF.TTF_CREATED_DATE, 'YYYYMMDD') AS TFTG_CREATED_DATE,
		TRY_TO_DATE(TF.TTF_DOC_DATE, 'YYYYMMDD') AS TFTG_DATE,
		CASE 
			WHEN TF.TTF_CREATED_DATE IS NULL AND TF.TTF_DOC_DATE IS NULL THEN 'N/A'
			WHEN TF.TTF_CREATED_DATE IS NOT NULL AND TF.TTF_DOC_DATE IS NULL THEN 'Real-time entry'
			WHEN TF.TTF_CREATED_DATE = TF.TTF_DOC_DATE THEN 'Real-time entry'
			WHEN TF.TTF_DOC_DATE > TF.TTF_CREATED_DATE THEN 'Forward-dated entry'
			WHEN TF.TTF_DOC_DATE < TF.TTF_CREATED_DATE THEN 'Backdated entry'
			ELSE 'Backdated entry'
		END AS TFTG_BACKDATE_FLAG,
		CASE 
			WHEN TF.TTF_CREATED_DATE IS NULL AND TF.TTF_DOC_DATE IS NULL THEN 'N/A'
			WHEN TF.TTF_CREATED_DATE IS NOT NULL AND TF.TTF_DOC_DATE IS NULL THEN '0'
			WHEN TF.TTF_CREATED_DATE IS NOT NULL AND TF.TTF_DOC_DATE IS NOT NULL THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(TF.TTF_CREATED_DATE,'YYYYMMDD'), TRY_TO_DATE(TF.TTF_DOC_DATE,'YYYYMMDD')))
			ELSE 'N/A'
		END AS TFTG_DIFF_DAYS,
		CASE
		    WHEN TF.TTF_CREATED_DATE IS NULL AND TF.TTF_DOC_DATE IS NULL THEN 'N/A'
		    WHEN DATEDIFF(DAY, TRY_TO_DATE(TF.TTF_CREATED_DATE,'YYYYMMDD'), TRY_TO_DATE(TF.TTF_DOC_DATE,'YYYYMMDD')) >= 0 THEN '1/ 0 Hari'
		    WHEN DATEDIFF(DAY, TRY_TO_DATE(TF.TTF_CREATED_DATE,'YYYYMMDD'), TRY_TO_DATE(TF.TTF_DOC_DATE,'YYYYMMDD')) BETWEEN -3 AND -1 THEN '2/ 1-3 Hari'
		    WHEN DATEDIFF(DAY, TRY_TO_DATE(TF.TTF_CREATED_DATE,'YYYYMMDD'), TRY_TO_DATE(TF.TTF_DOC_DATE,'YYYYMMDD')) BETWEEN -7 AND -4 THEN '3/ 3-7 Hari'
		    WHEN DATEDIFF(DAY, TRY_TO_DATE(TF.TTF_CREATED_DATE,'YYYYMMDD'), TRY_TO_DATE(TF.TTF_DOC_DATE,'YYYYMMDD')) BETWEEN -14 AND -8 THEN '4/ 7-14 Hari'
		    WHEN DATEDIFF(DAY, TRY_TO_DATE(TF.TTF_CREATED_DATE,'YYYYMMDD'), TRY_TO_DATE(TF.TTF_DOC_DATE,'YYYYMMDD')) BETWEEN -30 AND -15 THEN '5/ 14-30 Hari'
		    WHEN DATEDIFF(DAY, TRY_TO_DATE(TF.TTF_CREATED_DATE,'YYYYMMDD'), TRY_TO_DATE(TF.TTF_DOC_DATE,'YYYYMMDD')) < -30 THEN '6/ >30 Hari'
		    ELSE ''
		END AS AGING_TFTG_DIFF_DAYS
	FROM HEADER H
	LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_TTF TF
    ON TF.SOURCE_SYSTEM = H.SOURCE_SYSTEM
    AND TF.BILLING_NUMBER = H.BILLING_NUMBER
),
BILLING_CLEARING_DETAIL_SELLING AS (
SELECT 
		H.SOURCE_SYSTEM,
		H.BILLING_NUMBER,
		SBC.BILLING_CLEARING_DOC,
		TRY_TO_DATE(SBC.BILLING_CLEAR_CREATED_DATE, 'YYYYMMDD') AS BILLING_CLEAR_CREATED_DATE,
		TRY_TO_DATE(SBC.BILLING_CLEAR_DATE, 'YYYYMMDD') AS BILLING_CLEAR_DATE,
		CASE 
			WHEN SBC.BILLING_CLEAR_CREATED_DATE IS NULL AND SBC.BILLING_CLEAR_DATE IS NULL THEN 'N/A'
			WHEN SBC.BILLING_CLEAR_CREATED_DATE IS NOT NULL AND SBC.BILLING_CLEAR_DATE IS NULL THEN 'Real-time entry'
			WHEN SBC.BILLING_CLEAR_CREATED_DATE = SBC.BILLING_CLEAR_DATE THEN 'Real-time entry'
			WHEN SBC.BILLING_CLEAR_DATE > SBC.BILLING_CLEAR_CREATED_DATE THEN 'Forward-dated entry'
			WHEN SBC.BILLING_CLEAR_DATE < SBC.BILLING_CLEAR_CREATED_DATE THEN 'Backdated entry'
			ELSE 'Backdated entry'
		END AS BILLING_CLEARING_CUSTOMER_BACKDATE_FLAG,
		CASE 
			WHEN SBC.BILLING_CLEAR_CREATED_DATE IS NULL AND SBC.BILLING_CLEAR_DATE IS NULL THEN 'N/A'
			WHEN SBC.BILLING_CLEAR_CREATED_DATE IS NOT NULL AND SBC.BILLING_CLEAR_DATE IS NULL THEN '0'
			WHEN SBC.BILLING_CLEAR_CREATED_DATE IS NOT NULL AND SBC.BILLING_CLEAR_DATE IS NOT NULL THEN TO_VARCHAR(DATEDIFF(DAY, TRY_TO_DATE(SBC.BILLING_CLEAR_CREATED_DATE,'YYYYMMDD'), TRY_TO_DATE(SBC.BILLING_CLEAR_DATE,'YYYYMMDD')))
			ELSE 'N/A'
		END AS BILLING_CLEARING_CUSTOMER_DIFF_DAYS,
		CASE
		    WHEN SBC.BILLING_CLEAR_CREATED_DATE IS NULL AND SBC.BILLING_CLEAR_DATE IS NULL THEN 'N/A'
		    WHEN DATEDIFF(DAY, TRY_TO_DATE(SBC.BILLING_CLEAR_CREATED_DATE,'YYYYMMDD'), TRY_TO_DATE(SBC.BILLING_CLEAR_DATE,'YYYYMMDD')) >= 0 THEN '1/ 0 Hari'
		    WHEN DATEDIFF(DAY, TRY_TO_DATE(SBC.BILLING_CLEAR_CREATED_DATE,'YYYYMMDD'), TRY_TO_DATE(SBC.BILLING_CLEAR_DATE,'YYYYMMDD')) BETWEEN -3 AND -1 THEN '2/ 1-3 Hari'
		    WHEN DATEDIFF(DAY, TRY_TO_DATE(SBC.BILLING_CLEAR_CREATED_DATE,'YYYYMMDD'), TRY_TO_DATE(SBC.BILLING_CLEAR_DATE,'YYYYMMDD')) BETWEEN -7 AND -4 THEN '3/ 3-7 Hari'
		    WHEN DATEDIFF(DAY, TRY_TO_DATE(SBC.BILLING_CLEAR_CREATED_DATE,'YYYYMMDD'), TRY_TO_DATE(SBC.BILLING_CLEAR_DATE,'YYYYMMDD')) BETWEEN -14 AND -8 THEN '4/ 7-14 Hari'
		    WHEN DATEDIFF(DAY, TRY_TO_DATE(SBC.BILLING_CLEAR_CREATED_DATE,'YYYYMMDD'), TRY_TO_DATE(SBC.BILLING_CLEAR_DATE,'YYYYMMDD')) BETWEEN -30 AND -15 THEN '5/ 14-30 Hari'
		    WHEN DATEDIFF(DAY, TRY_TO_DATE(SBC.BILLING_CLEAR_CREATED_DATE,'YYYYMMDD'), TRY_TO_DATE(SBC.BILLING_CLEAR_DATE,'YYYYMMDD')) < -30 THEN '6/ >30 Hari'
		    ELSE ''
		END AS AGING_BILLING_CLEARING_CUSTOMER_DIFF_DAYS
	FROM HEADER H
	INNER JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_CLEARING SBC
    ON SBC.SOURCE_SYSTEM = H.SOURCE_SYSTEM
    AND SBC.BILLING_NUMBER = H.BILLING_NUMBER
),
BILLING_CLEARING_DETAIL_PRODUCTION AS(
	SELECT DISTINCT
		HP.SOURCE_SYSTEM,
		HP.BILLING_NUMBER_INTERCO,
		SBC.BILLING_CLEARING_DOC AS BILLING_CLEARING_DOC_INTERCO,
		TRY_TO_DATE(SBC.BILLING_CLEAR_CREATED_DATE, 'YYYYMMDD') AS BILLING_CLEAR_INTERCO_CREATED_DATE,
		TRY_TO_DATE(SBC.BILLING_CLEAR_DATE, 'YYYYMMDD') AS BILLING_CLEAR_INTERCO_DATE,
	FROM HEADER_PRODUCTION HP
    INNER JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_CLEARING SBC
		ON SBC.SOURCE_SYSTEM = HP.SOURCE_SYSTEM
		AND SBC.BILLING_NUMBER = HP.BILLING_NUMBER_INTERCO
),
AGGR AS (
SELECT
	-- SELLING ENTITY --
    H.SOURCE_SYSTEM,
    SO.COMPANY,
    SO.PLANT,
    SO.CUSTOMER,
    SO.CUSTOMER_NAME,
    SO.CUSTOMER_SHIP_TO,
    SO.CUSTOMER_SHIP_TO_NAME,
    SO.REGION,
    SO.REGION_GROUP,
    SO.POD_FLAG,
    SO.SALES_OFFICE,
    SO.SALES_OFFICE_GROUP,
    SO.DIVISION,
    SO.DISTRIBUTION_CHANNEL,
    BL.TERM_OF_PAYMENT,
    SO.SALES_ORDER_CATEGORY,
    SO.SALES_ORDER_TYPE,
    DO.DELIVERY_TYPE,
    BL.BILLING_TYPE,
    TF.TTF_DOC_TYPE,
    SO.SALES_ORDER_STATUS,
    SO.SALES_ORDER_STATUS_REJECTION,
    SO.SALES_ORDER_REASON_REJECTION_DESC,
    SO.SALES_ORDER_REASON_REJECTION_GROUP,
    DO.DELIVERY_STATUS,
/*  DO.DELIVERY_POD_STATUS,
    DO.REASON_POD,
    DO.REASON_POD_FLAG,
    DO.REASON_POD_GROUP,
	BL.AMOUNT_ZERO_FLAG,*/
    BL.BILLING_STATUS,
    -- SELLING DOC NUMBER --
    SO.CREATED_BY,
    H.SALES_ORDER_NUMBER,
    H.DELIVERY_NUMBER,
    GI.GI_NUMBER,
    H.BILLING_NUMBER,
    TF.TTF_NUMBER,
    BC.BILLING_CLEARING_DOC,
    H.PO_NUMBER,
    H.GR_NUMBER,
    H.INVOICE_NUMBER,
	-- PRODUCTION DOC NUMBER --
	HP.SALES_ORDER_NUMBER_INTERCO,
    HP.DELIVERY_NUMBER_INTERCO,
    GIPROD.GI_NUMBER_INTERCO,
    DF.SALES_ORDER_CONS_NUMBER,
    DF.DELIVERY_CONS_NUMBER,
    DF.GI_CONS_NUMBER,
    HP.BILLING_NUMBER_INTERCO,
    BCPROD.BILLING_CLEARING_DOC_INTERCO,
    -- PRODUCTION ENTITY --
	SOPROD.COMPANY_INTERCO,
    SOPROD.PLANT_INTERCO,
    SOPROD.SALES_OFFICE_INTERCO,
    SOPROD.DISTRIBUTION_CHANNEL_INTERCO,
    SOPROD.SALES_ORDER_INTERCO_TYPE,
    DOPROD.DELIVERY_INTERCO_TYPE,
    BLPROD.BILLING_INTERCO_TYPE,
    SOPROD.SALES_ORDER_INTERCO_STATUS,
    DF.SALES_ORDER_CONS_STATUS,
    SOPROD.SALES_ORDER_INTERCO_STATUS_REJECTION,
    SOPROD.SALES_ORDER_INTERCO_REASON_REJECTION_DESC,
	DOPROD.DELIVERY_INTERCO_STATUS,
    DOPROD.DELIVERY_INTERCO_POD_STATUS,
    BLPROD.BILLING_INTERCO_STATUS,
	CASE
	    WHEN COALESCE(COALESCE (DOPROD.SALES_ORDER_REASON,DF.SALES_ORDER_REASON) || '-' || COALESCE (DOPROD.SALES_ORDER_REASON_DESC,DF.SALES_ORDER_REASON_DESC), '') = '' THEN FALSE
	    ELSE TRUE
	END AS DELIVERY_INTERCO_REJECTION_FLAG,
	COALESCE (DOPROD.SALES_ORDER_REASON,DF.SALES_ORDER_REASON) || '-' || COALESCE (DOPROD.SALES_ORDER_REASON_DESC,DF.SALES_ORDER_REASON_DESC) AS DELIVERY_INTERCO_REJECTION_REASON,
	CASE
    WHEN
        COALESCE(DOPROD.SALES_ORDER_REASON, DF.SALES_ORDER_REASON) || '-' || COALESCE(DOPROD.SALES_ORDER_REASON_DESC, DF.SALES_ORDER_REASON_DESC)
        IN (
            'K00-(CAS)Ret Cons',
            'K03-(CAS)Ret Same Prd Qlty',
            'K04-(CAS)Ret Same Prd Non Qlty',
            'K12-(CAS)Ret Same Prd Adm'
        )
    THEN 'Order Related'
    ELSE 'N/A'
	END AS DELIVERY_INTERCO_REJECTION_REASON_GROUPING,
    DF.DELIVERY_CONS_STATUS,
	-- SELLING DOC DATE --
	SO.SALES_ORDER_CREATED_DATE,
	SO.SALES_ORDER_DATE,
	DO.DELIVERY_CREATED_DATE,
	DO.DELIVERY_ACTUAL_DATE,
    DO.POD_DATE,
    GI.GI_ENTRY_DATE,
    GI.GI_POSTING_DATE,
    BL.BILLING_CREATED_DATE,
    BL.BILLING_DATE,
    TF.TFTG_CREATED_DATE,
    TF.TFTG_DATE, 
    BC.BILLING_CLEAR_CREATED_DATE,
    BC.BILLING_CLEAR_DATE,
    IR.INVOICE_RECEIPT_POSTING_DATE,
    -- PRODUCTION DATE --
	SOPROD.SALES_ORDER_INTERCO_CREATED_DATE,
	DOPROD.DELIVERY_INTERCO_CREATED_DATE,
	DOPROD.POD_INTERCO_DATE,
	GIPROD.GI_INTERCO_CREATED_DATE,
    BLPROD.BILLING_INTERCO_CREATED_DATE,
    BCPROD.BILLING_CLEAR_INTERCO_CREATED_DATE,
    -- INTERCO CONSIGNMENT --
    DF.SALES_ORDER_CONS_CREATED_DATE,
    DF.DELIVERY_CONS_CREATED_DATE,
    DF.GI_CONS_CREATED_DATE,
    -- OPEN ITEM AGING --
    -- SO CUSTOMER TO SO INTERCO --
	CASE 
	    WHEN SOPROD.SALES_ORDER_INTERCO_CREATED_DATE IS NOT NULL AND SO.SALES_ORDER_CREATED_DATE IS NOT NULL
	    THEN TO_VARCHAR(DATEDIFF(DAY,SO.SALES_ORDER_CREATED_DATE,SOPROD.SALES_ORDER_INTERCO_CREATED_DATE))
	    WHEN SOPROD.SALES_ORDER_INTERCO_CREATED_DATE IS NULL AND SO.SALES_ORDER_CREATED_DATE IS NOT NULL
	    THEN TO_VARCHAR(DATEDIFF(DAY,SO.SALES_ORDER_CREATED_DATE,CURRENT_DATE))
	    ELSE 'N/A'
	END AS SELISIH_SO_CUSTOMER_SO_INTERCO,
	CASE
	    WHEN SELISIH_SO_CUSTOMER_SO_INTERCO = 'N/A' THEN 'N/A'
	    WHEN SELISIH_SO_CUSTOMER_SO_INTERCO = 0 THEN '1/ Hari - H'
	    WHEN ABS(SELISIH_SO_CUSTOMER_SO_INTERCO) = 1 THEN '2/ 1 Hari'
	    WHEN ABS(SELISIH_SO_CUSTOMER_SO_INTERCO) = 2 THEN '3/ 2 Hari'
	    WHEN ABS(SELISIH_SO_CUSTOMER_SO_INTERCO) = 3 THEN '4/ 3 Hari'
	    WHEN ABS(SELISIH_SO_CUSTOMER_SO_INTERCO) BETWEEN 4 AND 7 THEN '5/ 4-7 Hari'
	    WHEN ABS(SELISIH_SO_CUSTOMER_SO_INTERCO) BETWEEN 8 AND 14 THEN '6/ 7-14 Hari'
	    WHEN ABS(SELISIH_SO_CUSTOMER_SO_INTERCO) BETWEEN 15 AND 30 THEN '7/ 14-30 Hari'
	    WHEN ABS(SELISIH_SO_CUSTOMER_SO_INTERCO) > 30 THEN '8/ >30 Hari'
    ELSE ''
	END AS AGING_SO_CUSTOMER_SO_INTERCO,
    -- SO INTERCO TO DO CONS --
	CASE 
	    WHEN DF.DELIVERY_CONS_CREATED_DATE IS NOT NULL AND SOPROD.SALES_ORDER_INTERCO_CREATED_DATE IS NOT NULL
	    THEN TO_VARCHAR(DATEDIFF(DAY,SOPROD.SALES_ORDER_INTERCO_CREATED_DATE,DF.DELIVERY_CONS_CREATED_DATE))
	    WHEN DF.DELIVERY_CONS_CREATED_DATE IS NULL AND SOPROD.SALES_ORDER_INTERCO_CREATED_DATE IS NOT NULL
	    THEN TO_VARCHAR(DATEDIFF(DAY,SOPROD.SALES_ORDER_INTERCO_CREATED_DATE,CURRENT_DATE))
	    ELSE 'N/A'
	END AS SELISIH_SO_INTERCO_DO_CONS,
	CASE
	    WHEN SELISIH_SO_INTERCO_DO_CONS = 'N/A' THEN 'N/A'
	    WHEN SELISIH_SO_INTERCO_DO_CONS = 0 THEN '1/ Hari - H'
	    WHEN ABS(SELISIH_SO_INTERCO_DO_CONS) = 1 THEN '2/ 1 Hari'
	    WHEN ABS(SELISIH_SO_INTERCO_DO_CONS) = 2 THEN '3/ 2 Hari'
	    WHEN ABS(SELISIH_SO_INTERCO_DO_CONS) = 3 THEN '4/ 3 Hari'
	    WHEN ABS(SELISIH_SO_INTERCO_DO_CONS) BETWEEN 4 AND 7 THEN '5/ 4-7 Hari'
	    WHEN ABS(SELISIH_SO_INTERCO_DO_CONS) BETWEEN 8 AND 14 THEN '6/ 7-14 Hari'
	    WHEN ABS(SELISIH_SO_INTERCO_DO_CONS) BETWEEN 15 AND 30 THEN '7/ 14-30 Hari'
	    WHEN ABS(SELISIH_SO_INTERCO_DO_CONS) > 30 THEN '8/ >30 Hari'
    ELSE ''
	END AS AGING_SO_INTERCO_DO_CONS,
    -- GI CONS TO POD --
	CASE 
	    WHEN DOPROD.POD_INTERCO_DATE IS NOT NULL AND DF.GI_CONS_CREATED_DATE IS NOT NULL
	    THEN TO_VARCHAR(DATEDIFF(DAY,DF.GI_CONS_CREATED_DATE,DOPROD.POD_INTERCO_DATE))
	    WHEN DOPROD.POD_INTERCO_DATE IS NULL AND DF.GI_CONS_CREATED_DATE IS NOT NULL
	    THEN TO_VARCHAR(DATEDIFF(DAY,DF.GI_CONS_CREATED_DATE,CURRENT_DATE))
	    ELSE 'N/A'
	END AS SELISIH_GI_CONS_POD_INTERCO,
	CASE
	    WHEN SELISIH_GI_CONS_POD_INTERCO = 'N/A' THEN 'N/A'
	    WHEN SELISIH_GI_CONS_POD_INTERCO = 0 THEN '1/ Hari - H'
	    WHEN ABS(SELISIH_GI_CONS_POD_INTERCO) = 1 THEN '2/ 1 Hari'
	    WHEN ABS(SELISIH_GI_CONS_POD_INTERCO) = 2 THEN '3/ 2 Hari'
	    WHEN ABS(SELISIH_GI_CONS_POD_INTERCO) = 3 THEN '4/ 3 Hari'
	    WHEN ABS(SELISIH_GI_CONS_POD_INTERCO) BETWEEN 4 AND 7 THEN '5/ 4-7 Hari'
	    WHEN ABS(SELISIH_GI_CONS_POD_INTERCO) BETWEEN 8 AND 14 THEN '6/ 7-14 Hari'
	    WHEN ABS(SELISIH_GI_CONS_POD_INTERCO) BETWEEN 15 AND 30 THEN '7/ 14-30 Hari'
	    WHEN ABS(SELISIH_GI_CONS_POD_INTERCO) > 30 THEN '8/ >30 Hari'
    ELSE ''
	END AS AGING_GI_CONS_POD_INTERCO,
    -- POD TO BILLING INTERCO --
	CASE 
	    WHEN BLPROD.BILLING_INTERCO_CREATED_DATE IS NOT NULL AND DOPROD.POD_INTERCO_DATE IS NOT NULL
	    THEN TO_VARCHAR(DATEDIFF(DAY,DOPROD.POD_INTERCO_DATE,BLPROD.BILLING_INTERCO_CREATED_DATE))
	    WHEN BLPROD.BILLING_INTERCO_CREATED_DATE IS NULL AND DOPROD.POD_INTERCO_DATE IS NOT NULL
	    THEN TO_VARCHAR(DATEDIFF(DAY,DOPROD.POD_INTERCO_DATE,CURRENT_DATE))
	    ELSE 'N/A'
	END AS SELISIH_POD_INTERCO_BILLING_INTERCO,
	CASE
	    WHEN SELISIH_POD_INTERCO_BILLING_INTERCO = 'N/A' THEN 'N/A'
	    WHEN SELISIH_POD_INTERCO_BILLING_INTERCO = 0 THEN '1/ Hari - H'
	    WHEN ABS(SELISIH_POD_INTERCO_BILLING_INTERCO) = 1 THEN '2/ 1 Hari'
	    WHEN ABS(SELISIH_POD_INTERCO_BILLING_INTERCO) = 2 THEN '3/ 2 Hari'
	    WHEN ABS(SELISIH_POD_INTERCO_BILLING_INTERCO) = 3 THEN '4/ 3 Hari'
	    WHEN ABS(SELISIH_POD_INTERCO_BILLING_INTERCO) BETWEEN 4 AND 7 THEN '5/ 4-7 Hari'
	    WHEN ABS(SELISIH_POD_INTERCO_BILLING_INTERCO) BETWEEN 8 AND 14 THEN '6/ 7-14 Hari'
	    WHEN ABS(SELISIH_POD_INTERCO_BILLING_INTERCO) BETWEEN 15 AND 30 THEN '7/ 14-30 Hari'
	    WHEN ABS(SELISIH_POD_INTERCO_BILLING_INTERCO) > 30 THEN '8/ >30 Hari'
    ELSE ''
	END AS AGING_POD_INTERCO_BILLING_INTERCO,
    -- BILLING INTERCO TO BILLING CUSTOMER --
	CASE 
	    WHEN BL.BILLING_CREATED_DATE IS NOT NULL AND BLPROD.BILLING_INTERCO_CREATED_DATE IS NOT NULL
	    THEN TO_VARCHAR(DATEDIFF(DAY,BLPROD.BILLING_INTERCO_CREATED_DATE,BL.BILLING_CREATED_DATE))
	    WHEN BL.BILLING_CREATED_DATE IS NULL AND BLPROD.BILLING_INTERCO_CREATED_DATE IS NOT NULL
	    THEN TO_VARCHAR(DATEDIFF(DAY,BLPROD.BILLING_INTERCO_CREATED_DATE,CURRENT_DATE))
	    ELSE 'N/A'
	END AS SELISIH_BILLING_INTERCO_BILLING_CUSTOMER,
	CASE
	    WHEN SELISIH_BILLING_INTERCO_BILLING_CUSTOMER = 'N/A' THEN 'N/A'
	    WHEN SELISIH_BILLING_INTERCO_BILLING_CUSTOMER = 0 THEN '1/ Hari - H'
	    WHEN ABS(SELISIH_BILLING_INTERCO_BILLING_CUSTOMER) = 1 THEN '2/ 1 Hari'
	    WHEN ABS(SELISIH_BILLING_INTERCO_BILLING_CUSTOMER) = 2 THEN '3/ 2 Hari'
	    WHEN ABS(SELISIH_BILLING_INTERCO_BILLING_CUSTOMER) = 3 THEN '4/ 3 Hari'
	    WHEN ABS(SELISIH_BILLING_INTERCO_BILLING_CUSTOMER) BETWEEN 4 AND 7 THEN '5/ 4-7 Hari'
	    WHEN ABS(SELISIH_BILLING_INTERCO_BILLING_CUSTOMER) BETWEEN 8 AND 14 THEN '6/ 7-14 Hari'
	    WHEN ABS(SELISIH_BILLING_INTERCO_BILLING_CUSTOMER) BETWEEN 15 AND 30 THEN '7/ 14-30 Hari'
	    WHEN ABS(SELISIH_BILLING_INTERCO_BILLING_CUSTOMER) > 30 THEN '8/ >30 Hari'
    ELSE ''
	END AS AGING_BILLING_INTERCO_BILLING_CUSTOMER,
	-- BILLING CUSTOMER TO TF/TG --
	CASE 
	    WHEN TF.TFTG_CREATED_DATE IS NOT NULL AND BL.BILLING_CREATED_DATE IS NOT NULL
	    THEN TO_VARCHAR(DATEDIFF(DAY,BL.BILLING_CREATED_DATE,TF.TFTG_CREATED_DATE))
	    WHEN TF.TFTG_CREATED_DATE IS NULL AND BL.BILLING_CREATED_DATE IS NOT NULL
	    THEN TO_VARCHAR(DATEDIFF(DAY,BL.BILLING_CREATED_DATE,CURRENT_DATE))
	    ELSE 'N/A'
	END AS SELISIH_BILLING_CUSTOMER_TFTG_CUSTOMER,
	CASE
	    WHEN SELISIH_BILLING_CUSTOMER_TFTG_CUSTOMER = 'N/A' THEN 'N/A'
	    WHEN SELISIH_BILLING_CUSTOMER_TFTG_CUSTOMER = 0 THEN '1/ Hari - H'
	    WHEN ABS(SELISIH_BILLING_CUSTOMER_TFTG_CUSTOMER) = 1 THEN '2/ 1 Hari'
	    WHEN ABS(SELISIH_BILLING_CUSTOMER_TFTG_CUSTOMER) = 2 THEN '3/ 2 Hari'
	    WHEN ABS(SELISIH_BILLING_CUSTOMER_TFTG_CUSTOMER) = 3 THEN '4/ 3 Hari'
	    WHEN ABS(SELISIH_BILLING_CUSTOMER_TFTG_CUSTOMER) BETWEEN 4 AND 7 THEN '5/ 4-7 Hari'
	    WHEN ABS(SELISIH_BILLING_CUSTOMER_TFTG_CUSTOMER) BETWEEN 8 AND 14 THEN '6/ 7-14 Hari'
	    WHEN ABS(SELISIH_BILLING_CUSTOMER_TFTG_CUSTOMER) BETWEEN 15 AND 30 THEN '7/ 14-30 Hari'
	    WHEN ABS(SELISIH_BILLING_CUSTOMER_TFTG_CUSTOMER) > 30 THEN '8/ >30 Hari'
    ELSE ''
	END AS AGING_BILLING_CUSTOMER_TFTG_CUSTOMER,
		-- TF/TG TO BILLING CLEARING --
	CASE 
	    WHEN BC.BILLING_CLEAR_CREATED_DATE IS NOT NULL AND TF.TFTG_CREATED_DATE IS NOT NULL
	    THEN TO_VARCHAR(DATEDIFF(DAY,TF.TFTG_CREATED_DATE,BC.BILLING_CLEAR_CREATED_DATE))
	    WHEN BC.BILLING_CLEAR_CREATED_DATE IS NULL AND TF.TFTG_CREATED_DATE IS NOT NULL
	    THEN TO_VARCHAR(DATEDIFF(DAY,TF.TFTG_CREATED_DATE,CURRENT_DATE))
	    ELSE 'N/A'
	END AS SELISIH_TFTG_CUSTOMER_BILLING_CLEARING_CUSTOMER,
	CASE
	    WHEN SELISIH_TFTG_CUSTOMER_BILLING_CLEARING_CUSTOMER = 'N/A' THEN 'N/A'
	    WHEN SELISIH_TFTG_CUSTOMER_BILLING_CLEARING_CUSTOMER = 0 THEN '1/ Hari - H'
	    WHEN ABS(SELISIH_TFTG_CUSTOMER_BILLING_CLEARING_CUSTOMER) = 1 THEN '2/ 1 Hari'
	    WHEN ABS(SELISIH_TFTG_CUSTOMER_BILLING_CLEARING_CUSTOMER) = 2 THEN '3/ 2 Hari'
	    WHEN ABS(SELISIH_TFTG_CUSTOMER_BILLING_CLEARING_CUSTOMER) = 3 THEN '4/ 3 Hari'
	    WHEN ABS(SELISIH_TFTG_CUSTOMER_BILLING_CLEARING_CUSTOMER) BETWEEN 4 AND 7 THEN '5/ 4-7 Hari'
	    WHEN ABS(SELISIH_TFTG_CUSTOMER_BILLING_CLEARING_CUSTOMER) BETWEEN 8 AND 14 THEN '6/ 7-14 Hari'
	    WHEN ABS(SELISIH_TFTG_CUSTOMER_BILLING_CLEARING_CUSTOMER) BETWEEN 15 AND 30 THEN '7/ 14-30 Hari'
	    WHEN ABS(SELISIH_TFTG_CUSTOMER_BILLING_CLEARING_CUSTOMER) > 30 THEN '8/ >30 Hari'
    ELSE ''
	END AS AGING_TFTG_CUSTOMER_BILLING_CLEARING_CUSTOMER,
	-- BILLING INTERCO TO INVOICE RECEIPT --
	CASE 
	    WHEN IR.INVOICE_RECEIPT_POSTING_DATE IS NOT NULL AND BLPROD.BILLING_INTERCO_CREATED_DATE IS NOT NULL
	    THEN TO_VARCHAR(DATEDIFF(DAY,BLPROD.BILLING_INTERCO_CREATED_DATE,IR.INVOICE_RECEIPT_POSTING_DATE))
	    WHEN IR.INVOICE_RECEIPT_POSTING_DATE IS NULL AND BLPROD.BILLING_INTERCO_CREATED_DATE IS NOT NULL
	    THEN TO_VARCHAR(DATEDIFF(DAY,BLPROD.BILLING_INTERCO_CREATED_DATE,CURRENT_DATE))
	    ELSE 'N/A'
	END AS SELISIH_BILLING_INTERCO_INVOICE_RECEIPT,
	CASE
	    WHEN SELISIH_BILLING_INTERCO_INVOICE_RECEIPT = 'N/A' THEN 'N/A'
	    WHEN SELISIH_BILLING_INTERCO_INVOICE_RECEIPT = 0 THEN '1/ Hari - H'
	    WHEN ABS(SELISIH_BILLING_INTERCO_INVOICE_RECEIPT) = 1 THEN '2/ 1 Hari'
	    WHEN ABS(SELISIH_BILLING_INTERCO_INVOICE_RECEIPT) = 2 THEN '3/ 2 Hari'
	    WHEN ABS(SELISIH_BILLING_INTERCO_INVOICE_RECEIPT) = 3 THEN '4/ 3 Hari'
	    WHEN ABS(SELISIH_BILLING_INTERCO_INVOICE_RECEIPT) BETWEEN 4 AND 7 THEN '5/ 4-7 Hari'
	    WHEN ABS(SELISIH_BILLING_INTERCO_INVOICE_RECEIPT) BETWEEN 8 AND 14 THEN '6/ 7-14 Hari'
	    WHEN ABS(SELISIH_BILLING_INTERCO_INVOICE_RECEIPT) BETWEEN 15 AND 30 THEN '7/ 14-30 Hari'
	    WHEN ABS(SELISIH_BILLING_INTERCO_INVOICE_RECEIPT) > 30 THEN '8/ >30 Hari'
    ELSE ''
	END AS AGING_BILLING_INTERCO_INVOICE_RECEIPT,
	-- SO CUSTOMER TO POD DI PRODUCTION ENTITY --
	CASE 
	    WHEN DOPROD.POD_INTERCO_DATE IS NOT NULL AND SO.SALES_ORDER_CREATED_DATE IS NOT NULL
	    THEN TO_VARCHAR(DATEDIFF(DAY,SO.SALES_ORDER_CREATED_DATE,DOPROD.POD_INTERCO_DATE))
	    WHEN DOPROD.POD_INTERCO_DATE IS NULL AND SO.SALES_ORDER_CREATED_DATE IS NOT NULL
	    THEN TO_VARCHAR(DATEDIFF(DAY,SO.SALES_ORDER_CREATED_DATE,CURRENT_DATE))
	    ELSE 'N/A'
	END AS SELISIH_SALES_ORDER_CUSTOMER_POD_CUSTOMER,
	CASE
	    WHEN SELISIH_SALES_ORDER_CUSTOMER_POD_CUSTOMER = 'N/A' THEN 'N/A'
	    WHEN SELISIH_SALES_ORDER_CUSTOMER_POD_CUSTOMER = 0 THEN '1/ Hari - H'
	    WHEN ABS(SELISIH_SALES_ORDER_CUSTOMER_POD_CUSTOMER) = 1 THEN '2/ 1 Hari'
	    WHEN ABS(SELISIH_SALES_ORDER_CUSTOMER_POD_CUSTOMER) = 2 THEN '3/ 2 Hari'
	    WHEN ABS(SELISIH_SALES_ORDER_CUSTOMER_POD_CUSTOMER) = 3 THEN '4/ 3 Hari'
	    WHEN ABS(SELISIH_SALES_ORDER_CUSTOMER_POD_CUSTOMER) BETWEEN 4 AND 7 THEN '5/ 4-7 Hari'
	    WHEN ABS(SELISIH_SALES_ORDER_CUSTOMER_POD_CUSTOMER) BETWEEN 8 AND 14 THEN '6/ 7-14 Hari'
	    WHEN ABS(SELISIH_SALES_ORDER_CUSTOMER_POD_CUSTOMER) BETWEEN 15 AND 30 THEN '7/ 14-30 Hari'
	    WHEN ABS(SELISIH_SALES_ORDER_CUSTOMER_POD_CUSTOMER) > 30 THEN '8/ >30 Hari'
    ELSE ''
	END AS AGING_SALES_ORDER_CUSTOMER_POD_CUSTOMER,
	-- SO CUSTOMER TO BILLING INTERCO DI PRODUCTION ENTITY --
	CASE 
	    WHEN BLPROD.BILLING_INTERCO_CREATED_DATE IS NOT NULL AND SO.SALES_ORDER_CREATED_DATE IS NOT NULL
	    THEN TO_VARCHAR(DATEDIFF(DAY,SO.SALES_ORDER_CREATED_DATE,BLPROD.BILLING_INTERCO_CREATED_DATE))
	    WHEN BLPROD.BILLING_INTERCO_CREATED_DATE IS NULL AND SO.SALES_ORDER_CREATED_DATE IS NOT NULL
	    THEN TO_VARCHAR(DATEDIFF(DAY,SO.SALES_ORDER_CREATED_DATE,CURRENT_DATE))
	    ELSE 'N/A'
	END AS SELISIH_SALES_ORDER_CUSTOMER_BILLING_INTERCO,
	CASE
	    WHEN SELISIH_SALES_ORDER_CUSTOMER_BILLING_INTERCO = 'N/A' THEN 'N/A'
	    WHEN SELISIH_SALES_ORDER_CUSTOMER_BILLING_INTERCO = 0 THEN '1/ Hari - H'
	    WHEN ABS(SELISIH_SALES_ORDER_CUSTOMER_BILLING_INTERCO) = 1 THEN '2/ 1 Hari'
	    WHEN ABS(SELISIH_SALES_ORDER_CUSTOMER_BILLING_INTERCO) = 2 THEN '3/ 2 Hari'
	    WHEN ABS(SELISIH_SALES_ORDER_CUSTOMER_BILLING_INTERCO) = 3 THEN '4/ 3 Hari'
	    WHEN ABS(SELISIH_SALES_ORDER_CUSTOMER_BILLING_INTERCO) BETWEEN 4 AND 7 THEN '5/ 4-7 Hari'
	    WHEN ABS(SELISIH_SALES_ORDER_CUSTOMER_BILLING_INTERCO) BETWEEN 8 AND 14 THEN '6/ 7-14 Hari'
	    WHEN ABS(SELISIH_SALES_ORDER_CUSTOMER_BILLING_INTERCO) BETWEEN 15 AND 30 THEN '7/ 14-30 Hari'
	    WHEN ABS(SELISIH_SALES_ORDER_CUSTOMER_BILLING_INTERCO) > 30 THEN '8/ >30 Hari'
    ELSE ''
	END AS AGING_SALES_ORDER_CUSTOMER_BILLING_INTERCO,
    -- BACKDATE --
    -- GI INTERCO BACKDATE --
	DF.GI_CONS_BACKDATE_FLAG,
	DF.GI_CONS_DIFF_DAYS,
	DF.AGING_GI_CONS_DIFF_DAYS,
	BL.BILLING_CUSTOMER_BACKDATE_FLAG,
	BL.BILLING_CUSTOMER_DIFF_DAYS,
	BL.AGING_BILLING_CUSTOMER_DIFF_DAYS,
	BLPROD.BILLING_INTERCO_BACKDATE_FLAG,
	BLPROD.BILLING_INTERCO_DIFF_DAYS,
	BLPROD.AGING_BILLING_INTERCO_DIFF_DAYS,
	TF.TFTG_BACKDATE_FLAG,
	TF.TFTG_DIFF_DAYS,
	TF.AGING_TFTG_DIFF_DAYS,
	BC.BILLING_CLEARING_CUSTOMER_BACKDATE_FLAG,
	BC.BILLING_CLEARING_CUSTOMER_DIFF_DAYS,
	BC.AGING_BILLING_CLEARING_CUSTOMER_DIFF_DAYS
    -- TF/TG CUSTOMER BACKDATE --
FROM HEADER H
LEFT JOIN HEADER_PRODUCTION HP
    ON HP.SALES_ORDER_EXTERNAL_DOCUMENT = H.SALES_ORDER_NUMBER
LEFT JOIN DOCUMENT_FLOW DF
    ON DF.SOURCE_SYSTEM = HP.SOURCE_SYSTEM
   AND DF.SALES_ORDER_NUMBER = HP.SALES_ORDER_NUMBER_INTERCO
LEFT JOIN SO_DETAIL_SELLING SO
    ON SO.SOURCE_SYSTEM = H.SOURCE_SYSTEM
   AND SO.SALES_ORDER_NUMBER = H.SALES_ORDER_NUMBER
LEFT JOIN SO_DETAIL_PRODUCTION SOPROD
    ON SOPROD.SOURCE_SYSTEM = HP.SOURCE_SYSTEM
   AND SOPROD.SALES_ORDER_NUMBER_INTERCO = HP.SALES_ORDER_NUMBER_INTERCO
LEFT JOIN DO_DETAIL_SELLING DO
    ON DO.SOURCE_SYSTEM = H.SOURCE_SYSTEM
   AND DO.DELIVERY_NUMBER = H.DELIVERY_NUMBER
LEFT JOIN DO_DETAIL_PRODUCTION DOPROD
	ON DOPROD.SOURCE_SYSTEM = HP.SOURCE_SYSTEM
	AND DOPROD.DELIVERY_NUMBER_INTERCO = HP.DELIVERY_NUMBER_INTERCO
LEFT JOIN GI_DETAIL_SELLING GI
    ON GI.SOURCE_SYSTEM = H.SOURCE_SYSTEM
   AND GI.DELIVERY_NUMBER = H.DELIVERY_NUMBER
LEFT JOIN GI_DETAIL_PRODUCTION GIPROD
    ON GIPROD.SOURCE_SYSTEM = HP.SOURCE_SYSTEM
   AND GIPROD.DELIVERY_NUMBER_INTERCO = HP.DELIVERY_NUMBER_INTERCO
LEFT JOIN BILLING_DETAIL_SELLING BL
    ON BL.SOURCE_SYSTEM  = H.SOURCE_SYSTEM
   AND BL.BILLING_NUMBER = H.BILLING_NUMBER
LEFT JOIN BILLING_DETAIL_PRODUCTION BLPROD
	ON BLPROD.SOURCE_SYSTEM = HP.SOURCE_SYSTEM
	AND BLPROD.BILLING_NUMBER_INTERCO = HP.BILLING_NUMBER_INTERCO 
LEFT JOIN INVOICE_RECEIPT IR
	ON IR.SOURCE_SYSTEM = H.SOURCE_SYSTEM
	AND IR.DOCUMENT_NUMBER = H.INVOICE_NUMBER
LEFT JOIN TFTG_DETAIL_SELLING TF
    ON TF.SOURCE_SYSTEM  = H.SOURCE_SYSTEM
   AND TF.BILLING_NUMBER = H.BILLING_NUMBER
LEFT JOIN BILLING_CLEARING_DETAIL_SELLING BC
    ON BC.SOURCE_SYSTEM  = H.SOURCE_SYSTEM
   AND BC.BILLING_NUMBER = H.BILLING_NUMBER
LEFT JOIN BILLING_CLEARING_DETAIL_PRODUCTION BCPROD
	ON BCPROD.SOURCE_SYSTEM = HP.SOURCE_SYSTEM
	AND BCPROD.BILLING_NUMBER_INTERCO = HP.BILLING_NUMBER_INTERCO 
)
SELECT * FROM AGGR WHERE SALES_ORDER_CREATED_DATE BETWEEN '2025-12-01' AND CURRENT_DATE
;
