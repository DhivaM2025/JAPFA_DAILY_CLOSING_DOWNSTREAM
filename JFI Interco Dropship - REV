CREATE TEMPORARY TABLE TEMP_HEADER AS
SELECT * FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_INTERCO_HEADER 
WHERE SALES_ORDER_NUMBER IN ('1207560670','1207560170','1207560566','1207560580','1207559384','1207543944','1207543014',    
'1705251294','1705250138','1705283936','1705283656','1705283659','1705283662','1705283464'); 

WITH HEADER AS (
    SELECT DISTINCT
        SOURCE_SYSTEM,
        SALES_ORDER_NUMBER,
        DELIVERY_NUMBER,
        BILLING_NUMBER,
        PO_NUM_REQ AS PO_NUMBER,
        GR_NUM     AS GR_NUMBER,
        INV_NUM    AS INVOICE_NUMBER
    FROM TEMP_HEADER 
    WHERE SALES_ORDER_NUMBER IN ('1207560670','1207560170','1207560566','1207560580','1207559384','1207543944','1207543014','1705251294','1705250138','1705283936','1705283656','1705283659','1705283662','1705283464')
	AND SALES_ORDER_EXTERNAL_DOCUMENT IS NULL
    ),
    HEADER_PRODUCTION AS (
    SELECT DISTINCT
        TH.SOURCE_SYSTEM,
        TH.SALES_ORDER_NUMBER AS SALES_ORDER_NUMBER_INTERCO,
        TH.DELIVERY_NUMBER AS DELIVERY_NUMBER_INTERCO,
        TH.BILLING_NUMBER AS BILLING_NUMBER_INTERCO,
        TH.SALES_ORDER_EXTERNAL_DOCUMENT
    FROM HEADER H
    LEFT JOIN TEMP_HEADER TH 
    	ON TH.SALES_ORDER_EXTERNAL_DOCUMENT = H.SALES_ORDER_NUMBER
    ), 
    DOCUMENT_FLOW AS (
    SELECT DISTINCT 
    	HP.SOURCE_SYSTEM,
    	HP.SALES_ORDER_NUMBER_INTERCO,
    	FLOW.SALES_ORDER_NUMBER,
    	FLOW.SO_CSGMNT_NUMBER, 
    	FLOW.DO_CSGMNT_NUMBER,
    	TRY_TO_DATE(SOC.SALES_ORDER_CREATED_DATE, 'YYYYMMDD') AS SALES_ORDER_CONS_CREATED_DATE,
		CASE 
    		WHEN SOC.SALES_ORDER_STATUS IS NULL OR SOC.SALES_ORDER_STATUS_DESC IS NULL THEN SOC.SALES_ORDER_STATUS_DESC 
    		ELSE SOC.SALES_ORDER_STATUS || '-' || SOC.SALES_ORDER_STATUS_DESC 
		END AS SALES_ORDER_CONS_STATUS,
    FROM HEADER_PRODUCTION HP
    LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_FLOW_ORDER_DOCUMENT_FLOW FLOW 
    	ON FLOW.SALES_ORDER_NUMBER  = HP.SALES_ORDER_NUMBER_INTERCO
    	AND FLOW.SALES_ORDER_TYPE = 'ZKS2'
	LEFT JOIN 
		(SELECT DISTINCT SOURCE_SYSTEM,SALES_ORDER_NUMBER,SALES_ORDER_CREATED_DATE,SALES_ORDER_STATUS,SALES_ORDER_STATUS_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER) SOC
		ON SOC.SALES_ORDER_NUMBER = FLOW.SO_CSGMNT_NUMBER
    ),
    SO_DETAIL_SELLING AS (
    SELECT DISTINCT 
        H.SOURCE_SYSTEM,
        H.SALES_ORDER_NUMBER,
        SO.COMPANY_CODE || '-' || CP.COMPANY_NAME AS COMPANY,
        SO.PLANT || '-' || CP1.PLANT_NAME AS PLANT,
        SO.CUSTOMER,
        CUST.CUSTOMER_NAME,
        CUST.REGION || '-' || DSR.REGION_DESCRIPTION AS REGION,
		CASE 
			WHEN DSR.REGION IN ('01', '02', '03', '04', '05', '28') THEN 'Pulau Jawa'
    		ELSE 'Luar Pulau Jawa'
		END AS REGION_GROUP,
        SO.CUSTOMER_SHIP_TO,
        CUSTSH.CUSTOMER_NAME AS CUSTOMER_SHIP_TO_NAME,
		CASE 
        	WHEN CUST1.SALES_OFFICE IS NULL OR CUST1.SALES_OFFICE = '' OR CUST1.SALES_OFFICE = '9001'
        	THEN SO.SALES_OFFICE || '-' || CUSTSO.SALES_OFFICE_DESC
        	ELSE CUST1.SALES_OFFICE || '-' || CUST1.SALES_OFFICE_DESC
    	END AS SALES_OFFICE,
    	CASE 
	        WHEN CUST1.SALES_OFFICE IS NULL OR CUST1.SALES_OFFICE = '' OR CUST1.SALES_OFFICE = '9001'
	        THEN LEFT(CUSTSO.SALES_OFFICE_DESC, 3)
	        WHEN CUST1.SALES_OFFICE_DESC IS NOT NULL AND CUST1.SALES_OFFICE_DESC <> ''
	        THEN LEFT(CUST1.SALES_OFFICE_DESC, 3)
	        ELSE CUST1.SALES_OFFICE
	    END AS SALES_OFFICE_GROUP,
        SO.DIVISION || '-' || SO.DIVISION_DESC AS DIVISION,
        SO.DISTRIBUTION_CHANNEL || '-' || SA.DISTRIBUTION_CHANNEL_DESC AS DISTRIBUTION_CHANNEL,
        CUST.POD_FLAG,
        SO.SALES_ORDER_TYPE || '-' || SO.SALES_ORDER_TYPE_DESC AS SALES_ORDER_TYPE,
		CASE 
    		WHEN SO.SALES_ORDER_STATUS IS NULL OR SO.SALES_ORDER_STATUS_DESC IS NULL THEN SO.SALES_ORDER_STATUS_DESC 
    		ELSE SO.SALES_ORDER_STATUS || '-' || SO.SALES_ORDER_STATUS_DESC 
		END AS SALES_ORDER_STATUS, 
        SO.SALES_ORDER_STATUS_REJECTION || '-' || SO.SALES_ORDER_STATUS_REJECTION_DESC AS SALES_ORDER_STATUS_REJECTION,
        SO.SALES_ORDER_REASON_REJECTION_DESC,
		CASE 
	    	WHEN LEFT(SALES_ORDER_REASON_REJECTION_DESC, 2) IN ('Z2','Z6','ZH','ZJ','ZK','ZM','ZQ') THEN 'Order Related'
	    	WHEN LEFT(SALES_ORDER_REASON_REJECTION_DESC, 2) IN ('Z3','ZI') THEN 'AR Related'
	    	WHEN LEFT(SALES_ORDER_REASON_REJECTION_DESC, 2) IN ('ZA','ZN') THEN 'Delivery Related'
	    	WHEN LEFT(SALES_ORDER_REASON_REJECTION_DESC, 2) IN ('Z1','Z4','ZO') THEN 'Stock Related'
	    	WHEN SALES_ORDER_REASON_REJECTION_DESC IS NULL OR SALES_ORDER_REASON_REJECTION_DESC = '' THEN 'N/A'
	    	ELSE 'N/A'
		END AS SALES_ORDER_REASON_REJECTION_GROUP,
		TRY_TO_DATE(SO.SALES_ORDER_CREATED_DATE, 'YYYYMMDD') AS SALES_ORDER_CREATED_DATE,
		TRY_TO_DATE(SO.SALES_ORDER_DATE, 'YYYYMMDD') AS SALES_ORDER_DATE,
        SO.CREATED_BY,
		CASE 
    		WHEN SO.SALES_ORDER_TYPE = 'ZB20' THEN 'Interco Automation MT'
        	WHEN SO.SALES_ORDER_TYPE = 'ZB01' AND SO.CUSTOMER = '2000174657' THEN 'Interco Automation FS'
        	ELSE 'Non Interco'
		END AS SALES_ORDER_CATEGORY,
    FROM HEADER H
    INNER JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER SO 
        ON SO.SOURCE_SYSTEM = H.SOURCE_SYSTEM
       AND SO.SALES_ORDER_NUMBER = H.SALES_ORDER_NUMBER
	LEFT JOIN (SELECT
        SOURCE_SYSTEM, CUSTOMER, CUSTOMER_NAME, REGION, POD_FLAG FROM (
        SELECT
		    SOURCE_SYSTEM,
		    CUSTOMER,
		    CUSTOMER_NAME,
		    REGION,
		    POD_FLAG,
		    ROW_NUMBER() OVER (
		        PARTITION BY SOURCE_SYSTEM, CUSTOMER
		        ORDER BY SALES_OFFICE ASC
		    ) AS RN
		FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER
    	)
    	WHERE RN = 1
		) CUST
    	ON CUST.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
    	AND CUST.CUSTOMER = SO.CUSTOMER 
	LEFT JOIN (SELECT
        SOURCE_SYSTEM, CUSTOMER, CUSTOMER_NAME FROM (
        SELECT
            SOURCE_SYSTEM, CUSTOMER, CUSTOMER_NAME,
            ROW_NUMBER() OVER (
                PARTITION BY SOURCE_SYSTEM, CUSTOMER
                ORDER BY SALES_OFFICE ASC
            ) AS RN
        FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER
    	)
    	WHERE RN = 1
		) CUSTSH
    	ON CUSTSH.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
    	AND CUSTSH.CUSTOMER = SO.CUSTOMER_SHIP_TO
	LEFT JOIN (SELECT
        SOURCE_SYSTEM, COMPANY_CODE, COMPANY_NAME FROM (
        SELECT
            SOURCE_SYSTEM, COMPANY_CODE, COMPANY_NAME,
            ROW_NUMBER() OVER (
                PARTITION BY SOURCE_SYSTEM, COMPANY_CODE
                ORDER BY PLANT ASC
            ) AS RN
        FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT
    	)
    	WHERE RN = 1
		) CP
    	ON CP.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
    	AND CP.COMPANY_CODE = SO.COMPANY_CODE
	LEFT JOIN ( SELECT
        SOURCE_SYSTEM, PLANT, PLANT_NAME FROM (
        SELECT
            SOURCE_SYSTEM, PLANT, PLANT_NAME,
            ROW_NUMBER() OVER (
                PARTITION BY SOURCE_SYSTEM, PLANT
                ORDER BY STORAGE_LOCATION ASC
            ) AS RN
        FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT
    	)
    	WHERE RN = 1
		) CP1
		ON CP1.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
		AND CP1.PLANT = SO.PLANT
		LEFT JOIN (SELECT SOURCE_SYSTEM, CUSTOMER, SALES_OFFICE, SALES_OFFICE_DESC, SALES_DIVISION 
           FROM (SELECT SOURCE_SYSTEM, CUSTOMER, SALES_OFFICE, SALES_OFFICE_DESC, SALES_DIVISION,
                        ROW_NUMBER() OVER (PARTITION BY SOURCE_SYSTEM, CUSTOMER 
                                           ORDER BY CASE WHEN SALES_OFFICE <> '9001' THEN 0 ELSE 1 END, SALES_OFFICE) AS RN
                 FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER
                 WHERE BLOCK_FOR_SALES = 'Non block' AND DELETION_FOR_SALES = 'Non delete')
           QUALIFY RN = 1) CUST1
    	ON CUST1.SOURCE_SYSTEM = SO.SOURCE_SYSTEM 
    	AND CUST1.CUSTOMER = SO.CUSTOMER
		LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, SALES_OFFICE, SALES_OFFICE_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER
           			WHERE BLOCK_FOR_SALES = 'Non block' AND DELETION_FOR_SALES = 'Non delete') CUSTSO
    	ON CUSTSO.SOURCE_SYSTEM = SO.SOURCE_SYSTEM 
    	AND CUSTSO.SALES_OFFICE = SO.SALES_OFFICE
    	LEFT JOIN (SELECT
        SOURCE_SYSTEM, DISTRIBUTION_CHANNEL, DISTRIBUTION_CHANNEL_DESC FROM (
        SELECT
            SOURCE_SYSTEM, DISTRIBUTION_CHANNEL, DISTRIBUTION_CHANNEL_DESC,
            ROW_NUMBER() OVER (
                PARTITION BY SOURCE_SYSTEM, DISTRIBUTION_CHANNEL
                ORDER BY SALES_OFFICE ASC
            ) AS RN
        FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_AREA
    	)
    	WHERE RN = 1
		) SA
	    ON SA.SOURCE_SYSTEM = SO.SOURCE_SYSTEM 
	    AND SA.DISTRIBUTION_CHANNEL = SO.DISTRIBUTION_CHANNEL
	    LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, REGION, REGION_DESCRIPTION FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_REGION) DSR
	    ON DSR.SOURCE_SYSTEM = CUST.SOURCE_SYSTEM
	    AND DSR.REGION = CUST.REGION
),
SO_DETAIL_PRODUCTION AS (
	SELECT DISTINCT 
		HP.SOURCE_SYSTEM,
        HP.SALES_ORDER_NUMBER_INTERCO,
        SO.SALES_ORDER_NUMBER,
		SO.COMPANY_CODE AS COMPANY_INTERCO, 
		SO.PLANT AS PLANT_INTERCO,
		SO.SALES_OFFICE AS SALES_OFFICE_INTERCO,
		SO.DISTRIBUTION_CHANNEL AS DISTRIBUTION_CHANNEL_INTERCO,
	FROM HEADER_PRODUCTION HP
	INNER JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER SO 
        ON SO.SOURCE_SYSTEM = HP.SOURCE_SYSTEM
       AND SO.SALES_ORDER_NUMBER = HP.SALES_ORDER_NUMBER_INTERCO
),
DO_DETAIL_SELLING AS (
    SELECT DISTINCT 
        H.SOURCE_SYSTEM,
        H.DELIVERY_NUMBER,
        SD.REFERENCE_SALES_ORDER_NUMBER,
		TRY_TO_DATE(SD.DELIVERY_CREATED_DATE, 'YYYYMMDD') AS DELIVERY_CREATED_DATE,
		TRY_TO_DATE(SD.DELIVERY_ACTUAL_DATE, 'YYYYMMDD') AS DELIVERY_ACTUAL_DATE,
        TRY_TO_DATE(SD.DELIVERY_POSTING_DATE, 'YYYYMMDD') AS POD_DATE,
        SD.DELIVERY_TYPE || '-' || SD.DELIVERY_TYPE_DESC AS DELIVERY_TYPE,
		CASE 
  			WHEN SD.DELIVERY_STATUS = 'Not yet processed' THEN 'A-Not yet processed'
    		WHEN SD.DELIVERY_STATUS = 'Partially processed' THEN 'B-Partially processed'
    		WHEN SD.DELIVERY_STATUS = 'Completely processed' THEN 'C-Completely processed'
    		ELSE SD.DELIVERY_STATUS
		END AS DELIVERY_STATUS,
		CASE 
	  		WHEN SD.DELIVERY_POD_STATUS = 'Not yet processed' THEN 'A-Not yet processed'
	    	WHEN SD.DELIVERY_POD_STATUS = 'Partially processed' THEN 'B-Partially processed'
	    	WHEN SD.DELIVERY_POD_STATUS = 'Completely processed' THEN 'C-Completely processed'
	    	ELSE SD.DELIVERY_POD_STATUS
		END AS DELIVERY_POD_STATUS,
        SD.DELIVERY_NOTE AS REASON_POD,
		CASE
			WHEN SD.DELIVERY_NOTE IS NULL OR SD.DELIVERY_NOTE = '' THEN FALSE
			ELSE TRUE
		END AS REASON_POD_FLAG,
		CASE 
		    WHEN SD.DELIVERY_NOTE = 'FREEZER RUSAK' THEN 'Customer Related'
		    WHEN SD.DELIVERY_NOTE = 'OUTLET TDK BISA INPUT SKU' THEN 'Customer Related'
		    WHEN SD.DELIVERY_NOTE = 'OVER STOCK' THEN 'Customer Related'
		    WHEN SD.DELIVERY_NOTE = 'STOCK FISIK â‰  SISTEM' THEN 'Customer Related'
		    WHEN SD.DELIVERY_NOTE = 'TOKO TIDAK ORDER' THEN 'Order Related'
		    WHEN SD.DELIVERY_NOTE = 'TOKO TIDAK PUNYA UANG' THEN 'Customer Related'
		    WHEN SD.DELIVERY_NOTE = 'TOKO TUTUP' THEN 'Customer Related'
		    WHEN SD.DELIVERY_NOTE = 'ALAMAT TIDAK SESUAI' THEN 'Delivery Related'
		    WHEN SD.DELIVERY_NOTE = 'BARANG/KEMASAN RUSAK' THEN 'Delivery Related'
		    WHEN SD.DELIVERY_NOTE = 'RETUR PRODUK TDK DIAMBIL' THEN 'Delivery Related'
		    WHEN SD.DELIVERY_NOTE = 'RETUR SF CONSIGMENT' THEN 'Delivery Related'
		    WHEN SD.DELIVERY_NOTE = 'SALAH LOADING' THEN 'Delivery Related'
		    WHEN SD.DELIVERY_NOTE = 'SALAH KIRIM TOKO' THEN 'Delivery Related'
		    WHEN SD.DELIVERY_NOTE = 'SPACE TIDAK CUKUP' THEN 'Customer Related'
		    WHEN SD.DELIVERY_NOTE = 'SUHU MOBIL TIDAK SESUAI' THEN 'Delivery Related'
		    WHEN SD.DELIVERY_NOTE = 'TIDAK TERKIRIM (TPL)' THEN 'Delivery Related'
		    WHEN SD.DELIVERY_NOTE = 'WAKTU DELIVERY TDK CUKUP' THEN 'Delivery Related'
		    WHEN SD.DELIVERY_NOTE = 'DOUBLE PO' THEN 'Order Related'
		    WHEN SD.DELIVERY_NOTE = 'SALAH INPUT DI ANDROID' THEN 'Order Related'
		    WHEN SD.DELIVERY_NOTE = 'SALAH INPUT SO/DO' THEN 'Order Related'
		    WHEN SD.DELIVERY_NOTE = 'TIDAK SESUAI ORDER/PO' THEN 'Order Related'
		    WHEN SD.DELIVERY_NOTE = 'BARANG SUSUT' THEN 'Stock Related'
		    WHEN SD.DELIVERY_NOTE = 'ISI/PRODUK TIDAK SESUAI' THEN 'Stock Related'
		    WHEN SD.DELIVERY_NOTE = 'PRODUK MENDEKATI EXPIRED' THEN 'Stock Related'
		    WHEN SD.DELIVERY_NOTE IS NULL OR DELIVERY_NOTE = '' THEN 'N/A'
		    ELSE 'N/A'
		END AS REASON_POD_GROUP,
    FROM HEADER H
    LEFT JOIN F_SALES_DELIVERY SD 
        ON SD.SOURCE_SYSTEM = H.SOURCE_SYSTEM
       AND SD.DELIVERY_NUMBER = H.DELIVERY_NUMBER
),
GI_DETAIL_SELLING AS (
    SELECT DISTINCT 
        H.SOURCE_SYSTEM,
        SCM."REFERENCE"                AS DELIVERY_NUMBER,
        SCM.MATERIAL_DOCUMENT_NUMBER   AS GI_NUMBER,
        SCM.FISCAL_YEAR,
		TRY_TO_DATE(SCM.ENTRY_DATE, 'YYYYMMDD') AS GI_ENTRY_DATE,
		TRY_TO_DATE (SCM.POSTING_DATE, 'YYYYMMDD') AS GI_POSTING_DATE,
    FROM HEADER H 
    LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SCM_STOCK_TRANSACTION_SAP SCM
        ON SCM.SOURCE_SYSTEM = H.SOURCE_SYSTEM
       AND SCM."REFERENCE" = H.DELIVERY_NUMBER
       AND SCM.FISCAL_YEAR = '2025'
),
BILLING_DETAIL_SELLING AS (
SELECT 
        H.SOURCE_SYSTEM,
        SB.REFERENCE_SALES_ORDER_NUMBER,
        SB.BILLING_TYPE,
        SB.BILLING_TYPE_DESC,
		CASE 
	    	WHEN SB.POSTING_STATUS IS NULL OR SB.POSTING_STATUS_DESCRIPTION IS NULL THEN SB.POSTING_STATUS_DESCRIPTION 
	    	ELSE SB.POSTING_STATUS || '-' || SB.POSTING_STATUS_DESCRIPTION 
	  	END AS BILLING_STATUS,
        H.BILLING_NUMBER,
		TRY_TO_DATE(SB.BILLING_CREATED_DATE, 'YYYYMMDD') AS BILLING_CREATED_DATE,
		TRY_TO_DATE(SB.BILLING_DATE, 'YYYYMMDD') AS BILLING_DATE,
		CASE 
    		WHEN SB.TERM_OF_PAYMENT_DESC IS NULL OR SB.TERM_OF_PAYMENT = '' THEN SB.TERM_OF_PAYMENT
    		ELSE SB.TERM_OF_PAYMENT || '-' || SB.TERM_OF_PAYMENT_DESC
		END AS TERM_OF_PAYMENT,
        SUM(BILLING_NET_AMOUNT) AS TOTAL_BILLING_AMOUNT,
		CASE 
    		WHEN TOTAL_BILLING_AMOUNT = 0 THEN TRUE 
    		ELSE FALSE 
		END AS AMOUNT_ZERO_FLAG,
    FROM HEADER H 
    LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING SB
    ON SB.SOURCE_SYSTEM = H.SOURCE_SYSTEM 
    AND SB.BILLING_NUMBER = H.BILLING_NUMBER 
    WHERE SB.BILLING_TYPE NOT IN ('ZB50','ZB99')
    GROUP BY H.SOURCE_SYSTEM,REFERENCE_SALES_ORDER_NUMBER,BILLING_TYPE,BILLING_TYPE_DESC,POSTING_STATUS,POSTING_STATUS_DESCRIPTION,
             H.BILLING_NUMBER,BILLING_CREATED_DATE,BILLING_DATE,TERM_OF_PAYMENT,TERM_OF_PAYMENT_DESC
),
TFTG_DETAIL_SELLING AS (
SELECT 
		H.SOURCE_SYSTEM,
		H.BILLING_NUMBER,
		TF.TTF_NUMBER,
		TF.TTF_DOC_TYPE,
		TRY_TO_DATE(TF.TTF_CREATED_DATE, 'YYYYMMDD') AS TFTG_CREATED_DATE,
		TRY_TO_DATE(TF.TTF_DOC_DATE, 'YYYYMMDD') AS TFTG_DATE
	FROM HEADER H
	LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_TTF TF
    ON TF.SOURCE_SYSTEM = H.SOURCE_SYSTEM
    AND TF.BILLING_NUMBER = H.BILLING_NUMBER
),
BILLING_CLEARING_DETAIL_SELLING AS (
SELECT 
		H.SOURCE_SYSTEM,
		H.BILLING_NUMBER,
		SBC.BILLING_CLEARING_DOC,
		TRY_TO_DATE(SBC.BILLING_CLEAR_CREATED_DATE, 'YYYYMMDD') AS BILLING_CLEAR_CREATED_DATE,
		TRY_TO_DATE(SBC.BILLING_CLEAR_DATE, 'YYYYMMDD') AS BILLING_CLEAR_DATE,
	FROM HEADER H
	LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_CLEARING SBC
    ON SBC.SOURCE_SYSTEM = H.SOURCE_SYSTEM
    AND SBC.BILLING_NUMBER = H.BILLING_NUMBER
)
SELECT
    H.SOURCE_SYSTEM,
    SO.COMPANY,
    SO.PLANT,
    SO.CUSTOMER,
    SO.CUSTOMER_NAME,
    SO.CUSTOMER_SHIP_TO,
    SO.CUSTOMER_SHIP_TO_NAME,
    SO.REGION,
    SO.REGION_GROUP,
    SO.POD_FLAG,
    SO.SALES_OFFICE,
    SO.SALES_OFFICE_GROUP,
    SO.DIVISION,
    SO.DISTRIBUTION_CHANNEL,
    BL.TERM_OF_PAYMENT,
    SO.SALES_ORDER_CATEGORY,
    SO.SALES_ORDER_TYPE,
    DO.DELIVERY_TYPE,
    BL.BILLING_TYPE,
    BL.BILLING_TYPE_DESC,
    TF.TTF_DOC_TYPE,
    SO.SALES_ORDER_STATUS,
    SO.SALES_ORDER_STATUS_REJECTION,
    SO.SALES_ORDER_REASON_REJECTION_DESC,
    SO.SALES_ORDER_REASON_REJECTION_GROUP,
    DO.DELIVERY_STATUS,
    DO.DELIVERY_POD_STATUS,
    DO.REASON_POD,
    DO.REASON_POD_FLAG,
    DO.REASON_POD_GROUP,
    BL.BILLING_STATUS,
	BL.AMOUNT_ZERO_FLAG,
	SO.SALES_ORDER_CREATED_DATE,
	SO.SALES_ORDER_DATE,
	DO.DELIVERY_CREATED_DATE,
	DO.DELIVERY_ACTUAL_DATE,
    DO.POD_DATE,
    GI.GI_ENTRY_DATE,
    GI.GI_POSTING_DATE,
    BL.BILLING_CREATED_DATE,
    BL.BILLING_DATE,
    TF.TFTG_CREATED_DATE,
    TF.TFTG_DATE, 
    BC.BILLING_CLEAR_CREATED_DATE,
    BC.BILLING_CLEAR_DATE,
    SO.CREATED_BY,
    -- DOC NUMBER --
    H.SALES_ORDER_NUMBER,
    H.DELIVERY_NUMBER,
    GI.GI_NUMBER,
    H.BILLING_NUMBER,
    TF.TTF_NUMBER,
    BC.BILLING_CLEARING_DOC,
    H.PO_NUMBER,
    H.GR_NUMBER,
    H.INVOICE_NUMBER,
    -- PRODUCTION ENTITY --
	SOPROD.COMPANY_INTERCO,
    SOPROD.PLANT_INTERCO,
    SOPROD.SALES_OFFICE_INTERCO,
    SOPROD.DISTRIBUTION_CHANNEL_INTERCO,
	HP.SALES_ORDER_NUMBER_INTERCO,
    HP.DELIVERY_NUMBER_INTERCO,
    DF.SO_CSGMNT_NUMBER,
    DF.DO_CSGMNT_NUMBER,
    -- PRODUCTION DATE --
    DF.SALES_ORDER_CONS_CREATED_DATE,
    DF.SALES_ORDER_CONS_STATUS,
    HP.BILLING_NUMBER_INTERCO,
FROM HEADER H
LEFT JOIN HEADER_PRODUCTION HP
    ON HP.SALES_ORDER_EXTERNAL_DOCUMENT = H.SALES_ORDER_NUMBER
LEFT JOIN DOCUMENT_FLOW DF
    ON DF.SOURCE_SYSTEM = HP.SOURCE_SYSTEM
   AND DF.SALES_ORDER_NUMBER = HP.SALES_ORDER_NUMBER_INTERCO
LEFT JOIN SO_DETAIL_SELLING SO
    ON SO.SOURCE_SYSTEM = H.SOURCE_SYSTEM
   AND SO.SALES_ORDER_NUMBER = H.SALES_ORDER_NUMBER
LEFT JOIN SO_DETAIL_PRODUCTION SOPROD
    ON SOPROD.SOURCE_SYSTEM = HP.SOURCE_SYSTEM
   AND SOPROD.SALES_ORDER_NUMBER_INTERCO = HP.SALES_ORDER_NUMBER_INTERCO
LEFT JOIN DO_DETAIL_SELLING DO
    ON DO.SOURCE_SYSTEM = H.SOURCE_SYSTEM
   AND DO.DELIVERY_NUMBER = H.DELIVERY_NUMBER
LEFT JOIN GI_DETAIL_SELLING GI
    ON GI.SOURCE_SYSTEM = H.SOURCE_SYSTEM
   AND GI.DELIVERY_NUMBER = H.DELIVERY_NUMBER
LEFT JOIN BILLING_DETAIL_SELLING BL
    ON BL.SOURCE_SYSTEM  = H.SOURCE_SYSTEM
   AND BL.BILLING_NUMBER = H.BILLING_NUMBER
LEFT JOIN TFTG_DETAIL_SELLING TF
    ON TF.SOURCE_SYSTEM  = H.SOURCE_SYSTEM
   AND TF.BILLING_NUMBER = H.BILLING_NUMBER
LEFT JOIN BILLING_CLEARING_DETAIL_SELLING BC
    ON BC.SOURCE_SYSTEM  = H.SOURCE_SYSTEM
   AND BC.BILLING_NUMBER = H.BILLING_NUMBER
;
