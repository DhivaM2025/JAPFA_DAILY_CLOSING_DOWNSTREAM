-- TEMPORARY TABLE F_SALES_INTERCO_HEADER --
CREATE TEMPORARY TABLE TEMP_HEADER AS
SELECT * FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_INTERCO_HEADER 
WHERE SALES_ORDER_NUMBER IN ('1207560670','1207560170','1207560566','1207560580','1207559384','1207543944','1207543014'); 

-- MAIN QUERY --
WITH HEADER AS (
    SELECT 
        SOURCE_SYSTEM,
        SALES_ORDER_NUMBER,
        DELIVERY_NUMBER,
        BILLING_NUMBER,
        PO_NUM_REQ AS PO_NUMBER,
        GR_NUM     AS GR_NUMBER,
        INV_NUM    AS INVOICE_NUMBER
    FROM TEMP_HEADER 
    WHERE SALES_ORDER_NUMBER IN (
        '1207560670','1207560170','1207560566',
        '1207560580','1207559384','1207543944','1207543014'
    )
),
SO_DETAIL_SELLING AS (
    SELECT DISTINCT 
        H.SOURCE_SYSTEM,
        H.SALES_ORDER_NUMBER,
        SO.COMPANY_CODE || '-' || CP.COMPANY_NAME AS COMPANY,
        SO.PLANT || '-' || CP1.PLANT_NAME AS PLANT,
        SO.CUSTOMER,
        CUST.CUSTOMER_NAME,
        CUST.REGION,
        SO.CUSTOMER_SHIP_TO,
        CUSTSH.CUSTOMER_NAME AS CUSTOMER_SHIP_TO_NAME,
        SO.SALES_OFFICE,
        SO.DIVISION,
        SO.DIVISION_DESC,
        SO.DISTRIBUTION_CHANNEL,
        SO.SALES_ORDER_TYPE,
        SO.SALES_ORDER_TYPE_DESC,
        SO.SALES_ORDER_STATUS,
        SO.SALES_ORDER_STATUS_DESC,
        SO.SALES_ORDER_STATUS_REJECTION,
        SO.SALES_ORDER_STATUS_REJECTION_DESC,
        SO.SALES_ORDER_REASON_REJECTION_DESC,
        SO.CREATED_BY
    FROM HEADER H
    INNER JOIN F_SALES_SALES_ORDER SO 
        ON SO.SOURCE_SYSTEM = H.SOURCE_SYSTEM
       AND SO.SALES_ORDER_NUMBER = H.SALES_ORDER_NUMBER
	LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, CUSTOMER, CUSTOMER_NAME, REGION FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER) CUST
    	ON CUST.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
    	AND CUST.CUSTOMER = SO.CUSTOMER 
	LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, CUSTOMER, CUSTOMER_NAME FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER) CUSTSH
    	ON CUSTSH.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
    	AND CUSTSH.CUSTOMER = SO.CUSTOMER_SHIP_TO
	LEFT JOIN (SELECT
        SOURCE_SYSTEM, COMPANY_CODE, COMPANY_NAME FROM (
        SELECT
            SOURCE_SYSTEM, COMPANY_CODE, COMPANY_NAME,
            ROW_NUMBER() OVER (
                PARTITION BY SOURCE_SYSTEM, COMPANY_CODE
                ORDER BY PLANT ASC
            ) AS RN
        FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT
    	)
    	WHERE RN = 1
		) CP
    	ON CP.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
    	AND CP.COMPANY_CODE = SO.COMPANY_CODE
	LEFT JOIN ( SELECT
        SOURCE_SYSTEM, PLANT, PLANT_NAME FROM (
        SELECT
            SOURCE_SYSTEM, PLANT, PLANT_NAME,
            ROW_NUMBER() OVER (
                PARTITION BY SOURCE_SYSTEM, PLANT
                ORDER BY STORAGE_LOCATION ASC
            ) AS RN
        FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT
    	)
    	WHERE RN = 1
		) CP1
		ON CP1.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
		AND CP1.PLANT = SO.PLANT
),
DO_DETAIL_SELLING AS (
    SELECT DISTINCT 
        H.SOURCE_SYSTEM,
        H.DELIVERY_NUMBER,
        SD.REFERENCE_SALES_ORDER_NUMBER,
        SD.DELIVERY_POSTING_DATE,
        SD.DELIVERY_TYPE,
        SD.DELIVERY_TYPE_DESC,
        SD.DELIVERY_STATUS,
        SD.DELIVERY_POD_STATUS,
        SD.DELIVERY_NOTE
    FROM HEADER H
    LEFT JOIN F_SALES_DELIVERY SD 
        ON SD.SOURCE_SYSTEM = H.SOURCE_SYSTEM
       AND SD.DELIVERY_NUMBER = H.DELIVERY_NUMBER
),
GI_DETAIL_SELLING AS (
    SELECT DISTINCT 
        H.SOURCE_SYSTEM,
        SCM."REFERENCE"                AS DELIVERY_NUMBER,
        SCM.MATERIAL_DOCUMENT_NUMBER   AS GI_NUMBER,
        SCM.FISCAL_YEAR
    FROM HEADER H 
    LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SCM_STOCK_TRANSACTION_SAP SCM
        ON SCM.SOURCE_SYSTEM = H.SOURCE_SYSTEM
       AND SCM."REFERENCE" = H.DELIVERY_NUMBER
       AND SCM.FISCAL_YEAR = '2025'
),
BILLING_DETAIL_SELLING AS (
SELECT 
        H.SOURCE_SYSTEM,REFERENCE_SALES_ORDER_NUMBER,BILLING_TYPE,BILLING_TYPE_DESC,
        POSTING_STATUS,POSTING_STATUS_DESCRIPTION,H.BILLING_NUMBER,BILLING_CREATED_DATE,
        BILLING_DATE,TERM_OF_PAYMENT,TERM_OF_PAYMENT_DESC,SUM(BILLING_NET_AMOUNT) AS TOTAL_BILLING_AMOUNT
    FROM HEADER H 
    LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING SB
    ON SB.SOURCE_SYSTEM = H.SOURCE_SYSTEM 
    AND SB.BILLING_NUMBER = H.BILLING_NUMBER 
    WHERE SB.BILLING_TYPE NOT IN ('ZB50','ZB99')
    GROUP BY H.SOURCE_SYSTEM,REFERENCE_SALES_ORDER_NUMBER,BILLING_TYPE,BILLING_TYPE_DESC,POSTING_STATUS,POSTING_STATUS_DESCRIPTION,
             H.BILLING_NUMBER,BILLING_CREATED_DATE,BILLING_DATE,TERM_OF_PAYMENT,TERM_OF_PAYMENT_DESC
),
TFTG_DETAIL_SELLING AS (
SELECT 
		H.SOURCE_SYSTEM,H.BILLING_NUMBER,TTF_NUMBER,TTF_DOC_TYPE 
	FROM HEADER H
	LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_TTF TF
    ON TF.SOURCE_SYSTEM = H.SOURCE_SYSTEM
    AND TF.BILLING_NUMBER = H.BILLING_NUMBER
),
BILLING_CLEARING_DETAIL_SELLING AS (
SELECT 
		H.SOURCE_SYSTEM,H.BILLING_NUMBER,BILLING_CLEARING_DOC 
	FROM HEADER H
	LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_CLEARING SBC
    ON SBC.SOURCE_SYSTEM = H.SOURCE_SYSTEM
    AND SBC.BILLING_NUMBER = H.BILLING_NUMBER
)
SELECT
    H.SOURCE_SYSTEM,
    H.SALES_ORDER_NUMBER,
    H.DELIVERY_NUMBER,
    H.BILLING_NUMBER,
    H.PO_NUMBER,
    H.GR_NUMBER,
    H.INVOICE_NUMBER,
    SO.COMPANY,
    SO.PLANT,
    SO.CUSTOMER,
    SO.CUSTOMER_NAME,
    SO.CUSTOMER_SHIP_TO,
    SO.CUSTOMER_SHIP_TO_NAME,
    SO.SALES_OFFICE,
    SO.DIVISION,
    SO.DIVISION_DESC,
    SO.DISTRIBUTION_CHANNEL,
    SO.SALES_ORDER_TYPE,
    SO.SALES_ORDER_TYPE_DESC,
    SO.SALES_ORDER_STATUS,
    SO.SALES_ORDER_STATUS_DESC,
    SO.SALES_ORDER_STATUS_REJECTION,
    SO.SALES_ORDER_STATUS_REJECTION_DESC,
    SO.SALES_ORDER_REASON_REJECTION_DESC,
    SO.CREATED_BY,
    DO.REFERENCE_SALES_ORDER_NUMBER,
    DO.DELIVERY_POSTING_DATE,
    DO.DELIVERY_TYPE,
    DO.DELIVERY_TYPE_DESC,
    DO.DELIVERY_STATUS,
    DO.DELIVERY_POD_STATUS,
    DO.DELIVERY_NOTE,
    GI.GI_NUMBER,
    GI.FISCAL_YEAR AS GI_FISCAL_YEAR,
    BL.BILLING_TYPE,
    BL.BILLING_TYPE_DESC,
    BL.POSTING_STATUS,
    BL.POSTING_STATUS_DESCRIPTION,
    BL.BILLING_CREATED_DATE,
    BL.BILLING_DATE,
    BL.TERM_OF_PAYMENT,
    BL.TERM_OF_PAYMENT_DESC,
    BL.TOTAL_BILLING_AMOUNT,
	CASE 
    	WHEN BL.TOTAL_BILLING_AMOUNT = 0 THEN TRUE 
    	ELSE FALSE 
	END AS AMOUNT_ZERO_FLAG,
    TF.TTF_NUMBER,
    TF.TTF_DOC_TYPE,
    BC.BILLING_CLEARING_DOC
FROM HEADER H
LEFT JOIN SO_DETAIL_SELLING SO
    ON SO.SOURCE_SYSTEM = H.SOURCE_SYSTEM
   AND SO.SALES_ORDER_NUMBER = H.SALES_ORDER_NUMBER
LEFT JOIN DO_DETAIL_SELLING DO
    ON DO.SOURCE_SYSTEM = H.SOURCE_SYSTEM
   AND DO.DELIVERY_NUMBER = H.DELIVERY_NUMBER
LEFT JOIN GI_DETAIL_SELLING GI
    ON GI.SOURCE_SYSTEM = H.SOURCE_SYSTEM
   AND GI.DELIVERY_NUMBER = H.DELIVERY_NUMBER
LEFT JOIN BILLING_DETAIL_SELLING BL
    ON BL.SOURCE_SYSTEM  = H.SOURCE_SYSTEM
   AND BL.BILLING_NUMBER = H.BILLING_NUMBER
LEFT JOIN TFTG_DETAIL_SELLING TF
    ON TF.SOURCE_SYSTEM  = H.SOURCE_SYSTEM
   AND TF.BILLING_NUMBER = H.BILLING_NUMBER
LEFT JOIN BILLING_CLEARING_DETAIL_SELLING BC
    ON BC.SOURCE_SYSTEM  = H.SOURCE_SYSTEM
   AND BC.BILLING_NUMBER = H.BILLING_NUMBER
;
