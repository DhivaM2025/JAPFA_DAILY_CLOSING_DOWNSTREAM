-- CATATAN : 
-- 1/ Block all code lalu click Ctrl + Enter untuk run query di DBeaver
-- 2/ Ganti period pada row 92 sesuai kebutuhan >> TRY_TO_DATE(SSO.SALES_ORDER_DATE, 'YYYYMMDD') BETWEEN '2025-06-01' AND CURRENT_DATE

-- DASHBOARD #1 : SGF SALES FLOW QTY

SELECT 
	Y.SOURCE_SYSTEM,
	Y.COMPANY_CODE || '-' || CP.COMPANY_NAME AS COMPANY, 
	TRY_TO_DATE (Y.SALES_ORDER_DATE, 'YYYYMMDD') AS SO_DATE,
	Y.CUSTOMER || '-' || CUST.CUSTOMER_NAME AS CUSTOMER, 
	/*CUST.SALES_OFFICE || '-' || CUST.SALES_OFFICE_DESC AS SALES_OFFICE, */
	/*LEFT (CUST.SALES_OFFICE_DESC, 3) AS SALES_OFFICE_LOKASI,*/
	Y.PLANT || '-' || CP.PLANT_NAME AS PLANT, 
	CUST.DISTRIBUTION_CHANNEL || '-' || SA.DISTRIBUTION_CHANNEL_DESC AS DISTRIBUTION_CHANNEL, 
	Y.DIVISION || '-' || Y.DIVISION_DESC AS DIVISION,  
	X.* 
FROM
((SELECT 'SO' AS TRX, 
	SALES_ORDER_TYPE || '-' || SALES_ORDER_TYPE_DESC AS TYPE,
	SALES_ORDER_STATUS || '-' || SALES_ORDER_STATUS_DESC AS STATUS,
	SALES_ORDER_STATUS_REJECTION || '-' || SALES_ORDER_STATUS_REJECTION_DESC AS STATUS_REJECTION,
	SALES_ORDER_NUMBER, 
	NULL AS DELIVERY_NUMBER, 
	NULL AS GI_NUMBER,
	NULL AS BILLING_NUMBER, 
	NULL AS TTF_NUMBER,
	NULL AS BILLING_CLEARING_NUMBER,
	SALES_ORDER_CREATED_DATE AS CREATED_DATE, 
	SUM(SALES_ORDER_NEGATIVE_FLAG * SALES_ORDER_QUANTITY_IN_KG) AS SO_QTY, 
	SUM (SALES_ORDER_NEGATIVE_FLAG * SALES_ORDER_NET_AMOUNT) AS SO_AMOUNT,
	0 AS DO_QTY, 
	0 AS GI_QTY,
	0 AS POD_QTY, 
	0 AS BILL_QTY,
	0 AS BILL_AMOUNT,
	0 AS TFTG_AMOUNT
FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER
WHERE SALES_ORDER_NUMBER = '1207365456'
GROUP BY ALL)
UNION ALL
(SELECT 'DO' AS TRX, 
	DELIVERY_TYPE || '-' || DELIVERY_TYPE_DESC AS TYPE,
	CASE 
    	WHEN SO.SALES_ORDER_STATUS_DELIVERY IS NULL OR SO.SALES_ORDER_STATUS_DELIVERY_DESC IS NULL
    	THEN SO.SALES_ORDER_STATUS_DELIVERY_DESC
    	ELSE SO.SALES_ORDER_STATUS_DELIVERY || '-' || SO.SALES_ORDER_STATUS_DELIVERY_DESC
    END AS STATUS,
	NULL AS STATUS_REJECTION,
	REFERENCE_SALES_ORDER_NUMBER, 
	DELIVERY_NUMBER, 
	NULL AS GI_NUMBER,
	NULL AS BILLING_NUMBER, 
	NULL AS TTF_NUMBER,
	NULL AS BILLING_CLEARING_NUMBER,
	DELIVERY_CREATED_DATE AS CREATED_DATE,
	0 AS SO_QTY, 
	0 AS SO_AMOUNT,
	SUM(DELIVERY_QUANTITY_IN_KG) AS DO_QTY, 
	0 AS GI_QTY,
	0 AS POD_QTY,
	0 AS BILL_QTY,
	0 AS BILL_AMOUNT,
	0 AS TFTG_AMOUNT
FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_DELIVERY SD
LEFT JOIN 
	(SELECT DISTINCT SALES_ORDER_NUMBER, SALES_ORDER_STATUS_DELIVERY, SALES_ORDER_STATUS_DELIVERY_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER) AS SO
	ON SD.REFERENCE_SALES_ORDER_NUMBER  = SO.SALES_ORDER_NUMBER
WHERE REFERENCE_SALES_ORDER_NUMBER = '1207365456'
GROUP BY ALL)
UNION ALL
(SELECT 'GI' AS TRX, 
	NULL AS TYPE,
	NULL AS STATUS,
	NULL AS STATUS_REJECTION,
	SALES_ORDER_NUMBER, 
	REFERENCE AS DELIVERY_NUMBER, 
	MATERIAL_DOCUMENT_NUMBER AS GI_NUMBER,
	NULL AS BILLING_NUMBER,
	NULL AS TTF_NUMBER,
	NULL AS BILLING_CLEARING_NUMBER,
	ENTRY_DATE AS CREATED_DATE, 
	0 AS SO_QTY, 
	0 AS SO_AMOUNT,
	0 AS DO_QTY,
	SUM(SIGNED_QUANTITY_FOR_BALANCE) AS GI_QTY,
	0 AS POD_QTY,
	0 AS BILL_QTY,
	0 AS BILL_AMOUNT,
	0 AS TFTG_AMOUNT
FROM PROD_DB.DSTR_BI_COMMUNITY.F_SCM_MUTASI_MATERIAL /*SCM_TMP*/ AS A
LEFT JOIN 
(SELECT DISTINCT SALES_ORDER_NUMBER, DELIVERY_NUMBER FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_FLOW_ORDER_DOCUMENT_FLOW /*SO_TMP*/) AS B 
ON A.REFERENCE = B.DELIVERY_NUMBER
WHERE REFERENCE = '3207552043'
GROUP BY ALL)
UNION ALL
(SELECT 'POD' AS TRX, 
	NULL AS TYPE,
	POD_STATUS AS STATUS,
	POD_REASON_DESC AS STATUS_REJECTION,
	SALES_ORDER_NUMBER, 
	PD.DELIVERY_NUMBER, 
	NULL AS BILLING_NUMBER,
	NULL AS GI_NUMBER,
	NULL AS TTF_NUMBER,
	NULL AS BILLING_CLEARING_NUMBER,
	POD_DATE AS CREATED_DATE,
	0 AS SO_QTY, 
	0 AS SO_AMOUNT,
	0 AS DO_QTY,
	0 AS GI_QTY,
	SUM (SB.BILLING_NEGATIVE_FLAG * SB.BILLING_QUANTITY_IN_KG) AS POD_QTY,
	0 AS BILL_QTY,
	0 AS BILL_AMOUNT,
	0 AS TFTG_AMOUNT
FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_DELIVERY_POD PD
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, SALES_ORDER_NUMBER, DELIVERY_NUMBER FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_FLOW_ORDER_DOCUMENT_FLOW ) AS B 
	ON PD.DELIVERY_NUMBER = B.DELIVERY_NUMBER
	AND PD.SOURCE_SYSTEM = B.SOURCE_SYSTEM
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, DELIVERY_NUMBER, DELIVERY_POSTING_DATE FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_DELIVERY ) AS SD
	ON PD.DELIVERY_NUMBER = SD.DELIVERY_NUMBER
	AND PD.SOURCE_SYSTEM = SD.SOURCE_SYSTEM
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, BILLING_NUMBER, REFERENCE_DOCUMENT_NUMBER, BILLING_NEGATIVE_FLAG, BILLING_QUANTITY_IN_KG, BILLING_TYPE FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING) AS SB
	ON PD.DELIVERY_NUMBER = SB.REFERENCE_DOCUMENT_NUMBER
	AND PD.SOURCE_SYSTEM = SB.SOURCE_SYSTEM
	AND SB.BILLING_TYPE <> 'ZB50'
WHERE PD.DELIVERY_NUMBER = '3207552043'
GROUP BY ALL)
UNION ALL
(SELECT 'BILLING' AS TRX, 
	BILLING_TYPE || '-' || BILLING_TYPE_DESC AS TYPE,
	CASE 
    	WHEN SO.SALES_ORDER_STATUS_BILLING_DESC IS NULL OR SO.SALES_ORDER_STATUS_BILLING = '' 
    	THEN SO.SALES_ORDER_STATUS_BILLING_DESC
    	ELSE SO.SALES_ORDER_STATUS_BILLING || '-' || SO.SALES_ORDER_STATUS_BILLING_DESC
    END AS STATUS,
	NULL AS STATUS_REJECTION,
	REFERENCE_SALES_ORDER_NUMBER, 
	NULL AS DELIVERY_NUMBER, 
	NULL AS GI_NUMBER,
	BILLING_NUMBER, 
	NULL AS TTF_NUMBER,
	NULL AS BILLING_CLEARING_NUMBER,
	BILLING_CREATED_DATE AS CREATED_DATE,
	0 AS SO_QTY, 
	0 AS SO_AMOUNT,
	0 AS DO_QTY,
	0 AS GI_QTY,
	0 AS POD_QTY,
	SUM (BILLING_NEGATIVE_FLAG * BILLING_QUANTITY_IN_KG) AS BILL_QTY,
	SUM (BILLING_NEGATIVE_FLAG * BILLING_NET_AMOUNT) AS BILL_AMOUNT,
	0 AS TFTG_AMOUNT
FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING AS SB
LEFT JOIN 
	(SELECT DISTINCT SALES_ORDER_NUMBER, SALES_ORDER_STATUS_BILLING, SALES_ORDER_STATUS_BILLING_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER) AS SO
	ON SB.REFERENCE_SALES_ORDER_NUMBER = SO.SALES_ORDER_NUMBER
WHERE BILLING_TYPE <> 'ZB50'
AND REFERENCE_SALES_ORDER_NUMBER = '1207365456'
GROUP BY ALL)
UNION ALL
(SELECT 'TFTG' AS TRX, 
	NULL AS TYPE,
	NULL AS STATUS,
	NULL AS STATUS_REJECTION,
	SALES_ORDER_NUMBER, 
	NULL AS DELIVERY_NUMBER, 
	NULL AS GI_NUMBER,
	TF.BILLING_NUMBER AS BILLING_NUMBER,
	TF.TTF_NUMBER,
	NULL AS BILLING_CLEARING_NUMBER,
	TTF_CREATED_DATE AS CREATED_DATE,
	0 AS SO_QTY, 
	0 AS SO_AMOUNT,
	0 AS DO_QTY,
	0 AS GI_QTY,
	0 AS POD_QTY,
	0 AS BILL_QTY,
	0 AS BILL_AMOUNT,
	SUM (AMOUNT) AS TFTG_AMOUNT
FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_TTF_LATEST TF
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, SALES_ORDER_NUMBER, DELIVERY_NUMBER, BILLING_NUMBER FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_FLOW_ORDER_DOCUMENT_FLOW ) AS B 
	ON TF.BILLING_NUMBER = B.BILLING_NUMBER
	AND TF.SOURCE_SYSTEM = B.SOURCE_SYSTEM
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, BILLING_NUMBER, BILLING_TYPE FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING) AS SB
	ON TF.BILLING_NUMBER = SB.BILLING_NUMBER
	AND TF.SOURCE_SYSTEM = SB.SOURCE_SYSTEM
	AND SB.BILLING_TYPE <> 'ZB50'
WHERE TF.BILLING_NUMBER = '5204957586'
GROUP BY ALL)
UNION ALL
(SELECT 'BILLING CLEARING' AS TRX, 
	NULL AS TYPE,
	NULL AS STATUS,
	NULL AS STATUS_REJECTION,
	SALES_ORDER_NUMBER, 
	NULL AS DELIVERY_NUMBER, 
	NULL AS GI_NUMBER,
	SBC.BILLING_NUMBER AS BILLING_NUMBER,
	NULL AS TTF_NUMBER,
	BILLING_CLEARING_DOC AS BILLING_CLEARING_NUMBER,
	BILLING_CLEAR_CREATED_DATE AS CREATED_DATE,
	0 AS SO_QTY, 
	0 AS SO_AMOUNT,
	0 AS DO_QTY,
	0 AS GI_QTY,
	0 AS POD_QTY,
	0 AS BILL_QTY,
	0 AS BILL_AMOUNT,
	0 AS TFTG_AMOUNT
FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING_CLEARING SBC
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, SALES_ORDER_NUMBER, DELIVERY_NUMBER, BILLING_NUMBER FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_FLOW_ORDER_DOCUMENT_FLOW ) AS B 
	ON SBC.BILLING_NUMBER = B.BILLING_NUMBER
	AND SBC.SOURCE_SYSTEM = B.SOURCE_SYSTEM
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, BILLING_NUMBER, BILLING_NEGATIVE_FLAG, BILLING_NET_AMOUNT, BILLING_TYPE FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_BILLING) AS SB
	ON SBC.BILLING_NUMBER = SB.BILLING_NUMBER
	AND SBC.SOURCE_SYSTEM = SB.SOURCE_SYSTEM
	AND SB.BILLING_TYPE <> 'ZB50'
WHERE SBC.BILLING_NUMBER = '5204957586'
GROUP BY ALL)) X
LEFT JOIN 
	(SELECT DISTINCT SALES_ORDER_DATE, SOURCE_SYSTEM, COMPANY_CODE, CUSTOMER, SALES_OFFICE, PLANT, DISTRIBUTION_CHANNEL, DIVISION, DIVISION_DESC, SALES_ORDER_NUMBER 
	 FROM PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER) AS Y 
	ON X.SALES_ORDER_NUMBER = Y.SALES_ORDER_NUMBER
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, CUSTOMER, CUSTOMER_NAME, SALES_OFFICE, SALES_OFFICE_DESC, TERM_OF_PAYMENT, TERM_OF_PAYMENT_DESC, DISTRIBUTION_CHANNEL, REGION 
	 FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER) AS CUST
	ON Y.CUSTOMER = CUST.CUSTOMER
	AND Y.SOURCE_SYSTEM = CUST.SOURCE_SYSTEM
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, DISTRIBUTION_CHANNEL, DISTRIBUTION_CHANNEL_DESC
	 FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_AREA) AS SA
	ON Y.DISTRIBUTION_CHANNEL = SA.DISTRIBUTION_CHANNEL
	AND Y.SOURCE_SYSTEM = SA.SOURCE_SYSTEM
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, SALES_OFFICE, SALES_OFFICE_DESC
	 FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_AREA) AS SA2
	ON Y.SALES_OFFICE = SA2.SALES_OFFICE
	AND Y.SOURCE_SYSTEM = SA2.SOURCE_SYSTEM
LEFT JOIN 
	(SELECT DISTINCT SOURCE_SYSTEM, COMPANY_CODE, COMPANY_NAME, PLANT, PLANT_NAME
	 FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT CP) AS CP
	ON Y.COMPANY_CODE = CP.COMPANY_CODE
	AND Y.PLANT = CP.PLANT
	AND Y.SOURCE_SYSTEM = CP.SOURCE_SYSTEM;
