WITH BASE_PO AS (
    SELECT 
        SOURCE_SYSTEM,
        PURCHASE_ORDER,
        COMPANY_CODE,
        PLANT,
        SUPPLYING_PLANT,
        VENDOR,
        VENDOR_GROUP,
        PO_PERIOD,
        PURCHASE_TYPE,
        PURCHASE_ORDER_ITEM_CATEGORY,
        PURCHASE_ORDER_ITEM_CATEGORY_DESCRIPTION,
        DOCUMENT_NUMBER,
        PURCHASE_DOCUMENT_TYPE,
        PO_QUANTITY,
        PO_AMOUNT_ACTUAL_POSTING,
        GR_QUANTITY,
        GR_AMOUNT,
        IR_QUANTITY,
        IR_AMOUNT,
        POSTING_DATE_PO,
        POSTING_DATE
    FROM F_SCM_PURCHASING_ORDER
    WHERE PO_PERIOD BETWEEN '202509' AND '202510'
    AND 
    PLANT = '90HA'
    AND VENDOR IN ('ID7A29','ID7A107','ID7A43','ID7A108','ID7A109','ID7A90','ID7A104','ID7A69','ID7AA25','ID7A103','ID7A92','ID7A97')
    AND PURCHASE_TYPE LIKE 'STANDARD'
),
PO_HEADER AS (
    SELECT DISTINCT
        SOURCE_SYSTEM,
        PURCHASE_ORDER,
        COMPANY_CODE,
        PLANT,
        SUPPLYING_PLANT,
        VENDOR,
        VENDOR_GROUP,
        PO_PERIOD,
        PURCHASE_TYPE
    FROM BASE_PO
),
UNIFIED AS (
    SELECT
        'Purchase Order' AS CATEGORY,
        PURCHASE_DOCUMENT_TYPE || '-' || PURCHASE_TYPE AS TYPE,
        PURCHASE_ORDER AS PO_NUMBER,
        NULL AS GR_NUMBER,
        NULL AS INV_NUMBER,
        TO_DATE(POSTING_DATE_PO) AS PO_POSTING_DATE,
        NULL AS POSTING_DATE,
        SUM(PO_QUANTITY) AS PO_QTY,
        SUM(PO_AMOUNT_ACTUAL_POSTING) AS PO_AMOUNT,
        0 AS GR_QTY,
        0 AS GR_AMOUNT,
        0 AS INV_QTY,
        0 AS INV_AMOUNT
    FROM BASE_PO
    GROUP BY 1,2,3,4,5,6,7
    UNION ALL
    SELECT
        'Good Receipt' AS CATEGORY,
        PURCHASE_ORDER_ITEM_CATEGORY || '-' || PURCHASE_ORDER_ITEM_CATEGORY_DESCRIPTION AS TYPE,
        PURCHASE_ORDER AS PO_NUMBER,
        DOCUMENT_NUMBER AS GR_NUMBER,
        NULL AS INV_NUMBER,
        TO_DATE(POSTING_DATE_PO) AS PO_POSTING_DATE,
        TO_DATE(POSTING_DATE) AS POSTING_DATE,
        0 AS PO_QTY,
        0 AS PO_AMOUNT,
        SUM(GR_QUANTITY) AS GR_QTY,
        SUM(GR_AMOUNT) AS GR_AMOUNT,
        0 AS INV_QTY,
        0 AS INV_AMOUNT
    FROM BASE_PO
    WHERE PURCHASE_ORDER_ITEM_CATEGORY IN ('E', 'U', 'F')
    GROUP BY 1,2,3,4,5,6,7
    UNION ALL
    SELECT
        'Invoice' AS CATEGORY,
        PURCHASE_ORDER_ITEM_CATEGORY || '-' || PURCHASE_ORDER_ITEM_CATEGORY_DESCRIPTION AS TYPE,
        PURCHASE_ORDER AS PO_NUMBER,
        NULL AS GR_NUMBER,
        DOCUMENT_NUMBER AS INV_NUMBER,
        TO_DATE(POSTING_DATE_PO) AS PO_POSTING_DATE,
        TO_DATE(POSTING_DATE) AS POSTING_DATE,
        0 AS PO_QTY,
        0 AS PO_AMOUNT,
        0 AS GR_QTY,
        0 AS GR_AMOUNT,
        SUM(IR_QUANTITY) AS INV_QTY,
        SUM(IR_AMOUNT) AS INV_AMOUNT
    FROM BASE_PO
    WHERE PURCHASE_ORDER_ITEM_CATEGORY IN ('M', 'P', 'N', 'K', 'Q')
    GROUP BY 1,2,3,4,5,6,7
)
SELECT
    PO.SOURCE_SYSTEM,
    PO.COMPANY_CODE || '-' || CP.COMPANY_NAME AS COMPANY,
    PO.PLANT || '-' || CP1.PLANT_NAME AS PLANT,
    PO.SUPPLYING_PLANT || '-' || CP2.PLANT_NAME AS SUPPLYING_PLANT,
    PO.VENDOR AS VENDOR_CODE,
    VDR.VENDOR_DESC AS VENDOR_NAME,
    PO.VENDOR_GROUP,
    PO.PO_PERIOD,
    X.*
FROM UNIFIED X
JOIN PO_HEADER PO
    ON X.PO_NUMBER = PO.PURCHASE_ORDER
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, COMPANY_CODE, COMPANY_NAME FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT) CP
    ON PO.SOURCE_SYSTEM = CP.SOURCE_SYSTEM
   AND PO.COMPANY_CODE = CP.COMPANY_CODE
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, PLANT, PLANT_NAME FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT) CP1
    ON PO.SOURCE_SYSTEM = CP1.SOURCE_SYSTEM
   AND PO.PLANT = CP1.PLANT
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, PLANT, PLANT_NAME FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT) CP2
    ON PO.SOURCE_SYSTEM = CP2.SOURCE_SYSTEM
   AND PO.SUPPLYING_PLANT = CP2.PLANT
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, VENDOR, VENDOR_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.D_SCM_VENDOR) VDR
    ON PO.SOURCE_SYSTEM = VDR.SOURCE_SYSTEM
   AND PO.VENDOR = VDR.VENDOR
WHERE 
    PO.PLANT = '90HA'
    AND PO.VENDOR IN ('ID7A29','ID7A107','ID7A43','ID7A108','ID7A109','ID7A90','ID7A104','ID7A69','ID7AA25','ID7A103','ID7A92','ID7A97')
    AND PO.PURCHASE_TYPE LIKE 'STANDARD';
