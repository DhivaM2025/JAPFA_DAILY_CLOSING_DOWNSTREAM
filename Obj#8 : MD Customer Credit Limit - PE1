-- CATATAN : 
-- 1/ Copy and paste code pada DBeaver lalu click Ctrl + Enter untuk run query
-- 2/ Sesuaikan CC.SOURCE_SYSTEM = 'PE1'

-- Dashboard #8: Customer Credit Limit Master Data Join With Customer Master Data
SELECT
    CC.CREDIT_CONTROL_AREA,
	SO.SALES_OFFICE || '-' || SA2.SALES_OFFICE_DESC AS SALES_OFFICE,
	LEFT (SA2.SALES_OFFICE_DESC, 3) AS SALES_OFFICE_LOKASI,
    SO.PLANT || '-' || CP.PLANT_NAME AS PLANT,
    REG.REGION || '-' || REG.REGION_DESC AS REGION,
    CASE 
        WHEN REG.REGION IN ('01', '02', '03', '04', '05', '28') THEN 'Pulau Jawa'
        ELSE 'Luar Jawa'
    END AS STATUS_REGION,
    SO.DISTRIBUTION_CHANNEL || '-' || SA.DISTRIBUTION_CHANNEL_DESC AS DISTRIBUTION_CHANNEL,
    CUST.BLOCK_FOR_SALES,
    CC.CREDIT_OWNER,
    CC.CREDIT_OWNER_NAME,
    CC.CUSTOMER,
    CC.CUSTOMER_NAME,
    CC.CREDIT_LIMIT,
	CASE
		WHEN CC.CREDIT_LIMIT < 3000000 THEN '1/ <3 juta'
		WHEN CC.CREDIT_LIMIT >= 3000000 AND CC.CREDIT_LIMIT <= 30000000 THEN '2/ 3-30 juta'
		WHEN CC.CREDIT_LIMIT > 30000000 AND CC.CREDIT_LIMIT <= 100000000 THEN '3/ 30-100 juta'
		WHEN CC.CREDIT_LIMIT > 100000000 AND CC.CREDIT_LIMIT <= 500000000 THEN '4/ 100-500 juta'
		WHEN CC.CREDIT_LIMIT > 500000000 AND CC.CREDIT_LIMIT <= 1000000000 THEN '5/ 500 juta - 1M'
		WHEN CC.CREDIT_LIMIT > 1000000000 THEN '6/ > 1 M'
	ELSE 'Unknown'
	END AS CREDIT_LIMIT_GROUP,
FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER_CREDIT CC
LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.F_SALES_SALES_ORDER SO
	ON CC.CUSTOMER = SO.CUSTOMER
    AND CC.SOURCE_SYSTEM = SO.SOURCE_SYSTEM
LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.D_SALES_CUSTOMER CUST
	ON CC.CUSTOMER = CUST.CUSTOMER
    AND CC.SOURCE_SYSTEM = CUST.SOURCE_SYSTEM
    AND CUST.BLOCK_FOR_SALES = 'Non block'
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, DISTRIBUTION_CHANNEL, DISTRIBUTION_CHANNEL_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_AREA) SA
    ON SO.DISTRIBUTION_CHANNEL = SA.DISTRIBUTION_CHANNEL
    AND SO.SOURCE_SYSTEM = SA.SOURCE_SYSTEM 
LEFT JOIN (SELECT DISTINCT SOURCE_SYSTEM, SALES_OFFICE, SALES_OFFICE_DESC FROM PROD_DB.DSTR_BI_COMMUNITY.D_SALES_AREA) SA2
	ON SO.SALES_OFFICE = SA2.SALES_OFFICE
    AND SO.SOURCE_SYSTEM = SA2.SOURCE_SYSTEM
LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.D_SALES_REGION REG
    ON CUST.REGION = REG.REGION
    AND CUST.SOURCE_SYSTEM = REG.SOURCE_SYSTEM
	AND REG.COUNTRY = 'ID'
LEFT JOIN PROD_DB.DSTR_BI_COMMUNITY.D_SCM_COMPANY_AND_PLANT CP
    ON SO.SOURCE_SYSTEM = CP.SOURCE_SYSTEM
    AND SO.COMPANY_CODE = CP.COMPANY_CODE
    AND SO.PLANT = CP.PLANT
WHERE CC.SOURCE_SYSTEM = 'PE1' 
AND CUST.BLOCK_FOR_SALES = 'Non block'
GROUP BY ALL;
